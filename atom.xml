<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[@znz blog]]></title>
  <link href="http://blog.n-z.jp/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2016-08-16T01:23:45+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[LILO&東海道らぐオフラインミーティング 2016/08/14]]></title>
    <link href="http://blog.n-z.jp/blog/2016-08-14-lilo-tokaidolug.html"/>
    <updated>2016-08-14T13:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/lilo-tokaidolug</id>
    <content type="html"><![CDATA[<p><a href="http://lilo.connpass.com/event/37410/" title="LILO&amp;東海道らぐオフラインミーティング 2016/08/14">LILO&amp;東海道らぐオフラインミーティング 2016/08/14</a> に参加しました。</p>

<p>今回もアンカンファレンス形式でした。</p>

<p><a href="https://www.doorkeeper.jp/news/2016/7/25/change-in-pricing" title="Doorkeeper料金体系の変更について">Doorkeeper料金体系の変更について</a>でアナウンスされたように Doorkeeper が有料化されることに伴い、申し込みは connpass に移行しました。</p>

<!--more-->


<h2>メモ</h2>

<p>今回のメモです。</p>

<ul>
<li>いつものように鍵担当の人が遅れていたが、代理で開けていた</li>
<li>ハッシュタグ: <code>#lilo_jp</code> <code>#東海道らぐ</code></li>
<li>登録参加者数 14名</li>
<li>自己紹介から</li>
<li>最初は自分の発表「lilo.linux.or.jp の話」</li>
<li>「OpenStreetMap で地図を作ろう!」坂ノ下さん</li>
<li>Map Compare というサイトで Google Map と OSM の平安神宮を比較すると、OSMの方が詳しい</li>
<li>JOSM というクライアントで実演</li>
<li>ノード、ウェイ、エリアででできている</li>
<li>誰でも書き込めるし消せるので、悪質なユーザーへの対処は日々行っている</li>
<li><a href="http://wiki.openstreetmap.org/wiki/JA:Map_Features">http://wiki.openstreetmap.org/wiki/JA:Map_Features</a></li>
<li>鳥居のタグの話</li>
<li>どのようにタグをつけるのかは議論しながら決まっている</li>
<li>「IoTハウス」山内さん</li>
<li><a href="http://www.pepolinux.com">http://www.pepolinux.com</a> <a href="https://twitter.com/kujiranodanna">https://twitter.com/kujiranodanna</a></li>
<li>ラズパイで IoT ハウス</li>
<li>Tocos, IRKit</li>
<li>リセッタブルヒューズ</li>
<li>休憩</li>
<li>「お前が持っているLPICってどんなものよ? LPI 304受験報告記」中野さん</li>
<li>事前に公開されていた発表資料: <a href="https://bitbucket.org/itsango/lilo20160814">https://bitbucket.org/itsango/lilo20160814</a></li>
<li>有意性の期限がある</li>
<li>メリット: Linux が使える客観的な証拠になる</li>
<li>デメリット: 高い</li>
<li>304 の参考書: <a href="https://amazon.jp/dp/4844380540">https://amazon.jp/dp/4844380540</a></li>
<li>TOEIC みたいに何か統計処理された採点方式らしい</li>
<li>「Windows 10 タブレットに Ubuntu 16.04 を色々入れてみた 2016 年度版」Kapper さん</li>
<li><a href="http://www.slideshare.net/kapper1224/windows10ubuntu16042016install-ubuntu1604-on-windows10-tablet-63862255">http://www.slideshare.net/kapper1224/windows10ubuntu16042016install-ubuntu1604-on-windows10-tablet-63862255</a></li>
<li>Wubi for Ubuntu 16.04 が公式にタブレット対応</li>
<li>「Yocto を使った Linux Distro の作り方とハマり方」山口さん</li>
<li><a href="https://github.com/watatuki">https://github.com/watatuki</a></li>
<li><a href="https://www.yoctoproject.org/">https://www.yoctoproject.org/</a></li>
<li>たとえていえば Gentoo をクロスビルドにしたようなもの</li>
<li>layer を組み合わせて構成</li>
<li>recipe はソースと 1対1 対応</li>
<li>複数の layer の組み合わせが問題でビルドが通らなくなることがある</li>
<li>Android でおなじみの repo でいい感じできた</li>
<li>例: <a href="https://github.com/watatuki/agl-jetson-tk1">https://github.com/watatuki/agl-jetson-tk1</a></li>
<li>休憩</li>
<li>「TUI作業で便利なソフト2題」島田さん</li>
<li>opencocon の紹介</li>
<li>build server</li>
<li>このごろあった悩み: ファイルツリーを駆け回るのがめんどい</li>
<li>解決法：TUI ファイラー</li>
<li>mc (Midnight Commander)</li>
<li>あんまり慣れてない</li>
<li>Ctrl キー等を多用する</li>
<li>F1-F12 を使わなければならない</li>
<li>tmux とキーバインドが干渉しやすい</li>
<li>他に選択肢がないか?</li>
<li>FDclone</li>
<li>このごろあった悩み: git コマンドをいちいち叩くのがめんどい</li>
<li>tig</li>
<li>「Docker話」左川さん</li>
<li>vagrant で docker を試した話</li>
<li>box ファイルは VirtualBox で普通にインストールして不要なものを削除して作成した。</li>
<li>会場から packer がおすすめという話</li>
<li>さくらインターネットの Arukas はまだ誰も使ったことがない</li>
<li>今回の会場費は余剰金があるので無料になった。</li>
<li>「sedの話」田川さん</li>
<li>sed はプログラミング言語</li>
<li>デバッグオプション <code>-d</code> のある sed</li>
<li>sdb というデバッガをネットワーク経由で接続</li>
<li>「せっかくのプレゼン資料なんだから Git で管理しよう Slides を公開しよう」中野さん</li>
<li>事前に公開されていた資料: <a href="https://bitbucket.org/itsango/vcsforslides">https://bitbucket.org/itsango/vcsforslides</a></li>
<li><a href="http://progit-ja.github.io/">http://progit-ja.github.io/</a></li>
<li><a href="https://ja.wikipedia.org/wiki/OSS%E3%83%9B%E3%82%B9%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AE%E6%AF%94%E8%BC%83" title="OSSホスティングサービスの比較">OSSホスティングサービスの比較</a></li>
<li>次は冬休みの予定 (その前に k-of.jp にも参加予定)</li>
</ul>


<h2>発表した内容</h2>

<p>lilo.linux.or.jp のサーバーの前回の発表以降の話をしました。</p>

<p>内容は大きく分けると 二要素認証は進捗なし、 letsencrypt の証明書は certbot に変わっても順調に使えている話、 ufw でアタックが多いポートをログに残さないようにした話でした。</p>

<p>スライドはいつも通り <a href="http://slide.rabbit-shocker.org/authors/znz/lilo-20160814/">Rabbit Slide Show</a> (<a href="https://rubygems.org/gems/rabbit-slide-znz-lilo-20160814">RubyGems</a>), <a href="http://www.slideshare.net/znzjp/lilo-20160814">SlideShare</a>, <a href="https://speakerdeck.com/znz/lilo-dot-linux-dot-or-dot-jp-falsehua">Speaker Deck</a> にあげています。(ソースは <a href="https://github.com/znz/lilo-20160814">github</a> にあげています。)
(しかし、2016-08-14現在 slide.rabbit-shocker.org (Rabbit Slide Show) には反映されていないようなので、 SlideShare か Speaker Deck でみてください。)
(2016-08-16現在、反映されたので Rabbit Slide Show でも見えるようになりました。)</p>

<iframe src="http://slide.rabbit-shocker.org/authors/znz/lilo-20160814/viewer.html"
        width="640" height="524"
        frameborder="0"
        marginwidth="0"
        marginheight="0"
        scrolling="no"
        style="border: 1px solid #ccc; border-width: 1px 1px 0; margin-bottom: 5px"
        allowfullscreen> </iframe>


<div style="margin-bottom: 5px">
  <a href="http://slide.rabbit-shocker.org/authors/znz/lilo-20160814/" title="lilo.linux.or.jp の話">lilo.linux.or.jp の話</a>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Let's Encrypt Subscriber Agreementの比較]]></title>
    <link href="http://blog.n-z.jp/blog/2016-07-27-letsencrypt-new-subscriber-agreement.html"/>
    <updated>2016-07-27T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/letsencrypt-new-subscriber-agreement</id>
    <content type="html"><![CDATA[<p>7月9日(土) に <code>Let's Encrypt Subscriber Agreement Update</code> というメールがきていて、
<code>Let's Encrypt Subscriber Agreement</code> が8月1日に v1.0.1 から v1.1.1 に更新されるというので、
内容をテキストファイルに落として diff をとってみました。</p>

<!--more-->


<h2>Let&rsquo;s Encrypt からのメール</h2>

<p>Let&rsquo;s Encrypt からのメールは必要最低限しかこないのですが、
今のところ staging 環境で取得していた証明書の期限切れ通知メールと
今回の <code>Let's Encrypt Subscriber Agreement Update</code> のお知らせメールしか届いていません。</p>

<p>お知らせメールの内容は以下の通りでした。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Let&#39;s Encrypt Subscriber,
</span><span class='line'>
</span><span class='line'>We&#39;re writing to let you know that we are updating the Let&#39;s Encrypt Subscriber Agreement, effective August 1, 2016. You can find the updated agreement (v1.1.1) as well as the current agreement (v1.0.1) in the &quot;Let&#39;s Encrypt Subscriber Agreement&quot; section of the following page:
</span><span class='line'>
</span><span class='line'>https://letsencrypt.org/repository/
</span><span class='line'>
</span><span class='line'>Thank you for helping to secure the Web by using Let&#39;s Encrypt.
</span><span class='line'>
</span><span class='line'>- The Let&#39;s Encrypt Team
</span></code></pre></td></tr></table></div></figure>


<h2>テキストへ変換</h2>

<p><code>poppler</code> に入っている <code>pdftotext</code> コマンドで PDF からテキストファイルに変換しました。</p>

<h2>diff</h2>

<p><code>git diff --no-index LE-SA-v1.*.txt</code> での比較結果は以下の通りでした。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/LE-SA-v1.0.1-July-27-2015.txt b/LE-SA-v1.1.1-August-1-2016.txt</span>
</span><span class='line'><span class="gh">index d5a0b9d..e5850ef 100644</span>
</span><span class='line'><span class="gd">--- a/LE-SA-v1.0.1-July-27-2015.txt</span>
</span><span class='line'><span class="gi">+++ b/LE-SA-v1.1.1-August-1-2016.txt</span>
</span><span class='line'><span class="gu">@@ -1,6 +1,6 @@</span>
</span><span class='line'><span class="gd">-Version 1.0.1</span>
</span><span class='line'><span class="gd">-July 27, 2015</span>
</span><span class='line'><span class="gd">-Page 1 of 6</span>
</span><span class='line'><span class="gi">+Version 1.1.1</span>
</span><span class='line'><span class="gi">+August 1, 2016</span>
</span><span class='line'><span class="gi">+Page 1 of 7</span>
</span><span class='line'>
</span><span class='line'> LET’S ENCRYPT
</span><span class='line'> SUBSCRIBER AGREEMENT
</span><span class='line'><span class="gu">@@ -38,15 +38,20 @@ Key.</span>
</span><span class='line'> “Public Key” — In Public Key Cryptography, this is the publicly-disclosed key that is used by the recipient
</span><span class='line'> to (i) validate Digital Signatures created with the corresponding Private Key and (ii) encrypt messages or
</span><span class='line'> files to be decrypted with the corresponding Private Key.
</span><span class='line'><span class="gi">+“Key Compromise”— A Private Key is said to be compromised if its value has been disclosed to an</span>
</span><span class='line'><span class="gi">+unauthorized person, an unauthorized person has had access to it, or there exists a practical technique by</span>
</span><span class='line'><span class="gi">+which an unauthorized person may discover its value. A Private Key is also considered compromised if</span>
</span><span class='line'><span class="gi">+methods have been developed that can easily calculate it based on the Public Key or if there is clear</span>
</span><span class='line'><span class="gi">+evidence that the specific method used to generate the Private Key was flawed.</span>
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+Version 1.1.1</span>
</span><span class='line'><span class="gi">+August 1, 2016</span>
</span><span class='line'><span class="gi">+Page 2 of 7</span>
</span><span class='line'> “Public Key Cryptography” — A type of cryptography that uses a Key Pair to securely encrypt and
</span><span class='line'> decrypt messages. One key encrypts a message, and the other key decrypts the message. One key is kept
</span><span class='line'> secret (the Private Key), and one is made available to others (the Public Key). These keys are, in essence,
</span><span class='line'> large mathematically-related numbers that form a unique pair. Either key may be used to encrypt a
</span><span class='line'> message, but only the other corresponding key may be used to decrypt the message.
</span><span class='line'><span class="gd">-</span>
</span><span class='line'><span class="gd">-Version 1.0.1</span>
</span><span class='line'><span class="gd">-July 27, 2015</span>
</span><span class='line'><span class="gd">-Page 2 of 6</span>
</span><span class='line'> “Repository” — An online system maintained by ISRG for storing and retrieving Let’s Encrypt Certificates
</span><span class='line'> and other information relevant to Let’s Encrypt Certificates, including information relating validity or
</span><span class='line'> revocation.
</span><span class='line'><span class="gu">@@ -54,7 +59,7 @@ revocation.</span>
</span><span class='line'> (“Valid From” or “Activation” date), and ending on the expiration date indicated in such Certificate (“Valid
</span><span class='line'> To” or “Expiry” date).
</span><span class='line'> “Your Certificate” — A Let’s Encrypt Certificate issued to You.
</span><span class='line'><span class="gd">-2.!</span>
</span><span class='line'><span class="gi">+2.</span>
</span><span class='line'>
</span><span class='line'> Effective Date, Term, and Survival
</span><span class='line'> 2.1
</span><span class='line'><span class="gu">@@ -78,7 +83,7 @@ Sections in this Agreement concerning privacy, indemnification, disclaimer of wa</span>
</span><span class='line'> liability, governing law, choice of forum, limitations on claims against ISRG, and prohibitions on the use of
</span><span class='line'> fraudulently-obtained Certificates and expired Certificates shall survive any termination or expiration of
</span><span class='line'> this Agreement.
</span><span class='line'><span class="gd">-3.!</span>
</span><span class='line'><span class="gi">+3.</span>
</span><span class='line'>
</span><span class='line'> Your Warranties and Responsibilities
</span><span class='line'> 3.1
</span><span class='line'><span class="gu">@@ -86,16 +91,10 @@ Your Warranties and Responsibilities</span>
</span><span class='line'> Warranties
</span><span class='line'>
</span><span class='line'> By requesting, accepting, or using a Let’s Encrypt Certificate:
</span><span class='line'><span class="gd">-•!</span>
</span><span class='line'><span class="gd">-</span>
</span><span class='line'><span class="gd">-•!</span>
</span><span class='line'><span class="gd">-</span>
</span><span class='line'><span class="gd">-•!</span>
</span><span class='line'><span class="gd">-•!</span>
</span><span class='line'><span class="gd">-•!</span>
</span><span class='line'><span class="gd">-•!</span>
</span><span class='line'><span class="gd">-•!</span>
</span><span class='line'><span class="gd">-3.2</span>
</span><span class='line'><span class="gi">+•</span>
</span><span class='line'><span class="gi">+•</span>
</span><span class='line'><span class="gi">+•</span>
</span><span class='line'><span class="gi">+•</span>
</span><span class='line'>
</span><span class='line'> You warrant to ISRG and the public-at-large that You are the legitimate registrant of the
</span><span class='line'> Internet domain name that is, or is going to be, the subject of Your Certificate, or that You are
</span><span class='line'><span class="gu">@@ -103,21 +102,30 @@ the duly authorized agent of such registrant.</span>
</span><span class='line'> You warrant to ISRG and the public-at-large that either (1) You did not obtain control of
</span><span class='line'> such domain name as the result of a seizure of such domain name, or (2) such domain name
</span><span class='line'> had no ongoing lawful uses at the time of such seizure.
</span><span class='line'><span class="gd">-You warrant that all information in Your Certificate regarding You or Your domain</span>
</span><span class='line'><span class="gd">-name is accurate, current, reliable, complete, and not misleading.</span>
</span><span class='line'><span class="gd">-You warrant that all information You have provided to ISRG is accurate, current,</span>
</span><span class='line'><span class="gd">-complete, reliable, complete, and not misleading.</span>
</span><span class='line'><span class="gd">-You warrant that You rightfully hold the Private Key corresponding to the Public Key</span>
</span><span class='line'><span class="gd">-listed in Your Certificate.</span>
</span><span class='line'><span class="gd">-You warrant that You have taken all appropriate, reasonable, and necessary steps to secure</span>
</span><span class='line'><span class="gd">-and keep your Private Key secret.</span>
</span><span class='line'><span class="gd">-You warrant that You will not use Your Certificates to attack, defraud or intercept the</span>
</span><span class='line'><span class="gd">-traffic of others.</span>
</span><span class='line'><span class="gi">+You warrant to ISRG and the public-at-large that all information in Your Certificate</span>
</span><span class='line'><span class="gi">+regarding You or Your domain name is accurate, current, reliable, complete, and not</span>
</span><span class='line'><span class="gi">+misleading.</span>
</span><span class='line'><span class="gi">+You warrant to ISRG and the public-at-large that all information You have provided to</span>
</span><span class='line'><span class="gi">+ISRG is, and You agree that all information you will provide to ISRG at any time will be,</span>
</span><span class='line'><span class="gi">+accurate, current, complete, reliable, and not misleading.</span>
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+Version 1.1.1</span>
</span><span class='line'><span class="gi">+August 1, 2016</span>
</span><span class='line'><span class="gi">+Page 3 of 7</span>
</span><span class='line'><span class="gi">+•</span>
</span><span class='line'><span class="gi">+•</span>
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+3.2</span>
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+You warrant to ISRG and the public-at-large that You rightfully hold the Private Key</span>
</span><span class='line'><span class="gi">+corresponding to the Public Key listed in Your Certificate.</span>
</span><span class='line'><span class="gi">+You warrant to ISRG and the public-at-large that You have taken, and You agree that at</span>
</span><span class='line'><span class="gi">+all times You will take, all appropriate, reasonable, and necessary steps to maintain sole</span>
</span><span class='line'><span class="gi">+control of, secure, properly protect and keep secret and confidential the Private Key</span>
</span><span class='line'><span class="gi">+corresponding to the Public Key in Your Certificate (and any associated activation data or</span>
</span><span class='line'><span class="gi">+device, e.g. password or token).</span>
</span><span class='line'> Changes in Certificate Information
</span><span class='line'>
</span><span class='line'><span class="gd">-Version 1.0.1</span>
</span><span class='line'><span class="gd">-July 27, 2015</span>
</span><span class='line'><span class="gd">-Page 3 of 6</span>
</span><span class='line'> If at any time You no longer control the Internet domain names associated with any of Your Certificates, or
</span><span class='line'> if any of the warranties in Section 3.1 above are no longer true with respect to any of Your Certificates in
</span><span class='line'> any other way, You will immediately request that ISRG revoke the affected Certificates. You may request
</span><span class='line'><span class="gu">@@ -141,7 +149,7 @@ Key Pair Generation</span>
</span><span class='line'> Your Key Pair (Public and Private Keys) will be generated by You or Your ACME Client Software on
</span><span class='line'> Your systems. You will submit the corresponding Public Key to ISRG and it will be incorporated into
</span><span class='line'> Your Certificate. ISRG will store Your Certificate in its Repository. ISRG will not have access to Your
</span><span class='line'><span class="gd">-Private Key.</span>
</span><span class='line'><span class="gi">+Private Key. Your Private and Public Keys will remain Your property.</span>
</span><span class='line'> We will use technical methods and protocols to verify that You have exclusive control over the subject
</span><span class='line'> Internet domain name. This verification is done solely to assist ISRG in determining whether to issue a
</span><span class='line'> Let’s Encrypt Certificate and is not a service being performed for Your benefit or on Your behalf.
</span><span class='line'><span class="gu">@@ -149,46 +157,59 @@ Let’s Encrypt Certificate and is not a service being performed for Your benefi</span>
</span><span class='line'>
</span><span class='line'> Inspection and Acceptance of Certificates
</span><span class='line'>
</span><span class='line'><span class="gd">-You agree to immediately inspect the contents of Your Certificate (“Initial Inspection”), and to</span>
</span><span class='line'><span class="gd">-immediately request revocation if you become aware of any inaccuracies, errors, defects, or other</span>
</span><span class='line'><span class="gd">-problems (collectively, “Certificate Problems”) with Your Certificate. Your ACME Client Software</span>
</span><span class='line'><span class="gd">-may perform this task for You. You agree that You will have accepted Your Certificate when You</span>
</span><span class='line'><span class="gd">-first use Your Certificate or the corresponding Private Key after obtaining Your Certificate, or if You</span>
</span><span class='line'><span class="gd">-fail to request revocation of Your Certificate immediately following Initial Inspection.</span>
</span><span class='line'><span class="gi">+You warrant to ISRG and the public-at-large, and You agree, that You will immediately inspect the</span>
</span><span class='line'><span class="gi">+contents of Your Certificate (“Initial Inspection”), and to immediately request revocation if you</span>
</span><span class='line'><span class="gi">+become aware of any inaccuracies, errors, defects, or other problems (collectively, “Certificate</span>
</span><span class='line'><span class="gi">+Problems”) with Your Certificate. Your ACME Client Software may perform this task for You. You</span>
</span><span class='line'><span class="gi">+agree that You will have accepted Your Certificate when You first use Your Certificate or the</span>
</span><span class='line'><span class="gi">+corresponding Private Key after obtaining Your Certificate, or if You fail to request revocation of</span>
</span><span class='line'><span class="gi">+Your Certificate immediately following Initial Inspection.</span>
</span><span class='line'> 3.6
</span><span class='line'>
</span><span class='line'><span class="gd">-Use of Your Certificate</span>
</span><span class='line'><span class="gd">-</span>
</span><span class='line'><span class="gd">-The purpose of Your Certificate is to encrypt Internet communications. ISRG is not responsible for any</span>
</span><span class='line'><span class="gd">-legal or other consequences resulting from or associated with the use of Your Certificate. You agree that</span>
</span><span class='line'><span class="gd">-You will not use Your Certificate for any purpose requiring fail-safe performance, such as the operation of</span>
</span><span class='line'><span class="gd">-public utilities or power facilities, air traffic control or navigation systems, weapons systems, or any other</span>
</span><span class='line'><span class="gd">-systems, the failure of which would reasonably be expected to lead to bodily injury, death or property</span>
</span><span class='line'><span class="gd">-damage.</span>
</span><span class='line'><span class="gi">+Installation and Use of Your Certificate</span>
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+You may reproduce and distribute Your Certificate on a nonexclusive and royalty-free basis, provided that</span>
</span><span class='line'><span class="gi">+it is reproduced and distributed in full and in compliance with this Agreement. You warrant to ISRG and</span>
</span><span class='line'><span class="gi">+the public-at-large, and You agree, that You will install Your Certificate only on servers that are accessible</span>
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+Version 1.1.1</span>
</span><span class='line'><span class="gi">+August 1, 2016</span>
</span><span class='line'><span class="gi">+Page 4 of 7</span>
</span><span class='line'><span class="gi">+at the subjectAltName(s) listed in Your Certificate, and that you will use Your Certificate solely in</span>
</span><span class='line'><span class="gi">+compliance with all applicable laws and solely in accordance with this Agreement. Your Certificate will</span>
</span><span class='line'><span class="gi">+remain the property of ISRG, subject to Your right to use it as set forth in this Agreement.</span>
</span><span class='line'><span class="gi">+The purpose of Your Certificate is to authenticate and encrypt Internet communications. ISRG is not</span>
</span><span class='line'><span class="gi">+responsible for any legal or other consequences resulting from or associated with the use of Your</span>
</span><span class='line'><span class="gi">+Certificate. You agree that You will not use Your Certificate for any purpose requiring fail-safe</span>
</span><span class='line'><span class="gi">+performance, such as the operation of public utilities or power facilities, air traffic control or navigation</span>
</span><span class='line'><span class="gi">+systems, weapons systems, or any other systems, the failure of which would reasonably be expected to</span>
</span><span class='line'><span class="gi">+lead to bodily injury, death or property damage.</span>
</span><span class='line'> 3.7.
</span><span class='line'>
</span><span class='line'> When to Revoke Your Certificate
</span><span class='line'>
</span><span class='line'><span class="gd">-You must immediately request that Your Certificate be revoked if: (i) You suspect or discover that</span>
</span><span class='line'><span class="gd">-Your Private Key has been, or is in danger of being, lost, stolen, otherwise compromised, or subjected</span>
</span><span class='line'><span class="gd">-to unauthorized use, or (ii) any information in Your Certificate is no longer accurate, current or</span>
</span><span class='line'><span class="gd">-complete, or any such information becomes misleading. You may make a revocation request to ISRG</span>
</span><span class='line'><span class="gd">-</span>
</span><span class='line'><span class="gd">-Version 1.0.1</span>
</span><span class='line'><span class="gd">-July 27, 2015</span>
</span><span class='line'><span class="gd">-Page 4 of 6</span>
</span><span class='line'><span class="gd">-using ACME Client Software. You should also notify anyone who may have relied upon Your use of</span>
</span><span class='line'><span class="gd">-Your Certificate that Your encrypted communications may have been subject to compromise</span>
</span><span class='line'><span class="gi">+You warrant to ISRG and the public-at-large, and You agree, that You will immediately request that</span>
</span><span class='line'><span class="gi">+Your Certificate be revoked if: (i) there is any actual or suspected misuse or Key Compromise of the</span>
</span><span class='line'><span class="gi">+Private Key associated with the Public Key included in Your Certificate, or (ii) any information in Your</span>
</span><span class='line'><span class="gi">+Certificate is, or becomes, misleading, incorrect or inaccurate. You may make a revocation request to</span>
</span><span class='line'><span class="gi">+ISRG using ACME Client Software. You should also notify anyone who may have relied upon Your</span>
</span><span class='line'><span class="gi">+use of Your Certificate that Your encrypted communications may have been subject to compromise.</span>
</span><span class='line'> 3.8
</span><span class='line'>
</span><span class='line'> When to Cease Using Your Certificate
</span><span class='line'>
</span><span class='line'><span class="gd">-You must immediately cease using Your Certificate if: (i) You suspect or discover that the Private Key</span>
</span><span class='line'><span class="gd">-corresponding to Your Certificate has been or may be stolen, lost, or otherwise compromised or subjected</span>
</span><span class='line'><span class="gd">-to unauthorized use, (ii) any information in Your Certificate is no longer accurate, current or complete, or</span>
</span><span class='line'><span class="gd">-any such information becomes misleading, or (iii) upon the revocation or expiration of Your Certificate.</span>
</span><span class='line'><span class="gi">+You warrant to ISRG and the public-at-large, and You agree, that You will promptly cease using Your</span>
</span><span class='line'><span class="gi">+Certificate (i) if any information in Your Certificate is, or becomes, misleading, incorrect or inaccurate, or</span>
</span><span class='line'><span class="gi">+(ii) upon the revocation or expiration of Your Certificate.</span>
</span><span class='line'> 3.9
</span><span class='line'>
</span><span class='line'><span class="gi">+When to Cease Using Your Private Key</span>
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+You warrant to ISRG and the public-at-large, and You agree, that You will promptly cease all use of the</span>
</span><span class='line'><span class="gi">+Private Key corresponding to the Public Key included in Your Certificate upon revocation of Your</span>
</span><span class='line'><span class="gi">+Certificate for reasons of known or suspected Key Compromise.</span>
</span><span class='line'><span class="gi">+3.10</span>
</span><span class='line'><span class="gi">+</span>
</span><span class='line'> Indemnification
</span><span class='line'>
</span><span class='line'> You agree to indemnify and hold harmless ISRG and its directors, officers, employees, agents, and
</span><span class='line'><span class="gu">@@ -207,20 +228,17 @@ ISRG’s Rights and Responsibilities</span>
</span><span class='line'>
</span><span class='line'> Privacy
</span><span class='line'>
</span><span class='line'><span class="gd">-Because others may rely on your use of Your Certificate to encrypt Internet communications, much of the</span>
</span><span class='line'><span class="gi">+Because others may rely on your use of Your Certificates to encrypt Internet communications, much of the</span>
</span><span class='line'> information You send to ISRG will be published by ISRG and will become a matter of public record.
</span><span class='line'><span class="gd">-However, information used for account-recovery purposes (such as Your email address and telephone</span>
</span><span class='line'><span class="gd">-number) (“Private Recovery Information” or “PRI”) will NOT be published by ISRG. ISRG will not sell</span>
</span><span class='line'><span class="gd">-or share your Private Recovery Information. ISRG may disclose Private Recovery Information, however,</span>
</span><span class='line'><span class="gd">-if compelled to do so by court order or other compulsory legal process. If legally permissible and to the</span>
</span><span class='line'><span class="gd">-extent possible and within ISRG’s control, and if you have provided ISRG with an email address, ISRG</span>
</span><span class='line'><span class="gd">-will send an email to such address notifying You of the potential disclosure. ISRG may also disclose your</span>
</span><span class='line'><span class="gd">-PRI if ISRG believes disclosure is necessary to prevent loss of life, personal injury, damage to property, or</span>
</span><span class='line'><span class="gd">-significant financial harm.</span>
</span><span class='line'><span class="gi">+ISRG’s collection, storage, use and disclosure of such information are governed by the Let’s Encrypt</span>
</span><span class='line'><span class="gi">+Privacy Policy at: https://letsencrypt.org/privacy/.</span>
</span><span class='line'> 4.2
</span><span class='line'>
</span><span class='line'> Certificate Repository
</span><span class='line'>
</span><span class='line'><span class="gi">+Version 1.1.1</span>
</span><span class='line'><span class="gi">+August 1, 2016</span>
</span><span class='line'><span class="gi">+Page 5 of 7</span>
</span><span class='line'> During the term of the Agreement, ISRG will operate and maintain a secure online Repository that is
</span><span class='line'> available to authorized relying parties that contains: (i) all past and current Let’s Encrypt Certificates
</span><span class='line'> (including, as applicable, Your Certificate) and (ii) a CRL or similar online database indicating whether
</span><span class='line'><span class="gu">@@ -231,36 +249,36 @@ public to access this information.</span>
</span><span class='line'>
</span><span class='line'> Suspension and Revocation
</span><span class='line'>
</span><span class='line'><span class="gd">-ISRG may immediately suspend Your Certificate if any party notifies ISRG that Your Certificate is</span>
</span><span class='line'><span class="gd">-invalid or has been compromised. ISRG will determine, in its sole discretion, whether to revoke Your</span>
</span><span class='line'><span class="gd">-Certificate or restore it to valid status. If You or Your agent requests that Your Certificate be revoked,</span>
</span><span class='line'><span class="gd">-ISRG will revoke Your Certificate and update the Repository as soon as practical. If a request for</span>
</span><span class='line'><span class="gd">-revocation is signed by your Private Key, then ISRG will automatically deem the request to be valid.</span>
</span><span class='line'><span class="gd">-</span>
</span><span class='line'><span class="gd">-Version 1.0.1</span>
</span><span class='line'><span class="gd">-July 27, 2015</span>
</span><span class='line'><span class="gd">-Page 5 of 6</span>
</span><span class='line'><span class="gd">-ISRG may also, without advance notice, revoke Your Certificate if ISRG determines, in its sole discretion,</span>
</span><span class='line'><span class="gd">-that: (i) Your Certificate was not properly issued or was obtained through misrepresentation, concealment,</span>
</span><span class='line'><span class="gd">-or fraud; (ii) Your Certificate has become, or appears to have become, unreliable; (iii) the security of the</span>
</span><span class='line'><span class="gd">-Private Key corresponding to Your Certificate has been or may be stolen, lost, or otherwise compromised,</span>
</span><span class='line'><span class="gd">-or subject to unauthorized use; (iv) any information in Your registration with ISRG or Your request for a</span>
</span><span class='line'><span class="gd">-Let’s Encrypt Certificate has changed or has become false or misleading; (v) You have violated any</span>
</span><span class='line'><span class="gd">-applicable law, agreement or other obligation; (vi) You request revocation; (vii) ISRG is legally required to</span>
</span><span class='line'><span class="gd">-revoke Your Certificate pursuant to a valid court order issued by a court of competent jurisdiction; (viii)</span>
</span><span class='line'><span class="gd">-this Agreement has terminated; or (iv) there are other reasonable and lawful grounds for revocation. ISRG</span>
</span><span class='line'><span class="gd">-will provide notice of revocation via email to the email address of record.</span>
</span><span class='line'><span class="gi">+You acknowledge and accept that ISRG may immediately suspend Your Certificate if any party notifies</span>
</span><span class='line'><span class="gi">+ISRG that Your Certificate is invalid or has been compromised. ISRG will determine, in its sole discretion,</span>
</span><span class='line'><span class="gi">+whether to revoke Your Certificate. If You or Your agent requests that Your Certificate be revoked, ISRG</span>
</span><span class='line'><span class="gi">+will revoke Your Certificate and update the Repository as soon as practical. If a request for revocation is</span>
</span><span class='line'><span class="gi">+signed by your Private Key, then ISRG will automatically deem the request to be valid. You also</span>
</span><span class='line'><span class="gi">+acknowledge and accept that ISRG may, without advance notice, immediately revoke Your Certificate if</span>
</span><span class='line'><span class="gi">+ISRG determines, in its sole discretion, that: (i) Your Certificate was not properly issued or was obtained</span>
</span><span class='line'><span class="gi">+through misrepresentation, concealment, or fraud; (ii) Your Certificate has become, or appears to have</span>
</span><span class='line'><span class="gi">+become, unreliable; (iii) the security of the Private Key corresponding to Your Certificate has been or may</span>
</span><span class='line'><span class="gi">+be stolen, lost, or otherwise compromised, or subject to unauthorized use; (iv) any information in Your</span>
</span><span class='line'><span class="gi">+registration with ISRG or Your request for a Let’s Encrypt Certificate has changed or has become false or</span>
</span><span class='line'><span class="gi">+misleading; (v) You have violated any applicable law, agreement (including this Agreement), or other</span>
</span><span class='line'><span class="gi">+obligation; (vi) Your Certificate is being used, or has been used, to enable any criminal activity (such as</span>
</span><span class='line'><span class="gi">+phishing attacks, fraud or the distribution of malware); (vii) Your Certificate is being used, or has been</span>
</span><span class='line'><span class="gi">+used, to intercept the traffic of others; (viii) You request revocation; (ix) ISRG is legally required to revoke</span>
</span><span class='line'><span class="gi">+Your Certificate pursuant to a valid court order issued by a court of competent jurisdiction; (x) this</span>
</span><span class='line'><span class="gi">+Agreement has terminated; or (xi) there are other reasonable and lawful grounds for revocation. ISRG will</span>
</span><span class='line'><span class="gi">+provide notice of revocation via email to the email address of record.</span>
</span><span class='line'> 4.4
</span><span class='line'>
</span><span class='line'> IMPORTANT DISCLAIMER OF WARRANTIES AND LIMITATION OF
</span><span class='line'> LIABILITY
</span><span class='line'>
</span><span class='line'><span class="gd">-LET’S ENCRYPT CERTIFICATES AND SERVICES ARE PROVIDED “AS-IS.”</span>
</span><span class='line'><span class="gd">-ISRG DISCLAIMS ANY AND ALL WARRANTIES OF ANY TYPE, WHETHER EXPRESS</span>
</span><span class='line'><span class="gd">-OR IMPLIED, INCLUDING AND WITHOUT LIMITATION ANY IMPLIED WARRANTY OF</span>
</span><span class='line'><span class="gd">-TITLE, NON-INFRINGEMENT, MERCHANTABILITY, OR FITNESS FOR A PARTICULAR</span>
</span><span class='line'><span class="gd">-PURPOSE, IN CONNECTION WITH ANY ISRG SERVICE OR LET’S ENCRYPT</span>
</span><span class='line'><span class="gd">-CERTIFICATE.</span>
</span><span class='line'><span class="gi">+EXCEPT AS EXPRESSLY SET FORTH IN ISRG’S CERTIFICATE POLICY AND</span>
</span><span class='line'><span class="gi">+CERTIFICATE PRACTICE STATEMENT, LET’S ENCRYPT CERTIFICATES AND</span>
</span><span class='line'><span class="gi">+SERVICES ARE PROVIDED “AS-IS” AND ISRG DISCLAIMS ANY AND ALL</span>
</span><span class='line'><span class="gi">+WARRANTIES OF ANY TYPE, WHETHER EXPRESS OR IMPLIED, INCLUDING AND</span>
</span><span class='line'><span class="gi">+WITHOUT LIMITATION ANY IMPLIED WARRANTY OF TITLE, NON-INFRINGEMENT,</span>
</span><span class='line'><span class="gi">+MERCHANTABILITY, OR FITNESS FOR A PARTICULAR PURPOSE, IN CONNECTION</span>
</span><span class='line'><span class="gi">+WITH ANY ISRG SERVICE OR LET’S ENCRYPT CERTIFICATE.</span>
</span><span class='line'> BECAUSE LET’S ENCRYPT CERTIFICATES ARE ISSUED FREE-OF-CHARGE AS A PUBLIC
</span><span class='line'> SERVICE, ISRG CANNOT ACCEPT ANY LIABILITY FOR ANY LOSS, HARM, CLAIM, OR
</span><span class='line'> ATTORNEY’S FEES IN CONNECTION WITH SUCH CERTIFICATES. ACCORDINGLY, YOU
</span><span class='line'><span class="gu">@@ -275,6 +293,10 @@ REGULATION, COMMON LAW, OR ANY OTHER SOURCE OF LAW, STANDARD OF CARE,</span>
</span><span class='line'> CATEGORY OF CLAIM, NOTION OF FAULT OR RESPONSIBILITY, OR THEORY OF
</span><span class='line'> RECOVERY. THE PARTIES AGREE THAT THIS DISCLAIMER IS INTENDED TO BE
</span><span class='line'> CONSTRUED TO THE FULLEST EXTENT ALLOWED BY APPLICABLE LAW.
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+Version 1.1.1</span>
</span><span class='line'><span class="gi">+August 1, 2016</span>
</span><span class='line'><span class="gi">+Page 6 of 7</span>
</span><span class='line'> BY WAY OF FURTHER EXPLANATION REGARDING THE SCOPE OF THE DISCLAIMER,
</span><span class='line'> AND WITHOUT WAIVING OR LIMITING THE FOREGOING IN ANY WAY, ISRG DOES NOT
</span><span class='line'> MAKE, AND ISRG EXPRESSLY DISCLAIMS, ANY WARRANTY REGARDING ITS RIGHT TO
</span><span class='line'><span class="gu">@@ -297,9 +319,6 @@ choice of law and conflicts of law principles.</span>
</span><span class='line'>
</span><span class='line'> Choice of Forum
</span><span class='line'>
</span><span class='line'><span class="gd">-Version 1.0.1</span>
</span><span class='line'><span class="gd">-July 27, 2015</span>
</span><span class='line'><span class="gd">-Page 6 of 6</span>
</span><span class='line'> Any claim, suit or proceeding arising out of this Agreement must be brought in a state or federal court
</span><span class='line'> located in San Jose, California.
</span><span class='line'> 5.3
</span><span class='line'><span class="gu">@@ -339,6 +358,10 @@ If any provision of this Agreement is found to be invalid, unenforceable, or con</span>
</span><span class='line'> Agreement will be deemed amended by modifying such provision to the extent necessary to make it valid
</span><span class='line'> and enforceable while preserving its intent or, if that is not possible, by striking the provision and enforcing
</span><span class='line'> the remainder of this Agreement.
</span><span class='line'><span class="gi">+</span>
</span><span class='line'><span class="gi">+Version 1.1.1</span>
</span><span class='line'><span class="gi">+August 1, 2016</span>
</span><span class='line'><span class="gi">+Page 7 of 7</span>
</span><span class='line'> 5.8
</span><span class='line'>
</span><span class='line'> Authorization of ISRG to Send Emails
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[require './file'とrequire_relative 'file'の違い]]></title>
    <link href="http://blog.n-z.jp/blog/2016-07-26-require-relative.html"/>
    <updated>2016-07-26T21:16:07+09:00</updated>
    <id>http://blog.n-z.jp/blog/require-relative</id>
    <content type="html"><![CDATA[<p>最近 Debian の Perl が <code>CVE-2016-1238</code> (<a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=588017" title="#588017">#588017</a>) で更新されました。
似たような変更は Ruby だと <a href="https://www.ruby-lang.org/ja/news/2010/08/18/ruby-1-9-2-is-released/">1.9.2 から <code>.</code> が <code>$:</code> (<code>$LOAD_PATH</code>) から削除された</a>ということがありました。
そして、明記はされていませんが <code>require_relative</code> が推奨されるようになったようです。</p>

<!--more-->


<h2><code>require './file'</code> と <code>require_relative 'file'</code> の違い</h2>

<p><code>/var/tmp</code> と <code>/tmp</code> に確認用のファイルを以下のように準備して実行してみました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ head main.rb require.rb require_relative.rb /tmp/require.rb /tmp/require_relative.rb
</span><span class='line'>==&gt; main.rb &lt;==
</span><span class='line'>require './require'
</span><span class='line'>require_relative 'require_relative'
</span><span class='line'>
</span><span class='line'>==&gt; require.rb &lt;==
</span><span class='line'>p __FILE__
</span><span class='line'>
</span><span class='line'>==&gt; require_relative.rb &lt;==
</span><span class='line'>p __FILE__
</span><span class='line'>
</span><span class='line'>==&gt; /tmp/require.rb &lt;==
</span><span class='line'>p __FILE__
</span><span class='line'>
</span><span class='line'>==&gt; /tmp/require_relative.rb &lt;==
</span><span class='line'>p __FILE__
</span><span class='line'>$ ruby main.rb
</span><span class='line'>"/var/tmp/require.rb"
</span><span class='line'>"/var/tmp/require_relative.rb"
</span><span class='line'>$ cd /tmp
</span><span class='line'>$ ruby /var/tmp/main.rb
</span><span class='line'>"/tmp/require.rb"
</span><span class='line'>"/var/tmp/require_relative.rb"</span></code></pre></td></tr></table></div></figure>


<p>結果を見ればわかるように <code>require './file'</code> はカレントディレクトリがどこなのかの影響を受けます。</p>

<p>このような書き方を使っていると <code>$LOAD_PATH</code> から <code>.</code> が取り除かれていても (Windows の) DLL hijacking vulnerability のような脆弱性の原因になるため、
<code>require_relative</code> を使う方が望ましいということになります。</p>

<h2>require_relative の歴史</h2>

<p>いつから使えるようになったのか調べたので、ついでにメモしておきます。</p>

<ul>
<li>ruby 1.9.0-1 で <code>lib/require_relative.rb</code> が追加され、 <code>require 'require_relative'</code> すれば <code>require_relative</code> が使えるようになる。</li>
<li>ruby 1.9.0-2 で <code>lib/require_relative.rb</code> から <code>prelude.rb</code> (ruby 本体に組み込まれて実行開始時に自動実行されるファイル) に移動して <code>require 'require_relative'</code> なしで <code>require_relative</code> が使えるようになる。</li>
<li>ruby 1.9.2 で <code>doc/NEWS</code> に <code>Kernel#require_relative</code> が載る。 <code>require_relative</code> が <code>prelude.rb</code> から C 実装に置き換えられる。</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[letsencrypt の Rate Limit について]]></title>
    <link href="http://blog.n-z.jp/blog/2016-06-17-letsencrypt.html"/>
    <updated>2016-06-17T15:44:18+09:00</updated>
    <id>http://blog.n-z.jp/blog/letsencrypt</id>
    <content type="html"><![CDATA[<p><a href="http://www.clear-code.com/blog/2016/6/16.html" title="Let’s Encryptをcloudapp.azure.comで使おうとするときのハマりどころ">Let’s Encryptをcloudapp.azure.comで使おうとするときのハマりどころ</a>
という記事で Rate Limit の制限解除方法について誤解があるようなので、解説してみたいと思います。</p>

<!--more-->


<h2>Rate Limit について</h2>

<p><code>細かな制限はいろいろありますが、どうやら特定ドメインに対しては、週に20個のSSL/TLSサーバー証明書しか発行しないようです。そのため*.cloudapp.azure.comなどのように、皆がこぞってSSL/TLSサーバー証明書を取得しに行くような場合、見事に制限にひっかかってしまいます。</code>
と書いてありますが、これはその通りだと思います。</p>

<p><code>これを回避するには別途独自にドメインをとるなどしなければなりません。</code>
とありますが、 Dynamic DNS や IaaS などを利用している場合はプロバイダーに対応してもらうという方法があります。
また、その方が Cookie Monster と呼ばれる問題にも対処出来て望ましいと思います。</p>

<h2>適用例外について</h2>

<p><a href="https://github.com/certbot/certbot/issues/1607" title="DDNS Rate Limited">DDNS Rate Limited</a>
や
<a href="https://github.com/certbot/certbot/issues/2186" title="Too many certificates already issued for dynamic dns provider sub domain">Too many certificates already issued for dynamic dns provider sub domain</a>
のやりとりをみてもらえば詳細はわかるのですが、簡単に言うと</p>

<ul>
<li>プロバイダーに <a href="https://publicsuffix.org/">Public Suffix List</a> に登録してもらう</li>
<li><a href="https://github.com/letsencrypt/boulder">Let&rsquo;s Encrypt のサーバー</a> に反映してもらう</li>
</ul>


<p>ということになります。</p>

<h2>「正式版じゃなくてもいいから試してみたい」について</h2>

<p><code>certbot --help all</code> で出てくるヘルプにあるように <code>--test-cert</code> オプションか <code>--staging</code> オプションを使えば <code>/usr/lib/python2.7/dist-packages/certbot/constants.py</code> を書き換えるなどという方法をとらなくてもステージング環境の ACME サーバーを使えるようになります。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% certbot --help all
</span><span class='line'>(中略)
</span><span class='line'>testing:
</span><span class='line'>  The following flags are meant for testing purposes only! Do NOT change
</span><span class='line'>  them, unless you really know what you're doing!
</span><span class='line'>
</span><span class='line'>  --debug               Show tracebacks in case of errors, and allow
</span><span class='line'>                        letsencrypt-auto execution on experimental platforms
</span><span class='line'>                        (default: False)
</span><span class='line'>  --no-verify-ssl       Disable SSL certificate verification. (default: False)
</span><span class='line'>  --tls-sni-01-port TLS_SNI_01_PORT
</span><span class='line'>                        Port number to perform tls-sni-01 challenge. Boulder
</span><span class='line'>                        in testing mode defaults to 5001. (default: 443)
</span><span class='line'>  --http-01-port HTTP01_PORT
</span><span class='line'>                        Port used in the SimpleHttp challenge. (default: 80)
</span><span class='line'>  --break-my-certs      Be willing to replace or renew valid certs with
</span><span class='line'>                        invalid (testing/staging) certs (default: False)
</span><span class='line'>  --test-cert, --staging
</span><span class='line'>                        Use the staging server to obtain test (invalid) certs;
</span><span class='line'>                        equivalent to --server https://acme-
</span><span class='line'>                        staging.api.letsencrypt.org/directory (default: False)
</span><span class='line'>(後略)</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>Dynamic DNS や IaaS などを使っていて Rate Limit に引っかかった時の対処方法について説明しました。
また Cookie Monster と呼ばれる問題の影響についても少し触れました。</p>

<p>また、ステージング環境の ACME サーバーを使うのにソースを書き換えなくてもオプション指定で済むということを説明しました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[6月12日 APIデザインケーススタディ読書会 第1回に参加しました]]></title>
    <link href="http://blog.n-z.jp/blog/2016-06-12-amagasakirb.html"/>
    <updated>2016-06-12T12:55:16+09:00</updated>
    <id>http://blog.n-z.jp/blog/amagasakirb</id>
    <content type="html"><![CDATA[<p><a href="http://kokucheese.com/event/index/395115/" title="6月12日 APIデザインケーススタディ読書会 第1回">6月12日 APIデザインケーススタディ読書会 第1回</a>
に参加しました。
今回は第 1,2 章でした。</p>

<!--more-->




<div style="float:right">
<iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=znz-22&amp;o=9&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=4774178020" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>
</div>


<p>以下、今回のメモです。</p>

<ul>
<li>今回は本町駅近くでした。</li>
<li>ソケット関連のメソッド名の末尾につく <code>_in</code> は internet の in (unix socket などではないという意味)</li>
<li><code>gets</code>, <code>read</code>, <code>readpartial</code>, <code>read_nonblock</code> などを使い分けるユーザーはあんまりいなさそう</li>
<li>ネットワーク系の話から IRC とか net send とか msg.exe とか</li>
<li>ハッピーターンズの話、ハッピーパウダーを増量しているものがある話</li>
<li>Ruby の socket が便利になっている話</li>
<li>今の時代自分で直接ソケットプログラミングすることは少なそうという話</li>
<li>HULFT</li>
<li>全銀フォーマットの話</li>
<li>Encoding::IBM037 (alias ebcdic-cp-us; dummy) が ruby 2.3.0 から入っている話</li>
<li><code>recvmsg</code> と <code>sendmsg</code> の話</li>
<li>エコーネットとか独自規格のプロトコルを使うのには役に立つかも、という話</li>
<li><a href="https://github.com/SonyCSL/OpenECHO">https://github.com/SonyCSL/OpenECHO</a></li>
<li><code>PLC</code> は廃れてしまったという話</li>
<li>もっと良いタイトルがあったのではないかという話</li>
<li>懇親会も同じ場所という話</li>
<li><a href="https://rubykansai.doorkeeper.jp/events/46880" title="【発表者向け】 第73回 Ruby関西 勉強会 発表者募集">【発表者向け】 第73回 Ruby関西 勉強会 発表者募集</a> の話</li>
<li>寿司はダメな人がいるので、ピザが定番という話</li>
<li>会場提供者から <a href="https://sou-meetup.doorkeeper.jp/" title="SOU meetup">SOU meetup</a> などの話</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jessie の letsencrypt を certbot にあげてみた]]></title>
    <link href="http://blog.n-z.jp/blog/2016-05-30-letsencrypt-to-certbot-on-jessie.html"/>
    <updated>2016-05-30T21:20:43+09:00</updated>
    <id>http://blog.n-z.jp/blog/letsencrypt-to-certbot-on-jessie</id>
    <content type="html"><![CDATA[<p>Debian で <a href="https://packages.debian.org/letsencrypt">letsencrypt パッケージ</a>が <a href="https://packages.debian.org/certbot">certbot パッケージ</a>に変わって、
jessie-backports にも反映されたので、 certbot パッケージに入れ替えてみました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>Debian GNU/Linux 8.4 (jessie) (amd64)</li>
<li>letsencrypt 0.5.0-1~bpo8+1 から certbot 0.6.0-2~bpo8+1</li>
</ul>


<h2>アップグレード失敗</h2>

<p>普通に upgrade しようとすると以下のように失敗します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>%  sudo aptitude full-upgrade -DV
</span><span class='line'>以下のパッケージが更新されます:
</span><span class='line'>  python-acme{b} [0.5.0-1~bpo8+1 -&gt; 0.6.0-1~bpo8+1] (破: python-letsencrypt)
</span><span class='line'>更新: 1 個、新規インストール: 0 個、削除: 0 個、保留: 0 個。
</span><span class='line'>アーカイブ 54.6 k バイト中 0  バイトを取得する必要があります。展開後に 1,024  バイトのディスク領域が新たに消費されます。以下のパッケージには満たされていない依存関係があります:
</span><span class='line'> python-acme : 破壊: python-letsencrypt (&lt; 0.6.0) [0.5.0-1~bpo8+1 が既にインストール済みです]
</span><span class='line'>以下のアクションでこれらの依存関係の問題は解決されます:
</span><span class='line'>
</span><span class='line'>     以下のパッケージを削除する:
</span><span class='line'>1)     letsencrypt
</span><span class='line'>2)     python-letsencrypt
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>この解決方法を受け入れますか? [Y/n/q/?]q
</span><span class='line'>これらの依存関係の問題を解決するための努力をすべて放棄します。
</span><span class='line'>中断。
</span></code></pre></td></tr></table></div></figure>


<h2>certbot パッケージで入れ替え</h2>

<p>以下のように <code>certbot</code> パッケージをインストールすることで <code>letsencrypt</code> パッケージが削除されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% sudo aptitude install certbot
</span><span class='line'>以下の新規パッケージがインストールされます:
</span><span class='line'>  certbot{b} python-certbot{ab}
</span><span class='line'>以下のパッケージが更新されます:
</span><span class='line'>  python-acme{b}
</span><span class='line'>更新: 1 個、新規インストール: 2 個、削除: 0 個、保留: 0 個。
</span><span class='line'>アーカイブ 204 k バイト中 149 k バイトを取得する必要があります。展開後に 816 k バイトのディスク領域が新たに消費されます 。
</span><span class='line'>以下のパッケージには満たされていない依存関係があります:
</span><span class='line'> python-acme : 破壊: python-letsencrypt (&lt; 0.6.0) [0.5.0-1~bpo8+1 が既にインストール済みです]
</span><span class='line'> python-certbot : 破壊: python-letsencrypt [0.5.0-1~bpo8+1 が既にインストール済みです]
</span><span class='line'> certbot : 破壊: letsencrypt [0.5.0-1~bpo8+1 が既にインストール済みです]
</span><span class='line'>以下のアクションでこれらの依存関係の問題は解決されます:
</span><span class='line'>
</span><span class='line'>     以下のパッケージを削除する:
</span><span class='line'>1)     letsencrypt
</span><span class='line'>2)     python-letsencrypt
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>この解決方法を受け入れますか? [Y/n/q/?]
</span><span class='line'>以下の新規パッケージがインストールされます:
</span><span class='line'>  certbot python-certbot{a}
</span><span class='line'>以下のパッケージが削除されます:
</span><span class='line'>  letsencrypt{a} python-letsencrypt{a}
</span><span class='line'>以下のパッケージが更新されます:
</span><span class='line'>  python-acme
</span><span class='line'>更新: 1 個、新規インストール: 2 個、削除: 2 個、保留: 0 個。
</span><span class='line'>アーカイブ 204 k バイト中 149 k バイトを取得する必要があります。展開後に 14.3 k バイトのディスク領域が新たに消費されます。
</span><span class='line'>先に進みますか? [Y/n/?]
</span></code></pre></td></tr></table></div></figure>


<h2>自動更新設定確認</h2>

<p>インストール後に <code>etckeeper</code> の <code>commit</code> が発生して差分があるようだったので、
<code>sudo etckeeper vcs log -p --stat</code> で確認してみたところ、
<code>/etc/cron.d/certbot</code> ができていました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/cron.d/certbot b/cron.d/certbot</span>
</span><span class='line'>new file mode 100644
</span><span class='line'><span class="gh">index 0000000..9c3dc35</span>
</span><span class='line'><span class="gd">--- /dev/null</span>
</span><span class='line'><span class="gi">+++ b/cron.d/certbot</span>
</span><span class='line'><span class="gu">@@ -0,0 +1,6 @@</span>
</span><span class='line'><span class="gi">+# Upstream recommends attempting renewal twice a day</span>
</span><span class='line'><span class="gi">+#</span>
</span><span class='line'><span class="gi">+# Eventually, this will be an opportunity to validate certificates</span>
</span><span class='line'><span class="gi">+# haven&#39;t been revoked, etc.  Renewal will only occur if expiration</span>
</span><span class='line'><span class="gi">+# is within 30 days.</span>
</span><span class='line'><span class="gi">+* */12 * * * root perl -e &#39;sleep int(rand(3600))&#39;; certbot -q renew</span>
</span></code></pre></td></tr></table></div></figure>


<h2>自動更新設定変更</h2>

<p>自動更新はログを残しつつ、 apache の reload も行う自前のスクリプトを用意していたので、
そちらを引き続き使うことにして、 <code>/etc/cron.d/certbot</code> はコメントアウトして動かないようにしました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'>% sudo etckeeper vcs diff
</span><span class='line'><span class="gh">diff --git a/cron.d/certbot b/cron.d/certbot</span>
</span><span class='line'><span class="gh">index 9c3dc35..e81f9aa 100644</span>
</span><span class='line'><span class="gd">--- a/cron.d/certbot</span>
</span><span class='line'><span class="gi">+++ b/cron.d/certbot</span>
</span><span class='line'><span class="gu">@@ -3,4 +3,4 @@</span>
</span><span class='line'> # Eventually, this will be an opportunity to validate certificates
</span><span class='line'> # haven&#39;t been revoked, etc.  Renewal will only occur if expiration
</span><span class='line'> # is within 30 days.
</span><span class='line'><span class="gd">-* */12 * * * root perl -e &#39;sleep int(rand(3600))&#39;; certbot -q renew</span>
</span><span class='line'><span class="gi">+#* */12 * * * root perl -e &#39;sleep int(rand(3600))&#39;; certbot -q renew</span>
</span><span class='line'><span class="gh">diff --git a/cron.daily/local-letsencrypt b/cron.daily/local-letsencrypt</span>
</span><span class='line'><span class="gh">index 8b83e29..40a23ea 100755</span>
</span><span class='line'><span class="gd">--- a/cron.daily/local-letsencrypt</span>
</span><span class='line'><span class="gi">+++ b/cron.daily/local-letsencrypt</span>
</span><span class='line'><span class="gu">@@ -3,7 +3,7 @@ LOGFILE=/var/log/letsencrypt/renew.log</span>
</span><span class='line'> if [ -f &quot;$LOGFILE&quot; ]; then
</span><span class='line'>     savelog -c 90 -q &quot;$LOGFILE&quot;
</span><span class='line'> fi
</span><span class='line'><span class="gd">-if ! letsencrypt renew &gt; &quot;$LOGFILE&quot; 2&gt;&amp;1 ; then</span>
</span><span class='line'><span class="gi">+if ! certbot renew &gt; &quot;$LOGFILE&quot; 2&gt;&amp;1 ; then</span>
</span><span class='line'>     echo Automated renewal failed:
</span><span class='line'>     cat &quot;$LOGFILE&quot;
</span><span class='line'>     exit 1
</span></code></pre></td></tr></table></div></figure>


<h2>現状の自動更新スクリプト</h2>

<p>現状の自動更新スクリプト <code>/etc/cron.daily/local-letsencrypt</code> は以下のようにしています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="nv">LOGFILE</span><span class="o">=</span>/var/log/letsencrypt/renew.log
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>    savelog -c <span class="m">90</span> -q <span class="s2">&quot;$LOGFILE&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="k">if</span> ! certbot renew &gt; <span class="s2">&quot;$LOGFILE&quot;</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>    <span class="nb">echo </span>Automated renewal failed:
</span><span class='line'>    cat <span class="s2">&quot;$LOGFILE&quot;</span>
</span><span class='line'>    <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;$LOGFILE&quot;</span>.0 <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>    diff -u <span class="s2">&quot;$LOGFILE&quot;</span>.0 <span class="s2">&quot;$LOGFILE&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>apachectl graceful
</span></code></pre></td></tr></table></div></figure>


<p>以下のようなシンボリックリンクがあるので、 <code>letsencrypt renew</code> のままでも大丈夫そうでしたが、念のため変更しました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% ls -alF /usr/bin/letsencrypt
</span><span class='line'>lrwxrwxrwx 1 root root 7  5月 28 07:30 /usr/bin/letsencrypt -&gt; certbot*
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ubuntuで「ハッシュサムが適合しません」で backports のパッケージが入ってしまって大変だった]]></title>
    <link href="http://blog.n-z.jp/blog/2016-05-26-ubuntu-hash-mismatch.html"/>
    <updated>2016-05-26T22:23:35+09:00</updated>
    <id>http://blog.n-z.jp/blog/ubuntu-hash-mismatch</id>
    <content type="html"><![CDATA[<p><code>jp.archive.ubuntu.com</code> のミラーが不完全だったのか、「ハッシュサムが適合しません」という警告が出て、そのまま <code>sudo aptitude full-upgrade -DV</code> をしたら backports のパッケージが入ってしまって大変な思いをしたという話です。</p>

<!--more-->


<h2>環境</h2>

<ul>
<li>Ubuntu 14.04.4 LTS</li>
</ul>


<h2>警告</h2>

<p><code>sudo aptitude update</code> で以下のような警告とエラーが出ていました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>W: http://jp.archive.ubuntu.com/ubuntu/dists/trusty-updates/main/source/Sources を取得できませんでした: ハッシュサムが適合しません
</span><span class='line'>W: http://jp.archive.ubuntu.com/ubuntu/dists/trusty-updates/universe/source/Sources を取得できませんでした: ハッシュサムが適合しません
</span><span class='line'>W: http://jp.archive.ubuntu.com/ubuntu/dists/trusty-updates/main/binary-amd64/Packages を取得できませんでした: ハッシュ サムが適合しません
</span><span class='line'>W: http://jp.archive.ubuntu.com/ubuntu/dists/trusty-updates/universe/binary-amd64/Packages を取得できませんでした: ハッ シュサムが適合しません
</span><span class='line'>W: http://jp.archive.ubuntu.com/ubuntu/dists/trusty-updates/main/binary-i386/Packages を取得できませんでした: ハッシュサムが適合しません
</span><span class='line'>W: http://jp.archive.ubuntu.com/ubuntu/dists/trusty-updates/universe/binary-i386/Packages を取得できませんでした: ハッシュサムが適合しません
</span><span class='line'>E: 一部のインデックスファイルのダウンロードに失敗しました。無視されたか古いものを代わりに利用しています。
</span><span class='line'>E: パッケージキャッシュを再構築できませんでした</span></code></pre></td></tr></table></div></figure>


<h2>不用意なアップグレード</h2>

<p>あまり気にせず、セキュリティアップデートがあれば更新しておこうと思って、 <code>sudo aptitude full-upgrade -DV</code> を実行してみたところ、以下のパッケージが更新対象に上がりました。</p>

<p>証明書の設定で <code>SSLCertificateChainFile</code> が必要なくなる 2.4.8 をまたぐので、ちょっと危険な気はしましたが、個人のサーバーなので多少の停止時間は構わないだろうと思ってアップグレードしてしまいました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>以下のパッケージが更新されます:
</span><span class='line'>  apache2 [2.4.7-1ubuntu4.9 -&gt; 2.4.10-1ubuntu1.1~ubuntu14.04.1]
</span><span class='line'>  apache2-bin [2.4.7-1ubuntu4.9 -&gt; 2.4.10-1ubuntu1.1~ubuntu14.04.1]
</span><span class='line'>  apache2-data [2.4.7-1ubuntu4.9 -&gt; 2.4.10-1ubuntu1.1~ubuntu14.04.1]
</span><span class='line'>  apache2-dev [2.4.7-1ubuntu4.9 -&gt; 2.4.10-1ubuntu1.1~ubuntu14.04.1]
</span><span class='line'>  apache2-mpm-prefork [2.4.7-1ubuntu4.9 -&gt; 2.4.10-1ubuntu1.1~ubuntu14.04.1]
</span><span class='line'>  apache2-utils [2.4.7-1ubuntu4.9 -&gt; 2.4.10-1ubuntu1.1~ubuntu14.04.1]
</span><span class='line'>  libcgmanager0 [0.24-0ubuntu7.5 -&gt; 0.39-2ubuntu2~ubuntu14.04.1]</span></code></pre></td></tr></table></div></figure>


<h2>backports のパッケージだった</h2>

<p>ダウンロード中の URL を見て backports のパッケージが入ってしまっている、と気づいたのですが、手遅れで止める間もなく上がってしまいました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% apt-cache policy apache2
</span><span class='line'>apache2:
</span><span class='line'>  インストールされているバージョン: 2.4.7-1ubuntu4.9
</span><span class='line'>  候補:               2.4.10-1ubuntu1.1~ubuntu14.04.1
</span><span class='line'>  バージョンテーブル:
</span><span class='line'>     2.4.10-1ubuntu1.1~ubuntu14.04.1 0
</span><span class='line'>        100 http://jp.archive.ubuntu.com/ubuntu/ trusty-backports/main amd64 Packages
</span><span class='line'> *** 2.4.7-1ubuntu4.9 0
</span><span class='line'>        100 /var/lib/dpkg/status
</span><span class='line'>     2.4.7-1ubuntu4.5 0
</span><span class='line'>        500 http://security.ubuntu.com/ubuntu/ trusty-security/main amd64 Packages
</span><span class='line'>     2.4.7-1ubuntu4 0
</span><span class='line'>        500 http://jp.archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages</span></code></pre></td></tr></table></div></figure>


<h2>ダウングレード失敗</h2>

<p><code>/etc/apt/preferences</code> を設定してダウングレードすることにしました。</p>

<p>まず以下を試してみたところ、 <code>base-files</code> などを含む大量のパッケージがダウングレード対象になってしまったので中断しました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Package: *
</span><span class='line'>Pin: release a=trusty
</span><span class='line'>Pin-Priority: 1001</span></code></pre></td></tr></table></div></figure>


<p><code>apt-cache policy</code> で確認してみると、現在のバージョンのインストール候補がなくなっているのが原因の一つでした。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% apt-cache policy base-files
</span><span class='line'>base-files:
</span><span class='line'>  インストールされているバージョン: 7.2ubuntu5.4
</span><span class='line'>  候補:               7.2ubuntu5
</span><span class='line'>  バージョンテーブル:
</span><span class='line'> *** 7.2ubuntu5.4 0
</span><span class='line'>        100 /var/lib/dpkg/status
</span><span class='line'>     7.2ubuntu5 0
</span><span class='line'>       1001 http://ubuntutym.u-toyama.ac.jp/ubuntu/ trusty/main amd64 Packages</span></code></pre></td></tr></table></div></figure>


<p>そこで、 <code>/etc/apt/sources.list</code> の末尾に <code>archive.ubuntu.com</code> を一時的に追加することにしました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>deb http://archive.ubuntu.com/ubuntu/ trusty main restricted universe multiverse
</span><span class='line'>#deb-src http://archive.ubuntu.com/ubuntu/ trusty main restricted universe multiverse
</span><span class='line'>deb http://archive.ubuntu.com/ubuntu/ trusty-updates main restricted universe multiverse
</span><span class='line'>deb-src http://archive.ubuntu.com/ubuntu/ trusty-updates main restricted universe multiverse</span></code></pre></td></tr></table></div></figure>


<p>すると <code>trusty-updates</code> も出てきたのですが、 priority が 500 になって期待した値になっていませんでした。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% apt-cache policy base-files
</span><span class='line'>base-files:
</span><span class='line'>  インストールされているバージョン: 7.2ubuntu5.4
</span><span class='line'>  候補:               7.2ubuntu5
</span><span class='line'>  バージョンテーブル:
</span><span class='line'> *** 7.2ubuntu5.4 0
</span><span class='line'>        500 http://archive.ubuntu.com/ubuntu/ trusty-updates/main amd64 Packages
</span><span class='line'>        100 /var/lib/dpkg/status
</span><span class='line'>     7.2ubuntu5 0
</span><span class='line'>       1001 http://jp.archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages
</span><span class='line'>       1001 http://archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages</span></code></pre></td></tr></table></div></figure>


<p>次に <code>n=trusty</code> を試してみたところ、 <code>backports</code> も priority が 1001 になってしまってダウングレードできませんでした。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Package: *
</span><span class='line'>Pin: release n=trusty
</span><span class='line'>Pin-Priority: 1001</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% apt-cache policy base-files
</span><span class='line'>base-files:
</span><span class='line'>  インストールされているバージョン: 7.2ubuntu5.4
</span><span class='line'>  候補:               7.2ubuntu5.4
</span><span class='line'>  バージョンテーブル:
</span><span class='line'> *** 7.2ubuntu5.4 0
</span><span class='line'>       1001 http://archive.ubuntu.com/ubuntu/ trusty-updates/main amd64 Packages
</span><span class='line'>        100 /var/lib/dpkg/status
</span><span class='line'>     7.2ubuntu5 0
</span><span class='line'>       1001 http://jp.archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages
</span><span class='line'>       1001 http://archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages
</span><span class='line'>% apt-cache policy apache2
</span><span class='line'>apache2:
</span><span class='line'>  インストールされているバージョン: 2.4.10-1ubuntu1.1~ubuntu14.04.1
</span><span class='line'>  候補:               2.4.10-1ubuntu1.1~ubuntu14.04.1
</span><span class='line'>  バージョンテーブル:
</span><span class='line'> *** 2.4.10-1ubuntu1.1~ubuntu14.04.1 0
</span><span class='line'>       1001 http://jp.archive.ubuntu.com/ubuntu/ trusty-backports/main amd64 Packages
</span><span class='line'>        100 /var/lib/dpkg/status
</span><span class='line'>     2.4.7-1ubuntu4.9 0
</span><span class='line'>       1001 http://archive.ubuntu.com/ubuntu/ trusty-updates/main amd64 Packages
</span><span class='line'>     2.4.7-1ubuntu4.5 0
</span><span class='line'>       1001 http://security.ubuntu.com/ubuntu/ trusty-security/main amd64 Packages
</span><span class='line'>     2.4.7-1ubuntu4 0
</span><span class='line'>       1001 http://jp.archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages
</span><span class='line'>       1001 http://archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages</span></code></pre></td></tr></table></div></figure>


<h2>ダウングレード成功</h2>

<p>最終的に <code>a=trusty-updates</code> と <code>a=trusty-security</code> も追加することでダウングレードできました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Package: *
</span><span class='line'>Pin: release a=trusty
</span><span class='line'>Pin-Priority: 1001
</span><span class='line'>
</span><span class='line'>Package: *
</span><span class='line'>Pin: release a=trusty-updates
</span><span class='line'>Pin-Priority: 1001
</span><span class='line'>
</span><span class='line'>Package: *
</span><span class='line'>Pin: release a=trusty-security
</span><span class='line'>Pin-Priority: 1001</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% apt-cache policy apache2
</span><span class='line'>apache2:
</span><span class='line'>  インストールされているバージョン: 2.4.10-1ubuntu1.1~ubuntu14.04.1
</span><span class='line'>  候補:               2.4.7-1ubuntu4.9
</span><span class='line'>  バージョンテーブル:
</span><span class='line'> *** 2.4.10-1ubuntu1.1~ubuntu14.04.1 0
</span><span class='line'>        100 http://jp.archive.ubuntu.com/ubuntu/ trusty-backports/main amd64 Packages
</span><span class='line'>        100 /var/lib/dpkg/status
</span><span class='line'>     2.4.7-1ubuntu4.9 0
</span><span class='line'>       1001 http://archive.ubuntu.com/ubuntu/ trusty-updates/main amd64 Packages
</span><span class='line'>     2.4.7-1ubuntu4.5 0
</span><span class='line'>       1001 http://security.ubuntu.com/ubuntu/ trusty-security/main amd64 Packages
</span><span class='line'>     2.4.7-1ubuntu4 0
</span><span class='line'>       1001 http://jp.archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages
</span><span class='line'>       1001 http://archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages
</span><span class='line'>% apt-cache policy base-files
</span><span class='line'>base-files:
</span><span class='line'>  インストールされているバージョン: 7.2ubuntu5.4
</span><span class='line'>  候補:               7.2ubuntu5.4
</span><span class='line'>  バージョンテーブル:
</span><span class='line'> *** 7.2ubuntu5.4 0
</span><span class='line'>       1001 http://archive.ubuntu.com/ubuntu/ trusty-updates/main amd64 Packages
</span><span class='line'>        100 /var/lib/dpkg/status
</span><span class='line'>     7.2ubuntu5 0
</span><span class='line'>       1001 http://jp.archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages
</span><span class='line'>       1001 http://archive.ubuntu.com/ubuntu/ trusty/main amd64 Packages</span></code></pre></td></tr></table></div></figure>


<h2>backports のコメントアウト</h2>

<p>backports のパッケージは使っていなかったので、この後 backports の apt-line はコメントアウトしました。</p>

<h2>まとめ</h2>

<p><code>apt</code> の <code>update</code> に失敗した時はアップグレード対象のパッケージに注意しましょう。</p>

<p>ダウングレードする時は <code>apt_preferences(5)</code> の <code>Pin</code> 設定をうまく工夫しましょう。</p>

<p>backports のパッケージが不要なら backports の apt-line を追加するのは避けましょう。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[letsencrypt-auto が certbot-auto になった]]></title>
    <link href="http://blog.n-z.jp/blog/2016-05-13-letsencrypt-certbot.html"/>
    <updated>2016-05-13T23:40:09+09:00</updated>
    <id>http://blog.n-z.jp/blog/letsencrypt-certbot</id>
    <content type="html"><![CDATA[<p><a href="https://www.eff.org/deeplinks/2016/05/announcing-certbot-new-tls-robot">EFF の Let&rsquo;s Encrypt クライアントが Certbot になった</a>という話です。</p>

<!--more-->


<h2>経緯</h2>

<p><a href="https://letsencrypt.jp/usage/">Let&rsquo;s Encrypt の使い方</a> から引用しつつまとめます。</p>

<ul>
<li>2016年4月12日 に、Let&rsquo;s Encrypt の公開ベータプログラム（Public Beta Program）が終了し、正式サービスが開始されました。</li>
<li>この時点でベータがとれたのは Let&rsquo;s Encrypt のサービス側で <code>letsencrypt-auto</code> コマンドを含む github.com/letsencrypt/letsencrypt にあったクライアントはまだベータのままでした。</li>
<li>クライアントの 0.6.0 のリリースにあたり github.com/letsencrypt/letsencrypt は github.com/certbot/certbot に移動して Certbot に改名されました。</li>
<li><a href="https://www.eff.org/deeplinks/2016/05/announcing-certbot-new-tls-robot">Announcing Certbot: EFF&rsquo;s Client for Let&rsquo;s Encrypt</a> に書いてあるように Certbot もまだベータで、今年中に Certbot 1.0 のリリースが予定されているようです。</li>
</ul>


<p>改名されたのは EFF の Let&rsquo;s Encrypt クライアントだけでサービス自体は Let&rsquo;s Encrypt という名前のままです。</p>

<h2>その他の変更点</h2>

<p>インストール方法も <code>git clone</code> して <code>letsencrypt-auto</code> を実行する方法から、 <code>https://dl.eff.org/certbot-auto</code> をダウンロードして実行する方法に変わっています。</p>

<h2>インストール済み環境への影響</h2>

<p>インストール済み環境ではどうなるのかと思って、 <code>letsencrypt-auto --help</code> を実行してアップグレードさせてみたところ、以下のようになりました。</p>

<p>出力をよく見ると <code>sudo</code> のところで <code>CERTBOT_AUTO</code> という環境変数の指定が増えていて、 <code>letsencrypt-auto</code> コマンド自体はそのまま使えるようです。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% ~/letsencrypt/letsencrypt-auto --help
</span><span class='line'>Checking for new version...
</span><span class='line'>Upgrading letsencrypt-auto 0.5.0 to 0.6.0...
</span><span class='line'>Replacing letsencrypt-auto...
</span><span class='line'>   sudo cp -p /home/vpsuser/letsencrypt/letsencrypt-auto /tmp/user/1000/tmp.AiqGtrjioJ/letsencrypt-auto.permission-clone
</span><span class='line'>   sudo cp /tmp/user/1000/tmp.AiqGtrjioJ/letsencrypt-auto /tmp/user/1000/tmp.AiqGtrjioJ/letsencrypt-auto.permission-clone
</span><span class='line'>   sudo mv -f /tmp/user/1000/tmp.AiqGtrjioJ/letsencrypt-auto.permission-clone /home/vpsuser/letsencrypt/letsencrypt-auto
</span><span class='line'>Creating virtual environment...
</span><span class='line'>Installing Python packages...
</span><span class='line'>Installation succeeded.
</span><span class='line'>Requesting root privileges to run certbot...
</span><span class='line'>   sudo CERTBOT_AUTO=/home/vpsuser/letsencrypt/letsencrypt-auto /home/vpsuser/.local/share/letsencrypt/bin/letsencrypt --help
</span><span class='line'>
</span><span class='line'>  letsencrypt-auto [SUBCOMMAND] [options] [-d domain] [-d domain] ...
</span><span class='line'>
</span><span class='line'>Certbot can obtain and install HTTPS/TLS/SSL certificates.  By default,
</span><span class='line'>it will attempt to use a webserver both for obtaining and installing the
</span><span class='line'>cert. Major SUBCOMMANDS are:
</span><span class='line'>
</span><span class='line'>  (default) run        Obtain & install a cert in your current webserver
</span><span class='line'>  certonly             Obtain cert, but do not install it (aka "auth")
</span><span class='line'>  install              Install a previously obtained cert in a server
</span><span class='line'>  renew                Renew previously obtained certs that are near expiry
</span><span class='line'>  revoke               Revoke a previously obtained certificate
</span><span class='line'>  rollback             Rollback server configuration changes made during install
</span><span class='line'>  config_changes       Show changes made to server config during installation
</span><span class='line'>  plugins              Display information about installed plugins
</span><span class='line'>
</span><span class='line'>Choice of server plugins for obtaining and installing cert:
</span><span class='line'>
</span><span class='line'>  --apache          Use the Apache plugin for authentication & installation
</span><span class='line'>  --standalone      Run a standalone webserver for authentication
</span><span class='line'>  (nginx support is experimental, buggy, and not installed by default)
</span><span class='line'>  --webroot         Place files in a server's webroot folder for authentication
</span><span class='line'>
</span><span class='line'>OR use different plugins to obtain (authenticate) the cert and then install it:
</span><span class='line'>
</span><span class='line'>  --authenticator standalone --installer apache
</span><span class='line'>
</span><span class='line'>More detailed help:
</span><span class='line'>
</span><span class='line'>  -h, --help [topic]    print this message, or detailed help on a topic;
</span><span class='line'>                        the available topics are:
</span><span class='line'>
</span><span class='line'>   all, automation, paths, security, testing, or any of the subcommands or
</span><span class='line'>   plugins (certonly, install, nginx, apache, standalone, webroot, etc)</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第72回 Ruby関西 勉強会に参加しました]]></title>
    <link href="http://blog.n-z.jp/blog/2016-05-07-rubykansai72.html"/>
    <updated>2016-05-07T13:42:09+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubykansai72</id>
    <content type="html"><![CDATA[<p><a href="https://rubykansai.doorkeeper.jp/events/43253" title="第72回 Ruby関西 勉強会">第72回 Ruby関西 勉強会</a>
に参加しました。
アプローズタワーというビルに入るのは初めてだったので、どこから上に上がるのか、ちょっとわかりにくかったです。</p>

<!--more-->


<p>以下、そのメモです。</p>

<h2>オープニング</h2>

<ul>
<li>会場説明</li>
<li>懇親会は事前に企画していなかったので 15 時ぐらいまでに受付で募集してその状況次第で決定</li>
<li>スポンサーセッション (西谷さん)</li>
</ul>


<h2>低レイヤから考えるrubyプログラミング</h2>

<ul>
<li>よしだあつしさん</li>
<li>自己紹介は時間がないので省略して後で</li>
<li>メモリ上のクラスやオブジェクト</li>
<li>RClass 構造体や RObject 構造体などの説明</li>
<li>ruby のメモリ利用の例</li>
<li>メソッド呼び出し</li>
<li>下のレイヤーを勉強すると理解が深まる</li>
<li>時間があったので自己紹介</li>
<li><a href="https://twitter.com/yalab">https://twitter.com/yalab</a></li>
<li><a href="http://shop.oke-ya.com/">http://shop.oke-ya.com/</a></li>
<li><a href="https://www.makuake.com/project/oke-ya/">https://www.makuake.com/project/oke-ya/</a></li>
<li><a href="https://github.com/yalab">https://github.com/yalab</a></li>
<li><a href="http://www.slideshare.net/yalab/ruby-61765227">低レイヤから見たrubyプログラミング</a></li>
</ul>


<h2>Wakayama.rb発のmrubyボード「GR-CITRUS」の使い方</h2>

<ul>
<li>Wakayama.rb のたろサさん</li>
<li>今は Mac や Windows 8, 10 で動かないので Windows 7 でしか動かない状態 (シリアルのドライバーの問題)</li>
<li>Wakayama.rb の活動報告</li>
<li>GR-CITRUS</li>
<li>ピンク色の基盤</li>
<li>GR = がじぇっとるねさす</li>
<li>CITRUS (シトラス) = 和歌山っぽい名前</li>
<li>秋月電子通商販売予定 (8 月)</li>
<li>GR-CITRUS の使い方</li>
<li><a href="https://github.com/wakayamarb/wrbb-v2lib-firm">https://github.com/wakayamarb/wrbb-v2lib-firm</a></li>
<li>firmware/citrus_sketch.bin を書き込む</li>
<li>開発環境 Rubic</li>
<li>chrome アプリなので簡単インストール</li>
<li>GR-CITRUS のライブラリ紹介</li>
<li>動作デモ</li>
<li><a href="http://www.slideshare.net/MinaoYamamoto/grcitrusruby">GR-CITRUS搭載のRubyファームウェアの説明</a></li>
<li>WA-MIKAN (みかんボード)</li>
<li>WiFi 通信ボード</li>
<li>Linux では動くかどうか試してないのでわからない</li>
</ul>


<h2>休憩</h2>

<ul>
<li><a href="http://railsgirls.com/osaka">Rails Girls Osaka #3</a> 2016年6月18日-19日</li>
<li><a href="http://rubykaigi.org/2016">RubyKaigi 2016</a> 2016年9月8日(木)-10日(土)</li>
</ul>


<h2>今すぐRailsアプリを多言語化してみよう</h2>

<ul>
<li><a href="https://twitter.com/youcune">https://twitter.com/youcune</a></li>
<li><a href="https://youcune.com/">https://youcune.com/</a></li>
<li><a href="http://yurie.sexy">http://yurie.sexy</a></li>
<li><a href="http://ur3.jp/yurie-blog">http://ur3.jp/yurie-blog</a></li>
<li><a href="https://speakerdeck.com/youcune/i18n-your-rails-application">いますぐRailsアプリを英語化してみよう / i18n your Rails application</a></li>
</ul>


<h2>Ruby on Rails もくもく会をほぼ毎週開催してきてわかった事</h2>

<ul>
<li>八木さん</li>
<li>もくもく会開催の経緯</li>
<li>感じたこと</li>
<li>起こったこと</li>
<li>みんなピザが好き</li>
<li>今後やっていきたいこと</li>
<li>なぜ?</li>
<li><a href="https://sou-meetup.doorkeeper.jp/">https://sou-meetup.doorkeeper.jp/</a></li>
</ul>


<h2>Github Pages で独自ドメインのサイトを作る</h2>

<ul>
<li>HDMI で接続できなかったので画面を OHP でうつして表示</li>
<li><a href="https://twitter.com/107steps">https://twitter.com/107steps</a></li>
<li><a href="https://ruby-maizuru.doorkeeper.jp/">Ruby舞鶴</a></li>
<li>Jekyll</li>
<li><a href="https://pages.github.com/">GitHub Pages</a></li>
<li>Google Analytics</li>
<li><a href="https://github.com/masoo/masoo.jp/blob/master/_config.yml#L8"><code>_config.yml</code></a> に変数を作り true の時だけ<a href="https://github.com/masoo/masoo.jp/blob/master/_includes/google_analytics.html">有効にした</a></li>
<li>Cloudflare の導入</li>
<li><a href="https://gtmetrix.com/">https://gtmetrix.com/</a> で B 判定が A 判定に</li>
<li>https 導入</li>
<li>Cloudflare で <a href="https://support.cloudflare.com/hc/en-us/articles/200170416-What-do-the-SSL-options-mean-">flexible SSL</a></li>
<li>Accelerated Mobile Page の対応 (失敗)</li>
<li><a href="https://github.com/juusaw/amp-jekyll">https://github.com/juusaw/amp-jekyll</a></li>
<li><a href="https://jekyllrb.com/docs/plugins/">https://jekyllrb.com/docs/plugins/</a></li>
<li><a href="http://gosyujin.github.io/2013/05/21/jekyll-plugin-githubpages/">GitHub PagesでJekyllプラグインを使えるようにするには…</a></li>
<li><a href="http://107steps.la.coocan.jp/">http://107steps.la.coocan.jp/</a></li>
<li>質疑応答</li>
<li>jekyll の <code>--config</code> オプションで <code>_config.yml</code> の設定を上書き設定できるのを使うのが良いのでは。</li>
<li>jekyll, middleman, Hugo などがある中で jekyll を選んだ理由は?</li>
<li>最初に見かけたのが jekyll だったから</li>
<li>発表資料: <a href="http://www.slideshare.net/107steps/github-pages-61765408">Github pagesで独自ドメインのサイトを作る</a></li>
</ul>


<h2>関西Rubyコミュニティー紹介</h2>

<ul>
<li><a href="https://twitter.com/ogomr">ogomr さん</a></li>
<li><a href="http://rubykansai.github.io/kansai-ruby-community/" title="関西 Ruby コミュニティー 紹介">関西 Ruby コミュニティー 紹介</a></li>
<li><a href="https://github.com/ruby-no-kai/official/wiki/RegionalRubyistMeetUp" title="地域Rubyの会">地域Rubyの会</a></li>
</ul>


<h2>Ruby 初級者向けレッスン - 文字列</h2>

<ul>
<li><a href="https://github.com/higaki/learn_ruby_kansai_72">https://github.com/higaki/learn_ruby_kansai_72</a></li>
</ul>


<h2>クロージング</h2>

<ul>
<li><a href="http://railsgirls.com/osaka">Rails Girls Osaka #3</a> 2016年6月18日-19日</li>
<li><a href="http://rubykaigi.org/2016">RubyKaigi 2016</a> 2016年9月8日(木)-10日(土)</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LILO&東海道らぐオフラインミーティング 2016/05/01 に参加しました]]></title>
    <link href="http://blog.n-z.jp/blog/2016-05-01-lilo-tokaidolug.html"/>
    <updated>2016-05-01T13:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/lilo-tokaidolug</id>
    <content type="html"><![CDATA[<p><a href="https://lilo.doorkeeper.jp/events/42910" title="LILO&amp;東海道らぐオフラインミーティング 2016/05/01">LILO&amp;東海道らぐオフラインミーティング 2016/05/01</a>
に参加しました。</p>

<p>今回もアンカンファレンス形式でした。</p>

<!--more-->


<h2>メモ</h2>

<p>今回のメモです。</p>

<ul>
<li>いつものように鍵担当の人が遅れていた</li>
<li>ハッシュタグ: <code>#lilo_jp</code> <code>#東海道らぐ</code></li>
<li>登録参加者数 13名</li>
<li>自己紹介から</li>
<li>はしもとさん : 東海道らぐともうひとつの東海道</li>
<li>東海道らぐ 今年で 5 周年目突入</li>
<li>インプットメソッドの話</li>
<li><a href="https://github.com/tkd53">https://github.com/tkd53</a></li>
<li>Genji も方向性が違うので続けるという話</li>
<li>自分の発表</li>
<li>休憩</li>
<li>Kapperさん : シンガポールFossasia2016に初参加してみた</li>
<li>あひる焼き先進国</li>
<li>シンガポール英語とインド英語</li>
<li>マニアックな話が多かった</li>
<li>アンカンファレンス形式は海外ではメジャー</li>
<li>3月はチケット代が高い</li>
<li>京橋ひよわさん : 自宅サーバのトラブルを楽しもう</li>
<li><a href="http://hiyowa.com/">http://hiyowa.com/</a></li>
<li><code>SSLCertificateChainFile</code> がなくなっていたはまった話で nginx は単純に cat で中間証明書を結合すればいけるが apache はダメらしい <a href="http://serverfault.com/questions/588986/sslcertificatechainfile-deprecation-warning-on-apache-2-4-8">http://serverfault.com/questions/588986/sslcertificatechainfile-deprecation-warning-on-apache-2-4-8</a></li>
<li>owncloud はエラー表示が親切</li>
<li>こんどうさん : やりなおし方について</li>
<li>デュアルブートを諦めれば楽</li>
<li>fdisk /mbr とか fixmbr とか</li>
<li>EaseUS Todo Backup で D2D Backup</li>
<li>Windows 10 が勝手にアップグレードする話</li>
<li>UEFI だと ESP パーティションをマウントして Linux のブート情報を消すだけ</li>
<li>おくのさん : 格安モバイルノート PC で Linux</li>
<li>hp Stream 11-d000 の 2 代目モデル</li>
<li>hp Stream 11-r000</li>
<li>Wi-Fi がカニから Intel</li>
<li>Linux Mint 17.3 は Wi-Fi が新しすぎて対応していなかったのでアップグレードが必要だった</li>
<li>Lubuntu 16.04 だと問題なく動いた</li>
<li>DELL New Inspiron 11 3000 シリーズの方が良さそうだったというオチ</li>
<li>休憩</li>
<li>しまださん : このごろの状況</li>
<li>opencocon v9i</li>
<li>Libretto L1 の CD ブート対応</li>
<li>ビルド時間 3 時間の半分は WebKit</li>
<li>opencocon v10</li>
<li>Linux 4.4</li>
<li>uClibc から musl libc に変更</li>
<li>musl libc を採用しているディストリ</li>
<li>標準採用 : Alpine Linux</li>
<li>選択可能 : Gentoo, Buildroot, OpenEmbedded, などなど</li>
<li>ext4 に正式対応</li>
<li>grub-legacy も Arch Linux のパッチで対応</li>
<li>Dynabook AZ + Linux 3.18 〜 を公式サポートする唯一のディストリビューションになる予定</li>
<li>AZ はシンクライアント用途にしてはちょっと高速すぎる?</li>
<li>デスクトップでもいいぐらい</li>
<li>v10 から名前に thinclient が入って opencocon thinclient v10 になる</li>
<li>Allwinner タブレットの話</li>
<li>さとうさん</li>
<li><code>sleep 300; poweroff</code> を実行してから開始</li>
<li>タイムラプス</li>
<li>赤外線カメラと通常のカメラを並べてくっつけて同時に撮影</li>
<li>raspistill で撮影</li>
<li>mencoder で jpg から動画に変換</li>
<li>動画表示デモ</li>
<li>ききょうさん : openSUSE で bot を作ろう</li>
<li>鹿焼き</li>
<li>BotBuilder/Connector/Directly</li>
<li>LILO&amp;東海道らぐの次回は 8 月 (お盆) ぐらいの予定</li>
</ul>


<h2>発表した内容</h2>

<p>このオフラインミーティングのネタのためも兼ねて、 lilo.linux.or.jp のサーバーを wheezy から jessie にあげたので、その話をしました。</p>

<p>内容は大きく分けると jessie にあげた話、二要素認証を導入した話、 letsencrypt の証明書を導入した話でした。</p>

<p>スライドはいつも通り <a href="http://slide.rabbit-shocker.org/authors/znz/lilo-20160501/">Rabbit Slide Show</a> (<a href="https://rubygems.org/gems/rabbit-slide-znz-lilo-20160501">RubyGems</a>), <a href="http://www.slideshare.net/znzjp/lilo-20160501">SlideShare</a>, <a href="https://speakerdeck.com/znz/lilo-dot-linux-dot-or-dot-jp-from-wheezy-to-jessie">Speaker Deck</a> にあげています。</p>

<iframe src="http://slide.rabbit-shocker.org/authors/znz/lilo-20160501/viewer.html"
        width="640" height="524"
        frameborder="0"
        marginwidth="0"
        marginheight="0"
        scrolling="no"
        style="border: 1px solid #ccc; border-width: 1px 1px 0; margin-bottom: 5px"
        allowfullscreen> </iframe>


<div style="margin-bottom: 5px">
  <a href="http://slide.rabbit-shocker.org/authors/znz/lilo-20160501/" title="lilo.linux.or.jp を wheezy から jessie にあげた話">lilo.linux.or.jp を wheezy から jessie にあげた話</a>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[wheezy から jessie にあげたら mailman でエラーが起きていた]]></title>
    <link href="http://blog.n-z.jp/blog/2016-04-30-mailman-error.html"/>
    <updated>2016-04-30T23:52:04+09:00</updated>
    <id>http://blog.n-z.jp/blog/mailman-error</id>
    <content type="html"><![CDATA[<p>wheezy から jessie にあげた VPS の環境のうちの 1 個で mailman を使っていたのですが、ちゃんと確認していなかったらエラーが起きてちゃんとメールが配送されていなかったので、修正しました。</p>

<!--more-->


<h2>環境</h2>

<ul>
<li>Debian GNU/Linux amd64 の wheezy から jessie にあげた環境</li>
<li><a href="http://packages.debian.org/mailman">mailman</a> 1:2.1.15-1+deb7u1 から 1:2.1.18-2</li>
</ul>


<h2>エラーの内容</h2>

<p><code>/var/log/mailman/error</code> を見ると以下のようなエラーが出てメールの配送がされていませんでした。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Apr 30 17:02:36 2016 (17947) Uncaught runner exception: 'utf8' codec can't decode byte 0xcb in position 5: invalid conti
</span><span class='line'>nuation byte
</span><span class='line'>Apr 30 17:02:36 2016 (17947) Traceback (most recent call last):
</span><span class='line'>  File "/var/lib/mailman/Mailman/Queue/Runner.py", line 119, in _oneloop
</span><span class='line'>    self._onefile(msg, msgdata)
</span><span class='line'>  File "/var/lib/mailman/Mailman/Queue/Runner.py", line 190, in _onefile
</span><span class='line'>    keepqueued = self._dispose(mlist, msg, msgdata)
</span><span class='line'>  File "/var/lib/mailman/Mailman/Queue/IncomingRunner.py", line 130, in _dispose
</span><span class='line'>    more = self._dopipeline(mlist, msg, msgdata, pipeline)
</span><span class='line'>  File "/var/lib/mailman/Mailman/Queue/IncomingRunner.py", line 153, in _dopipeline
</span><span class='line'>    sys.modules[modname].process(mlist, msg, msgdata)
</span><span class='line'>  File "/var/lib/mailman/Mailman/Handlers/CookHeaders.py", line 179, in process
</span><span class='line'>    i18ndesc = uheader(mlist, mlist.description, 'Reply-To')
</span><span class='line'>  File "/var/lib/mailman/Mailman/Handlers/CookHeaders.py", line 65, in uheader
</span><span class='line'>    return Header(s, charset, maxlinelen, header_name, continuation_ws)
</span><span class='line'>  File "/usr/lib/python2.7/email/header.py", line 183, in __init__
</span><span class='line'>    self.append(s, charset, errors)
</span><span class='line'>  File "/usr/lib/python2.7/email/header.py", line 267, in append
</span><span class='line'>    ustr = unicode(s, incodec, errors)
</span><span class='line'>UnicodeDecodeError: 'utf8' codec can't decode byte 0xcb in position 5: invalid continuation byte
</span><span class='line'>
</span><span class='line'>Apr 30 17:02:36 2016 (17947) SHUNTING: 1462003356.244866+ea73a2d0f0636f691f515c4b199b5e8c21436142</span></code></pre></td></tr></table></div></figure>


<h2>調査</h2>

<p>エラーメッセージで適当に切り出していろいろ検索してみたところ、
<a href="https://bugs.launchpad.net/mailman/+bug/1462755">qrunner crashes on invalid unicode sequence</a>
と同じ現象だとわかりました。</p>

<p>コメントにあるように調査してみたところ、確かに description に問題がありそうでした。
Web の設定画面で見てみると info も化けていたので、元の設定を調査するために <code>withlist</code> の環境で表示しておきました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># withlist lilo
</span><span class='line'>lilo のリストを読み込中 (ロック解除)
</span><span class='line'>変数 `m' が lilo の MailList インスタンスです
</span><span class='line'>&gt;&gt;&gt; m.preferred_language
</span><span class='line'>'ja'
</span><span class='line'>&gt;&gt;&gt; m.description
</span><span class='line'>'LILO \xcb\xdc\xc2\xceML'
</span><span class='line'>&gt;&gt;&gt; m.info
</span><span class='line'>'LILO ( \xa4\xea\xa4\xed : Linux Install Learning Osaka ) \xa4\xcf\xb4\xd8\xc0\xbe\xa4\xce Linux \xa5\xe6\xa1\xbc\xa5\xb6\xb2\xf1\xa4\xc7\xa4\xb9\xa1\xa3 \xbc\xe7\xa4\xcb\xb4\xd8\xc0\xbe\xa4\xce Linux \xa5\xe6\xa1\xbc\xa5\xb6\xa4\xce\xb8\xf2\xce\xae\xa1\xa2\xbe\xf0\xca\xf3\xb8\xf2\xb4\xb9\xa4\xce\xbe\xec\xa4\xf2\xc4\xf3\xb6\xa1\xa4\xb9\xa4\xeb\xa4\xbf\xa4\xe1\xa4\xcb\xb3\xe8\xc6\xb0\xa4\xb7\xa4\xc6\xa4\xa4\xa4\xde\xa4\xb9\xa1\xa3'
</span><span class='line'>&gt;&gt;&gt;
</span><span class='line'>最終処理中
</span><span class='line'>#</span></code></pre></td></tr></table></div></figure>


<h2>変換</h2>

<p>何でも良かったのですが、使い慣れているという理由で ruby の nkf で変換しました。
変換した結果を Web の設定画面から設定し直しました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% rbenv exec irb -r irb/completion --simple-prompt
</span><span class='line'>&gt;&gt; require 'nkf'
</span><span class='line'>=&gt; true
</span><span class='line'>&gt;&gt; NKF.nkf('-w',"LILO \xcb\xdc\xc2\xceML")
</span><span class='line'>=&gt; "LILO 本体ML"
</span><span class='line'>&gt;&gt; NKF.nkf('-w',"'LILO ( \xa4\xea\xa4\xed : Linux Install Learning Osaka ) \xa4\xcf\xb4\xd8\xc0\xbe\xa4\xce Linux \xa5\xe6\xa1\xbc\xa5\xb6\xb2\xf1\xa4\xc7\xa4\xb9\xa1\xa3 \xbc\xe7\xa4\xcb\xb4\xd8\xc0\xbe\xa4\xce Linux \xa5\xe6\xa1\xbc\xa5\xb6\xa4\xce\xb8\xf2\xce\xae\xa1\xa2\xbe\xf0\xca\xf3\xb8\xf2\xb4\xb9\xa4\xce\xbe\xec\xa4\xf2\xc4\xf3\xb6\xa1\xa4\xb9\xa4\xeb\xa4\xbf\xa4\xe1\xa4\xcb\xb3\xe8\xc6\xb0\xa4\xb7\xa4\xc6\xa4\xa4\xa4\xde\xa4\xb9\xa1\xa3'")
</span><span class='line'>=&gt; "'LILO ( りろ : Linux Install Learning Osaka ) は関西の Linux ユーザ会です。 主に関西の Linux ユーザの交流、情報交換 の場を提供するために活動しています。'"
</span><span class='line'>&gt;&gt;</span></code></pre></td></tr></table></div></figure>


<h2>失敗したメールの再配送</h2>

<p>設定し直した後、しばらく待ってみても再配送はされなかったので、メールキューの強制再実行が必要かと思って、 <code>/var/lib/mailman</code> 以下を調べてみたところ、 <code>/var/lib/mailman/qfiles/shunt/</code> の中にファイルが溜まっていることがわかりました。</p>

<p>さらに調べていて見つけた
<a href="http://docs.python.jp/contrib/mailman/siteadmin.html#unshunt">http://docs.python.jp/contrib/mailman/siteadmin.html#unshunt</a>
によると qrunner が処理中にエラーを発生させて処理できなかったメールは <code>&lt;prefix&gt;/qfiles/shunt</code> に保存されていて、<code>unshunt</code> コマンドで処理できるらしいということなので、試してみたところ、ちゃんと溜まっていたメールが配送されました。</p>

<h2>NEWS.Debian 確認</h2>

<p>復旧を優先して、ちゃんと見るのを忘れていたのですが、 <code>/usr/share/doc/mailman/NEWS.Debian.gz</code> によると <code>mailman (1:2.1.16-1exp1)</code> で UTF-8 化したから description を webinterface などから設定しなおせと書いてありました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mailman (1:2.1.16-1exp1) experimental; urgency=low
</span><span class='line'>
</span><span class='line'>  This version has changed the encoding of most strings, templates
</span><span class='line'>  and pages to UTF-8 to meet the Debian release goal of full UTF-8
</span><span class='line'>  support in all packages. It also no longer automatically converts
</span><span class='line'>  mails to ISO-8859-1.
</span><span class='line'>
</span><span class='line'>  If you have been using any nōn-ASCII strings in places such as
</span><span class='line'>  the mailing list description, these were be stored wrongly in the
</span><span class='line'>  list configuration file (config.pck), so you will need to change
</span><span class='line'>  those (e.g. via the webinterface) again in order to have them be
</span><span class='line'>  displayed correctly.
</span><span class='line'>
</span><span class='line'> -- Thorsten Glaser &lt;tg@mirbsd.de&gt;  Sun, 29 Dec 2013 14:35:50 +0000</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>mailman が UTF-8 対応で description や info などに日本語などの ASCII 以外の文字を使っているとエラーが起きるという話でした。</p>

<p>実行例で気付いた人もいると思いますが、 lilo.linux.or.jp のサーバーでの話で、他にも管理用の ML などがあるのですが、それらは description や info が空だったので問題が起きていなかったようです。</p>

<p>教訓としては、急いでいても apt-listchanges で最低限 NEWS だけはちゃんと読むようにした方が良いということでした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[KOF勉強会(今回のテーマ：ネットワーク)に参加しました]]></title>
    <link href="http://blog.n-z.jp/blog/2016-04-30-kof.html"/>
    <updated>2016-04-30T13:38:16+09:00</updated>
    <id>http://blog.n-z.jp/blog/kof</id>
    <content type="html"><![CDATA[<p><a href="https://atnd.org/events/75591" title="KOF勉強会(今回のテーマ：ネットワーク) #KOF勉強会 #さくらクラブ">KOF勉強会(今回のテーマ：ネットワーク) #KOF勉強会 #さくらクラブ</a>
に参加しました。</p>

<!--more-->


<p>以下、今回のメモです。</p>

<h2>会場案内、全体説明</h2>

<ul>
<li>今回も会場無線 LAN がありました。</li>
<li>今回は 14:00-17:00</li>
<li>今年の KOF は 11/11(金)-12(土)</li>
<li><a href="https://twitter.com/KansaiOpenForum" title="@KansaiOpenForum">@KansaiOpenForum</a></li>
<li>今後の予定</li>
<li>6/4(土) Redmine, Drupal</li>
<li>7/18(月祝) 未定</li>
<li>8/6(土) 未定</li>
<li>9/22(木祝) 未定</li>
<li>10/8(土) and/or 10/22(土) 未定</li>
</ul>


<h2>KOFとは</h2>

<ul>
<li>重要な話は飲み屋で決まる</li>
<li>問題点は会場、お金、人</li>
<li>最初は Kansai Opensource and Freeware</li>
<li>Freeware という言葉が問題になった</li>
<li>今は Kansai Open Forum</li>
<li>OSS と IT コミュニティ</li>
<li>広い意味での IT コミュニティ</li>
<li>IT コミュニティの甲子園</li>
<li>録音していた内容は VOD として公開される</li>
<li>(例として紹介された VOD は <a href="http://www.tezuka-gu.ac.jp/faculty/information_media/">http://www.tezuka-gu.ac.jp/faculty/information_media/</a> だったので、たぶんここで公開されると思います)</li>
</ul>


<h2>KOF2015会場ネットワークのできるまで</h2>

<ul>
<li>京都女子大学や学部の紹介</li>
<li>Cisco Networking Academy</li>
<li>実機演習の前の Packet Tracer のデモ</li>
<li>KOF のネットワークの担当は今が 6 代目</li>
<li>KOF での話</li>
<li>RSTP で冗長化</li>
<li>Cisco Network Assistant</li>
</ul>


<h2>NSCの取り組みご紹介と、ネットワーク運用から得られた知見</h2>

<ul>
<li>参加者向けには後で資料を配布するのでメモなどに気を取られずにしっかり話を聞くようにという話があったので、あまりメモは取っていません。</li>
<li><a href="http://www.nsc.gr.jp/">http://www.nsc.gr.jp/</a></li>
<li>Network Skills Competition → Network Skills Community</li>
</ul>


<h2>フリーディスカッション</h2>

<ul>
<li>無線 LAN を提供しても安定しない</li>
<li>安定して会場ネットワークが提供されると自発的に無線ルーターを切ってくれる</li>
<li>できるだけ 5G</li>
<li>8:2 で 2.4G が使われる</li>
<li>出展者向けには必要だとしても、参加者向けは必要か?</li>
<li>勉強会とかハンズオンとかのイベントの種類によって違ってくる</li>
<li>OS アップデートとか iTunes とか Dropbox とか制限しないとつらい</li>
<li>みんな 443 番ポートなのでアプリケーションレベルでの挙動を理解する必要がある</li>
<li>アクセスポイントの乱立をさけるための参加者向け無線 LAN 提供</li>
<li>ベンダーに頼むと繋がらない時に文句を言う先ができるので精神衛生上は良い</li>
<li>出展者が無線機器を展示している場合に会場ネットワークが強すぎると問題が出る</li>
<li>Twitter 連動とかやってる時に参加者向けネットワークを提供していないと問題</li>
<li>出展者にネットワークが繋がらなくてもなんとかなるような展示をしてくださいとお願いする</li>
<li>無線だと有線だと考えなくて良いことを考える必要がある</li>
<li>端末の偏り、移動など</li>
<li>ライトユーザー向けの話</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[公開鍵認証 + libpam-google-authenticator による二要素認証を特定のユーザーだけ対象に導入する]]></title>
    <link href="http://blog.n-z.jp/blog/2016-04-18-libpam-google-authenticator.html"/>
    <updated>2016-04-18T21:26:42+09:00</updated>
    <id>http://blog.n-z.jp/blog/libpam-google-authenticator</id>
    <content type="html"><![CDATA[<p>普通に <code>libpam-google-authenticator</code> を PAM の設定に追加するだけだと公開鍵認証の時に使われなくて二要素認証として嬉しくなかったのと、
<code>libpam-google-authenticator</code> による二要素認証をいきなり全ユーザーに導入してしまうと <code>google-authenticator</code> コマンドによるトークン作成をしていないユーザーが入れなくなってしまったり、リモートバックアップ処理の自動実行などで入れなくなったりして困るので、
一部のユーザーだけ二要素認証が必須になる設定を考えてみました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>Debian GNU/Linux 8.4 (jessie)</li>
<li>openssh-server 1:6.7p1-5+deb8u1</li>
<li>libpam-google-authenticator 20130529-2</li>
</ul>


<h2>設定時の注意</h2>

<p>PAM の設定変更は失敗するとログインできなくなって危険なので、設定を戻したりできるシェルを最低一個は残した状態で設定を変更することをおすすめします。</p>

<h2>PAM の設定</h2>

<p>PAM の設定では <code>@include common-auth</code> の代わりに <code>pam_unix.so</code> を <code>pam_google_authenticator.so</code> に置き換えた設定を <code>/etc/pam.d/sshd</code> に追加しました。</p>

<p>これで <code>keyboard-interactive</code> 認証では unix password による認証は使えなくなって <code>libpam-google-authenticator</code> による認証だけになります。</p>

<p>ワンタイムパスワードなので、入力している値を見られても困らないし、実際 GitHub などでの入力画面では隠されていないので、 <code>/usr/share/doc/libpam-google-authenticator/README.gz</code> にも書いてある <code>echo_verification_code</code> の設定も追加してエコーバックされるようにしてみました。</p>

<figure class='code'><figcaption><span>/etc/pam.d/sshd</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+auth [success=1 default=ignore] pam_google_authenticator.so echo_verification_code
</span><span class='line'>+auth requisite pam_deny.so
</span><span class='line'>+auth required pam_permit.so
</span><span class='line'> # Standard Un*x authentication.
</span><span class='line'>-@include common-auth
</span><span class='line'>+#@include common-auth</span></code></pre></td></tr></table></div></figure>


<h2>sshd の設定</h2>

<p>他の <code>pam_google_authenticator.so</code> 導入記事にも書いてあるように
<code>ChallengeResponseAuthentication</code> を <code>yes</code> に変更します。
この設定を変更しないと <code>Verification code:</code> の入力プロンプトが出てこなくて、
認証コードの入力ができません。</p>

<figure class='code'><figcaption><span>/etc/ssh/sshd_config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ChallengeResponseAuthentication yes</span></code></pre></td></tr></table></div></figure>


<p>最後に適当なグループ (今回は <code>/var/log/</code> のログファイルのグループなどに利用されている <code>adm</code> グループを利用しましたが <code>sudo</code> グループなどでも良いかもしれません) を <code>Match</code> で指定して、そのグループに属するユーザーの時だけ <code>AuthenticationMethods</code> で公開鍵認証と <code>keyboard-interactive</code> 認証の両方を必須にしました。</p>

<figure class='code'><figcaption><span>/etc/ssh/sshd_config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Match Group adm
</span><span class='line'>AuthenticationMethods publickey,keyboard-interactive</span></code></pre></td></tr></table></div></figure>


<h2>トークンを生成しているユーザーだけ有効にする設定</h2>

<p><code>google-authenticator</code> コマンドで <code>~/.google-authenticator</code> を生成しているユーザーだけ有効にすることができたので、その方法もメモしておきます。</p>

<p>方法としては <code>pam_exec</code> を使ってファイルの存在チェックをすれば可能でした。
<code>pam_exec.so</code> の引数部分では直接環境変数展開ができなかったので、別途外部に実行ファイルを用意する方法がデバッグもしやすくておすすめです。</p>

<p>存在チェックが成功すればそのまま次の行に進んで、存在しなければ後続の 2 行を飛ばして <code>pam_permit.so</code> で許可するようにしました。</p>

<p>PAM の設定の詳細については<a href="http://tokyodebian.alioth.debian.org/pdf/debianmeetingresume2012-natsu.pdf">大統一Debian勉強会 特大号 東京エリア/関西Debian勉強会のPDF</a> か、<a href="http://gum.debian.or.jp/2012/">大統一Debian勉強会</a> の「Linux-PAMの設定について」の発表資料を参考にしてください。</p>

<p><code>pam_exec.so</code> に <code>quiet</code> をつけないと <code>~/.google-authenticator</code> がない場合に毎回 <code>/usr/local/bin/check_google_authenticator.sh failed: exit code 1</code> が出るので、 <code>quiet</code> をつけて抑制するようにしました。
<code>Authenticated with partial success.</code> というメッセージは <code>ssh</code> が出しているので消せませんでした。</p>

<figure class='code'><figcaption><span>/etc/pam.d/sshd</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auth [success=ignore default=2] pam_exec.so quiet /usr/local/bin/check_google_authenticator.sh
</span><span class='line'>auth [success=1 default=ignore] pam_google_authenticator.so echo_verification_code
</span><span class='line'>auth requisite pam_deny.so
</span><span class='line'>auth required pam_permit.so</span></code></pre></td></tr></table></div></figure>


<p>存在のチェック用スクリプトは <code>pam_exec</code> 経由で実行された時には <code>HOME</code> 環境変数が設定されていなくて、代わりに <code>PAM_USER</code> などが設定されているのを利用して <code>HOME</code> を設定されていなければ設定するようにしました。</p>

<figure class='code'><figcaption><span>/usr/local/bin/check_google_authenticator.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>: <span class="k">${</span><span class="nv">HOME</span><span class="p">:=</span><span class="k">$(</span>getent passwd <span class="s2">&quot;$PAM_USER&quot;</span> <span class="p">|</span> awk -F: <span class="s1">&#39;{print $6}&#39;</span><span class="k">)}</span>
</span><span class='line'><span class="nb">test</span> -f <span class="s2">&quot;$HOME/.google_authenticator&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>/etc/pam.d/sshd にまとめる書き方</h2>

<p>発表資料の PDF を確認して気付いたのですが、 <code>[ ]</code> でくくれば空白の入った引数も渡せるので、シェルを経由するようにすれば変数展開付きのコマンドを含められました。</p>

<figure class='code'><figcaption><span>/etc/pam.d/sshd</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auth [success=ignore default=2] pam_exec.so quiet /bin/sh -c [: ${HOME:=$(getent passwd "$PAM_USER" | awk -F: '{print $6}')}; test -f "$HOME/.google_authenticator"]
</span><span class='line'>auth [success=1 default=ignore] pam_google_authenticator.so echo_verification_code
</span><span class='line'>auth requisite pam_deny.so
</span><span class='line'>auth required pam_permit.so</span></code></pre></td></tr></table></div></figure>


<h2>google-authenticator コマンドによるトークンの作成</h2>

<p>二要素認証を使うユーザーで <code>google-authenticator</code> コマンドを実行してトークンを作成して、 iOS なら Google Authenticator のアプリに、 Android なら Google 認証システムアプリに QR コードを読み込ませておきます。
<code>google-authenticator</code> コマンドの質問は全部 <code>y</code> で良いと思います。</p>

<p>設定は <code>~/.google_authenticator</code> に保存されています。</p>

<p>テスト環境では QR コードは読み込ませずに <code>emergency scratch codes</code> を使っていたのですが、
<code>emergency scratch codes</code> は使っていくと <code>~/.google_authenticator</code> からどんどん減っていくので、適当なタイミングで <code>google-authenticator</code> コマンドを使って再生成させないと入れなくなりそうでした。</p>

<h2>失敗した設定例</h2>

<p><code>Match</code> で <code>ChallengeResponseAuthentication</code> を設定しようとしましたが、 <code>Directive 'ChallengeResponseAuthentication' is not allowed within a Match block</code> というエラーで設定できませんでした。</p>

<p>公開鍵ごとに二要素認証の設定ができないか、検討してみましたが、使えそうな設定項目が見つかりませんでした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jessie で dovecot-imapd と postfix の設定をして Thunderbird 用の autoconfig ファイルを用意した]]></title>
    <link href="http://blog.n-z.jp/blog/2016-04-17-jessie-dovecot.html"/>
    <updated>2016-04-17T21:14:05+09:00</updated>
    <id>http://blog.n-z.jp/blog/jessie-dovecot</id>
    <content type="html"><![CDATA[<p><a href="http://gihyo.jp/admin/serial/01/ubuntu-recipe/0387?page=4">Ubuntu Weekly Recipe 第387回　UbuntuでSSLを利用したサービスを構築する</a> を参考にして、 Debian jessie で dovecot-imapd で IMAP サーバーの設定をしました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>Debian GNU/Linux 8.4 (jessie)</li>
<li>postfix 2.11.3-1</li>
<li>dovecot-imapd 1:2.2.13-12~deb8u1</li>
<li>Thunderbird 38.6.0</li>
</ul>


<h2>インストール</h2>

<p><code>sudo aptitude install dovecot-imapd</code> でインストールしました。</p>

<h2>認証設定</h2>

<p>クライアントによっては plain 認証は使えず login 認証が必要なので <code>sudoedit /etc/dovecot/conf.d/10-auth.conf</code> で <code>auth_mechanisms = plain login</code> に設定を変更しました。</p>

<h2>ssl 設定</h2>

<p><code>sudoedit /etc/dovecot/conf.d/10-ssl.conf</code> で以下の設定を変更しました。</p>

<ul>
<li><code>ssl = no</code> を <code>ssl = required</code> に</li>
<li><code>ssl_cert</code>, <code>ssl_key</code> を設定</li>
<li><code>#ssl_protocols = !SSLv2</code> を <code>ssl_protocols = !SSLv2 !SSLv3</code> に</li>
</ul>


<p><a href="http://wiki.dovecot.org/SSL/DovecotConfiguration">http://wiki.dovecot.org/SSL/DovecotConfiguration</a> によると <code>ssl</code> の設定については <code>ssl=no</code>, <code>ssl=yes and disable_plaintext_auth=yes</code>, <code>ssl=yes and disable_plaintext_auth=yes</code>, <code>ssl=required</code> という設定の組み合わせがあるようです。</p>

<h2>Maildir 設定</h2>

<p>postfix の設定で <code>Maildir</code> への配送を使っているので、 <code>sudoedit /etc/dovecot/conf.d/10-mail.conf</code> で <code>mail_location = mbox:~/mail:INBOX=/var/mail/%u</code> を <code>mail_location = maildir:~/Maildir</code> に設定を変更しました。</p>

<h2>postfix との認証連携</h2>

<p>まず <code>sudo ls -al /var/spool/postfix/private</code> で <code>auth</code> がないのを確認しました。</p>

<p><code>sudoedit /etc/dovecot/conf.d/10-master.conf</code> で</p>

<figure class='code'><figcaption><span>/etc/dovecot/conf.d/10-master.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  #unix_listener /var/spool/postfix/private/auth {
</span><span class='line'>  #  mode = 0666
</span><span class='line'>  #}</span></code></pre></td></tr></table></div></figure>


<p>を</p>

<figure class='code'><figcaption><span>/etc/dovecot/conf.d/10-master.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  unix_listener /var/spool/postfix/private/auth {
</span><span class='line'>    mode = 0660
</span><span class='line'>    user = postfix
</span><span class='line'>    group = postfix
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>に変更しました。</p>

<p>設定反映後に <code>sudo ls -al /var/spool/postfix/private</code> で <code>auth</code> が owner も group も postfix でパーミッションが <code>srw-rw----</code> になっているのを確認します。</p>

<h2>設定反映</h2>

<p><code>sudo service dovecot restart</code> で設定を反映しました。</p>

<p><code>journalctl -u dovecot.service</code> や <code>sudo ss -lntp | grep dovecot</code> で問題なく起動していることを確認しました。</p>

<h2>ufw でポート開放</h2>

<p><code>ufw allow 993/tcp</code> と <code>ufw limit 993/tcp</code> でポートを開放して連続接続数制限をしました。</p>

<h2>postfix 設定</h2>

<h3>SSL 設定</h3>

<p><code>smtpd_tls_cert_file</code> と <code>smtpd_tls_key_file</code> を設定します。
<code>smtpd_tls_cert_file</code> は中間証明書も結合したファイルを指定します。</p>

<p>その他の設定は以下のように設定しました。</p>

<figure class='code'><figcaption><span>/etc/postfix/main.cf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3
</span><span class='line'>smtpd_tls_protocols = !SSLv2, !SSLv3
</span><span class='line'>smtp_tls_mandatory_protocols = !SSLv2, !SSLv3
</span><span class='line'>smtp_tls_protocols = !SSLv2, !SSLv3</span></code></pre></td></tr></table></div></figure>


<p><code>smtpd_tls_security_level = may</code> は設定すると外部からのメール送信で問題が起きたことがあったので、メールの送信テストをしつつ、様子を見ながら設定するかどうか決めます。</p>

<h3>SASL 設定</h3>

<p><a href="http://gihyo.jp/admin/serial/01/ubuntu-recipe/0387?page=4">Ubuntu Weekly Recipe</a> では <code>smtpd_sasl_auth_enable</code> は <code>/etc/postfix/main.cf</code> でも <code>yes</code> にしていますが、 <code>/etc/postfix/master.cf</code> で <code>smtps</code> と <code>submission</code> で個別に <code>yes</code> に設定されているので、 <code>/etc/postfix/main.cf</code> では <code>no</code> のままにしておきます。</p>

<p>そうしておかないと 25 番ポートでも SMTP-Auth が有効になって、しかも <code>smtpd_tls_security_level = may</code> だとパスワードが平文で流れても良いということになるので、危険なことが起きる可能性があります。
最近は OBP25B という対策が普及しているので、一般のクライアントが間違って平文で送信してしまう可能性は低いと思いますが、余計な危険は避けておくのが良いと思います。</p>

<p>CRAM-MD5 が有効なら <code>smtpd_sasl_security_options = noanonymous,noplaintext</code> にして <code>master.cf</code> で <code>noanonymous</code> だけにしても良いかと思ったのですが、 plain 認証と login 認証しかない状態で <code>noplaintext</code> もつけてしまうと 25 番ポートで listen しているのに接続しても最初の <code>220 mail.example.org ESMTP Postfix (Debian/GNU)</code> が出てこなくてログに <code>fatal: no SASL authentication mechanisms</code> と記録されるという状態になってしまいました。
<code>/etc/passwd</code> (<code>/etc/shadow</code>) による認証だとパスワードをハッシュ化された状態でしか保存していないため、 CRAM-MD5 は使えないので、これ以上の検証はできませんでした。</p>

<p>以上を踏まえて以下のように設定しました。</p>

<figure class='code'><figcaption><span>/etc/postfix/main.cf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>smtpd_sasl_auth_enable = no
</span><span class='line'>smtpd_sasl_local_domain = $myhostname
</span><span class='line'>smtpd_sasl_security_options = noanonymous
</span><span class='line'>smtpd_sasl_type = dovecot
</span><span class='line'>smtpd_sasl_path = private/auth
</span><span class='line'>broken_sasl_auth_clients = yes</span></code></pre></td></tr></table></div></figure>


<p><code>smtpd_sasl_local_domain</code> や <code>broken_sasl_auth_clients</code> は不要かもしれません。</p>

<h2>Thunderbird 用自動設定ファイル設置</h2>

<p><a href="https://developer.mozilla.org/ja/docs/Mozilla/Thunderbird/Autoconfiguration">Thunderbird のアカウント情報自動設定機能</a>のために <code>mail/config-v1.1.xml</code> を設置します。</p>

<p><code>@example.com</code> のメールアドレスに対して <code>http://autoconfig.example.com/mail/config-v1.1.xml</code> か <code>http://example.com/.well-known/autoconfig/mail/config-v1.1.xml</code> を用意します。</p>

<p>内容は以下のような感じになります。
<code>mozilla.org</code> の例との主な違いは <code>authentication</code> を <code>password-encrypted</code> ではなく <code>password-cleartext</code> にしているところと、 <code>username</code> を <code>%EMAILADDRESS%</code> ではなく <code>%EMAILLOCALPART%</code> にしているところです。</p>

<figure class='code'><figcaption><span>mail/config-v1.1.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;clientConfig</span> <span class="na">version=</span><span class="s">&quot;1.1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;emailProvider</span> <span class="na">id=</span><span class="s">&quot;example.com&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;domain&gt;</span>example.com<span class="nt">&lt;/domain&gt;</span>
</span><span class='line'>    <span class="nt">&lt;displayName&gt;</span>Example.com Mail<span class="nt">&lt;/displayName&gt;</span>
</span><span class='line'>    <span class="nt">&lt;displayShortName&gt;</span>example.com<span class="nt">&lt;/displayShortName&gt;</span>
</span><span class='line'>    <span class="nt">&lt;incomingServer</span> <span class="na">type=</span><span class="s">&quot;imap&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;hostname&gt;</span>mail.example.com<span class="nt">&lt;/hostname&gt;</span>
</span><span class='line'>      <span class="nt">&lt;port&gt;</span>993<span class="nt">&lt;/port&gt;</span>
</span><span class='line'>      <span class="nt">&lt;socketType&gt;</span>SSL<span class="nt">&lt;/socketType&gt;</span>
</span><span class='line'>      <span class="nt">&lt;authentication&gt;</span>password-cleartext<span class="nt">&lt;/authentication&gt;</span>
</span><span class='line'>      <span class="nt">&lt;username&gt;</span>%EMAILLOCALPART%<span class="nt">&lt;/username&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/incomingServer&gt;</span>
</span><span class='line'>    <span class="nt">&lt;outgoingServer</span> <span class="na">type=</span><span class="s">&quot;smtp&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;hostname&gt;</span>mail.example.com<span class="nt">&lt;/hostname&gt;</span>
</span><span class='line'>      <span class="nt">&lt;port&gt;</span>587<span class="nt">&lt;/port&gt;</span>
</span><span class='line'>      <span class="nt">&lt;socketType&gt;</span>STARTTLS<span class="nt">&lt;/socketType&gt;</span>
</span><span class='line'>      <span class="nt">&lt;authentication&gt;</span>password-cleartext<span class="nt">&lt;/authentication&gt;</span>
</span><span class='line'>      <span class="nt">&lt;username&gt;</span>%EMAILLOCALPART%<span class="nt">&lt;/username&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/outgoingServer&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/emailProvider&gt;</span>
</span><span class='line'><span class="nt">&lt;/clientConfig&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p><a href="http://gihyo.jp/admin/serial/01/ubuntu-recipe/0387?page=4">Ubuntu Weekly Recipe</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ngircd から inspircd に移行した]]></title>
    <link href="http://blog.n-z.jp/blog/2016-04-13-ircd.html"/>
    <updated>2016-04-13T22:42:32+09:00</updated>
    <id>http://blog.n-z.jp/blog/ircd</id>
    <content type="html"><![CDATA[<p><a href="http://blog.n-z.jp/blog/2016-03-29-inspircd.html">jessie で inspircd を設定した</a>話に書いたように、 inspircd を設定したのですが、移行元の ngircd との機能比較を使っている範囲内でしてみたいと思います。</p>

<!--more-->


<h2>確認バージョン</h2>

<ul>
<li>ngircd 18-2 (on Ubuntu 12.04.5 LTS)</li>
<li>inspircd 2.0.17-1+deb8u1 (on Debian GNU/Linux 8.4 (jessie))</li>
</ul>


<h2>SSL/TLS 設定</h2>

<p>ngircd では <code>[SSL]</code> セクションで設定するだけでしたが、 inspircd では推奨されている <code>m_ssl_gnutls</code> を使うか <code>m_ssl_openssl</code> を使うか選ぶ必要がありました。
推奨があるので、特に迷うことはありませんでした。</p>

<h2>nick の長さ制限</h2>

<p>ngircd では <code>MaxNickLength</code> を 9 から 18 に変えていたのですが、 inspircd ではデフォルトで <code>NICKLEN=32</code> になっていて、設定は少し探した範囲では見つけられませんでした。</p>

<h2>チャンネルの作成制限</h2>

<p>ngircd では <code>PredefChannelsOnly = yes</code> にしていました。 inspircd では <a href="https://wiki.inspircd.org/Modules/2.0/restrictchans">m_restrictchans</a> で制限することができました。</p>

<h2>チャンネル自動作成</h2>

<p>ngircd では <code>[Channel]</code> でチャンネルをサーバー起動時に作成していました。 inspircd では <a href="https://wiki.inspircd.org/Modules/2.0/permchannels">m_permchannels</a> で作成しておくことができました。</p>

<h2>チャンネル自動参加</h2>

<p>ngircd では接続時に自動参加させることはできなかったのですが、 inspircd では <a href="https://wiki.inspircd.org/Modules/2.0/conn_join">m_conn_join</a> で接続時に強制的にチャンネルに参加させる設定ができました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[devise で電子メールアドレスのドメイン部分を省略してもログインできるようにする]]></title>
    <link href="http://blog.n-z.jp/blog/2016-04-13-devise-default-domain.html"/>
    <updated>2016-04-13T21:29:43+09:00</updated>
    <id>http://blog.n-z.jp/blog/devise-default-domain</id>
    <content type="html"><![CDATA[<p>社内向けアプリケーションのように、特定のドメインのユーザーがほとんどの場合、メールアドレスの全体を入力させるのは、余計な手間をしいていることが多いです。</p>

<p>そこで省略可能にするように変更しました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>ruby 2.2.4</li>
<li>rails 4.2.6</li>
<li>devise 3.5.6</li>
<li>warden 1.2.6</li>
</ul>


<h2>config/initializers/devise.rb での設定</h2>

<p>直接は関係ないですが、 <code>config/initializers/devise.rb</code> では以下のような感じの設定でユーザー登録できるメールアドレスのドメインを制限しています。</p>

<p>特殊用途に別ドメインのユーザーを登録する必要があったので、そこは <code>|</code> (or) で繋げて許可しています。</p>

<figure class='code'><figcaption><span>config/initializers/devise.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">email_regexp</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@example\.co\.jp\z\|\Aspecial@example\.com\z/i</span>
</span></code></pre></td></tr></table></div></figure>


<h2>User クラスへの追加</h2>

<p><a href="https://github.com/plataformatec/devise/wiki/How-To:-Allow-users-to-sign-in-using-their-username-or-email-address">How To: Allow users to sign in using their username or email address</a> を参考にして <code>User.find_first_by_auth_conditions(warden_conditions)</code> を定義すれば良いということがわかったので、以下のように定義しました。</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_for_database_authentication</span><span class="p">(</span><span class="n">warden_conditions</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="sr">/@/</span> <span class="o">=~</span> <span class="n">warden_conditions</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">super</span><span class="p">(</span><span class="n">warden_conditions</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">warden_conditions</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="si">}</span><span class="s2">@example.co.jp&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>メールアドレス全体が入力された時 (<code>@</code> を含む時) はデフォルトの挙動をそのまま使い、省略された時はデフォルトのドメイン (例では <code>example.co.jp</code>) を補ってデフォルトの挙動を呼び出すようにしました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[aasm 4.10.0 の警告に monkey patch で対処した]]></title>
    <link href="http://blog.n-z.jp/blog/2016-04-12-aasm-warn.html"/>
    <updated>2016-04-12T22:08:11+09:00</updated>
    <id>http://blog.n-z.jp/blog/aasm-warn</id>
    <content type="html"><![CDATA[<p>aasm を 4.10.0 にあげると <code>Job: overriding method 'sleeping?'!</code> のような警告が出るようになってしまい、<a href="https://github.com/aasm/aasm/issues/347">Warning when specifing states at ActiveRecord enum</a> で報告されているものの、まだ何も対応されていないので、とりあえず monkey patch で対処することにしました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>ruby 2.2.4</li>
<li>rails 4.2.6</li>
<li>aasm 4.10.0</li>
</ul>


<h2>対処方針</h2>

<p>モデルごとに対応するのは面倒なことになるので、 Rails 5 で導入される予定の <code>ApplicationRecord</code> に対応して、そこに対処を入れることにしました。</p>

<h2>ApplicationRecord 対応</h2>

<p>まず <code>sed -i~ -e 's/ActiveRecord::Base/ApplicationRecord/' app/models/*.rb</code> などで継承元を <code>ActiveRecord::Base</code> から <code>ApplicationRecord</code> に書き換えます。
(実際には <code>application_record.rb</code> の作成後にやってしまって <code>RuntimeError: Circular dependency detected while autoloading constant ApplicationRecord</code> になってしまったので、 <code>application_record.rb</code> だけ元に戻しました。)</p>

<p>次に以下の内容で <code>app/models/application_record.rb</code> を作成します。</p>

<figure class='code'><figcaption><span>app/models/application_record.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>テスト実行などで影響がないことを確認します。</p>

<h2>monkey patch</h2>

<p>aasm の README に書いてあるように</p>

<figure class='code'><figcaption><span>app/models/job.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Job</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">AASM</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">enum</span> <span class="ss">state</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">sleeping</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">running</span><span class="p">:</span> <span class="mi">99</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">aasm</span> <span class="ss">:column</span> <span class="o">=&gt;</span> <span class="ss">:state</span><span class="p">,</span> <span class="ss">:enum</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">state</span> <span class="ss">:sleeping</span><span class="p">,</span> <span class="ss">:initial</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">state</span> <span class="ss">:running</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>のようなハッシュを使った <code>enum</code> 呼び出ししかしていなかった (<code>enum status: [ :active, :archived ]</code> のような配列を使った呼び出しはしていなかった) ので、以下のように <code>each_value</code> と <code>each_key</code> の組み合わせ決め打ちで <code>undef_method</code> を呼び出すことにしました。</p>

<figure class='code'><figcaption><span>app/models/application_record.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="nb">self</span><span class="o">.</span><span class="n">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="no">AASM</span><span class="o">::</span><span class="no">VERSION</span> <span class="o">==</span> <span class="s1">&#39;4.10.0&#39;</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">enum</span><span class="p">(</span><span class="n">definitions</span><span class="p">)</span>
</span><span class='line'>      <span class="k">super</span>
</span><span class='line'>      <span class="n">definitions</span><span class="o">.</span><span class="n">each_value</span> <span class="k">do</span> <span class="o">|</span><span class="n">statuses</span><span class="o">|</span>
</span><span class='line'>        <span class="n">statuses</span><span class="o">.</span><span class="n">each_key</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class='line'>          <span class="n">undef_method</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">?&quot;</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ActiveRecord::Enum</code> では <code>enum</code> を呼び出したクラスに直接 <code>sleeping?</code> などのメソッドを定義するのではなく、無名モジュールに定義されているので、 <code>remove_method</code> ではなく <code>undef_method</code> を使う必要がありました。
(<code>aasm</code> は <code>aasm</code> を呼び出したクラスに直接定義していました。)</p>

<h2>今後の予定</h2>

<p>将来のバージョンでどう挙動が変わるのかわからないので、バージョン番号決め打ちで monkey patch をあてていて、バージョンアップで問題が再発するようならバージョン番号を更新、解決するようなら monkey patch を削除しようと思っています。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[4月9日 型システム入門読書会 第4回(兵庫県)に参加しました]]></title>
    <link href="http://blog.n-z.jp/blog/2016-04-09-amagasakirb.html"/>
    <updated>2016-04-09T13:19:38+09:00</updated>
    <id>http://blog.n-z.jp/blog/amagasakirb</id>
    <content type="html"><![CDATA[<p><a href="http://kokucheese.com/event/index/388328/" title="4月9日 型システム入門読書会 第4回(兵庫県)">4月9日 型システム入門読書会 第4回(兵庫県)</a>
に参加しました。
今回は第 20 章からでした。</p>

<!--more-->




<div style="float:right">
<iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=znz-22&amp;o=9&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=4274069117" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>
</div>


<p>以下、今回のメモです。</p>

<ul>
<li>今回は深江駅前でした。</li>
<li>Kotlin</li>
<li>第 20 章は難しい</li>
<li>数学の基礎の本のオススメは? 数学ガールの秘密のノートシリーズ?</li>
<li>誰も OCaml のコードは試していないという話</li>
<li>Visual Studio Code</li>
<li>Visual Studio Community</li>
<li>Xamarin</li>
<li><a href="https://code.visualstudio.com/docs/languages/overview">https://code.visualstudio.com/docs/languages/overview</a></li>
<li>NetBook の話</li>
<li>ARM などの CPU の話</li>
<li>深江駅には初めて来たという話</li>
<li><code>⊂</code> と <code>⊆</code> の違いについて</li>
<li><a href="https://ja.wikipedia.org/wiki/%E9%BB%92%E6%9D%BF%E5%A4%AA%E5%AD%97">黒板書体</a></li>
<li><a href="https://ja.wikipedia.org/wiki/%E4%B8%B8%E6%95%B0%E5%AD%97">丸数字</a></li>
<li>OS X で画面外にはみ出すサイズに window をリサイズした後、移動すると勝手に画面内に収まるサイズにリサイズされてしまって困るという話 (縦いっぱいの window を下げる、上に伸ばして画面サイズ以上の高さにする、ちょっと移動させる、という操作で再現可能)</li>
<li>Windows のアップデート通知の話</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jessie に backports から letsencrypt を入れてみた]]></title>
    <link href="http://blog.n-z.jp/blog/2016-04-08-jessie-letsencrypt.html"/>
    <updated>2016-04-08T14:30:02+09:00</updated>
    <id>http://blog.n-z.jp/blog/jessie-letsencrypt</id>
    <content type="html"><![CDATA[<p>現在リリースされている Ubuntu と違って Debian jessie には backports に letsencrypt パッケージがあるので、ちょっと古いですがパッケージ版の letsencrypt を使ってみることにしました。</p>

<p>Ubuntu も今月リリースされる 16.04 (xenial) には universe ですが letsencrypt パッケージが含まれるので、それが使えると思います。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>Debian GNU/Linux 8.4 (jessie) (amd64)</li>
<li>letsencrypt 0.4.1-1~bpo8+1</li>
<li>apache2 2.4.10-10+deb8u4</li>
</ul>


<h2>インストール</h2>

<p><code>/etc/apt/sources.list</code> で <code>deb http://ftp.jp.debian.org/debian jessie-backports main contrib non-free</code> のように backports を有効にしておきます。</p>

<p>依存パッケージも backports のものが必要なので <code>-t jessie-backports</code> 付きでインストールする必要がありました。</p>

<p><code>webroot</code> を使う予定だったので、 <code>python-letsencrypt-apache</code> はインストールしませんでした。</p>

<p>stable にあるパッケージのうち、いくつかのパッケージも backports のものに上がってしまうので、そのリスクが許容できない場合は <code>letsencrypt-auto</code> など、他のインストール方法を検討した方が良さそうです。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%  sudo apt install letsencrypt
</span><span class='line'>パッケージリストを読み込んでいます... 完了
</span><span class='line'>依存関係ツリーを作成しています
</span><span class='line'>状態情報を読み取っています... 完了
</span><span class='line'>インストールすることができないパッケージがありました。おそらく、あり得
</span><span class='line'>ない状況を要求したか、(不安定版ディストリビューションを使用しているの
</span><span class='line'>であれば) 必要なパッケージがまだ作成されていなかったり Incoming から移
</span><span class='line'>動されていないことが考えられます。
</span><span class='line'>以下の情報がこの問題を解決するために役立つかもしれません:
</span><span class='line'>
</span><span class='line'>以下のパッケージには満たせない依存関係があります:
</span><span class='line'> letsencrypt : 依存: python-letsencrypt (= 0.4.1-1~bpo8+1) しかし、インストールされようとしていませ ん
</span><span class='line'>E: 問題を解決することができません。壊れた変更禁止パッケージがあります。
</span><span class='line'>zsh: exit 100   sudo apt install letsencrypt
</span><span class='line'>%  sudo apt install -t jessie-backports letsencrypt
</span><span class='line'>パッケージリストを読み込んでいます... 完了
</span><span class='line'>依存関係ツリーを作成しています
</span><span class='line'>状態情報を読み取っています... 完了
</span><span class='line'>以下のパッケージが自動でインストールされましたが、もう必要とされていません:
</span><span class='line'>  python-cffi python-ply python-pycparser
</span><span class='line'>これを削除するには 'apt-get autoremove' を利用してください。
</span><span class='line'>以下の追加パッケージがインストールされます:
</span><span class='line'>  dialog python-acme python-cffi python-cffi-backend python-configargparse python-configobj
</span><span class='line'>  python-cryptography python-dialog python-enum34 python-funcsigs python-idna python-ipaddress
</span><span class='line'>  python-letsencrypt python-mock python-ndg-httpsclient python-openssl python-parsedatetime
</span><span class='line'>  python-pbr python-psutil python-pyasn1 python-pyicu python-requests python-rfc3339 python-six
</span><span class='line'>  python-urllib3 python-zope.component python-zope.event python-zope.interface
</span><span class='line'>提案パッケージ:
</span><span class='line'>  python-letsencrypt-apache python-letsencrypt-doc python-configobj-doc python-cryptography-doc
</span><span class='line'>  python-cryptography-vectors python-enum34-doc python-funcsigs-doc python-mock-doc
</span><span class='line'>  python-openssl-doc python-openssl-dbg doc-base python-ntlm
</span><span class='line'>以下のパッケージが新たにインストールされます:
</span><span class='line'>  dialog letsencrypt python-acme python-cffi-backend python-configargparse python-configobj
</span><span class='line'>  python-dialog python-enum34 python-funcsigs python-idna python-ipaddress python-letsencrypt
</span><span class='line'>  python-mock python-ndg-httpsclient python-parsedatetime python-pbr python-psutil python-pyasn1
</span><span class='line'>  python-pyicu python-requests python-rfc3339 python-urllib3 python-zope.component
</span><span class='line'>  python-zope.event python-zope.interface
</span><span class='line'>以下のパッケージはアップグレードされます:
</span><span class='line'>  python-cffi python-cryptography python-openssl python-six
</span><span class='line'>アップグレード: 4 個、新規インストール: 25 個、削除: 0 個、保留: 24 個。
</span><span class='line'>1,906 kB のアーカイブを取得する必要があります。
</span><span class='line'>この操作後に追加で 8,772 kB のディスク容量が消費されます。
</span><span class='line'>続行しますか? [Y/n]</span></code></pre></td></tr></table></div></figure>


<h2>letsencrypt コマンド実行</h2>

<p>一般ユーザー権限で実行するとエラーになり、カレントディレクトリに <code>letsencrypt.log</code> が作成されていました。
<code>--help</code> 付きでの実行は特にエラーもなく、 <code>letsencrypt.log</code> も作成されることなくヘルプが表示されました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%  letsencrypt
</span><span class='line'>An unexpected error occurred:
</span><span class='line'>OSError: [Errno 13] Permission denied: '/etc/letsencrypt'
</span><span class='line'>Please see the logfile 'letsencrypt.log' for more details.
</span><span class='line'>%  rm letsencrypt.log
</span><span class='line'>%  letsencrypt --help
</span><span class='line'>
</span><span class='line'>  letsencrypt [SUBCOMMAND] [options] [-d domain] [-d domain] ...
</span><span class='line'>
</span><span class='line'>The Let's Encrypt agent can obtain and install HTTPS/TLS/SSL certificates.  By
</span><span class='line'>default, it will attempt to use a webserver both for obtaining and installing
</span><span class='line'>the cert. Major SUBCOMMANDS are:
</span><span class='line'>
</span><span class='line'>  (default) run        Obtain & install a cert in your current webserver
</span><span class='line'>  certonly             Obtain cert, but do not install it (aka "auth")
</span><span class='line'>  install              Install a previously obtained cert in a server
</span><span class='line'>  renew                Renew previously obtained certs that are near expiry
</span><span class='line'>  revoke               Revoke a previously obtained certificate
</span><span class='line'>  rollback             Rollback server configuration changes made during install
</span><span class='line'>  config_changes       Show changes made to server config during installation
</span><span class='line'>  plugins              Display information about installed plugins
</span><span class='line'>
</span><span class='line'>Choice of server plugins for obtaining and installing cert:
</span><span class='line'>
</span><span class='line'>  (the apache plugin is not installed)
</span><span class='line'>  --standalone      Run a standalone webserver for authentication
</span><span class='line'>  (nginx support is experimental, buggy, and not installed by default)
</span><span class='line'>  --webroot         Place files in a server's webroot folder for authentication
</span><span class='line'>
</span><span class='line'>OR use different plugins to obtain (authenticate) the cert and then install it:
</span><span class='line'>
</span><span class='line'>  --authenticator standalone --installer apache
</span><span class='line'>
</span><span class='line'>More detailed help:
</span><span class='line'>
</span><span class='line'>  -h, --help [topic]    print this message, or detailed help on a topic;
</span><span class='line'>                        the available topics are:
</span><span class='line'>
</span><span class='line'>   all, automation, paths, security, testing, or any of the subcommands or
</span><span class='line'>   plugins (certonly, install, nginx, apache, standalone, webroot, etc)</span></code></pre></td></tr></table></div></figure>


<h2>本番実行</h2>

<p><code>letsencrypt certonly</code> で証明書発行します。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%  sudo letsencrypt certonly --webroot -w /srv/www/www.example.org/htdocs -d www.example.org</span></code></pre></td></tr></table></div></figure>


<p>まず、アカウントの作成があるので、アカウントの作成はメールアドレス入力しました。
アカウントのリカバリや緊急時の連絡などに使われるだけのようで、今の所ここで入力したメールアドレスに letsencrypt からメールが来たことはありません。</p>

<pre><code>         ┌──────────────────────────────────────────────────────────────────────┐
         │ Enter email address (used for urgent notices and lost key recovery)  │
         │ ┌──────────────────────────────────────────────────────────────────┐ │
         │ │                                                                  │ │
         │ └──────────────────────────────────────────────────────────────────┘ │
         ├──────────────────────────────────────────────────────────────────────┤
         │                     &lt; 了解 &gt;           &lt; 取消 &gt;                      │
         └──────────────────────────────────────────────────────────────────────┘
</code></pre>

<p>Terms of Service は前回みた時から変わっていないので、今度も Agree しました。</p>

<pre><code>         ┌──────────────────────────────────────────────────────────────────────┐
         │ Please read the Terms of Service at                                  │
         │ https://letsencrypt.org/documents/LE-SA-v1.0.1-July-27-2015.pdf. You │
         │ must agree in order to register with the ACME server at              │
         │ https://acme-v01.api.letsencrypt.org/directory                       │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         ├──────────────────────────────────────────────────────────────────────┤
         │                     &lt;Agree &gt;           &lt;Cancel&gt;                      │
         └──────────────────────────────────────────────────────────────────────┘
</code></pre>

<p>以下のような作成完了のメッセージが出ました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>IMPORTANT NOTES:
</span><span class='line'> - If you lose your account credentials, you can recover through
</span><span class='line'>   e-mails sent to z@n-z.jp.
</span><span class='line'> - Congratulations! Your certificate and chain have been saved at
</span><span class='line'>   /etc/letsencrypt/live/www.example.org/fullchain.pem. Your cert will
</span><span class='line'>   expire on 2016-07-07. To obtain a new version of the certificate in
</span><span class='line'>   the future, simply run Let's Encrypt again.
</span><span class='line'> - Your account credentials have been saved in your Let's Encrypt
</span><span class='line'>   configuration directory at /etc/letsencrypt. You should make a
</span><span class='line'>   secure backup of this folder now. This configuration directory will
</span><span class='line'>   also contain certificates and private keys obtained by Let's
</span><span class='line'>   Encrypt so making regular backups of this folder is ideal.
</span><span class='line'> - If you like Let's Encrypt, please consider supporting our work by:
</span><span class='line'>
</span><span class='line'>   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
</span><span class='line'>   Donating to EFF:                    https://eff.org/donate-le</span></code></pre></td></tr></table></div></figure>


<p>問題があれば <code>/var/log/letsencrypt/letsencrypt.log</code> でログを確認します。</p>

<h2>apache2 の設定変更</h2>

<p>apache2 の設定を変更して、 <code>sudo service apache2 reload</code> で反映します。
ブラウザーで Let&rsquo;s Encrypt Authority X3 の証明書になっていることが確認できたら設定完了です。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SSLCertificateKeyFile /etc/letsencrypt/live/www.example.org/privkey.pem
</span><span class='line'>SSLCertificateFile /etc/letsencrypt/live/www.example.org/fullchain.pem</span></code></pre></td></tr></table></div></figure>


<h2>自動更新設定</h2>

<p>パッケージの <code>letsencrypt</code> でインストールされたものではないということを明示するために <code>local</code> をつけて <code>/etc/cron.daily/local-letsencrypt</code> に自動更新の設定をしました。</p>

<p>試しに実行してみてちゃんと動いていれば設定完了です。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudoedit /etc/cron.daily/local-letsencrypt
</span><span class='line'>% sudo chmod +x /etc/cron.daily/local-letsencrypt
</span><span class='line'>% sudo /etc/cron.daily/local-letsencrypt
</span><span class='line'>% sudo cat /var/log/letsencrypt/renew.log
</span><span class='line'>Processing /etc/letsencrypt/renewal/www.example.org.conf
</span><span class='line'>
</span><span class='line'>The following certs are not due for renewal yet:
</span><span class='line'>  /etc/letsencrypt/live/www.example.org/fullchain.pem (skipped)
</span><span class='line'>No renewals were attempted.</span></code></pre></td></tr></table></div></figure>


<p><a href="http://blog.n-z.jp/blog/2016-04-07-letsencrypt.html">前回の記事</a> のように <a href="http://packages.debian.org/debianutils">debianutils</a> の <code>savelog</code> でログをローテートして、証明書の有効期限の 90 日分残すようにしています。</p>

<figure class='code'><figcaption><span>/etc/cron.daily/local-letsencrypt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="nv">LOGFILE</span><span class="o">=</span>/var/log/letsencrypt/renew.log
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>    savelog -c <span class="m">90</span> -q <span class="s2">&quot;$LOGFILE&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="k">if</span> ! letsencrypt renew &gt; <span class="s2">&quot;$LOGFILE&quot;</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>    <span class="nb">echo </span>Automated renewal failed:
</span><span class='line'>    cat <span class="s2">&quot;$LOGFILE&quot;</span>
</span><span class='line'>    <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>apachectl graceful
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[letsencrypt-auto の自動アップグレードを止めて手動でアップグレード]]></title>
    <link href="http://blog.n-z.jp/blog/2016-04-07-letsencrypt.html"/>
    <updated>2016-04-07T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/letsencrypt</id>
    <content type="html"><![CDATA[<p><code>/etc/cron.daily/letsencrypt</code> は <code>root</code> 権限で実行されるため、そこで自動アップグレードがかかるとファイルのオーナーが <code>root</code> になってしまうかもしれないと思ったので、自動更新を止めて手動でアップグレードするようにしました。</p>

<!--more-->


<h2>自動アップグレードを止めた <code>/etc/cron.daily/local-letsencrypt</code></h2>

<p><a href="http://blog.n-z.jp/blog/2016-03-06-letsencrypt.html">前回の記事</a> からの差分としては <a href="http://packages.debian.org/debianutils">debianutils</a> の <code>savelog</code> でログをローテートして、証明書の有効期限の 90 日分残すようにしたのと、 <code>--no-self-upgrade</code> をつけて自動アップグレードを止めたことです。
それから、パッケージで入れたものではないということを明示するために <code>local</code> という文字列を入れたファイル名に変更しました。</p>

<figure class='code'><figcaption><span>/etc/cron.daily/local-letsencrypt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="nv">LOGFILE</span><span class="o">=</span>/var/log/letsencrypt/renew.log
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;$LOGFILE&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>    /usr/bin/savelog -c <span class="m">90</span> -q <span class="s2">&quot;$LOGFILE&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="k">if</span> ! /home/hoge/letsencrypt/letsencrypt-auto renew --no-self-upgrade &gt; <span class="s2">&quot;$LOGFILE&quot;</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">;</span> <span class="k">then</span>
</span><span class='line'>    <span class="nb">echo </span>Automated renewal failed:
</span><span class='line'>    cat <span class="s2">&quot;$LOGFILE&quot;</span>
</span><span class='line'>    <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>apachectl graceful
</span><span class='line'>service postfix reload &gt;/dev/null
</span><span class='line'>service dovecot reload
</span></code></pre></td></tr></table></div></figure>


<h2>手動アップグレードしたログ</h2>

<p>手動実行したところ、ちょうど 0.4.2 から 0.5.0 へのアップグレードが実行されました。</p>

<figure class='code'><figcaption><span>/etc/cron.daily/local-letsencrypt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% ~/letsencrypt/letsencrypt-auto --help
</span><span class='line'>Checking <span class="k">for</span> new version...
</span><span class='line'>Upgrading letsencrypt-auto 0.4.2 to 0.5.0...
</span><span class='line'>Replacing letsencrypt-auto...
</span><span class='line'>   sudo cp -p /home/hoge/letsencrypt/letsencrypt-auto /tmp/user/1000/tmp.MclJH3TO68/letsencrypt-auto.permission-clone
</span><span class='line'>   sudo cp /tmp/user/1000/tmp.MclJH3TO68/letsencrypt-auto /tmp/user/1000/tmp.MclJH3TO68/letsencrypt-auto.permission-clone
</span><span class='line'>   sudo mv -f /tmp/user/1000/tmp.MclJH3TO68/letsencrypt-auto.permission-clone /home/hoge/letsencrypt/letsencrypt-auto
</span><span class='line'>Creating virtual environment...
</span><span class='line'>Installing Python packages...
</span><span class='line'>Installation succeeded.
</span><span class='line'>Requesting root privileges to run letsencrypt...
</span><span class='line'>   sudo /home/hoge/.local/share/letsencrypt/bin/letsencrypt --help
</span><span class='line'>
</span><span class='line'>  letsencrypt-auto <span class="o">[</span>SUBCOMMAND<span class="o">]</span> <span class="o">[</span>options<span class="o">]</span> <span class="o">[</span>-d domain<span class="o">]</span> <span class="o">[</span>-d domain<span class="o">]</span> ...
</span><span class='line'>
</span><span class='line'>The Let<span class="s1">&#39;s Encrypt agent can obtain and install HTTPS/TLS/SSL certificates.  By</span>
</span><span class='line'><span class="s1">default, it will attempt to use a webserver both for obtaining and installing</span>
</span><span class='line'><span class="s1">the cert. Major SUBCOMMANDS are:</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  (default) run        Obtain &amp; install a cert in your current webserver</span>
</span><span class='line'><span class="s1">  certonly             Obtain cert, but do not install it (aka &quot;auth&quot;)</span>
</span><span class='line'><span class="s1">  install              Install a previously obtained cert in a server</span>
</span><span class='line'><span class="s1">  renew                Renew previously obtained certs that are near expiry</span>
</span><span class='line'><span class="s1">  revoke               Revoke a previously obtained certificate</span>
</span><span class='line'><span class="s1">  rollback             Rollback server configuration changes made during install</span>
</span><span class='line'><span class="s1">  config_changes       Show changes made to server config during installation</span>
</span><span class='line'><span class="s1">  plugins              Display information about installed plugins</span>
</span><span class='line'>
</span><span class='line'><span class="s1">Choice of server plugins for obtaining and installing cert:</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  --apache          Use the Apache plugin for authentication &amp; installation</span>
</span><span class='line'><span class="s1">  --standalone      Run a standalone webserver for authentication</span>
</span><span class='line'><span class="s1">  (nginx support is experimental, buggy, and not installed by default)</span>
</span><span class='line'><span class="s1">  --webroot         Place files in a server&#39;</span>s webroot folder <span class="k">for</span> authentication
</span><span class='line'>
</span><span class='line'>OR use different plugins to obtain <span class="o">(</span>authenticate<span class="o">)</span> the cert and <span class="k">then</span> install it:
</span><span class='line'>
</span><span class='line'>  --authenticator standalone --installer apache
</span><span class='line'>
</span><span class='line'>More detailed <span class="nb">help</span>:
</span><span class='line'>
</span><span class='line'>  -h, --help <span class="o">[</span>topic<span class="o">]</span>    print this message, or detailed <span class="nb">help </span>on a topic<span class="p">;</span>
</span><span class='line'>                        the available topics are:
</span><span class='line'>
</span><span class='line'>   all, automation, paths, security, testing, or any of the subcommands or
</span><span class='line'>   plugins <span class="o">(</span>certonly, install, nginx, apache, standalone, webroot, etc<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>アップグレードがないときのログ</h2>

<figure class='code'><figcaption><span>/etc/cron.daily/local-letsencrypt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% ~/letsencrypt/letsencrypt-auto --help
</span><span class='line'>Checking <span class="k">for</span> new version...
</span><span class='line'>Requesting root privileges to run letsencrypt...
</span><span class='line'>   sudo /home/hoge/.local/share/letsencrypt/bin/letsencrypt --help
</span><span class='line'>
</span><span class='line'>  letsencrypt-auto <span class="o">[</span>SUBCOMMAND<span class="o">]</span> <span class="o">[</span>options<span class="o">]</span> <span class="o">[</span>-d domain<span class="o">]</span> <span class="o">[</span>-d domain<span class="o">]</span> ...
</span><span class='line'>
</span><span class='line'>The Let<span class="s1">&#39;s Encrypt agent can obtain and install HTTPS/TLS/SSL certificates.  By</span>
</span><span class='line'><span class="s1">default, it will attempt to use a webserver both for obtaining and installing</span>
</span><span class='line'><span class="s1">the cert. Major SUBCOMMANDS are:</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  (default) run        Obtain &amp; install a cert in your current webserver</span>
</span><span class='line'><span class="s1">  certonly             Obtain cert, but do not install it (aka &quot;auth&quot;)</span>
</span><span class='line'><span class="s1">  install              Install a previously obtained cert in a server</span>
</span><span class='line'><span class="s1">  renew                Renew previously obtained certs that are near expiry</span>
</span><span class='line'><span class="s1">  revoke               Revoke a previously obtained certificate</span>
</span><span class='line'><span class="s1">  rollback             Rollback server configuration changes made during install</span>
</span><span class='line'><span class="s1">  config_changes       Show changes made to server config during installation</span>
</span><span class='line'><span class="s1">  plugins              Display information about installed plugins</span>
</span><span class='line'>
</span><span class='line'><span class="s1">Choice of server plugins for obtaining and installing cert:</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  --apache          Use the Apache plugin for authentication &amp; installation</span>
</span><span class='line'><span class="s1">  --standalone      Run a standalone webserver for authentication</span>
</span><span class='line'><span class="s1">  (nginx support is experimental, buggy, and not installed by default)</span>
</span><span class='line'><span class="s1">  --webroot         Place files in a server&#39;</span>s webroot folder <span class="k">for</span> authentication
</span><span class='line'>
</span><span class='line'>OR use different plugins to obtain <span class="o">(</span>authenticate<span class="o">)</span> the cert and <span class="k">then</span> install it:
</span><span class='line'>
</span><span class='line'>  --authenticator standalone --installer apache
</span><span class='line'>
</span><span class='line'>More detailed <span class="nb">help</span>:
</span><span class='line'>
</span><span class='line'>  -h, --help <span class="o">[</span>topic<span class="o">]</span>    print this message, or detailed <span class="nb">help </span>on a topic<span class="p">;</span>
</span><span class='line'>                        the available topics are:
</span><span class='line'>
</span><span class='line'>   all, automation, paths, security, testing, or any of the subcommands or
</span><span class='line'>   plugins <span class="o">(</span>certonly, install, nginx, apache, standalone, webroot, etc<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
