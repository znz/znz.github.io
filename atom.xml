<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[@znz blog]]></title>
  <link href="http://blog.n-z.jp/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2014-02-07T17:15:07+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[pre-commit hookでmasterへのcommitを禁止した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-02-07-pre-commit-hook.html"/>
    <updated>2014-02-07T16:57:54+09:00</updated>
    <id>http://blog.n-z.jp/blog/pre-commit-hook</id>
    <content type="html"><![CDATA[<p>git flow を使っていて、
<code>git flow release finish</code>
後に master ブランチのままなのに気付かずに
develop ブランチのつもりで git commit してしまうということが起きるので、
pre-commit hook で禁止するようにしてみました。</p>

<!--more-->


<h2>参考</h2>

<p>twitter で
<a href="https://github.com/bleis-tift/Git-Hooks/blob/rewrite/hooks/pre-commit">https://github.com/bleis-tift/Git-Hooks/blob/rewrite/hooks/pre-commit</a>
というのを教えてもらって、
Git.pm に依存しているこれをそのまま使うのは面倒そうだったので、
シェルスクリプトで実装してみました。</p>

<h2>pre-commit の引数</h2>

<p>さきほどの pre-commit だと <code>my $gitdir = shift;</code> としていて、
pre-commit の第一引数で git-dir が渡されるのかと思ったのですが、
実際に試してみるとそんなことはなくて、
<code>.git/hooks/pre-commit.sample</code>
をみても <code>--git-dir</code> は付けていなかったので、
付けずに git コマンドを呼び出すことにしました。</p>

<h2>is_master_branch</h2>

<p><code>is_master_branch</code> の実装を GitHub の検索を使って探してみると
<code>git --git-dir="$dir" symbolic-ref HEAD 2&gt;/dev/null</code>
の結果を
<code>s"refs/heads/""</code>
で処理して
<code>'master'</code>
と比較しているだけだったので、</p>

<figure class='code'><figcaption><span>is_master_branch</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="k">if </span><span class="nb">test</span> <span class="s2">&quot;`git symbolic-ref HEAD | sed -e &#39;s:^refs/heads/::&#39;`&quot;</span> <span class="o">=</span> master; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;cannot commit on master branch.&quot;</span>
</span><span class='line'>  <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>とすることにしました。</p>

<p>pre-commit.sample を pre-commit にコピーして、
<code>exec 1&gt;&amp;2</code>
の下に追加しました。</p>

<h2>pre-commit 全体</h2>

<p>元の pre-commit.sample からコピーした部分も含めて、
pre-commit hook 全体は以下のようになりました。</p>

<figure class='code'><figcaption><span>.git/hooks/pre-commit</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># An example hook script to verify what is about to be committed.</span>
</span><span class='line'><span class="c"># Called by &quot;git commit&quot; with no arguments.  The hook should</span>
</span><span class='line'><span class="c"># exit with non-zero status after issuing an appropriate message if</span>
</span><span class='line'><span class="c"># it wants to stop the commit.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># To enable this hook, rename this file to &quot;pre-commit&quot;.</span>
</span><span class='line'>
</span><span class='line'><span class="k">if </span>git rev-parse --verify HEAD &gt;/dev/null 2&gt;&amp;1
</span><span class='line'><span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">against</span><span class="o">=</span>HEAD
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="c"># Initial commit: diff against an empty tree object</span>
</span><span class='line'>  <span class="nv">against</span><span class="o">=</span>4b825dc642cb6eb9a060e54bf8d69288fbee4904
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># If you want to allow non-ascii filenames set this variable to true.</span>
</span><span class='line'><span class="nv">allownonascii</span><span class="o">=</span><span class="k">$(</span>git config hooks.allownonascii<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Redirect output to stderr.</span>
</span><span class='line'><span class="nb">exec </span>1&gt;&amp;2
</span><span class='line'>
</span><span class='line'><span class="k">if </span><span class="nb">test</span> <span class="s2">&quot;`git symbolic-ref HEAD | sed -e &#39;s:^refs/heads/::&#39;`&quot;</span> <span class="o">=</span> master; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;cannot commit on master branch.&quot;</span>
</span><span class='line'>  <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Cross platform projects tend to avoid non-ascii filenames; prevent</span>
</span><span class='line'><span class="c"># them from being added to the repository. We exploit the fact that the</span>
</span><span class='line'><span class="c"># printable range starts at the space character and ends with tilde.</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$allownonascii&quot;</span> !<span class="o">=</span> <span class="s2">&quot;true&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>  <span class="c"># Note that the use of brackets around a tr range is ok here, (it&#39;s</span>
</span><span class='line'>  <span class="c"># even required, for portability to Solaris 10&#39;s /usr/bin/tr), since</span>
</span><span class='line'>  <span class="c"># the square bracket bytes happen to fall in the designated range.</span>
</span><span class='line'>  <span class="nb">test</span> <span class="k">$(</span>git diff --cached --name-only --diff-filter<span class="o">=</span>A -z <span class="nv">$against</span> |
</span><span class='line'>    <span class="nv">LC_ALL</span><span class="o">=</span>C tr -d <span class="s1">&#39;[ -~]\0&#39;</span> | wc -c<span class="k">)</span> !<span class="o">=</span> 0
</span><span class='line'><span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;Error: Attempt to add a non-ascii file name.&quot;</span>
</span><span class='line'>  <span class="nb">echo</span>
</span><span class='line'><span class="nb"> echo</span> <span class="s2">&quot;This can cause problems if you want to work&quot;</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;with people on other platforms.&quot;</span>
</span><span class='line'>  <span class="nb">echo</span>
</span><span class='line'><span class="nb"> echo</span> <span class="s2">&quot;To be portable it is advisable to rename the file ...&quot;</span>
</span><span class='line'>  <span class="nb">echo</span>
</span><span class='line'><span class="nb"> echo</span> <span class="s2">&quot;If you know what you are doing you can disable this&quot;</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;check using:&quot;</span>
</span><span class='line'>  <span class="nb">echo</span>
</span><span class='line'><span class="nb"> echo</span> <span class="s2">&quot;  git config hooks.allownonascii true&quot;</span>
</span><span class='line'>  <span class="nb">echo</span>
</span><span class='line'><span class="nb"> exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># If there are whitespace errors, print the offending file names and fail.</span>
</span><span class='line'><span class="nb">exec </span>git diff-index --check --cached <span class="nv">$against</span> --
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[bootstrap-sass-railsからbootstrap-sassに移行した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-02-06-bootstrap-sass.html"/>
    <updated>2014-02-06T14:29:27+09:00</updated>
    <id>http://blog.n-z.jp/blog/bootstrap-sass</id>
    <content type="html"><![CDATA[<p>今日の <code>bundle update</code> は bootstrap の sass の gem を bootstrap 公式のものに移行したのが大きな変更点でした。</p>

<!--more-->


<h2>bootstrap-sass-rails から bootstrap-sass 3.1.0.2</h2>

<p><a href="http://blog.getbootstrap.com/2014/01/30/bootstrap-3-1-0-released/">bootstrap 3.1.0 がリリース</a>されて少し時間が経ったので、
bootstrap-sass-rails を確認してみたところ、
<a href="https://github.com/yabawock/bootstrap-sass-rails#deprecation-notice">DEPRECATION NOTICE</a>
に公式サポートされた sass の gem があるので、
そちらに移行を推奨と書かれていたので、移行しました。</p>

<p>bootstrap-sass gem への移行は UPGRADING に書かれているように <code>@import "twitter/bootstrap";</code> を <code>@import "bootstrap";</code> に書き換えるだけでした。</p>

<h2>bootstrap-sass のカスタマイズ</h2>

<p><a href="https://github.com/twbs/bootstrap-sass#usage">Usage</a>
によると、一番単純な使い方としては <code>@import "bootstrap";</code> だけですが、
<a href="http://getbootstrap.com/customize/#less-variables">Less variables</a>
を参考にして以下のようにカスタマイズして使うのが良いようです。</p>

<p>Less では変数の接頭辞は <code>@</code> ですが、 sass では <code>$</code> になることさえわかっていれば、最低限のカスタマイズは出来ると思います。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$navbar-default-bg: #312312;
</span><span class='line'>$light-orange: #ff8c00;
</span><span class='line'>$navbar-default-color: $light-orange;
</span><span class='line'>
</span><span class='line'>@import "bootstrap";</span></code></pre></td></tr></table></div></figure>


<p>bootstrap-sass-rails からの移行だったので、
bootstrap-custom.css.scss の内容は以下のようにしました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$body-bg:               #fff;
</span><span class='line'>$text-color:            lighten(#000, 20%);
</span><span class='line'>
</span><span class='line'>@import "bootstrap";</span></code></pre></td></tr></table></div></figure>


<p>もっと高度なカスタマイズをするなら、
<code>cp $(bundle show bootstrap-sass)/vendor/assets/stylesheets/bootstrap.scss app/assets/stylesheets/bootstrap-custom.scss</code>
でコピーしたファイルを
<code>@import 'bootstrap';</code>
の代わりに
<code>@import 'bootstrap-custom';</code>
で使うことを想定しているようです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails_best_practices 1.15.0でtryが壊れた]]></title>
    <link href="http://blog.n-z.jp/blog/2014-02-05-rails-best-practices-1-15-0-broken.html"/>
    <updated>2014-02-05T10:35:06+09:00</updated>
    <id>http://blog.n-z.jp/blog/rails-best-practices-1-15-0-broken</id>
    <content type="html"><![CDATA[<p>今日の <code>bundle update</code> をしてみたところ、開発環境での devise でのログイン時に <code>devise (3.2.2) lib/devise/hooks/csrf_cleaner.rb, line 3</code> で <code>wrong number of arguments (2 for 1)</code> という <code>ArgumentError</code> が発生するようになりました。</p>

<p>その原因調査方法の記録です。</p>

<!--more-->


<p>例外が発生した行は以下の内容で、今まで問題なく動いていたし、特に問題はなさそうだったので、他の gem の影響だということがわかりました。</p>

<figure class='code'><figcaption><span>lib/devise/hooks/csrf_cleaner.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Warden</span><span class="p">:</span><span class="ss">:Manager</span><span class="o">.</span><span class="n">after_authentication</span> <span class="k">do</span> <span class="o">|</span><span class="n">record</span><span class="p">,</span> <span class="n">warden</span><span class="p">,</span> <span class="n">options</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">Devise</span><span class="o">.</span><span class="n">clean_up_csrf_token_on_authentication</span>
</span><span class='line'>    <span class="n">warden</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:delete</span><span class="p">,</span> <span class="ss">:_csrf_token</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>ソースコードを追いかけるのは難しそうだったので、 better_errors の live shell を使って調査しました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">&gt;</span>&gt; env.keys
</span><span class='line'><span class="go">=&gt; 略</span>
</span><span class='line'><span class="gp">&gt;</span>&gt; env<span class="o">[</span><span class="s2">&quot;warden&quot;</span><span class="o">]</span>
</span><span class='line'><span class="go">=&gt; Warden::Proxy:70192217236640 @config={:default_scope=&gt;:user, :scope_defaults=&gt;{}, :default_strategies=&gt;{:user=&gt;[:rememberable, :database_authenticatable]}, :intercept_401=&gt;false, :failure_app=&gt;#&lt;Devise::Delegator:0x007fadcc44d438&gt;}</span>
</span><span class='line'><span class="gp">&gt;</span>&gt; env<span class="o">[</span><span class="s2">&quot;warden&quot;</span><span class="o">]</span>.request
</span><span class='line'><span class="go">=&gt; #&lt;ActionDispatch::Request:0x007fadd10c4dc0 略&gt;</span>
</span><span class='line'><span class="gp">&gt;</span>&gt; env<span class="o">[</span><span class="s2">&quot;warden&quot;</span><span class="o">]</span>.request.session
</span><span class='line'><span class="go">=&gt; {&quot;session_id&quot;=&gt;&quot;略&quot;, &quot;user_return_to&quot;=&gt;&quot;/&quot;, &quot;_csrf_token&quot;=&gt;&quot;略&quot;, &quot;warden.user.user.key&quot;=&gt;[[8], &quot;$2a$10$略&quot;]}</span>
</span><span class='line'><span class="gp">&gt;</span>&gt; env<span class="o">[</span><span class="s2">&quot;warden&quot;</span><span class="o">]</span>.request.session.try<span class="o">(</span>:delete, :_csrf_token<span class="o">)</span>
</span><span class='line'><span class="go">!! #&lt;ArgumentError: wrong number of arguments (2 for 1)&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>env["warden"]</code> 経由で再現しました。</p>

<p>次に原因を探るために <code>arity</code> を調べました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">&gt;</span>&gt; env<span class="o">[</span><span class="s2">&quot;warden&quot;</span><span class="o">]</span>.request.session.methods.grep /delete/
</span><span class='line'><span class="go">=&gt; [:delete, :delete_if]</span>
</span><span class='line'><span class="gp">&gt;</span>&gt; env<span class="o">[</span><span class="s2">&quot;warden&quot;</span><span class="o">]</span>.request.session.method<span class="o">(</span><span class="s2">&quot;delete&quot;</span><span class="o">)</span>
</span><span class='line'><span class="go">=&gt; #&lt;Method: Rack::Session::Abstract::SessionHash#delete&gt;</span>
</span><span class='line'><span class="gp">&gt;</span>&gt; env<span class="o">[</span><span class="s2">&quot;warden&quot;</span><span class="o">]</span>.request.session.method<span class="o">(</span><span class="s2">&quot;delete&quot;</span><span class="o">)</span>.arity
</span><span class='line'><span class="go">=&gt; 1</span>
</span><span class='line'><span class="gp">&gt;</span>&gt; env<span class="o">[</span><span class="s2">&quot;warden&quot;</span><span class="o">]</span>.request.session.method<span class="o">(</span><span class="s2">&quot;try&quot;</span><span class="o">)</span>
</span><span class='line'><span class="go">=&gt; #&lt;Method: Rack::Session::Abstract::SessionHash(Object)#try&gt;</span>
</span><span class='line'><span class="gp">&gt;</span>&gt; env<span class="o">[</span><span class="s2">&quot;warden&quot;</span><span class="o">]</span>.request.session.method<span class="o">(</span><span class="s2">&quot;try&quot;</span><span class="o">)</span>.arity
</span><span class='line'><span class="go">=&gt; 1</span>
</span><span class='line'><span class="gp">&gt;</span>&gt; env<span class="o">[</span><span class="s2">&quot;warden&quot;</span><span class="o">]</span>.request.session.method<span class="o">(</span><span class="s2">&quot;try&quot;</span><span class="o">)</span>.source_location
</span><span class='line'><span class="go">=&gt; [&quot;略/rails_best_practices-1.15.0/lib/rails_best_practices/core_ext/object.rb&quot;, 7]</span>
</span><span class='line'><span class="gp">&gt;</span>&gt;
</span></code></pre></td></tr></table></div></figure>


<p>rails_best_practices 1.15.0 が原因とわかったので issues を確認すると既に同様の現象の報告があったので、<a href="https://github.com/railsbp/rails_best_practices/issues/202#issuecomment-34129010">コメントしておきました</a>。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[zabbixでmemcachedのヒット率を記録する]]></title>
    <link href="http://blog.n-z.jp/blog/2014-02-04-zabbix-memcached.html"/>
    <updated>2014-02-04T19:14:01+09:00</updated>
    <id>http://blog.n-z.jp/blog/zabbix-memcached</id>
    <content type="html"><![CDATA[<p>rails の dalli_store でキャッシュの保存場所として使っている memcached のキャッシュのヒット率を zabbix で記録して、コードの改善でどのくらい変わるのか調べてみることにしました。</p>

<!--more-->


<h2>参考</h2>

<p>memcached からのデータ取得方法は <a href="http://blog.withsin.net/2010/09/06/zabbix%E3%81%A7memcached%E7%9B%A3%E8%A6%96/">zabbixでmemcached監視 at technote</a> を参考にしました。</p>

<h2>前提</h2>

<p>zabbix-server は別サーバーで既に設定済みで動いているものを使いました。
zabbix-agent は新規インストールしました。
OS は Ubuntu 12.04.4 LTS です。</p>

<h2>memcached からデータ取得部分</h2>

<p><code>/etc/cron.d/zabbix-memcached</code> に以下の内容で取得部分を作成しました。
継続的にエラーが出ている時ぐらいは原因を調べられるように、標準エラー出力も最新のものだけファイルに残すようにしました。</p>

<figure class='code'><figcaption><span>/etc/cron.d/zabbix-memcached</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>*/5 * * * *   zabbix    test -d /run/zabbix &amp;&amp; { echo stats | nc localhost 11211 &gt; /run/zabbix/memcached.stats 2&gt;/run/zabbix/memcached.stats.err; }
</span></code></pre></td></tr></table></div></figure>


<h2>zabbix_agentd 設定</h2>

<p>以下の設定を変更しました。</p>

<ul>
<li>Server=<code>zabbix-serverのIPアドレス</code></li>
<li>Hostname=<code>zabbix の Web UI のホスト名にあわせる</code></li>
<li>DisableActive=1 : zabbix-agent 側からの接続ができない環境だったので、 zabbix-server からの接続を待ち受けるだけにしました。</li>
<li><code>UserParameter=memcached.stats[*],grep $1 /run/zabbix/memcached.stats | cut -d' ' -f3</code> : grep と組み合わせるには awk は重い気がしたので cut に変更しました。</li>
</ul>


<h2>firewall 設定</h2>

<p><code>ufw allow from zabbix-serverのIPアドレス to any port 10050</code> で zabbix-server からのみ許可しました。
インターネット上を平文で流れてしまうのは、機密データではないということで、許容することにしました。
暗号化が必要なら別途 openvpn などを使うと思います。</p>

<h2>動作確認</h2>

<ul>
<li>Server に localhost 以外を指定したので zabbix-agent を動かしているマシン上で <code>nc -v localhost 10050</code> は繋がった後、すぐに切断されます。</li>
<li>zabbix-server 側で <code>zabbix_get -s 49.212.178.112 -k agent.ping</code> を実行して <code>1</code> と出れば zabbix-agent へ接続できています。</li>
<li>zabbix の Web UI からテンプレートを作成して、 <code>cmd_get</code> <code>cmd_set</code> <code>cmd_hits</code> を記録するようにしました。
(キー: <code>memcached.stats[cmd_get]</code> など, 保存時の計算: なし (2014-02-06: 差分はやめました), 更新間隔: 300 (cronを5分間隔にしているので))</li>
<li>さらに計算アイテムとして式に <code>100*last("memcached.stats[get_hits]")/last("memcached.stats[cmd_get]")</code> を設定したものを追加しました。</li>
</ul>


<p>差分で記録しているからなのか、データが少ないタイミングだったからか、計算に使うアイテムのタイミングの問題なのかわかりませんが、計算アイテムのヒット率が 100% を超えることがありました。</p>

<p>2014-02-06 追記:
差分はやめて、そのまま記録した値を使うようにして、ヒット率の計算が安定するようにしました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[bundle updateした記録]]></title>
    <link href="http://blog.n-z.jp/blog/2014-02-03-bundle-update.html"/>
    <updated>2014-02-03T17:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/bundle-update</id>
    <content type="html"><![CDATA[<p><code>bundle update</code> で更新された gem などのメモを残すことにしました。</p>

<!--more-->


<h2>jquery-rails 3.1.0 (was 3.0.4)</h2>

<p>jQuery 1.11.0 にあがったのと jquery-ujs が更新されていました。</p>

<figure class='code'><figcaption><span>CHANGELOG.md</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>## 3.1.0 (29 January 2014)
</span><span class='line'>
</span><span class='line'>  - Updated to jQuery 1.11.0
</span><span class='line'>  - Updated to latest jquery-ujs
</span><span class='line'>  - Added development rake task for updating jQuery
</span></code></pre></td></tr></table></div></figure>


<h2>omniauth-oauth2 1.1.2 (was 1.1.1)</h2>

<p>oauth2 が 0.8.1 から 0.9.3 に一気にあがって驚きましたが、
omniauth-oauth2 の依存関係が更新されたのが原因でした。</p>

<p>他にもたくさん変更されていました。</p>

<h2>turbolinks 2.2.1 (was 2.2.0)</h2>

<p><a href="https://github.com/rails/turbolinks/blob/master/CHANGELOG.md#turbolinks-221-january-30-2014">https://github.com/rails/turbolinks/blob/master/CHANGELOG.md#turbolinks-221-january-30-2014</a>
によるとバグ修正のみのようです。</p>

<h2>rails_admin 0.6.1 (was 0.6.0)</h2>

<p>paper_trail gem が 3.0.0 で <code>Version</code> から <code>PaperTrail::Version</code> に変わった
<a href="https://github.com/airblade/paper_trail/pull/165">#165</a>
影響を受けて、
<code>config/initializers/rails_admin.rb</code>
を以下のように変更する必要がありました。</p>

<figure class='code'><figcaption><span>config/initializers/rails_admin.rb.diff</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">--- a/config/initializers/rails_admin.rb</span>
</span><span class='line'><span class="gi">+++ b/config/initializers/rails_admin.rb</span>
</span><span class='line'><span class="gu">@@ -18,7 +18,7 @@ RailsAdmin.config do |config|</span>
</span><span class='line'>   # config.audit_with :history, &#39;User&#39;
</span><span class='line'>
</span><span class='line'>   # Or with a PaperTrail: (you need to install it first)
</span><span class='line'><span class="gd">-  config.audit_with :paper_trail, &#39;User&#39;</span>
</span><span class='line'><span class="gi">+  config.audit_with :paper_trail, &#39;User&#39;, &#39;PaperTrail::Version&#39;</span>
</span><span class='line'>
</span><span class='line'>   # Display empty fields in show views:
</span><span class='line'>   # config.compact_show_view = false
</span></code></pre></td></tr></table></div></figure>


<p>あまりカスタマイズしていないのなら、
<code>rails g rails_admin:install</code>
で生成し直して、設定し直した方が良いかもしれません。</p>

<p>最初に rails_admin を更新した rails アプリでは以下のように
devise と pundit と paper_trail の設定をしただけで、
actions などはそのままにしています。</p>

<figure class='code'><figcaption><span>config/initializers/rails_admin.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">RailsAdmin</span><span class="o">.</span><span class="n">config</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">### Popular gems integration</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## == Devise ==</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">authenticate_with</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">warden</span><span class="o">.</span><span class="n">authenticate!</span> <span class="ss">scope</span><span class="p">:</span> <span class="ss">:user</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">current_user_method</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:current_user</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## == Cancan ==</span>
</span><span class='line'>  <span class="c1"># config.authorize_with :cancan</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;rails_admin/extensions/pundit&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">authorize_with</span> <span class="ss">:pundit</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## == PaperTrail ==</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">audit_with</span> <span class="ss">:paper_trail</span><span class="p">,</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="s1">&#39;PaperTrail::Version&#39;</span> <span class="c1"># PaperTrail &gt;= 3.0.0</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">### More at https://github.com/sferik/rails_admin/wiki/Base-configuration</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">actions</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">dashboard</span>                     <span class="c1"># mandatory</span>
</span><span class='line'>    <span class="n">index</span>                         <span class="c1"># mandatory</span>
</span><span class='line'>    <span class="kp">new</span>
</span><span class='line'>    <span class="n">export</span>
</span><span class='line'>    <span class="n">bulk_delete</span>
</span><span class='line'>    <span class="n">show</span>
</span><span class='line'>    <span class="n">edit</span>
</span><span class='line'>    <span class="n">delete</span>
</span><span class='line'>    <span class="n">show_in_app</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">## With an audit adapter, you can add:</span>
</span><span class='line'>    <span class="c1"># history_index</span>
</span><span class='line'>    <span class="c1"># history_show</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[emacsやdistnotedを安定させるパッチをhomebrewで適用した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-29-emacs-distnoted-patch.html"/>
    <updated>2014-01-29T15:59:28+09:00</updated>
    <id>http://blog.n-z.jp/blog/emacs-distnoted-patch</id>
    <content type="html"><![CDATA[<p>Emacs で distnoted が大変なことになる件で、
さらにコメントで追加の情報があったので、
homebrew でのインストール時に
追加のパッチをあてるようにしました。</p>

<!--more-->


<h2>パッチ適用</h2>

<p>適用法としては
<code>brew edit emacs</code>
で以下のように変更して、
<code>brew reinstall emacs</code>
で再インストールしました。
その後の <code>brew update</code> で引っかかる原因になるので、
reinstall したら <code>brew edit emacs</code> で戻しました。</p>

<p>適用されればどこでも良いのですが、最後に追加するようにしてみました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/Library/Formula/emacs.rb b/Library/Formula/emacs.rb</span>
</span><span class='line'><span class="gh">index db7c46c..26ec334 100644</span>
</span><span class='line'><span class="gd">--- a/Library/Formula/emacs.rb</span>
</span><span class='line'><span class="gi">+++ b/Library/Formula/emacs.rb</span>
</span><span class='line'><span class="gu">@@ -49,6 +49,7 @@ class Emacs &lt; Formula</span>
</span><span class='line'>     if build.include? &quot;cocoa&quot; and build.include? &quot;japanese&quot;
</span><span class='line'>       p[:p0].push(&quot;http://sourceforge.jp/projects/macemacsjp/svn/view/inline_patch/trunk/emacs-inline.patch?view=co&amp;revision=583&amp;root=macemacsjp&amp;pathrev=583&quot;)
</span><span class='line'>     end
</span><span class='line'><span class="gi">+    p[:p1].push &quot;https://gist.github.com/anonymous/8553178/raw/c0ddb67b6e92da35a815d3465c633e036df1a105/emacs.memory.leak.aka.distnoted.patch.diff&quot;</span>
</span><span class='line'>     p
</span><span class='line'>   end unless build.head?
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h2>しばらく使ってみて</h2>

<p>inline patch をあてたり外したりして試していた時は時々突然 Emacs 自体が落ちていたのですが、このパッチにしてからは起きていないようです。</p>

<h2>japanese パッチ問題</h2>

<p>別の話として、ことえりの日本語入力の確定直後になぜか「英字」入力状態になってしまうことがあって、カーソルを動かさないと直らないという現象が以前から起きています。
これは inline patch と mavericks の組み合わせで発生しているようなのですが、原因は調べられていません。</p>

<p>文章を入力しにくくなるので、今は</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'>brew uninstall emacs
</span><span class='line'>brew install emacs --cocoa --srgb --with-gnutls
</span><span class='line'>brew linkapps
</span></code></pre></td></tr></table></div></figure>


<p>という感じで <code>--japanese</code> は外した状態でインストールしています。</p>

<p>homebrew でオプションの追加は <code>brew reinstall emacs --japanese</code> のように <code>reinstall</code> でも出来るのに、
外す方は <code>reinstall</code> だと出来ないようなので、
<code>uninstall</code> してから <code>install</code> し直しています。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[yaml_dbでMySQLからPostgreSQLに移行した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-28-yaml-db.html"/>
    <updated>2014-01-28T21:25:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/yaml-db</id>
    <content type="html"><![CDATA[<p>先週 redmine を MySQL から PostgreSQL に移行するときに、最近の ruby では動かなくなっている taps ではなく yaml_db を使ってみました。</p>

<p>その後、自作 Rails アプリでも yaml_db を使って移行しました。</p>

<!--more-->


<h2>yaml_db 選び</h2>

<p>yaml_db は <code>gem install yaml_db</code> でインストールできるものが新しい rails などに
対応していないため fork が乱立していて、どれを使えばいいのか悩ましいのですが、
どこかで見かけた情報を元に
<code>gem 'yaml_db', github: 'jetthoughts/yaml_db', ref: 'fb4b6bd7e12de3cffa93e0a298a1e5253d7e92ba'</code>
を使いました。(今だと別の指定の方が良さそうです。後述)</p>

<p>redmine の場合は <code>Gemfile.local</code> に書いて (なければ作成)、
<code>bundle</code> でインストールすれば使えます。</p>

<h2>データベース移行</h2>

<p>アプリを止めるなどして、データベースの変更が発生しない状態にして移行作業をします。
YAML の互換性の問題などがあるので、データベースの移行と Ruby や Redmine のバージョンアップは別々にした方が良いです。</p>

<ol>
<li>まず <code>RAILS_ENV=production bundle exec rake db:data:dump</code> で <code>db/data.yml</code> を作成します。</li>
<li>つぎに Ruby や Rails や Redmine のバージョンはそのままで <code>config/database.yml</code> を変更します。</li>
<li>必要に応じて <code>bundle</code> でデータベースアダプターの gem をインストールします。</li>
<li>データベースの作成をしたり <code>db:migrate</code> をしておきます。</li>
<li><code>RAILS_ENV=production bundle exec rake db:data:load</code> で読み込みます。</li>
</ol>


<h2>yaml_db の fork の再調査</h2>

<p><a href="https://rubygems.org/gems/yaml_db">yaml_db gem</a> ( <a href="https://github.com/ludicast/yaml_db">ludicast/yaml_db</a> )
からの fork としては
<a href="https://rubygems.org/gems/gitlab_yaml_db">gitlab_yaml_db</a> ( <a href="https://github.com/gitlabhq/yaml_db">gitlabhq/yaml_db</a> ? )
のインストール数が
多いようですが、これは以前の gitlabhq が依存していたからのようです。 (今は依存していない)</p>

<p>新しい fork として
<a href="https://rubygems.org/gems/yaml_db_with_schema_tables">yaml_db_with_schema_tables</a>
( <a href="https://github.com/zweitag/yaml_db">zweitag/yaml_db</a> )
がありましたが、古い yaml_db からの fork なので、新しい rails への対応が入っていないような気がします。
他の fork との違いとして <code>schema_info</code> と <code>schema_migrations</code> も dump するようにしているようです。</p>

<p><a href="https://github.com/jetthoughts/yaml_db">jetthoughts/yaml_db</a> という fork は
rubygems.org にはリリースしていないようですが、
Rails 4 に対応して、 README の <code>This gem is now Rails 3 only.</code> という記述を削除しているなど、メンテナンスが続いていそうなので、
次はこの fork を使うのが良さそうだと思いました。
(古いブログの記事だと <code>gem 'yaml_db', github: 'jetthoughts/yaml_db', branch: 'rails4'</code> で rails4 ブランチを指定している例もあるようですが、 master にマージ済みなので branch 指定は不要です。)</p>

<h2>別 Rails アプリの移行</h2>

<p>続きとして、本日、自作の Rails アプリを <code>jetthoughts/yaml_db</code> を使って移行してみました。</p>

<h3>postgresql のデータベース作成</h3>

<p>データベースの作成は事前に出来るので、
<code>sudo -u postgres psql</code>
で作成しておきます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CREATE ROLE dbuser LOGIN ENCRYPTED PASSWORD 'dbpass' NOINHERIT VALID UNTIL 'infinity';
</span><span class='line'>CREATE DATABASE dbname WITH ENCODING='UTF8' OWNER=dbuser;</span></code></pre></td></tr></table></div></figure>


<p>データベースの作成方法はいつも
<a href="http://www.redmine.org/projects/redmine/wiki/RedmineInstall">RedmineInstall</a>
を参考にしています。</p>

<h3>pg gem</h3>

<p>pg gem も忘れずにあらかじめ入れておきます。</p>

<h3>メンテナンス中画面設定</h3>

<p>まず apache2 + passenger の方でメンテナンス中画面を出すようにしました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;Directory /path/to/app&gt;
</span><span class='line'>    Options FollowSymLinks
</span><span class='line'>    AllowOverride None
</span><span class='line'>    #Order allow,deny
</span><span class='line'>    #allow from all
</span><span class='line'>    Order deny,allow
</span><span class='line'>    deny from all
</span><span class='line'>&lt;/Directory&gt;
</span><span class='line'>ErrorDocument 403 "&#x30e1;&#x30f3;&#x30c6;&#x30ca;&#x30f3;&#x30b9;&#x4e2d;&#x3067;&#x3059;&#x3002;&#x20;&#x3057;&#x3070;&#x3089;&#x304f;&#x304a;&#x5f85;&#x3061;&#x304f;&#x3060;&#x3055;&#x3044;&#x3002;"</span></code></pre></td></tr></table></div></figure>


<p><code>ErrorDocument</code> の埋め込み文字列は <code>Content-Type: text/html;charset=iso-8859-1</code> になってNいたので、
<code>'メンテナンス中です。 しばらくお待ちください。'.unpack('U*').map{|c| '&amp;#x%x;' % c }.join('')</code>
のようにして、すべてエスケープして日本語を埋め込みました。</p>

<p>本来は 5xx のステータスにすべきですが、一時的なものなので 403 で妥協しました。
後日メンテナンスをするときはちゃんと 5xx にしたいと思っています。</p>

<h3>データベースのバックアップとダンプ</h3>

<p>cron で動かしているデータベースのバックアップと yaml_db でのダンプをしました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/path/to/app$ sudo /etc/cron.daily/local-dump
</span><span class='line'>/path/to/app$ $ sudo env PATH=$(dirname $(awk '/PassengerDefaultRuby/{print $2}' /etc/apache2/conf.d/passenger.conf)):$PATH RAILS_ENV=production bundle exec rake db:data:dump</span></code></pre></td></tr></table></div></figure>


<h3>config/database.yml 書き換え</h3>

<p>database.yml で postgresql の方を使うように書き換えます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  adapter: postgresql
</span><span class='line'>  encoding: unicode
</span><span class='line'>  database: dbname
</span><span class='line'>  pool: 5
</span><span class='line'>  username: dbuser
</span><span class='line'>  password: dbpass
</span><span class='line'>  host: localhost
</span><span class='line'>  #port: 5432
</span><span class='line'>  min_messages: warning</span></code></pre></td></tr></table></div></figure>


<h3>データの読み込み</h3>

<p><code>rake db:migrate</code> でマイグレーションを実行した後、
<code>rake db:data:load</code> でデータを読み込みます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/path/to/app$ $ sudo env PATH=$(dirname $(awk '/PassengerDefaultRuby/{print $2}' /etc/apache2/conf.d/passenger.conf)):$PATH RAILS_ENV=production bundle exec rake db:migrate
</span><span class='line'>/path/to/app$ $ sudo env PATH=$(dirname $(awk '/PassengerDefaultRuby/{print $2}' /etc/apache2/conf.d/passenger.conf)):$PATH RAILS_ENV=production bundle exec rake db:data:load</span></code></pre></td></tr></table></div></figure>


<h3>メンテナンス解除と確認</h3>

<p>apache2 の設定を戻して、動作確認します。</p>

<h2>まとめ</h2>

<p>Rails のデータベースの移行に yaml_db を使ってみました。</p>

<p>yaml_db の方が taps より昔からあって、
しばらくメンテナンスが止まっていて、
taps の方が主流になるかと思っていたら、
逆に taps の方がメンテナンスがあまりされなくなって、
yaml_db の方が fork が乱立して、新しい rails に対応したものもでてきて、
結局今のところデータベースの移行には yaml_db が無難という状況になっているようです。</p>

<p>taps は新しい Ruby に対応できていなかったり、
以前の記事に書いたようにスキーマの移行が不十分なところがあったりして、
使われなくなっていくように感じました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[slideshareからのメールが届かなかったのでなんとかした]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-26-slideshare-cannot-send-mail.html"/>
    <updated>2014-01-26T22:07:01+09:00</updated>
    <id>http://blog.n-z.jp/blog/slideshare-cannot-send-mail</id>
    <content type="html"><![CDATA[<p>spam 対策にひっかかって <code>slideshare.net</code> からのメールが届いていなかったので、回避策をとって受け取れるようになったという話です。</p>

<!--more-->


<h2>背景</h2>

<p>spam 対策の手段のひとつとして、メールアドレスのドメインに MX レコードだけ設定して A レコードは設定しないという方法があります。</p>

<p>この方法はまともな MTA を使っている送信元なら MX レコードを見てくれるので問題は起きないはずです。</p>

<p>そして、まともでない MTA だと A レコードがみつからないということで送信できずに諦めているのではないかと思います。
その場合はこちらには全くログが残らないので、本当はどういう状況なのかはわからないので、推測しかできません。</p>

<p>メールサーバーのログを <code>tail -F /var/log/mail.log</code> で確認しながら <code>slideshare.net</code> の確認メールの再送を何度押してもログに出なかったので、もしかしてこの spam 対策にひっかかっているのではないかと推測しました。</p>

<h2>対処</h2>

<p>MX レコードの他に A レコードを追加するという設定はしたくなかったので、
<code>/etc/postfix/main.cf</code> の <code>mydestination</code> に設定していて
A レコードが存在するサブドメインをメールアドレスのドメインとして
<code>slideshare.net</code> のメールアドレスに設定しました。</p>

<p>その結果、確認メールをやっと受け取ることができました。</p>

<h2>まとめ</h2>

<p>世界中で使われているようなサービスでも、まともにメール送信できないようなところが存在するようです。</p>

<p>受信側としては Gmail のように IPv6 でも逆引き必須にしているような特殊な設定をしているところもありますが、
Gmail のように利用者が多いところだと送信側が気付きやすいので、対応していることが多いような気がします。</p>

<p>困った時は Gmail などの利用者が多いドメインのメールアドレスを使って送信側の問題かどうか切り分けるというのも有効だと思います。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第 80 回 関西 Debian 勉強会に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-26-kansai-debian-meeting.html"/>
    <updated>2014-01-26T14:05:18+09:00</updated>
    <id>http://blog.n-z.jp/blog/kansai-debian-meeting</id>
    <content type="html"><![CDATA[<p><a href="https://wiki.debian.org/KansaiDebianMeeting/20140126">第 80 回 関西 Debian 勉強会</a>
に参加してきました。</p>

<p>今回は事前課題の発表で話が盛り上がって、その後の佐々木さんの話も盛り上がって長かったので、もくもくの会は少しだけでした。</p>

<p>事前課題で募集があったので、 LT もしました。</p>

<!--more-->


<h2>メモ</h2>

<p>以下 URL などのメモです。</p>

<ul>
<li>Debian で redmine を使う方法

<ul>
<li>stable を使う</li>
<li>gem2deb</li>
<li>deb パッケージの ruby は使わない</li>
</ul>
</li>
<li>UEFI のマシンでのインストールが大変という話</li>
<li><a href="http://www.docker.io/">docker</a> が <a href="http://packages.qa.debian.org/d/docker.io.html">docker.io</a> という名前で Debian に入っている

<ul>
<li>upstream 側の Ubuntu 用のパッケージ名は <a href="http://docs.docker.io/en/latest/installation/ubuntulinux/">lxc-docker</a></li>
</ul>
</li>
<li><a href="http://jenkins-ci.org/">Jenkins</a></li>
<li><a href="http://jenkins-debian-glue.org/">jenkins-debian-glue</a></li>
<li><a href="https://github.com/rcrowley/freight">freight</a> : A modern take on the Debian archive.</li>
</ul>


<h2>LT しました</h2>

<p>さくらの VPS の Debian wheezy で IPv6 設定をした話の LT 用スライドです。</p>

<ul>
<li><a href="https://github.com/znz/sakura-vps-debian-ipv6">https://github.com/znz/sakura-vps-debian-ipv6</a></li>
<li><a href="http://slide.rabbit-shocker.org/authors/znz/sakura-vps-debian-ipv6/">http://slide.rabbit-shocker.org/authors/znz/sakura-vps-debian-ipv6/</a></li>
<li><a href="https://speakerdeck.com/znz/sakurafalsevpsdeipv6she-ding">https://speakerdeck.com/znz/sakurafalsevpsdeipv6she-ding</a></li>
<li>(<code>slideshare.net</code> は 30分以上たっても Conversion in progress のままなので後で)</li>
</ul>


<p>LT ということで 5 分に収まるような軽い話をしました。
内容としては <a href="http://mla.n-z.jp/?debian-users:56921">debian-users:56921</a> に投稿した内容にちょっと説明を足しました。</p>

<h2>もくもくの会</h2>

<p>13時からと勘違いしていたので、早めに到着して、出発前から作成していた <code>rd2markdown</code> の Web アプリ作成の続きをしていました。
もくもくの時間でも引き続き作業していました。
これは後日公開します。</p>

<h2>まとめ</h2>

<p>今回の <a href="https://wiki.debian.org/KansaiDebianMeeting">関西Debian勉強会</a> は今までの発表をきくのがメインだったのを、変えていっている途中でもくもくの会など、今後どういう内容にしていくのが良いのか、試行錯誤中という感じでした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第59回 Ruby/Rails勉強会＠関西に参加しました]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-25-kansaiworkshop059.html"/>
    <updated>2014-01-25T13:36:50+09:00</updated>
    <id>http://blog.n-z.jp/blog/kansaiworkshop059</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/rubykansai/workshops/wiki/Kansaiworkshop059">第59回 Ruby/Rails勉強会＠関西</a> に参加しました。</p>

<p>一部メモを書いていたので公開しておきます。</p>

<!--more-->


<h2>IT関係の同人誌などの話</h2>

<h3>質疑応答</h3>

<ul>
<li>Q ReVIEW の本は?</li>
<li><p>A 存在を知ったのが後だったので、電子書籍で買っただけ。</p></li>
<li><p>Q いくらぐらい?</p></li>
<li>A コピー本などで無料のものもありますが、たとえば500円とか1200円とか。印刷代などの関係で決まります。</li>
</ul>


<h2>gitlab</h2>

<h3>メモ</h3>

<ul>
<li><a href="http://atnd.org/events/47159">C++テンプレート完全ガイド勉強会 vol.1大阪 : ATND</a></li>
<li><a href="http://qwik.jp/minamirb/">Minami.rb</a></li>
<li><a href="https://wiki.debian.org/KansaiDebianMeeting">関西Debian勉強会</a></li>
<li><a href="http://www.slideshare.net/takafumionaka/is-there-anynecessityofusinggithubenterprise">Gitlab は貧者の github enterprise</a></li>
<li><a href="https://gitorious.org/">Gitorious</a></li>
<li><a href="http://gitblit.com/">Gitblit</a></li>
<li>chef とか puppet とか ansible とかが何か知っている人は会場には少なかった。</li>
<li><a href="https://twitter.com/koichiroo/status/425454305944952832/photo/1">レガシー依存の悪循環こわい</a></li>
<li><a href="http://mrk1869.com/blog/gitlab_installation/">GitLab 6.0をインストールする &ndash; Markovnikov Laboratory</a></li>
<li>「6.2で転けて、6.1で転けて、ここまで設定するのに3日かかった…」と書いてあって大変そうなので、 ansible playbook を使ったという話</li>
<li><a href="http://d.hatena.ne.jp/akishin999/20130819/1376868748">20分(くらい)で GitLab をインストールする方法 &ndash; akishin999の日記</a></li>
<li>svn からの移行には GUI がある方が良い</li>
</ul>


<h2>LT1 ダジャレ</h2>

<ul>
<li>わたしを創ったもの R・C・フェラン 年刊ＳＦ傑作選１</li>
<li>mecab で分解して置き換えてダジャレ生成</li>
<li>変なのもたくさん出てくる</li>
<li>評価関数</li>
</ul>


<h2>Ruby 関西 10 周年</h2>

<ul>
<li><a href="https://k-of.jp/2004/">関西オープンソース 2004</a></li>
<li>2004年11月27日 第0回 Ruby勉強会</li>
<li>大前研一: 人間が変わる方法は3つしかない。 １番目は「時間配分を変える。」 ２番目は「住む場所 を変える。」 ３番目は「つきあう人を変える。」 この３つの要素でしか人間は変わらない。 最も無意味なのは「決意を新たにする」ことだ。</li>
<li>助け合いの力</li>
<li>グラミン銀行</li>
<li>Jim Rohn の名言 : あなたは、あなたのまわりの5人の平均です。</li>
<li><a href="http://thewriteway.com/2011/01/learning-by-doing-revisited/">http://thewriteway.com/2011/01/learning-by-doing-revisited/</a></li>
<li>多様性は善</li>
<li>ハブとしてのRuby関西</li>
</ul>


<h2>Ruby初級者向けレッスン</h2>

<ul>
<li><code>codepoints</code> とは Unicode のだったり、それぞれの encoding のだったり。</li>
<li><code>"Ruby関西".chars.each{|c| puts c}</code> の <code>.each</code> はなくても動くが <code>$VERBOSE=true</code> のときに <code>warning: passing a block to String#chars is deprecated</code> という警告がでる。</li>
<li><a href="https://gist.github.com/higaki/8147246">https://gist.github.com/higaki/8147246</a></li>
<li><a href="https://github.com/higaki/learn_ruby_kansai_59">https://github.com/higaki/learn_ruby_kansai_59</a></li>
</ul>


<h2>帰り際の話</h2>

<ul>
<li>Windows 版の Ruby で 2.0.0 からエスケープシーケンスに対応しているのが、
NEWS に書いていないなどソース以外に情報がない。</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[heroku で passenger を使うようにした]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-24-passenger-ruby-heroku.html"/>
    <updated>2014-01-24T23:23:25+09:00</updated>
    <id>http://blog.n-z.jp/blog/passenger-ruby-heroku</id>
    <content type="html"><![CDATA[<p>今は heroku で動いている <a href="https://bugs.ruby-lang.org/">https://bugs.ruby-lang.org/</a> が thin から passenger に切り替えて安定したという話を IRC で知ったので、自分が heroku で動かしている Rails アプリも passenger に切り替えてみました。
(ruby-lang.org の方はいろいろ試すために今後他のものに切り替える可能性もあります。)</p>

<!--more-->


<h2>概要</h2>

<p><a href="https://github.com/phusion/passenger-ruby-heroku-demo">https://github.com/phusion/passenger-ruby-heroku-demo</a>
を参考にして Gemfile と Procfile を設定するだけです。</p>

<h2>Gemfile の書き換え</h2>

<p><code>gem "unicorn"</code> や  <code>gem "thin"</code> があればコメントアウトするなり削除するなりして、
代わりに <code>gem "passenger"</code> を追加します。</p>

<h2>Procfile の設定</h2>

<p>Procfile がなければ新規作成します。
既存の Procfile があって以下のような行があれば削除します。</p>

<pre><code>web: bundle exec ruby web.rb -p $PORT
web: bundle exec unicorn -p $PORT
web: bundle exec thin start -p $PORT
</code></pre>

<p>Procfile に以下の設定を追加します。</p>

<pre><code>web: bundle exec passenger start -p $PORT --max-pool-size 3
</code></pre>

<h2>切り替え反映</h2>

<p>以下のように切り替えを反映します。</p>

<pre><code>bundle install
git commit -a -m "Switch to Phusion Passenger"
git push heroku master
</code></pre>

<p>ここまでは
<a href="https://github.com/phusion/passenger-ruby-heroku-demo">https://github.com/phusion/passenger-ruby-heroku-demo</a>
の手順そのままです。</p>

<h2>ローカルで使う</h2>

<p><code>gem install foreman</code> で <code>foreman</code> を入れておいて <code>env PORT=3000 foreman start</code> とか、
<code>bundle exec passenger start -p 3000 --max-pool-size 3</code> とかで
3000 番ポートで passenger を使えます。</p>

<p>初回起動時は standalone 版 passenger の初期設定が走るので、
少し時間がかかります。</p>

<h2>まとめ</h2>

<p>あまりアクセスが多くない無料の範囲内で使っている Rails アプリなので、
違いはあまりわかっていませんが、簡単に切り替えられるので、
選択肢のひとつとして使われやすくなるのではないかと思います。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第 7 回 RubyMotion もくもく会 in Osaka に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-22-rubymotion-mokumoku-osaka.html"/>
    <updated>2014-01-22T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-mokumoku-osaka</id>
    <content type="html"><![CDATA[<p>第 1 回から第 6 回にも参加した RubyMotion もくもく会 in Osaka の
<a href="http://connpass.com/event/4560/">第 7 回 RubyMotion もくもく会 in Osaka</a>
に参加してきました。</p>

<p>次回の
<a href="http://connpass.com/event/4910/">第 8 回 RubyMotion もくもく会 in Osaka</a>
は 2/19(水) になりました。</p>

<!--more-->


<h2>もくもく</h2>

<p>今回は初参加の人がいました。</p>

<p>途中は少し質問の話があったり、リリースしたものの話があったりした以外は
基本的にみんなもくもくしていました。</p>

<h2>話に出たもの</h2>

<p>話に出てきたサイトなどのメモです。</p>

<ul>
<li><a href="https://parse.com/">https://parse.com/</a></li>
<li><a href="http://shin1x1.github.io/vagrantx/">http://shin1x1.github.io/vagrantx/</a></li>
<li><a href="https://twitter.com/ametalk">https://twitter.com/ametalk</a></li>
<li><a href="http://orekike.com/history/orekike7">http://orekike.com/history/orekike7</a></li>
<li><a href="http://www.paintcodeapp.com/">http://www.paintcodeapp.com/</a></li>
</ul>


<h2>やっていたこと</h2>

<ul>
<li>ちゃんと名前をつけて <code>motion create</code> からやり直しました。</li>
<li>いらないメニュー項目がほとんどなので、 <code>buildMenu</code> をコメントアウトしてみたら、
Command+q での終了も出来なくなって不便になったので、戻しました。</li>
<li><code>open</code> コマンドでエラーになったときに <code>NSAlert</code> でエラーメッセージを出すようにしました。</li>
</ul>


<h2>引き続き不明な点</h2>

<p>細かいものはいろいろありますが、大きなものは以下の2点です。</p>

<h3>URL の受け取り方</h3>

<p>起動中に <code>open http://localhost:3000</code> のように URL を開いた場合は</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">NSAppleEventManager</span><span class="o">.</span><span class="n">sharedAppleEventManager</span><span class="o">.</span><span class="n">setEventHandler</span><span class="p">(</span>
</span><span class='line'>  <span class="nb">self</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">andSelector</span><span class="p">:</span> <span class="ss">:&#39;handleGetURLEvent:withReplyEvent:&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">forEventClass</span><span class="p">:</span> <span class="no">KInternetEventClass</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">andEventID</span><span class="p">:</span> <span class="no">KAEGetURL</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>で登録しておけば受け取れていますが、
起動していない時に開かれた URL を受け取る方法がわからないままです。</p>

<p><code>open -a Hello --args http://localhost:3000</code> のように起動すれば
<code>NSProcessInfo.processInfo.arguments</code> で取り出せますが、
他のアプリケーションから URL を開いた時に受け取れないので
意味がないです。</p>

<h3>window が閉じられた時の処理</h3>

<p>今のままだと Command+w などで閉じられてしまうと
URL を受け取っても見せる window がなくなっているので
何も出来ないです。</p>

<p>window を閉じられたら終了するか、
閉じられても URL を開いたらまた出てくるようにしたいです。</p>

<h2>まとめ</h2>

<p>今回はみんなもくもくとそれぞれの作業が進んだという感じで、
成果発表もすぐに終わった感じでした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Land of Lisp 読書会 第4回(兵庫県)に参加してきた]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-18-readling-land-of-lisp.html"/>
    <updated>2014-01-18T23:45:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/readling-land-of-lisp</id>
    <content type="html"><![CDATA[<p><a href="http://kokucheese.com/main/tag/amagasakirb">amagasakirb</a>
の
<a href="http://kokucheese.com/event/index/129358/">1月18日 Land of Lisp 読書会 第４回(兵庫県)</a>
に参加してきました。
今回は「第IV部 LISPは科学なり」の最初の方の14章と15章でした。</p>

<p>次回は2月22日ということでした。</p>

<!--more-->




<div style="float:right">
<iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=znz-22&amp;o=9&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=4873115876" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>
</div>


<p>今回は15章の前半が難しくて、あまり進みませんでした。</p>

<p>以下はメモです。</p>

<ul>
<li>p.295 の <code>(when list ...)</code> から <code>(car nil)</code> と <code>(cdr nil)</code> がエラー (例外) ではなく <code>nil</code></li>
<li>データ構造がわかりにくい</li>
<li>よくわからない挿絵よりもデータ構造の図がほしい</li>
<li><code>defstruct</code> を使えば良いのに</li>
<li>C言語やC++で <code>.</code> に比べて <code>-&gt;</code> の入力コストが高い</li>
<li>なぜ hex (六角形) なのか</li>
<li>由来はボードゲームなどで距離の計算がしやすいかららしい</li>
<li>ダイヤモンドゲームは三角形だが、辺と頂点の見方を変えれば六角形</li>
<li><a href="http://ja.wikipedia.org/wiki/%E3%82%B8%E3%82%AA%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5">Geohash</a> とか <a href="http://d.hatena.ne.jp/nayutaya/20110826/1314382637">GeoDelta</a> とか</li>
<li>loop や format がわかりにくい</li>
<li><code>~a</code> とか printf の <code>%</code> と全く違う</li>
<li>「、。」と「，．」(全角)と「,.」(半角) という感じで全角半角も意見が割れた</li>
<li>yen sign (<code>¥</code>) と backslash (<code>\</code>) の話</li>
<li>p.320 選択肢にある 2 &ndash;> 3 の 2 とか 3 とかの説明がない</li>
<li>choose your move: が選択肢の前にあって入力するときは行頭なのが変</li>
<li>p.320 announce-winner関数のアイコンなどは <a href="http://practical-scheme.net/wiliki/wiliki.cgi/Shiro:LandOfLisp">正誤表</a> に載っていた</li>
<li>PDF (第3刷) では直っていた</li>
<li>Ruby の末尾最適化の話

<ul>
<li><code>RubyVM::InstructionSequence.compile_option = { :tailcall_optimization =&gt; true }</code> で変更できる</li>
<li>例: <a href="http://d.hatena.ne.jp/yarb/20121029/p1">CRubyで末尾最適化を使った再帰 &ndash; yarbの日記</a></li>
</ul>
</li>
<li>p.333 スタックトレースが問題になる</li>
</ul>


<p>懇親会での話の一部のメモです。</p>

<ul>
<li>最近は朝とか移動中にオーディオブックを聞いているという話</li>
<li><a href="http://qiita.com/cuzic/items/86f012bba8c17cc98aea">4倍速にしている</a>話</li>
<li>コンテナ物語という本の話 <div style="float:right"><iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=znz-22&amp;o=9&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=4822245640" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe></div></li>
<li>ソードアート・オンラインは1巻だけでも良いのでオススメという話 <div style="float:right"><iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=znz-22&amp;o=9&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=4048677608" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe></div></li>
<li>なれる!SE は1巻には1と付いていないという話 <div style="float:right"><iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=znz-22&amp;o=9&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=4048686054" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe></div></li>
<li><a href="http://ascii.jp/elem/000/000/760/760389/">ASCII.jp：なれる！ＳＥ 間違いだらけの？ＩＴ用語辞典（中二版）</a></li>
<li><a href="http://qiita.com/advent-calendar/2013/ruby-on-rails">Ruby on Rails Advent Calendar 2013</a> のときから qiita に書くようになって、最近は<a href="http://qiita.com/cuzic">いろいろ書いている</a>という話</li>
<li>Ruby の id3 のライブラリが SJIS を latin-1 と解釈して UTF-8 に変換してしまって化けていたという話</li>
<li><a href="http://en.wikipedia.org/wiki/ID3#cite_ref-5">ID3タグの文字コードは latin-1 か Unicode</a> ということになっているのでライブラリとしては仕様通りの挙動だが日本語圏では latin-1 として実体は SJIS を入れていることが多いため問題が生じる</li>
<li><a href="http://homepage1.nifty.com/nomenclator/unicode/normalization.htm">Unicode正規化</a> の話</li>
<li>Unicode 絵文字の色情報はどこからきているのかわからないという話</li>
<li>OpenType とかのフォントには色情報は入らないはずなので別途どこかに持っている?</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[tapsでMySQLからPostgreSQLに移行した後に起きたトラブル事例]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-12-taps-trouble.html"/>
    <updated>2014-01-12T14:15:41+09:00</updated>
    <id>http://blog.n-z.jp/blog/taps-trouble</id>
    <content type="html"><![CDATA[<p>2013年7月ごろに <a href="http://rubygems.org/gems/taps">taps</a> を使って redmine のデータベースを MySQL から PostgreSQL に移行しました。</p>

<p>その時に移行が不十分で問題が少し起きていたので、その原因を調べて修正しました。</p>

<!--more-->


<h2>taps での移行</h2>

<p>taps の使い方については既に情報がたくさんあるので、簡単に書いておくだけにします。
昨年7月時点の情報なので、今だとさらにバージョン指定を増やさないとダメかもしれません。</p>

<p>まず、 Ruby 1.9.1 以降に対応できていないようなので、 Ruby 1.8.7 を使いました。
rack も新しいバージョンに対応できていないので、以下のような Gemfile でバージョンを指定して<code>bundle install --path vendor/bundle</code> して使いました。</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">source</span> <span class="s2">&quot;https://rubygems.org&quot;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;taps&quot;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;sqlite3&quot;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;mysql&quot;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;pg&quot;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;rack&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0.1&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>元の <code>config/database.yml</code> の設定が</p>

<figure class='code'><figcaption><span>config/database.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql2</span>
</span><span class='line'>  <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">redmine_db</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">redminemyuser</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my_password</span>
</span><span class='line'>  <span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">utf8</span>
</span></code></pre></td></tr></table></div></figure>


<p>という感じなら、 MySQL を動かしている方で
<code>bundle exec taps server mysql://redminemyuser:my_password@localhost/redmine_db tapsuser tapspass</code>
と起動します。</p>

<p>PostgreSQL の方では</p>

<figure class='code'><figcaption><span>sudo -u postgres psql</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">CREATE ROLE redminepguser LOGIN ENCRYPTED PASSWORD &#39;pg_password&#39; NOINHERIT VALID UNTIL &#39;infinity&#39;;</span>
</span><span class='line'><span class="go">CREATE DATABASE redmine_db WITH ENCODING=&#39;UTF8&#39; OWNER=redminepguser;</span>
</span></code></pre></td></tr></table></div></figure>


<p>という感じでデータベースを作っておいて、
<code>bundle exec taps pull postgres://redminepguser:pg_password@localhost/redmine_db http://tapsuser:tapspass@localhost:5000</code>
という感じでデータを移行しました。</p>

<p>同じサーバーで移行したので taps の http も localhost にしていますが、別サーバーなら ssh のポートフォワーディングなどを使ってつなげば良いと思います。</p>

<h2>redmine でのトラブル</h2>

<p>管理者権限でログインして、管理からグループを追加 (/groups/new) しようとするとエラーになって、 log/production.log を確認すると
<code>ActiveRecord::StatementInvalid (PG::NotNullViolation: ERROR:  null value in column "mail_notification" violates not-null constraint</code>
または
<code>(ActiveRecord::StatementInvalid (PG::NotNullViolation: ERROR:  列"mail_notification"内のNULL値はNOT NULL制約違反です</code>
というエラーが出ていました。</p>

<h2>トラブルの原因</h2>

<p>いろいろ調べてみると <code>db/schema.rb</code> でいうと <code>mail_notification</code> に default がないのが問題だとわかりました。
後で追加調査したところ、 default が <code>""</code> (空文字列) のときにうまく移行できていないことがあるようでした。</p>

<h2>原因修正</h2>

<p><code>rails dbconsole</code> で
<code>ALTER TABLE users ALTER mail_notification SET DEFAULT '';</code>
で設定して、
<code>rake db:migrate</code> で <code>db/schema.rb</code> にも反映して
redmine を再起動すると直りました。</p>

<h2>その他の DEFAULT の修正</h2>

<p>別途 PostgreSQL の環境を用意して redmine を新規インストールして <code>rake db:migrate</code> で生成した <code>db/schema.rb</code> と比較して全体としては以下の修正をしました。</p>

<figure class='code'><figcaption><span>rails dbconsole</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">attachments</span> <span class="k">ALTER</span> <span class="n">filename</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">attachments</span> <span class="k">ALTER</span> <span class="n">disk_filename</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">attachments</span> <span class="k">ALTER</span> <span class="n">content_type</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">attachments</span> <span class="k">ALTER</span> <span class="n">digest</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">auth_sources</span> <span class="k">ALTER</span> <span class="k">type</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">auth_sources</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">auth_sources</span> <span class="k">ALTER</span> <span class="n">account_password</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">boards</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">changes</span> <span class="k">ALTER</span> <span class="n">action</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">comments</span> <span class="k">ALTER</span> <span class="n">commented_type</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">custom_fields</span> <span class="k">ALTER</span> <span class="k">type</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">custom_fields</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">custom_fields</span> <span class="k">ALTER</span> <span class="n">field_format</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">custom_fields</span> <span class="k">ALTER</span> <span class="n">regexp</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">custom_values</span> <span class="k">ALTER</span> <span class="n">customized_type</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">documents</span> <span class="k">ALTER</span> <span class="n">title</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">enumerations</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">wiki_contents</span> <span class="k">ALTER</span> <span class="n">comments</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">issue_categories</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">issue_relations</span> <span class="k">ALTER</span> <span class="n">relation_type</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">issue_statuses</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">issues</span> <span class="k">ALTER</span> <span class="n">subject</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">journal_details</span> <span class="k">ALTER</span> <span class="n">property</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">journal_details</span> <span class="k">ALTER</span> <span class="n">prop_key</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">journals</span> <span class="k">ALTER</span> <span class="n">journalized_type</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">messages</span> <span class="k">ALTER</span> <span class="n">subject</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">news</span> <span class="k">ALTER</span> <span class="n">title</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">news</span> <span class="k">ALTER</span> <span class="n">summary</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">projects</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">projects</span> <span class="k">ALTER</span> <span class="n">homepage</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">queries</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">repositories</span> <span class="k">ALTER</span> <span class="n">url</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">repositories</span> <span class="k">ALTER</span> <span class="n">login</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">repositories</span> <span class="k">ALTER</span> <span class="n">password</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">repositories</span> <span class="k">ALTER</span> <span class="n">root_url</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">roles</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">settings</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tokens</span> <span class="k">ALTER</span> <span class="n">action</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">tokens</span> <span class="k">ALTER</span> <span class="n">value</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">trackers</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="k">ALTER</span> <span class="n">hashed_password</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="k">ALTER</span> <span class="n">firstname</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="k">ALTER</span> <span class="n">mail</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="k">ALTER</span> <span class="k">language</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">versions</span> <span class="k">ALTER</span> <span class="n">name</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">versions</span> <span class="k">ALTER</span> <span class="n">description</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">watchers</span> <span class="k">ALTER</span> <span class="n">watchable_type</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">wiki_content_versions</span> <span class="k">ALTER</span> <span class="n">compression</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">wiki_content_versions</span> <span class="k">ALTER</span> <span class="n">comments</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="k">ALTER</span> <span class="n">mail_notification</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="k">ALTER</span> <span class="n">lastname</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>rails dbconsole</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="k">ALTER</span> <span class="n">mail_notification</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>はすでに実行済みで、</p>

<figure class='code'><figcaption><span>rails dbconsole</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="k">ALTER</span> <span class="n">lastname</span> <span class="k">SET</span> <span class="k">DEFAULT</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>は既に default が <code>""</code> になっていたので不要でしたが、
重複して実行しても問題が起きないようなので、上の SQL にも入れています。</p>

<h2>まとめ</h2>

<p>最初のデータベース選択は重要で、アプリケーションが両方対応していても、後から変更するのは大変です。</p>

<p>問題が起きそうなデータ型を使っていなければ <code>taps</code> ですんなり移行できるように見えますが、別途クリーンな環境を用意して生成した <code>db/schema.rb</code> と比較するなどのチェックも必要でした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[virtualboxでdkmsによるモジュールのリビルドが動いていなかったので対処した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-04-virtualbox-dkms.html"/>
    <updated>2014-01-04T23:47:41+09:00</updated>
    <id>http://blog.n-z.jp/blog/virtualbox-dkms</id>
    <content type="html"><![CDATA[<p>Ubuntu 12.04.3 LTS の環境で
virtualbox.org から入れた VirtualBox を
virtualbox-4.2 (4.2.20-90983~Ubuntu~precise)
から
virtualbox-4.3 (4.3.6-91406~Ubuntu~precise)
にあげても dkms によるモジュールのリビルドがちゃんと動かないままだったので、
直し方を調べて対処してみました。</p>

<!--more-->


<h2>状況</h2>

<p>カーネルを linux-image-3.8.0-34-generic から
linux-image-3.8.0-35-generic にあげるときに
virtualbox-4.2 (4.2.20-90983~Ubuntu~precise)
から
virtualbox-4.3 (4.3.6-91406~Ubuntu~precise)
にあげました。</p>

<p>以下の作業は linux-image-3.8.0-34-generic で起動中に
再起動後に使われる linux-image-3.8.0-35-generic 用の
VirtualBox のカーネルモジュールをビルドしようとしています。</p>

<h2>エラーの状況</h2>

<p><code>dkms status</code> で調べると以下のエラーメッセージが出る状態でした。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ sudo dkms status</span>
</span><span class='line'><span class="go">  Error! Could not locate dkms.conf file.</span>
</span><span class='line'><span class="go">  File:  does not exist.</span>
</span></code></pre></td></tr></table></div></figure>


<h2>対処その1</h2>

<p><code>/var/lib/dkms/vboxhost</code> を退避して
<code>dpkg-reconfigure</code> しなおせば良いという情報があったので
試してみました。</p>

<p>この段階での <code>dkms status</code> は調べ忘れていたのですが、
後の状況からすると
今起動中のカーネルのモジュールだけビルドされたようです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ sudo mv /var/lib/dkms/vboxhost /tmp/</span>
</span><span class='line'><span class="go">  $ sudo dpkg-reconfigure virtualbox-4.3</span>
</span><span class='line'><span class="go">  Stopping VirtualBox kernel modules ...done.</span>
</span><span class='line'><span class="go">  addgroup: グループ `vboxusers&#39; はシステムグループとしてすでに存在しています。終了します。</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;all/all&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;all/allfiles&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/mms&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/mmst&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/mmsu&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/pnm&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/rtspt&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/rtspu&#39;</span>
</span><span class='line'><span class="go">  Stopping VirtualBox kernel modules ...done.</span>
</span><span class='line'><span class="go">  Uninstalling old VirtualBox DKMS kernel modules ...done.</span>
</span><span class='line'><span class="go">  Removing old VirtualBox pci kernel module ...done.</span>
</span><span class='line'><span class="go">  Removing old VirtualBox netadp kernel module ...done.</span>
</span><span class='line'><span class="go">  Removing old VirtualBox netflt kernel module ...done.</span>
</span><span class='line'><span class="go">  Removing old VirtualBox kernel module ...done.</span>
</span><span class='line'><span class="go">  Trying to register the VirtualBox kernel modules using DKMS ...done.</span>
</span><span class='line'><span class="go">  Starting VirtualBox kernel modules ...done.</span>
</span></code></pre></td></tr></table></div></figure>


<h2>対処その2</h2>

<p>purge した古いカーネルのモジュールが残っていたので、
削除しました。
安全のため <code>/tmp</code> への移動にしていますが、
いきなり <code>rm -rf</code> で削除しても良いと思います。
他の古いバージョンも残っていれば削除してしまっても
大丈夫だと思います。</p>

<p>ねんのため
<code>/etc/init.d/vboxdrv setup</code>
を実行してみましたが、
<code>dpkg-reconfigure</code>
で既に実行済みだったので関係なかったようです。</p>

<p>この段階で <code>dkms status</code> を確認してみると
起動中のカーネルのモジュールだけビルドされていることがわかります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ sudo mv /lib/modules/3.8.0-33-generic/ /tmp/</span>
</span><span class='line'><span class="go">  $ sudo /etc/init.d/vboxdrv setup</span>
</span><span class='line'><span class="go">  Stopping VirtualBox kernel modules ...done.</span>
</span><span class='line'><span class="go">  Uninstalling old VirtualBox DKMS kernel modules ...done.</span>
</span><span class='line'><span class="go">  Trying to register the VirtualBox kernel modules using DKMS ...done.</span>
</span><span class='line'><span class="go">  Starting VirtualBox kernel modules ...done.</span>
</span><span class='line'><span class="go">  $ sudo dkms status</span>
</span><span class='line'><span class="go">  vboxhost, 4.3.6, 3.8.0-34-generic, x86_64: installed</span>
</span></code></pre></td></tr></table></div></figure>


<h2>対処その3</h2>

<p>dkms でのモジュールのビルドは
<code>/etc/kernel/postinst.d/dkms</code>
で実行されているので、
カーネルを再インストールすれば確実ということで、
カーネルを <code>aptitude reinstall</code> しました。</p>

<p>その結果、正常にビルドされていることが確認できたので、
再起動して VirtualBox の動作確認をしました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ sudo aptitude reinstall linux-image-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  以下のパッケージが再インストールされます:</span>
</span><span class='line'><span class="go">    linux-image-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  0 個のパッケージを更新、 0 個を新たにインストール、 再インストール: 1 個、 0 個を削除予定 、0 個が更新されていない。</span>
</span><span class='line'><span class="go">  アーカイブ 48.2 M バイト中 0  バイトを取得する必要があります。 展開後に 0  バイトのディス ク領域が新たに消費されます。</span>
</span><span class='line'><span class="go">  (データベースを読み込んでいます ... 現在 117478 個のファイルとディレクトリがインストールされています。)</span>
</span><span class='line'><span class="go">  linux-image-3.8.0-35-generic 3.8.0-35.50~precise1 を (.../linux-image-3.8.0-35-generic_3.8.0-35.50~precise1_amd64.deb で) 置換するための準備をしています ...</span>
</span><span class='line'><span class="go">  Done.</span>
</span><span class='line'><span class="go">  linux-image-3.8.0-35-generic を展開し、置換しています...</span>
</span><span class='line'><span class="go">  Examining /etc/kernel/postrm.d .</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postrm.d/initramfs-tools 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postrm.d/zz-update-grub 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  linux-image-3.8.0-35-generic (3.8.0-35.50~precise1) を設定しています ...</span>
</span><span class='line'><span class="go">  Running depmod.</span>
</span><span class='line'><span class="go">  update-initramfs: deferring update (hook will be called later)</span>
</span><span class='line'><span class="go">  Not updating initrd symbolic links since we are being updated/reinstalled</span>
</span><span class='line'><span class="go">  (3.8.0-35.50~precise1 was configured last, according to dpkg)</span>
</span><span class='line'><span class="go">  Not updating image symbolic links since we are being updated/reinstalled</span>
</span><span class='line'><span class="go">  (3.8.0-35.50~precise1 was configured last, according to dpkg)</span>
</span><span class='line'><span class="go">  Examining /etc/kernel/postinst.d.</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/apt-auto-removal 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/dkms 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/initramfs-tools 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  update-initramfs: Generating /boot/initrd.img-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/pm-utils 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/update-notifier 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/zz-update-grub 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  Generating grub.cfg ...</span>
</span><span class='line'><span class="go">  Found linux image: /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  Found initrd image: /boot/initrd.img-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  Found linux image: /boot/vmlinuz-3.8.0-34-generic</span>
</span><span class='line'><span class="go">  Found initrd image: /boot/initrd.img-3.8.0-34-generic</span>
</span><span class='line'><span class="go">  Found memtest86+ image: /memtest86+.bin</span>
</span><span class='line'><span class="go">  done</span>
</span><span class='line'><span class="go">  $ sudo dkms status</span>
</span><span class='line'><span class="go">  vboxhost, 4.3.6, 3.8.0-34-generic, x86_64: installed</span>
</span><span class='line'><span class="go">  vboxhost, 4.3.6, 3.8.0-35-generic, x86_64: installed</span>
</span><span class='line'><span class="go">  $</span>
</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>古いバージョンは再起動で消えてしまって確認できないのですが、
多分古い VirtualBox では
<code>/var/lib/dkms/vboxhost/*/source/dkms.conf</code>
が存在していなくて、
バージョンを上げても古いバージョンの <code>source</code> が残ったままだと
同じエラーが出続けるようなので、
クリーンインストールやそれに近い状態にすると直るということのようです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RubyMotionのOSXアプリの起動エラー]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-28-rubymotion-error.html"/>
    <updated>2013-12-28T18:55:18+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-error</id>
    <content type="html"><![CDATA[<p>最近 RubyMotion で作っている OSX アプリが
<code>LSOpenURLsWithRole() failed with error -10810</code>
などで起動しないことがあったので原因を調べてみました。</p>

<!--more-->


<h2>LSOpenURLsWithRole() failed with error -10810</h2>

<h3>よくある原因</h3>

<p><code>Hello.app/Contents/MacOS/Hello</code>
のような実行ファイルの実体に実行属性が外れているというのが
よくある原因のようで、
<a href="http://owncloud.org/">ownCloud</a>
経由で同期したアプリが実行できなかったときは
これが原因でした。</p>

<h3>別の原因</h3>

<p>実行属性も問題なくて悩んでいたときに
コンソール (Console.app) のログを見てみると</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2013/12/28 10:39:17.963 open[85406]: spawn_via_launchd() failed, errno=22 label=com.yourcompany.Hello.44032 path=.../Hello/build/MacOSX-10.9-Development/Hello.app/Contents/MacOS/Hello flags=0 : LaunchApplicationClient.cp #1168 LaunchApplicationViaLaunchDJobLabel() q=com.apple.main-thread</span></code></pre></td></tr></table></div></figure>


<p>のようなログが出ていたので、
<code>LaunchApplicationViaLaunchDJobLabel</code>
で検索してみたところ、
<a href="http://portingteam.com/topic/9723-mavericks-problem-opening-fresh-wrapper/">Mavericks problem opening fresh wrapper</a>
という話が見つかって、
そこに書いてあった</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>launchctl remove $(launchctl list | grep wineskin | awk '{ print $3 }')</span></code></pre></td></tr></table></div></figure>


<p>という手順を参考にして解決しました。</p>

<p><code>Hello</code> が2個残っていて、
<code>$()</code> だとダメだったので個別に <code>launchctl remove</code> しました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% launchctl list | grep Hello
</span><span class='line'>- 2   com.yourcompany.Hello.44032
</span><span class='line'>- 0   com.yourcompany.Hello.53008
</span><span class='line'>%  launchctl remove $(launchctl list | awk '/Hello/{print $3}')
</span><span class='line'>usage: launchctl remove &lt;job label&gt;
</span><span class='line'>zsh: exit 1     launchctl remove $(launchctl list | awk '/Hello/{print $3}')
</span><span class='line'>%  echo launchctl remove $(launchctl list | awk '/Hello/{print $3}')
</span><span class='line'>launchctl remove com.yourcompany.Hello.44032 com.yourcompany.Hello.53008
</span><span class='line'>%  launchctl remove com.yourcompany.Hello.44032
</span><span class='line'>%  launchctl remove com.yourcompany.Hello.53008
</span><span class='line'>%  open -a Hello</span></code></pre></td></tr></table></div></figure>


<h3>その他</h3>

<p>その他の対象方法も含めて
<a href="http://www.thexlab.com/faqs/error-10810.html">Error -10810 Openng Applictions or Relaunching Finder</a>
にいろいろ書いてあるようです。
(英語で長かったのでちゃんと読んでません。)</p>

<h2>MacBookPro6,2 で EXC_BAD_INSTRUCTION (SIGILL) になって起動しない</h2>

<p>未解決です。</p>

<p><a href="https://github.com/MohawkApps/Hacker-Bar/issues/36">EXC_BAD_INSTRUCTION crash in App Store version&hellip;</a>
に似た話があって、
RubyMotion のバグっぽいという話のようです。</p>

<p><code>motion create --template=osx HelloOSX</code>
で作成しただけのものでも
<a href="https://gist.github.com/znz/8158061#file-helloosx-report-txt">クラッシュ</a>
して起動しませんでした。</p>

<p>RubyMotion を入れている自分の MacBook Air の環境の問題かどうかを切り分けるために
<a href="http://shin1x1.github.io/vagrantx/">VagrantX</a>
も試してみましたが、
<a href="https://gist.github.com/znz/8158061#file-vagrantx-report-txt">同じくクラッシュ</a>
して起動しませんでした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[distnotedの暴走が止まるというCocoa Emacsのinline patch修正版を使ってみた]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-27-emacs-inline-patch.html"/>
    <updated>2013-12-27T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/emacs-inline-patch</id>
    <content type="html"><![CDATA[<p><a href="http://blog.n-z.jp/blog/2013-11-13-killall-distnoted-periodically.html">launchdでdistnotedを定期的に終了させる</a>
話のコメントで
<a href="https://gist.github.com/anonymous/8142555">Emacs.appでインラインパッチを当てた時にdistnotedが暴走しなくなる</a>
修正を教えてもらったので、
試してみました。</p>

<p>2014-01-29追記:
コメントにあるようにまだ問題があったので、続きとして
<a href="http://blog.n-z.jp/blog/2014-01-29-emacs-distnoted-patch.html">emacsやdistnotedを安定させるパッチをhomebrewで適用した</a>
話を書きました。</p>

<!--more-->


<h2>homebrew で適用するパッチの変更</h2>

<p>適用法としては
<code>brew edit emacs</code>
で以下のように変更して、
<code>brew reinstall emacs</code>
で再インストールしました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/Library/Formula/emacs.rb b/Library/Formula/emacs.rb</span>
</span><span class='line'><span class="gh">index 712c3d1..5ce4ce2 100644</span>
</span><span class='line'><span class="gd">--- a/Library/Formula/emacs.rb</span>
</span><span class='line'><span class="gi">+++ b/Library/Formula/emacs.rb</span>
</span><span class='line'><span class="gu">@@ -47,7 +47,7 @@ class Emacs &lt; Formula</span>
</span><span class='line'>     # &quot;--japanese&quot; option:
</span><span class='line'>     # to apply a patch from MacEmacsJP for Japanese input methods
</span><span class='line'>     if build.include? &quot;cocoa&quot; and build.include? &quot;japanese&quot;
</span><span class='line'><span class="gd">-      p[:p0].push(&quot;http://sourceforge.jp/projects/macemacsjp/svn/view/inline_patch/trunk/emacs-inline.patch?view=co&amp;revision=583&amp;root=macemacsjp&amp;pathrev=583&quot;)</span>
</span><span class='line'><span class="gi">+      p[:p0].push(&quot;https://gist.github.com/anonymous/8142555/raw/d67ad1dc814579d125afbd18de3a62ba69895601/emacs-inline.patch&quot;)</span>
</span><span class='line'>     end
</span><span class='line'>     p
</span><span class='line'>   end unless build.head?
</span></code></pre></td></tr></table></div></figure>


<h2>元のパッチからの変更点</h2>

<p>元の sourceforge.jp のパッチとの差分をとってみると、
以下のメソッド呼び出しが変わっているだけでした。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/emacs-inline.patch.sfjp b/emacs-inline.patch.gist</span>
</span><span class='line'><span class="gh">index 52f2052..d67ad1d 100644</span>
</span><span class='line'><span class="gd">--- a/emacs-inline.patch.sfjp</span>
</span><span class='line'><span class="gi">+++ b/emacs-inline.patch.gist</span>
</span><span class='line'><span class="gu">@@ -1015,7 +1015,7 @@ diff -r -N -p ../emacs-24.3.org/src/nsterm.m src/nsterm.m</span>
</span><span class='line'>                                                name: nil object: nil]; */
</span><span class='line'> +   [[NSDistributedNotificationCenter defaultCenter] addObserver: NSApp
</span><span class='line'> +                    selector: @selector (changeInputMethod:)
</span><span class='line'><span class="gd">-+                          name: @&quot;AppleSelectedInputSourcesChangedNotification&quot; object: nil];</span>
</span><span class='line'><span class="gi">++                          name: @&quot;AppleSelectedInputSourcesChangedNotification&quot; object: nil suspensionBehavior:NSNotificationSuspensionBehaviorDeliverImmediately];</span>
</span><span class='line'>
</span><span class='line'>     dpyinfo = xzalloc (sizeof *dpyinfo);
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>使ってみて問題がなければ sourceforge.jp の方に取り込んでもらうのが良さそうです。</p>

<p>しばらく使ってみた感じだと distnoted のメモリ使用量が増えていっても、
一度 Emacs.app を終了すると distnoted のメモリ使用量が一気に減るようになりました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第 6 回 RubyMotion もくもく会 in Osaka に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-26-rubymotion-mokumoku-osaka.html"/>
    <updated>2013-12-26T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-mokumoku-osaka</id>
    <content type="html"><![CDATA[<p>第 1 回から第 5 回にも参加した RubyMotion もくもく会 in Osaka の
<a href="http://connpass.com/event/4211/">第 6 回 RubyMotion もくもく会 in Osaka</a>
に参加してきました。</p>

<p>次回の
<a href="http://connpass.com/event/4560/">第 7 回 RubyMotion もくもく会 in Osaka</a>
は 1/22(水) になりました。</p>

<!--more-->


<h2>話に出たもの</h2>

<p>話に出てきたサイトなどのメモです。</p>

<ul>
<li><a href="http://shin1x1.github.io/vagrantx/">http://shin1x1.github.io/vagrantx/</a>

<ul>
<li>URL が小文字に変わっていました。</li>
</ul>
</li>
<li><a href="https://www.cocoacontrols.com/">Cocoa Controls</a></li>
<li><a href="http://getpocket.com/">Pocket</a></li>
<li><a href="http://71squared.com/ja/particledesigner">Particle Designer</a></li>
<li>UIMotionEffect で視差効果が簡単に実装できる</li>
<li>All Cast という Android アプリで Apple TV に AirPlay できる</li>
</ul>


<h2>やっていたこと</h2>

<p>今回は前回作り始めていたデフォルトブラウザを乗っ取って、
Firefox とか Chrome とか Safari とかに起動し分けられる
OSX アプリの作成の続きをやっていました。</p>

<p>今回の最後ではスクリーンショットのようになりました。</p>

<p><img src="http://blog.n-z.jp/images/2013-12-26-hello.png" title="screenshot" alt="作成途中のアプリのスクリーンショット"></p>

<p>適当に作った Hello.app に動作確認用のメソッドを付け足していただけなので、
まだタイトルは Hello のままになっています。</p>

<h3>URL 受け取り問題</h3>

<p>LimeChat で URL をクリックしたときなどに受け取るのは
前回調べていた <code>LSSetDefaultHandlerForURLScheme</code> での
デフォルトブラウザ設定とあわせて、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">NSAppleEventManager</span><span class="o">.</span><span class="n">sharedAppleEventManager</span><span class="o">.</span><span class="n">setEventHandler</span><span class="p">(</span>
</span><span class='line'>  <span class="nb">self</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">andSelector</span><span class="p">:</span> <span class="ss">:&#39;handleGetURLEvent:withReplyEvent:&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">forEventClass</span><span class="p">:</span> <span class="no">KInternetEventClass</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">andEventID</span><span class="p">:</span> <span class="no">KAEGetURL</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>でイベントを受け取ると Hello.app 起動中は受け取れたのですが、
起動していない時の URL クリックのイベントを受け取れない問題は
結局解決できませんでした。</p>

<p><code>open -a Hello --args URL</code>
というなら
<code>NSProcessInfo.processInfo.arguments</code>
で受け取れるのですが、
LimeChat などでの URL クリックで起動された時や
<code>open -a Hello URL</code>
という起動方法だと受け取り方がわかりませんでした。</p>

<p>他のブラウザの起動も
<code>open -a 'Google Chrome' http://localhost:4000/ --args -incognito</code>
のように URL は args ではない方法で渡さないと開けませんでした。</p>

<h3><code>keyDirectObject</code> がない問題と前面に出てこない問題</h3>

<p>URL の受け取り部分は今のところ、以下のようにしています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">handleGetURLEvent</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="ss">withReplyEvent</span><span class="p">:</span> <span class="n">replyEvent</span><span class="p">)</span>
</span><span class='line'>    <span class="n">keyDirectObject</span> <span class="o">=</span> <span class="s1">&#39;----&#39;</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>    <span class="n">urlStr</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">paramDescriptorForKeyword</span><span class="p">(</span><span class="n">keyDirectObject</span><span class="p">)</span><span class="o">.</span><span class="n">stringValue</span>
</span><span class='line'>    <span class="vi">@text</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="n">urlStr</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Process</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="s2">&quot;osascript&quot;</span><span class="p">,</span> <span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">SCRIPT</span><span class="p">)</span>
</span><span class='line'><span class="sh">tell Application &quot;#{NSBundle.mainBundle.infoDictionary[&#39;CFBundleName&#39;]}&quot;</span>
</span><span class='line'><span class="sh">  activate</span>
</span><span class='line'><span class="sh">end tell</span>
</span><span class='line'><span class="no">    SCRIPT</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>最初の問題として、
<code>keyDirectObject</code> が RubyMotion にはなさそうだったので、
値を調べて <code>unpack</code> で同等の値を生成するようにしました。
この部分は前回から今回までの間に調査して作成済みだったので、
詳しい調査方法は忘れてしまいましたが、
引数のオブジェクトを調べて見つけたような気がします。</p>

<p>前面に出てこない問題は
今回のもくもく会の間に対処しました。</p>

<p>前面に持ってくる方法がどういう API を呼べばよいのかわからず、
AppleScript を使った方法は情報があったので、
とりあえず <code>osascript</code> を呼び出してしまうことにしました。</p>

<p>最初は <code>spawn</code> ではなく <code>system</code> を使ってしまったら、
デッドロックしてしまって強制終了するしかなくなってしまったので、
<code>Process.spawn</code> を使いました。</p>

<h2>まとめ</h2>

<p>今回は作りたいものが決まっていて、しっかりもくもく出来ました。</p>

<p>起動時に URL が受け取れない問題は
自分が使うだけなら
URL を 2 回クリックするという方法で
回避できるのですが、なんとかしたいところです。</p>

<p><code>keyDirectObject</code> と <code>osascript</code> を使っているところは
他に方法がなければ
今のままでも実用上は困らないと感じました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[weechat-cursesでの罫線の文字幅問題を回避する]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-25-weechat-curses.html"/>
    <updated>2013-12-25T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/weechat-curses</id>
    <content type="html"><![CDATA[<p>サーバー上の端末の中で使える IRC クライアントとして
<code>weechat-curses</code> をちょっと試しているのですが、
<code>│</code> (U+2502 BOX DRAWINGS LIGHT VERTICAL)
で罫線文字の文字幅問題が発生してずれるという現象に困っていたので、
問題を回避する設定をしてみました。</p>

<!--more-->


<h2>設定</h2>

<p><code>│</code> (U+2502) の代わりに <code>|</code> (U+007C VERTICAL LINE)
を使うだけなら、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/set weechat.look.separator_vertical "|"</span></code></pre></td></tr></table></div></figure>


<p>でいけます。</p>

<h2>問題の文字が使われている場所</h2>

<p>weechat の画面で問題が起きている行は</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>時刻 nickなどのprefix 左の縦線(|) メッセージ 右の縦線(│) nick一覧</span></code></pre></td></tr></table></div></figure>


<p>のようになっていて、最初は両方の縦線が問題になっているのかと
勘違いしていたのですが、実際には右側の方だけでした。</p>

<p>左側の縦線の部分の設定は <code>weechat.look.prefix_suffix</code> で、
右側は <code>weechat.look.separator_vertical</code> です。</p>

<p>左側の方はデフォルトで <code>"|"</code> になっていて、問題はありませんでした。</p>

<p>右側の方はデフォルトでは <code>""</code> (空文字列) になっていて、
その場合は ncurses で縦線を描画するという意味になって、
問題が起きていました。</p>

<p>たとえば <code>":"</code> などに設定を変えてみるとどっちがどっちなのか
よくわかると思います。</p>

<h2>まとめ</h2>

<p>weechat を試していて、ずっと困っていた問題が解決できたので、
これからもうちょっと使ってみようと思えるようになりました。</p>

<p>Web で検索しても全く情報がみつからなかったのですが、
誰も困っていなかったのでしょうか。
英語圏だと困らなさそうですが、日本語圏でも使っている人はいそうなのに
情報がないのは他のコマンドも含めて対処していて困っていないからなのか、
気にせずずれるまま使っているからなのかが気になりました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dockerで不要になったコンテナやイメージを削除する]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-24-docker-rm.html"/>
    <updated>2013-12-24T11:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/docker-rm</id>
    <content type="html"><![CDATA[<p>Docker を使い続けてコンテナやイメージを放置していると差分だけとはいえ、
ディスクの消費が増えていって、
<code>書き込みエラー: デバイスに空き領域がありません</code>
(<code>ENOSPC</code>, <code>write error: No space left on device</code>)
というエラーになってしまいます。</p>

<!--more-->


<h2>コンテナの削除</h2>

<p><a href="http://docs.docker.io/en/latest/commandline/cli/#rm">docker rm</a>
の Eamples にあるように</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go"> docker rm `docker ps -a -q`</span>
</span></code></pre></td></tr></table></div></figure>


<p>で停止しているコンテナを削除できます。</p>

<p>実行中のコンテナがあると削除できないというエラーが出ますが、
意図的にやっていることなので気にする必要はありません。</p>

<p>公式のドキュメントにも書いてある方法なので、
コンテナの削除方法はこのやり方で問題ないと思います。</p>

<h2>イメージの削除</h2>

<p><a href="https://github.com/dotcloud/docker/blob/e960152a1e9064d8c2ae57b9ab2a33d9b27276b9/CHANGELOG.md#072-2013-12-16">0.7.2 (2013-12-16) の変更点</a>
に
「実行中以外であってもコンテナが依存しているイメージは削除できなくした」
(Prevent deletion of image if ANY container is depending on it even if the container is not running)
と書いてあって、
今まではコンテナが停止していれば
<code>docker rmi</code> でイメージが削除できていたのですが、
0.7.2 からはできなくなったので、
上記の手順でコンテナを先に削除しておく必要があります。</p>

<p>不要なイメージの削除は
<code>docker images</code> で <code>REPOSITORY</code> が
<code>&lt;none&gt;</code> になっているものを削除すれば良いので、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go"> docker rmi $(docker images | awk &#39;/^&lt;none&gt;/ { print $3 }&#39;)</span>
</span></code></pre></td></tr></table></div></figure>


<p>のようにすれば可能です。</p>

<p><code>Error: No such image: xxxxxxxxxxxx</code>
のようにエラーが出ることがありますが、
他のイメージを削除したときに一緒に削除されてしまっているだけで、
特に問題はないようです。</p>

<p><a href="https://github.com/dotcloud/docker/blob/a665517151911866285e5a72164c5f2d2f31ba65/FIXME">FIXME</a>
に書いてある方法なので、
現状はこの方法が無難だと思います。</p>

<p>FIXME に書いてあるということで、
将来的にはコンテナの削除の方も含めて、
もっと簡単なコマンドが用意される予定のようです。</p>

<h2>その他のイメージの削除</h2>

<p><code>docker rmi local/debian-ja:7.2</code> で特定の <code>TAG</code> のイメージを削除したり、
<code>docker rmi shipyard/shipyard</code> で特定の <code>REPOSITORY</code> のすべてのイメージを削除したりできます。</p>

<h2>まとめ</h2>

<p>docker を使い続けていると起きることのある問題の対処方法を紹介しました。</p>

<p>本題ではないので上には書いていませんが、
イメージがたまっている状態で削除する前に
<a href="http://docs.docker.io/en/latest/commandline/cli/#displaying-images-visually">docker images -viz</a>
を見てみるのも面白いかもしれません。</p>
]]></content>
  </entry>
  
</feed>
