<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[@znz blog]]></title>
  <link href="http://blog.n-z.jp/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2014-01-05T00:22:58+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[virtualboxでdkmsによるモジュールのリビルドが動いていなかったので対処した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-04-virtualbox-dkms.html"/>
    <updated>2014-01-04T23:47:41+09:00</updated>
    <id>http://blog.n-z.jp/blog/virtualbox-dkms</id>
    <content type="html"><![CDATA[<p>Ubuntu 12.04.3 LTS の環境で
virtualbox.org から入れた VirtualBox を
virtualbox-4.2 (4.2.20-90983~Ubuntu~precise)
から
virtualbox-4.3 (4.3.6-91406~Ubuntu~precise)
にあげても dkms によるモジュールのリビルドがちゃんと動かないままだったので、
直し方を調べて対処してみました。</p>

<!--more-->


<h2>状況</h2>

<p>カーネルを linux-image-3.8.0-34-generic から
linux-image-3.8.0-35-generic にあげるときに
virtualbox-4.2 (4.2.20-90983~Ubuntu~precise)
から
virtualbox-4.3 (4.3.6-91406~Ubuntu~precise)
にあげました。</p>

<p>以下の作業は linux-image-3.8.0-34-generic で起動中に
再起動後に使われる linux-image-3.8.0-35-generic 用の
VirtualBox のカーネルモジュールをビルドしようとしています。</p>

<h2>エラーの状況</h2>

<p><code>dkms status</code> で調べると以下のエラーメッセージが出る状態でした。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ sudo dkms status</span>
</span><span class='line'><span class="go">  Error! Could not locate dkms.conf file.</span>
</span><span class='line'><span class="go">  File:  does not exist.</span>
</span></code></pre></td></tr></table></div></figure>


<h2>対処その1</h2>

<p><code>/var/lib/dkms/vboxhost</code> を退避して
<code>dpkg-reconfigure</code> しなおせば良いという情報があったので
試してみました。</p>

<p>この段階での <code>dkms status</code> は調べ忘れていたのですが、
後の状況からすると
今起動中のカーネルのモジュールだけビルドされたようです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ sudo mv /var/lib/dkms/vboxhost /tmp/</span>
</span><span class='line'><span class="go">  $ sudo dpkg-reconfigure virtualbox-4.3</span>
</span><span class='line'><span class="go">  Stopping VirtualBox kernel modules ...done.</span>
</span><span class='line'><span class="go">  addgroup: グループ `vboxusers&#39; はシステムグループとしてすでに存在しています。終了します。</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;all/all&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;all/allfiles&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/mms&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/mmst&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/mmsu&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/pnm&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/rtspt&#39;</span>
</span><span class='line'><span class="go">  Unknown media type in type &#39;uri/rtspu&#39;</span>
</span><span class='line'><span class="go">  Stopping VirtualBox kernel modules ...done.</span>
</span><span class='line'><span class="go">  Uninstalling old VirtualBox DKMS kernel modules ...done.</span>
</span><span class='line'><span class="go">  Removing old VirtualBox pci kernel module ...done.</span>
</span><span class='line'><span class="go">  Removing old VirtualBox netadp kernel module ...done.</span>
</span><span class='line'><span class="go">  Removing old VirtualBox netflt kernel module ...done.</span>
</span><span class='line'><span class="go">  Removing old VirtualBox kernel module ...done.</span>
</span><span class='line'><span class="go">  Trying to register the VirtualBox kernel modules using DKMS ...done.</span>
</span><span class='line'><span class="go">  Starting VirtualBox kernel modules ...done.</span>
</span></code></pre></td></tr></table></div></figure>


<h2>対処その2</h2>

<p>purge した古いカーネルのモジュールが残っていたので、
削除しました。
安全のため <code>/tmp</code> への移動にしていますが、
いきなり <code>rm -rf</code> で削除しても良いと思います。
他の古いバージョンも残っていれば削除してしまっても
大丈夫だと思います。</p>

<p>ねんのため
<code>/etc/init.d/vboxdrv setup</code>
を実行してみましたが、
<code>dpkg-reconfigure</code>
で既に実行済みだったので関係なかったようです。</p>

<p>この段階で <code>dkms status</code> を確認してみると
起動中のカーネルのモジュールだけビルドされていることがわかります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ sudo mv /lib/modules/3.8.0-33-generic/ /tmp/</span>
</span><span class='line'><span class="go">  $ sudo /etc/init.d/vboxdrv setup</span>
</span><span class='line'><span class="go">  Stopping VirtualBox kernel modules ...done.</span>
</span><span class='line'><span class="go">  Uninstalling old VirtualBox DKMS kernel modules ...done.</span>
</span><span class='line'><span class="go">  Trying to register the VirtualBox kernel modules using DKMS ...done.</span>
</span><span class='line'><span class="go">  Starting VirtualBox kernel modules ...done.</span>
</span><span class='line'><span class="go">  $ sudo dkms status</span>
</span><span class='line'><span class="go">  vboxhost, 4.3.6, 3.8.0-34-generic, x86_64: installed</span>
</span></code></pre></td></tr></table></div></figure>


<h2>対処その3</h2>

<p>dkms でのモジュールのビルドは
<code>/etc/kernel/postinst.d/dkms</code>
で実行されているので、
カーネルを再インストールすれば確実ということで、
カーネルを <code>aptitude reinstall</code> しました。</p>

<p>その結果、正常にビルドされていることが確認できたので、
再起動して VirtualBox の動作確認をしました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">  $ sudo aptitude reinstall linux-image-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  以下のパッケージが再インストールされます:</span>
</span><span class='line'><span class="go">    linux-image-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  0 個のパッケージを更新、 0 個を新たにインストール、 再インストール: 1 個、 0 個を削除予定 、0 個が更新されていない。</span>
</span><span class='line'><span class="go">  アーカイブ 48.2 M バイト中 0  バイトを取得する必要があります。 展開後に 0  バイトのディス ク領域が新たに消費されます。</span>
</span><span class='line'><span class="go">  (データベースを読み込んでいます ... 現在 117478 個のファイルとディレクトリがインストールされています。)</span>
</span><span class='line'><span class="go">  linux-image-3.8.0-35-generic 3.8.0-35.50~precise1 を (.../linux-image-3.8.0-35-generic_3.8.0-35.50~precise1_amd64.deb で) 置換するための準備をしています ...</span>
</span><span class='line'><span class="go">  Done.</span>
</span><span class='line'><span class="go">  linux-image-3.8.0-35-generic を展開し、置換しています...</span>
</span><span class='line'><span class="go">  Examining /etc/kernel/postrm.d .</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postrm.d/initramfs-tools 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postrm.d/zz-update-grub 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  linux-image-3.8.0-35-generic (3.8.0-35.50~precise1) を設定しています ...</span>
</span><span class='line'><span class="go">  Running depmod.</span>
</span><span class='line'><span class="go">  update-initramfs: deferring update (hook will be called later)</span>
</span><span class='line'><span class="go">  Not updating initrd symbolic links since we are being updated/reinstalled</span>
</span><span class='line'><span class="go">  (3.8.0-35.50~precise1 was configured last, according to dpkg)</span>
</span><span class='line'><span class="go">  Not updating image symbolic links since we are being updated/reinstalled</span>
</span><span class='line'><span class="go">  (3.8.0-35.50~precise1 was configured last, according to dpkg)</span>
</span><span class='line'><span class="go">  Examining /etc/kernel/postinst.d.</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/apt-auto-removal 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/dkms 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/initramfs-tools 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  update-initramfs: Generating /boot/initrd.img-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/pm-utils 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/update-notifier 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  run-parts: executing /etc/kernel/postinst.d/zz-update-grub 3.8.0-35-generic /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  Generating grub.cfg ...</span>
</span><span class='line'><span class="go">  Found linux image: /boot/vmlinuz-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  Found initrd image: /boot/initrd.img-3.8.0-35-generic</span>
</span><span class='line'><span class="go">  Found linux image: /boot/vmlinuz-3.8.0-34-generic</span>
</span><span class='line'><span class="go">  Found initrd image: /boot/initrd.img-3.8.0-34-generic</span>
</span><span class='line'><span class="go">  Found memtest86+ image: /memtest86+.bin</span>
</span><span class='line'><span class="go">  done</span>
</span><span class='line'><span class="go">  $ sudo dkms status</span>
</span><span class='line'><span class="go">  vboxhost, 4.3.6, 3.8.0-34-generic, x86_64: installed</span>
</span><span class='line'><span class="go">  vboxhost, 4.3.6, 3.8.0-35-generic, x86_64: installed</span>
</span><span class='line'><span class="go">  $</span>
</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>古いバージョンは再起動で消えてしまって確認できないのですが、
多分古い VirtualBox では
<code>/var/lib/dkms/vboxhost/*/source/dkms.conf</code>
が存在していなくて、
バージョンを上げても古いバージョンの <code>source</code> が残ったままだと
同じエラーが出続けるようなので、
クリーンインストールやそれに近い状態にすると直るということのようです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RubyMotionのOSXアプリの起動エラー]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-28-rubymotion-error.html"/>
    <updated>2013-12-28T18:55:18+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-error</id>
    <content type="html"><![CDATA[<p>最近 RubyMotion で作っている OSX アプリが
<code>LSOpenURLsWithRole() failed with error -10810</code>
などで起動しないことがあったので原因を調べてみました。</p>

<!--more-->


<h2>LSOpenURLsWithRole() failed with error -10810</h2>

<h3>よくある原因</h3>

<p><code>Hello.app/Contents/MacOS/Hello</code>
のような実行ファイルの実体に実行属性が外れているというのが
よくある原因のようで、
<a href="http://owncloud.org/">ownCloud</a>
経由で同期したアプリが実行できなかったときは
これが原因でした。</p>

<h3>別の原因</h3>

<p>実行属性も問題なくて悩んでいたときに
コンソール (Console.app) のログを見てみると</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2013/12/28 10:39:17.963 open[85406]: spawn_via_launchd() failed, errno=22 label=com.yourcompany.Hello.44032 path=.../Hello/build/MacOSX-10.9-Development/Hello.app/Contents/MacOS/Hello flags=0 : LaunchApplicationClient.cp #1168 LaunchApplicationViaLaunchDJobLabel() q=com.apple.main-thread</span></code></pre></td></tr></table></div></figure>


<p>のようなログが出ていたので、
<code>LaunchApplicationViaLaunchDJobLabel</code>
で検索してみたところ、
<a href="http://portingteam.com/topic/9723-mavericks-problem-opening-fresh-wrapper/">Mavericks problem opening fresh wrapper</a>
という話が見つかって、
そこに書いてあった</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>launchctl remove $(launchctl list | grep wineskin | awk '{ print $3 }')</span></code></pre></td></tr></table></div></figure>


<p>という手順を参考にして解決しました。</p>

<p><code>Hello</code> が2個残っていて、
<code>$()</code> だとダメだったので個別に <code>launchctl remove</code> しました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% launchctl list | grep Hello
</span><span class='line'>- 2   com.yourcompany.Hello.44032
</span><span class='line'>- 0   com.yourcompany.Hello.53008
</span><span class='line'>%  launchctl remove $(launchctl list | awk '/Hello/{print $3}')
</span><span class='line'>usage: launchctl remove &lt;job label&gt;
</span><span class='line'>zsh: exit 1     launchctl remove $(launchctl list | awk '/Hello/{print $3}')
</span><span class='line'>%  echo launchctl remove $(launchctl list | awk '/Hello/{print $3}')
</span><span class='line'>launchctl remove com.yourcompany.Hello.44032 com.yourcompany.Hello.53008
</span><span class='line'>%  launchctl remove com.yourcompany.Hello.44032
</span><span class='line'>%  launchctl remove com.yourcompany.Hello.53008
</span><span class='line'>%  open -a Hello</span></code></pre></td></tr></table></div></figure>


<h3>その他</h3>

<p>その他の対象方法も含めて
<a href="http://www.thexlab.com/faqs/error-10810.html">Error -10810 Openng Applictions or Relaunching Finder</a>
にいろいろ書いてあるようです。
(英語で長かったのでちゃんと読んでません。)</p>

<h2>MacBookPro6,2 で EXC_BAD_INSTRUCTION (SIGILL) になって起動しない</h2>

<p>未解決です。</p>

<p><a href="https://github.com/MohawkApps/Hacker-Bar/issues/36">EXC_BAD_INSTRUCTION crash in App Store version&hellip;</a>
に似た話があって、
RubyMotion のバグっぽいという話のようです。</p>

<p><code>motion create --template=osx HelloOSX</code>
で作成しただけのものでも
<a href="https://gist.github.com/znz/8158061#file-helloosx-report-txt">クラッシュ</a>
して起動しませんでした。</p>

<p>RubyMotion を入れている自分の MacBook Air の環境の問題かどうかを切り分けるために
<a href="http://shin1x1.github.io/vagrantx/">VagrantX</a>
も試してみましたが、
<a href="https://gist.github.com/znz/8158061#file-vagrantx-report-txt">同じくクラッシュ</a>
して起動しませんでした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[distnotedの暴走が止まるというCocoa Emacsのinline patch修正版を使ってみた]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-27-emacs-inline-patch.html"/>
    <updated>2013-12-27T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/emacs-inline-patch</id>
    <content type="html"><![CDATA[<p><a href="http://blog.n-z.jp/blog/2013-11-13-killall-distnoted-periodically.html">launchdでdistnotedを定期的に終了させる</a>
話のコメントで
<a href="https://gist.github.com/anonymous/8142555">Emacs.appでインラインパッチを当てた時にdistnotedが暴走しなくなる</a>
修正を教えてもらったので、
試してみました。</p>

<!--more-->


<h2>homebrew で適用するパッチの変更</h2>

<p>適用法としては
<code>brew edit emacs</code>
で以下のように変更して、
<code>brew reinstall emacs</code>
で再インストールしました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/Library/Formula/emacs.rb b/Library/Formula/emacs.rb</span>
</span><span class='line'><span class="gh">index 712c3d1..5ce4ce2 100644</span>
</span><span class='line'><span class="gd">--- a/Library/Formula/emacs.rb</span>
</span><span class='line'><span class="gi">+++ b/Library/Formula/emacs.rb</span>
</span><span class='line'><span class="gu">@@ -47,7 +47,7 @@ class Emacs &lt; Formula</span>
</span><span class='line'>     # &quot;--japanese&quot; option:
</span><span class='line'>     # to apply a patch from MacEmacsJP for Japanese input methods
</span><span class='line'>     if build.include? &quot;cocoa&quot; and build.include? &quot;japanese&quot;
</span><span class='line'><span class="gd">-      p[:p0].push(&quot;http://sourceforge.jp/projects/macemacsjp/svn/view/inline_patch/trunk/emacs-inline.patch?view=co&amp;revision=583&amp;root=macemacsjp&amp;pathrev=583&quot;)</span>
</span><span class='line'><span class="gi">+      p[:p0].push(&quot;https://gist.github.com/anonymous/8142555/raw/d67ad1dc814579d125afbd18de3a62ba69895601/emacs-inline.patch&quot;)</span>
</span><span class='line'>     end
</span><span class='line'>     p
</span><span class='line'>   end unless build.head?
</span></code></pre></td></tr></table></div></figure>


<h2>元のパッチからの変更点</h2>

<p>元の sourceforge.jp のパッチとの差分をとってみると、
以下のメソッド呼び出しが変わっているだけでした。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/emacs-inline.patch.sfjp b/emacs-inline.patch.gist</span>
</span><span class='line'><span class="gh">index 52f2052..d67ad1d 100644</span>
</span><span class='line'><span class="gd">--- a/emacs-inline.patch.sfjp</span>
</span><span class='line'><span class="gi">+++ b/emacs-inline.patch.gist</span>
</span><span class='line'><span class="gu">@@ -1015,7 +1015,7 @@ diff -r -N -p ../emacs-24.3.org/src/nsterm.m src/nsterm.m</span>
</span><span class='line'>                                                name: nil object: nil]; */
</span><span class='line'> +   [[NSDistributedNotificationCenter defaultCenter] addObserver: NSApp
</span><span class='line'> +                    selector: @selector (changeInputMethod:)
</span><span class='line'><span class="gd">-+                          name: @&quot;AppleSelectedInputSourcesChangedNotification&quot; object: nil];</span>
</span><span class='line'><span class="gi">++                          name: @&quot;AppleSelectedInputSourcesChangedNotification&quot; object: nil suspensionBehavior:NSNotificationSuspensionBehaviorDeliverImmediately];</span>
</span><span class='line'>
</span><span class='line'>     dpyinfo = xzalloc (sizeof *dpyinfo);
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>使ってみて問題がなければ sourceforge.jp の方に取り込んでもらうのが良さそうです。</p>

<p>しばらく使ってみた感じだと distnoted のメモリ使用量が増えていっても、
一度 Emacs.app を終了すると distnoted のメモリ使用量が一気に減るようになりました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第 6 回 RubyMotion もくもく会 in Osaka に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-26-rubymotion-mokumoku-osaka.html"/>
    <updated>2013-12-26T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-mokumoku-osaka</id>
    <content type="html"><![CDATA[<p>第 1 回から第 5 回にも参加した RubyMotion もくもく会 in Osaka の
<a href="http://connpass.com/event/4211/">第 6 回 RubyMotion もくもく会 in Osaka</a>
に参加してきました。</p>

<p>次回の
<a href="http://connpass.com/event/4560/">第 7 回 RubyMotion もくもく会 in Osaka</a>
は 1/22(水) になりました。</p>

<!--more-->


<h2>話に出たもの</h2>

<p>話に出てきたサイトなどのメモです。</p>

<ul>
<li><a href="http://shin1x1.github.io/vagrantx/">http://shin1x1.github.io/vagrantx/</a>

<ul>
<li>URL が小文字に変わっていました。</li>
</ul>
</li>
<li><a href="https://www.cocoacontrols.com/">Cocoa Controls</a></li>
<li><a href="http://getpocket.com/">Pocket</a></li>
<li><a href="http://71squared.com/ja/particledesigner">Particle Designer</a></li>
<li>UIMotionEffect で視差効果が簡単に実装できる</li>
<li>All Cast という Android アプリで Apple TV に AirPlay できる</li>
</ul>


<h2>やっていたこと</h2>

<p>今回は前回作り始めていたデフォルトブラウザを乗っ取って、
Firefox とか Chrome とか Safari とかに起動し分けられる
OSX アプリの作成の続きをやっていました。</p>

<p>今回の最後ではスクリーンショットのようになりました。</p>

<p><img src="http://blog.n-z.jp/images/2013-12-26-hello.png" title="screenshot" alt="作成途中のアプリのスクリーンショット"></p>

<p>適当に作った Hello.app に動作確認用のメソッドを付け足していただけなので、
まだタイトルは Hello のままになっています。</p>

<h3>URL 受け取り問題</h3>

<p>LimeChat で URL をクリックしたときなどに受け取るのは
前回調べていた <code>LSSetDefaultHandlerForURLScheme</code> での
デフォルトブラウザ設定とあわせて、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">NSAppleEventManager</span><span class="o">.</span><span class="n">sharedAppleEventManager</span><span class="o">.</span><span class="n">setEventHandler</span><span class="p">(</span>
</span><span class='line'>  <span class="nb">self</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">andSelector</span><span class="p">:</span> <span class="ss">:&#39;handleGetURLEvent:withReplyEvent:&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">forEventClass</span><span class="p">:</span> <span class="no">KInternetEventClass</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">andEventID</span><span class="p">:</span> <span class="no">KAEGetURL</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>でイベントを受け取ると Hello.app 起動中は受け取れたのですが、
起動していない時の URL クリックのイベントを受け取れない問題は
結局解決できませんでした。</p>

<p><code>open -a Hello --args URL</code>
というなら
<code>NSProcessInfo.processInfo.arguments</code>
で受け取れるのですが、
LimeChat などでの URL クリックで起動された時や
<code>open -a Hello URL</code>
という起動方法だと受け取り方がわかりませんでした。</p>

<p>他のブラウザの起動も
<code>open -a 'Google Chrome' http://localhost:4000/ --args -incognito</code>
のように URL は args ではない方法で渡さないと開けませんでした。</p>

<h3><code>keyDirectObject</code> がない問題と前面に出てこない問題</h3>

<p>URL の受け取り部分は今のところ、以下のようにしています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">handleGetURLEvent</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="ss">withReplyEvent</span><span class="p">:</span> <span class="n">replyEvent</span><span class="p">)</span>
</span><span class='line'>    <span class="n">keyDirectObject</span> <span class="o">=</span> <span class="s1">&#39;----&#39;</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>    <span class="n">urlStr</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">paramDescriptorForKeyword</span><span class="p">(</span><span class="n">keyDirectObject</span><span class="p">)</span><span class="o">.</span><span class="n">stringValue</span>
</span><span class='line'>    <span class="vi">@text</span><span class="o">.</span><span class="n">stringValue</span> <span class="o">=</span> <span class="n">urlStr</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Process</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="s2">&quot;osascript&quot;</span><span class="p">,</span> <span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="no">SCRIPT</span><span class="p">)</span>
</span><span class='line'><span class="sh">tell Application &quot;#{NSBundle.mainBundle.infoDictionary[&#39;CFBundleName&#39;]}&quot;</span>
</span><span class='line'><span class="sh">  activate</span>
</span><span class='line'><span class="sh">end tell</span>
</span><span class='line'><span class="no">    SCRIPT</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>最初の問題として、
<code>keyDirectObject</code> が RubyMotion にはなさそうだったので、
値を調べて <code>unpack</code> で同等の値を生成するようにしました。
この部分は前回から今回までの間に調査して作成済みだったので、
詳しい調査方法は忘れてしまいましたが、
引数のオブジェクトを調べて見つけたような気がします。</p>

<p>前面に出てこない問題は
今回のもくもく会の間に対処しました。</p>

<p>前面に持ってくる方法がどういう API を呼べばよいのかわからず、
AppleScript を使った方法は情報があったので、
とりあえず <code>osascript</code> を呼び出してしまうことにしました。</p>

<p>最初は <code>spawn</code> ではなく <code>system</code> を使ってしまったら、
デッドロックしてしまって強制終了するしかなくなってしまったので、
<code>Process.spawn</code> を使いました。</p>

<h2>まとめ</h2>

<p>今回は作りたいものが決まっていて、しっかりもくもく出来ました。</p>

<p>起動時に URL が受け取れない問題は
自分が使うだけなら
URL を 2 回クリックするという方法で
回避できるのですが、なんとかしたいところです。</p>

<p><code>keyDirectObject</code> と <code>osascript</code> を使っているところは
他に方法がなければ
今のままでも実用上は困らないと感じました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[weechat-cursesでの罫線の文字幅問題を回避する]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-25-weechat-curses.html"/>
    <updated>2013-12-25T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/weechat-curses</id>
    <content type="html"><![CDATA[<p>サーバー上の端末の中で使える IRC クライアントとして
<code>weechat-curses</code> をちょっと試しているのですが、
<code>│</code> (U+2502 BOX DRAWINGS LIGHT VERTICAL)
で罫線文字の文字幅問題が発生してずれるという現象に困っていたので、
問題を回避する設定をしてみました。</p>

<!--more-->


<h2>設定</h2>

<p><code>│</code> (U+2502) の代わりに <code>|</code> (U+007C VERTICAL LINE)
を使うだけなら、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/set weechat.look.separator_vertical "|"</span></code></pre></td></tr></table></div></figure>


<p>でいけます。</p>

<h2>問題の文字が使われている場所</h2>

<p>weechat の画面で問題が起きている行は</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>時刻 nickなどのprefix 左の縦線(|) メッセージ 右の縦線(│) nick一覧</span></code></pre></td></tr></table></div></figure>


<p>のようになっていて、最初は両方の縦線が問題になっているのかと
勘違いしていたのですが、実際には右側の方だけでした。</p>

<p>左側の縦線の部分の設定は <code>weechat.look.prefix_suffix</code> で、
右側は <code>weechat.look.separator_vertical</code> です。</p>

<p>左側の方はデフォルトで <code>"|"</code> になっていて、問題はありませんでした。</p>

<p>右側の方はデフォルトでは <code>""</code> (空文字列) になっていて、
その場合は ncurses で縦線を描画するという意味になって、
問題が起きていました。</p>

<p>たとえば <code>":"</code> などに設定を変えてみるとどっちがどっちなのか
よくわかると思います。</p>

<h2>まとめ</h2>

<p>weechat を試していて、ずっと困っていた問題が解決できたので、
これからもうちょっと使ってみようと思えるようになりました。</p>

<p>Web で検索しても全く情報がみつからなかったのですが、
誰も困っていなかったのでしょうか。
英語圏だと困らなさそうですが、日本語圏でも使っている人はいそうなのに
情報がないのは他のコマンドも含めて対処していて困っていないからなのか、
気にせずずれるまま使っているからなのかが気になりました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dockerで不要になったコンテナやイメージを削除する]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-24-docker-rm.html"/>
    <updated>2013-12-24T11:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/docker-rm</id>
    <content type="html"><![CDATA[<p>Docker を使い続けてコンテナやイメージを放置していると差分だけとはいえ、
ディスクの消費が増えていって、
<code>書き込みエラー: デバイスに空き領域がありません</code>
(<code>ENOSPC</code>, <code>write error: No space left on device</code>)
というエラーになってしまいます。</p>

<!--more-->


<h2>コンテナの削除</h2>

<p><a href="http://docs.docker.io/en/latest/commandline/cli/#rm">docker rm</a>
の Eamples にあるように</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go"> docker rm `docker ps -a -q`</span>
</span></code></pre></td></tr></table></div></figure>


<p>で停止しているコンテナを削除できます。</p>

<p>実行中のコンテナがあると削除できないというエラーが出ますが、
意図的にやっていることなので気にする必要はありません。</p>

<p>公式のドキュメントにも書いてある方法なので、
コンテナの削除方法はこのやり方で問題ないと思います。</p>

<h2>イメージの削除</h2>

<p><a href="https://github.com/dotcloud/docker/blob/e960152a1e9064d8c2ae57b9ab2a33d9b27276b9/CHANGELOG.md#072-2013-12-16">0.7.2 (2013-12-16) の変更点</a>
に
「実行中以外であってもコンテナが依存しているイメージは削除できなくした」
(Prevent deletion of image if ANY container is depending on it even if the container is not running)
と書いてあって、
今まではコンテナが停止していれば
<code>docker rmi</code> でイメージが削除できていたのですが、
0.7.2 からはできなくなったので、
上記の手順でコンテナを先に削除しておく必要があります。</p>

<p>不要なイメージの削除は
<code>docker images</code> で <code>REPOSITORY</code> が
<code>&lt;none&gt;</code> になっているものを削除すれば良いので、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go"> docker rmi $(docker images | awk &#39;/^&lt;none&gt;/ { print $3 }&#39;)</span>
</span></code></pre></td></tr></table></div></figure>


<p>のようにすれば可能です。</p>

<p><code>Error: No such image: xxxxxxxxxxxx</code>
のようにエラーが出ることがありますが、
他のイメージを削除したときに一緒に削除されてしまっているだけで、
特に問題はないようです。</p>

<p><a href="https://github.com/dotcloud/docker/blob/a665517151911866285e5a72164c5f2d2f31ba65/FIXME">FIXME</a>
に書いてある方法なので、
現状はこの方法が無難だと思います。</p>

<p>FIXME に書いてあるということで、
将来的にはコンテナの削除の方も含めて、
もっと簡単なコマンドが用意される予定のようです。</p>

<h2>その他のイメージの削除</h2>

<p><code>docker rmi local/debian-ja:7.2</code> で特定の <code>TAG</code> のイメージを削除したり、
<code>docker rmi shipyard/shipyard</code> で特定の <code>REPOSITORY</code> のすべてのイメージを削除したりできます。</p>

<h2>まとめ</h2>

<p>docker を使い続けていると起きることのある問題の対処方法を紹介しました。</p>

<p>本題ではないので上には書いていませんが、
イメージがたまっている状態で削除する前に
<a href="http://docs.docker.io/en/latest/commandline/cli/#displaying-images-visually">docker images -viz</a>
を見てみるのも面白いかもしれません。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[octopressをアップデートしてisolateを使い始めた]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-21-update-octopress.html"/>
    <updated>2013-12-21T22:43:36+09:00</updated>
    <id>http://blog.n-z.jp/blog/update-octopress</id>
    <content type="html"><![CDATA[<p>気が向いたので、また octopress の更新をしてみました。
そして <code>rake isolate</code> を使い始めました。</p>

<p>記事中では <code>git fetch --prune</code> とか、
zsh の <code>(mm-1)</code> を使っているので、
カテゴリに <code>git</code> と <code>zsh</code> も付けています。</p>

<!--more-->


<h2>octopress のアップデート</h2>

<p><code>git fetch</code> します。
最近は <code>--prune</code> を付けてリモートで削除されたブランチは手元でも削除されるようにしていることが多いので、
今回も付けています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">%</span> git remote -v
</span><span class='line'><span class="go">octopress    git://github.com/imathis/octopress.git (fetch)</span>
</span><span class='line'><span class="go">octopress    git@github.com:imathis/octopress.git (push)</span>
</span><span class='line'><span class="go">origin   git@github.com:znz/znz.github.io (fetch)</span>
</span><span class='line'><span class="go">origin   git@github.com:znz/znz.github.io (push)</span>
</span><span class='line'><span class="go">origin   ssh://git@bitbucket.org/znz/blog.n-z.jp.git (push)</span>
</span><span class='line'><span class="gp">%</span> git fetch --prune octopress
</span><span class='line'><span class="go">remote: Counting objects: 33, done.</span>
</span><span class='line'><span class="go">remote: Compressing objects: 100% (18/18), done.</span>
</span><span class='line'><span class="go">remote: Total 24 (delta 16), reused 14 (delta 6)</span>
</span><span class='line'><span class="go">Unpacking objects: 100% (24/24), done.</span>
</span><span class='line'><span class="go">From git://github.com/imathis/octopress</span>
</span><span class='line'><span class="go"> * [new branch]      jekyll-1-3 -&gt; octopress/jekyll-1-3</span>
</span><span class='line'><span class="go">   64ba603..78defff  master     -&gt; octopress/master</span>
</span><span class='line'><span class="gp">%</span>
</span></code></pre></td></tr></table></div></figure>


<p>差分を確認してからマージしました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">%</span> git diff source...octopress/master
</span><span class='line'><span class="gp">%</span> git merge octopress/master
</span><span class='line'><span class="go">Auto-merging Rakefile</span>
</span><span class='line'><span class="go">Merge made by the &#39;recursive&#39; strategy.</span>
</span><span class='line'><span class="go"> .themes/classic/sass/base/_theme.scss                     |  2 +-</span>
</span><span class='line'><span class="go"> .themes/classic/source/_includes/archive_post.html        |  2 +-</span>
</span><span class='line'><span class="go"> .themes/classic/source/_includes/custom/category_feed.xml |  4 +-</span>
</span><span class='line'><span class="go"> .themes/classic/source/_includes/disqus.html              |  2 +-</span>
</span><span class='line'><span class="go"> .themes/classic/source/_includes/head.html                |  4 +-</span>
</span><span class='line'><span class="go"> .themes/classic/source/atom.xml                           |  4 +-</span>
</span><span class='line'><span class="go"> README.markdown                                           |  2 +-</span>
</span><span class='line'><span class="go"> Rakefile                                                  |  6 +--</span>
</span><span class='line'><span class="go"> plugins/category_generator.rb                             |  3 +-</span>
</span><span class='line'><span class="go"> plugins/code_block.rb                                     |  2 +-</span>
</span><span class='line'><span class="go"> plugins/date.rb                                           | 53 +++++++++----------------</span>
</span><span class='line'><span class="go"> plugins/gist_tag.rb                                       |  8 +++-</span>
</span><span class='line'><span class="go"> plugins/include_code.rb                                   |  2 +-</span>
</span><span class='line'><span class="go"> plugins/jsfiddle.rb                                       |  2 +-</span>
</span><span class='line'><span class="go"> 14 files changed, 41 insertions(+), 55 deletions(-)</span>
</span></code></pre></td></tr></table></div></figure>


<p>themes も更新されているので、
<a href="http://octopress.org/docs/updating/">Updating Octopress</a>
の手順に従ってアップデートしました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go"> % bundle install</span>
</span><span class='line'><span class="go"> Using rake (0.9.2.2)</span>
</span><span class='line'><span class="go"> Using RedCloth (4.2.9)</span>
</span><span class='line'><span class="go"> Using chunky_png (1.2.5)</span>
</span><span class='line'><span class="go"> Using fast-stemmer (1.0.1)</span>
</span><span class='line'><span class="go"> Using classifier (1.3.3)</span>
</span><span class='line'><span class="go"> Using fssm (0.2.9)</span>
</span><span class='line'><span class="go"> Using sass (3.2.9)</span>
</span><span class='line'><span class="go"> Using compass (0.12.2)</span>
</span><span class='line'><span class="go"> Using directory_watcher (1.4.1)</span>
</span><span class='line'><span class="go"> Using haml (3.1.7)</span>
</span><span class='line'><span class="go"> Using kramdown (0.13.8)</span>
</span><span class='line'><span class="go"> Using liquid (2.3.0)</span>
</span><span class='line'><span class="go"> Using syntax (1.0.0)</span>
</span><span class='line'><span class="go"> Using maruku (0.6.1)</span>
</span><span class='line'><span class="go"> Using posix-spawn (0.3.6)</span>
</span><span class='line'><span class="go"> Using yajl-ruby (1.1.0)</span>
</span><span class='line'><span class="go"> Using pygments.rb (0.3.4)</span>
</span><span class='line'><span class="go"> Using jekyll (0.12.0)</span>
</span><span class='line'><span class="go"> Using rack (1.5.2)</span>
</span><span class='line'><span class="go"> Using rack-protection (1.5.0)</span>
</span><span class='line'><span class="go"> Using rb-fsevent (0.9.1)</span>
</span><span class='line'><span class="go"> Using rdiscount (2.0.7.3)</span>
</span><span class='line'><span class="go"> Using rubypants (0.2.0)</span>
</span><span class='line'><span class="go"> Using sass-globbing (1.0.0)</span>
</span><span class='line'><span class="go"> Using tilt (1.3.7)</span>
</span><span class='line'><span class="go"> Using sinatra (1.4.2)</span>
</span><span class='line'><span class="go"> Using stringex (1.4.0)</span>
</span><span class='line'><span class="go"> Using bundler (1.3.5)</span>
</span><span class='line'><span class="go"> Your bundle is complete!</span>
</span><span class='line'><span class="go"> Use `bundle show [gemname]` to see where a bundled gem is installed.</span>
</span><span class='line'><span class="go"> % bundle exec rake update_source</span>
</span><span class='line'><span class="go"> mkdir source.old</span>
</span><span class='line'><span class="go"> cp -r source/. source.old</span>
</span><span class='line'><span class="go"> ## Copied source into source.old/</span>
</span><span class='line'><span class="go"> cp -r --remove-destination .themes/classic/source/. source</span>
</span><span class='line'><span class="go"> cp -r --remove-destination source.old/_includes/custom/. source/_includes/custom/</span>
</span><span class='line'><span class="go"> cp source.old/favicon.png source</span>
</span><span class='line'><span class="go"> ## Updated source ##</span>
</span><span class='line'><span class="go"> % bundle exec rake update_style</span>
</span><span class='line'><span class="go"> mv sass sass.old</span>
</span><span class='line'><span class="go"> ## Moved styles into sass.old/</span>
</span><span class='line'><span class="go"> cp -r .themes/classic/sass/ sass</span>
</span><span class='line'><span class="go"> cp -r sass/custom/. sass.old/custom</span>
</span><span class='line'><span class="go"> ## Updated Sass ##</span>
</span><span class='line'><span class="go"> %</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>git diff</code> で確認するとローカルでの変更が消えてしまっていたので、
<code>git checkout ファイルパス</code> で戻したり、
再適用したりしてからコミットしました。</p>

<h2>rake isolate</h2>

<p><a href="http://rcmdnk.github.io/blog/2013/10/07/blog-octopress/">Octopressでチェック用に高速にgenerate/previewする</a>
で紹介されていた
<code>rake isolate[filename]</code>
を使い始めてみました。</p>

<h3>ファイル名の指定を省略する</h3>

<p>最終更新時刻でソートして最新だけ、という絞り込みをしたかったのですが、
zsh の機能だけでうまく表現できなかったので、
<a href="http://qiita.com/mollifier/items/1c4a4930a89aa75e5ced">zsh で find を使わずに簡単にファイルを絞り込む</a>
を参考にして1分以内に変更されたファイルだけという絞り込みで妥協することにしました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go"> bundle exec rake &quot;isolate[$(echo source/_posts/*.markdown(mm-1))]&quot;</span>
</span><span class='line'><span class="go"> bundle exec rake preview</span>
</span><span class='line'><span class="go"> bundle exec rake integrate</span>
</span></code></pre></td></tr></table></div></figure>


<h3>rake integrate 忘れを防ぐ</h3>

<p>isolate した状態で deploy する事故を防ぐために
<a href="https://github.com/imathis/octopress/pull/1444">check stash dir before deploy</a>
という変更を入れてから使うようにしてみました。</p>

<p>Rakefile をみてみると</p>

<figure class='code'><figcaption><span>Rakefile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s2">&quot;Generate website and deploy&quot;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:gen_deploy</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:integrate</span><span class="p">,</span> <span class="ss">:generate</span><span class="p">,</span> <span class="ss">:deploy</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>となっているので、
<code>bundle exec rake deploy</code> ではなく
<code>bundle exec rake gen_deploy</code> を使うようにしていれば
大丈夫そうですが、
念のためチェックした方が安全だと思いました。</p>

<p>octopress の fork で作成したこの変更は</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">git pull git@github.com:znz/octopress.git check-stash-before-deploy</span>
</span></code></pre></td></tr></table></div></figure>


<p>で手元の source ブランチに取り込みました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[DOCKER indexのTrusted Buildsで複数バージョンのrubyを試せるimageを作ってみた]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-19-docker-trusted-builds.html"/>
    <updated>2013-12-19T23:02:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/docker-trusted-builds</id>
    <content type="html"><![CDATA[<p><a href="https://index.docker.io/">DOCKER index</a>
には
<a href="http://blog.docker.io/2013/11/introducing-trusted-builds/">Trusted Builds</a>
という機能があり、
Docker index の方で
image の作成をしてくれます。</p>

<p>image の作成方法は GitHub に Dockerfile を公開して、
それを指定します。</p>

<p>今回はそれを使って複数バージョンの ruby を試せる image を作ってみました。</p>

<!--more-->


<h2>Dockerfile の動作確認</h2>

<p><code>docker build</code> への Dockerfile の指定方法は</p>

<pre><code>docker build DockerfileのあるディレクトリへのパスやURL
</code></pre>

<p>という方法と</p>

<pre><code>docker build - &lt; Dockerfile
</code></pre>

<p>のように <code>-</code> を指定して標準入力から渡す方法があります。</p>

<p>違いとしては
パスや URL の指定だとファイル名が Dockerfile 固定という制限があり、
<code>-</code> の方だと <code>ADD</code> が使えない (基準となるディレクトリがわからないため)
という制限があるようです。
(詳しく調べていないだけなので他にもあると思います。)</p>

<p>そこで、</p>

<pre><code>docker build -t local/rubys .
</code></pre>

<p>または</p>

<pre><code>docker build -t local/rubys - &lt; Dockerfile
</code></pre>

<p>のようにして動作確認します。</p>

<h2>DOCKER index のアカウント登録</h2>

<p>英小文字か数字で4文字から30文字という制限があったので、
<code>znzj</code> というアカウントにしました。</p>

<p>メールアドレスとパスワードを設定して、
メールの確認が済んだらアカウントの作成は完了です。</p>

<p>最近はサービスごとにメールアドレスを分けていて、
アイコンが gravatar のデフォルトになってしまっていたので、
User Settings から Gravatar email も設定しました。</p>

<p>ここはメールアドレスの確認がなかったので、
他人のアイコンでも使えてしまうように見えたのですが、
良いのでしょうか。
ちょっと考えてみましたが、
画像をコピーして使えば同じようなものなので、
気にするほどのことではなさそうに思いました。</p>

<h2>GitHub のアカウントとの連携</h2>

<p>hook の登録のため、ということで多少の書き込み権限も要求されるので、
許可したくない場合は Trusted builds は使えません。</p>

<h2>Trusted Builds の追加</h2>

<p>ログイン中に
<a href="https://index.docker.io/builds/">Trusted Builds</a>
のページの <code>+Add New</code> から、
GitHub レポジトリを選択します。
ここでは <a href="https://github.com/znz/docker-rubys">https://github.com/znz/docker-rubys</a> を選択しました。</p>

<ol>
<li>Default Branch は <code>master</code> のまま</li>
<li>Repo name も <code>znzj/docker-rubys</code> のまま (<code>/</code> の右の部分は英小文字か数字か <code>-</code> か <code>.</code> で 3 文字から 30 文字)</li>
<li>Docker Tag Name も <code>latest</code> のまま</li>
<li>Dockerfile Location は <code>/</code> から <code>rubys/</code> に変更</li>
<li>Active にはチェックをいれたまま</li>
</ol>


<p>という状態で作成しました。</p>

<p><code>Dockerfile</code> の push とどっちが先が良いのかわからなかったので、
<code>Dockerfile</code> なしで追加してしまったら、
初回は <code>Dockerfile</code> が見つからないという理由で失敗してしまったので、
先に <code>Dockerfile</code> を push してから追加するもののようです。</p>

<h2>イメージの使用</h2>

<p>しばらくまつと Trusted Builds のページで
Status が Pending から Building に変わって、
最終的に Done になってビルドできて使えるようになるので、</p>

<pre><code>docker pull znzj/docker-rubys
</code></pre>

<p>でダウンロードします。</p>

<p>ダウンロードが完了したら、</p>

<pre><code>docker run -i -t znzj/docker-rubys
</code></pre>

<p>で <code>/bin/bash -l</code> を起動します。
(<code>CMD</code> で指定されています。)</p>

<p>bash で</p>

<pre><code>rbenv versions
</code></pre>

<p>で入っている ruby のバージョンを確認したり、</p>

<pre><code>rbenv each ruby -v
</code></pre>

<p>や</p>

<pre><code>rbenv each -v gem list
</code></pre>

<p>などのように
<a href="https://github.com/chriseppstein/rbenv-each">rbenv each</a>
を使って、
それぞれのバージョンの ruby の環境でコマンドを実行できるようにしています。</p>

<p>ホスト側とのファイルのやり取りはどうするのが良いのか
まだ調べていないので、
とりあえず vim でファイルを作成するか、
wget でダウンロードすることを想定しています。</p>

<h2>abuse?</h2>

<p><code>GitHub: Add Trusted Build</code>
のところに
<code>Anyone who abuses the build system, will have their accounts disabled. If you are unsure what might be considered abuse, please ask before you build.</code>
という注意書きがあって、
ビルドするぐらいなら大丈夫かと思っていたのですが、
他の Trusted Builds をみるとインストールしたり
ファイルを追加したりしているだけのものが
多いので心配になってしまいました。
さらに探してみると
<a href="https://index.docker.io/u/sameersbn/gitlab/">https://index.docker.io/u/sameersbn/gitlab/</a>
で ruby を make しているものもあったので、
ビルドはダメということもなさそうでした。</p>

<p>しかし、頻繁にビルドして負荷をかけるのもよくなさそうなので、
trunk の nightly build などをしようと思ったら、
ローカルで作成して <code>docker push</code> する方がよさそうに感じました。</p>

<h2>aufs の制限</h2>

<p><a href="https://github.com/dotcloud/docker/issues/332">https://github.com/dotcloud/docker/issues/332</a>
によると aufs は重ねられる数に限界 (40ぐらい?) があるようなので、
<code>RUN</code> コマンドは出来るだけまとめて減らした方が良いのかもしれません。</p>

<p><a href="https://index.docker.io/u/truongsinh/nodejs/">https://index.docker.io/u/truongsinh/nodejs/</a>
のように <code>&amp;&amp;</code> でつなげて 1 個の <code>RUN</code> にまとめている例もありました。</p>

<p>aufs 以外が主流になるかもしれないので、
この辺りは Dockerfile の読みやすさや
<code>docker history</code> でわかれていた方が良いのかなど、
利点や欠点を考えつつ、
ベストプラクティスが決まっていくまで
試行錯誤するのが良さそうです。</p>

<h2>まとめ</h2>

<p>DOCKER index には Trusted Builds という向こう側で
<code>docker build</code> してくれる仕組みがあるので、
<code>docker push</code> とうまく使い分けて
公開可能なイメージはどんどん公開すると良いのではないでしょうか。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RubyMotionとRubyのバージョン]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-15-rubymotion-ruby-version.html"/>
    <updated>2013-12-15T14:49:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-ruby-version</id>
    <content type="html"><![CDATA[<p>今のところ RubyMotion は毎月のもくもく会以外ではほとんど触れていないので、
RubyMotion と Ruby のバージョンの関係と言う小ネタです。</p>

<p>この投稿は
<a href="http://qiita.com/advent-calendar/2013/rubymotion">RubyMotion Advent Calendar 2013</a>
の12日目の記事です。</p>

<!--more-->


<h2>RUBY_DESCRIPTION 確認</h2>

<p>まず <code>Rakefile</code> の先頭で <code>RUBY_DESCRIPTION</code> を入れて、
普通の <code>ruby</code> コマンドのバージョンを表示して、
次に開発環境のプロンプトでも確認してみました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">%</span> head -n2 Rakefile
</span><span class='line'><span class="gp">#</span> -*- coding: utf-8 -*-
</span><span class='line'><span class="go">p RUBY_DESCRIPTION</span>
</span><span class='line'><span class="gp">%</span> rake
</span><span class='line'><span class="go">&quot;ruby 2.0.0p353 (2013-11-22 revision 43784) [x86_64-darwin12.5.0]&quot;</span>
</span><span class='line'><span class="go">     Build ./build/MacOSX-10.8-Development</span>
</span><span class='line'><span class="go">   Compile ./app/app_delegate.rb</span>
</span><span class='line'><span class="go">   Compile ./app/menu.rb</span>
</span><span class='line'><span class="go">    Create ./build/MacOSX-10.8-Development/Hello.app/Contents</span>
</span><span class='line'><span class="go">    Create ./build/MacOSX-10.8-Development/Hello.app/Contents/MacOS</span>
</span><span class='line'><span class="go">      Link ./build/MacOSX-10.8-Development/Hello.app/Contents/MacOS/Hello</span>
</span><span class='line'><span class="go">    Create ./build/MacOSX-10.8-Development/Hello.app/Contents/PkgInfo</span>
</span><span class='line'><span class="go">    Create ./build/MacOSX-10.8-Development/Hello.app/Contents/Info.plist</span>
</span><span class='line'><span class="go">      Copy ./resources/Credits.rtf</span>
</span><span class='line'><span class="go">    Create ./build/MacOSX-10.8-Development/Hello.dSYM</span>
</span><span class='line'><span class="go">       Run ./build/MacOSX-10.8-Development/Hello.app/Contents/MacOS/Hello</span>
</span><span class='line'><span class="go">(main)&gt; RUBY_DESCRIPTION</span>
</span><span class='line'><span class="go">=&gt; &quot;RubyMotion (ruby 1.9.2) [universal-darwin13.0, x86_64]&quot;</span>
</span><span class='line'><span class="go">(main)&gt; exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>外側は 2.0.0 なのに RubyMotion の方は 1.9.2 でした。</p>

<h2>まとめ</h2>

<p>調べたきっかけはデバッグ用に <code>File.write</code>
(<a href="http://docs.ruby-lang.org/ja/2.0.0/class/IO.html#S_WRITE">IO.write</a>)
が使えなかったからでした。
それは結局普通に <code>File.open</code> して書き込むことにしましたが、
開発環境側の Ruby のバージョンを変えても生成されるアプリ側の
Ruby のバージョンには影響しないという話でした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[dockerのWeb UI 3種類を比較してみた]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-15-compare-docker-web-ui.html"/>
    <updated>2013-12-15T00:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/compare-docker-web-ui</id>
    <content type="html"><![CDATA[<p><a href="http://www.docker.io/">docker</a> の Web UI を比較してみました。</p>

<p>対象は以下の3種類の Web UI です。
検索すると <code>DockerUI</code> 以外が見つけにくいようなので、
まとめて紹介します。</p>

<ul>
<li><a href="https://github.com/shipyard/shipyard">Shipyard</a></li>
<li><a href="https://github.com/dynport/dockland">Dockland</a></li>
<li><a href="https://github.com/crosbymichael/dockerui">DockerUI</a></li>
</ul>


<!--more-->


<h2>対象バージョン</h2>

<p>先月末頃にも試したのですが、
その時にはこんなに <code>docker</code> が流行るとは思っていなかったので、
ちゃんとまとめていませんでした。</p>

<p>そこで改めて新しいバージョンを試しつつ比較したいと思います。</p>

<ul>
<li>amd64 の Ubuntu 13.04 (raring)</li>
<li>docker 0.7.1</li>
<li>Shipyard version 0dc558</li>
<li>Dockland 5a02db9d20</li>
<li>DockerUI v0.3 (5094acc024)</li>
</ul>


<h2>Shipyard</h2>

<h3>インストール</h3>

<p><a href="https://github.com/shipyard/shipyard/wiki/QuickStart">QuickStart</a>
の説明を参考にして <code>/etc/default/docker</code> を作成して <code>DOCKER_OPTS</code> を設定します。
<code>-d</code> は <code>/etc/init/docker.conf</code> の方に書いてあるので不要です。</p>

<p>VirtualBox の中で試したので、
IP アドレスは <code>10.0.2.15</code> にしています。</p>

<figure class='code'><figcaption><span>/etc/default/docker</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">DOCKER_OPTS</span><span class="o">=</span><span class="s2">&quot;-H tcp://10.0.2.15:4243 -H unix:///var/run/docker.sock&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>公開されている latest Shipyard image を使って起動します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">docker pull shipyard/shipyard</span>
</span><span class='line'><span class="go">docker run -i -t -d -p 80:80 -p 8000:8000 shipyard/shipyard</span>
</span></code></pre></td></tr></table></div></figure>


<p>バージョンアップの時も同様に <code>docker pull</code> でとってくると
古いイメージがたまっていくので、
<code>docker images</code> で一覧を確認して
<code>REPOSITORY</code> や <code>TAG</code> が <code>&lt;none&gt;</code> になっているイメージを
適当に <code>docker rmi</code> で削除すると良いと思います。</p>

<h3>初期設定</h3>

<p><code>http://127.0.0.1:8000/</code>
を開いて</p>

<ul>
<li>username: <code>admin</code></li>
<li>password: <code>shipyard</code></li>
</ul>


<p>でログインします。</p>

<p>左の <code>Hosts</code> を開いて <code>Add</code> で <code>docker</code> のホストを追加します。
例えば以下のような設定になります。</p>

<ul>
<li>Name: raring64</li>
<li>Hostname: 10.0.2.15</li>
<li>Public hostname: (空欄のまま)</li>
<li>Port: 4243</li>
</ul>


<h3>設定変更など</h3>

<p>以前は右上の <code>admin</code> から <code>administration</code> を選んで、
Django administration から追加する必要があったと思うのですが、
今は shipyard の方で設定できるようになっているようです。
追加や有効・無効の切り替えや削除は出来ても、
編集はまだ出来ないようなので、
<code>Name</code> などを変更したい時は
Django administration
の方を開く必要があるようです。</p>

<p>ログインパスワードの変更などのユーザー管理も
Django administration
の方を開く必要があるようです。</p>

<h3>使用感</h3>

<p>左の <code>Containers</code> や <code>Images</code> を開いてみて見ると何となく使い方がわかると思います。
バージョンアップで機能が増えていきそうなので、細かくは書きませんが、
ログが見えたりするのは便利です。</p>

<p><code>Applications</code> は
<a href="https://github.com/dotcloud/hipache">hipache</a>
に関連しているようです。</p>

<h2>Dockland</h2>

<h3>バージョン</h3>

<p>作りはじめで放置されているようで、
6 commits しかなくて、
latest commit も 2013 年 6 月になっています。
そのためバージョンは前回と変わっていません。</p>

<h3>依存関係</h3>

<p>sinatra ベースで作られていて、
graphviz も必要なので、
クリーンな環境に入れるのは大変です。</p>

<p>前回は docker のホスト側に入れたら大変だったので、
今回は <code>Dockerfile</code> を使ってインストールしました。</p>

<h3>インストール</h3>

<p>README にあった <code>dockland.dockerfile</code>
は古い docker のバージョンが対象のようなので、
最近の docker にあわせて
<code>EXPOSE</code> をコメントアウトするなどの
変更をして使います。
<code>APP_REVISION</code> のあたりは特定のリビジョンに固定して使いたい時のものだと思ったので、コメントアウトしています。</p>

<figure class='code'><figcaption><span>dockland.dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /tmp/dockland.dockerfile
</span><span class='line'>FROM ubuntu:12.04
</span><span class='line'>
</span><span class='line'>RUN sed 's/main$/main universe/' -i /etc/apt/sources.list && apt-get update && apt-get upgrade -y
</span><span class='line'>RUN apt-get install ruby1.9.1 ruby1.9.1-dev build-essential git-core graphviz libssl-dev -y
</span><span class='line'>
</span><span class='line'>RUN git clone https://github.com/dynport/dockland.git /app
</span><span class='line'>
</span><span class='line'># this is to speed up updates
</span><span class='line'>RUN cd /app && gem install bundler --no-ri --no-rdoc && bundle
</span><span class='line'>
</span><span class='line'># change the revision to update your image
</span><span class='line'>#ENV APP_REVISION 51f5445abeeb080568edeca248d68b29a66f1387
</span><span class='line'>#RUN cd /app && git fetch -q origin  && git reset -q --hard $APP_REVISION && git clean -q -d -x -f && bundle
</span><span class='line'>
</span><span class='line'>#EXPOSE 80
</span><span class='line'>
</span><span class='line'>CMD cd /app && bundle exec ./bin/dockland -h ${DOCKER_HOST-http://10.0.2.15:4243} -p 80</span></code></pre></td></tr></table></div></figure>


<p>公開するポートの指定は
docker 0.6.5 から
<code>Dockerfile</code> の
<code>EXPOSE</code> では出来なくなっていて、
<code>docker run</code> の引数の <code>-p</code> で指定する必要があります。
( <a href="http://blog.docker.io/2013/11/docker-0-7-docker-now-runs-on-any-linux-distribution/">Docker 0.7 runs on all Linux distributions – and 6 other major features | Docker Blog</a> の Feature 4: Advanced port redirects 参照)
<code>EXPOSE 80</code> のような指定はまだ使えるように書いてあるのですが、
ちゃんと使えたとしても外側のポートが可変なのは使いにくいので、
起動する時に指定するようにしました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">docker build -t dockland:dockland - &lt; /tmp/dockland.dockerfile</span>
</span><span class='line'><span class="go">id=$(docker run -d -p 8080:80 dockland:dockland)</span>
</span><span class='line'><span class="go">curl -I http://127.0.0.1:8080</span>
</span></code></pre></td></tr></table></div></figure>


<p>docker 側の API の公開設定は shipyard の方で設定したのと同じです。</p>

<h3>使用感</h3>

<p><code>graphviz</code> が必須ということからわかるかもしれませんが、
<code>docker images -viz</code> から生成できるイメージの有向グラフを使っています。
上の例だと <code>http://127.0.0.1:8080/</code> を開くと
矢印で繋がったイメージの ID 一覧が出てきて、
楕円の中の ID をクリックするとイメージの詳細情報が表示できます。</p>

<p>詳細ページには <code>DELETE</code> というボタンがあったり、
History から祖先のイメージをたどれたりするだけで
機能はほとんどありません。</p>

<p><code>docker images -viz</code> の図を良い感じに見たい、
という用途には良さそうです。</p>

<h2>DockerUI</h2>

<p>最後は DockerUI です。</p>

<h3>インストール</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">docker pull crosbymichael/dockerui</span>
</span><span class='line'><span class="go">docker run -d -p 9000:9000 crosbymichael/dockerui -e=&quot;http://10.0.2.15:4243&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>-api-enable-cors</code> は必要?</h3>

<p>DockerUI は docker 側の引数に <code>-api-enable-cors</code> が必要と書いていますが、
ちょっと表示を試した感じでは付けていなくても動いていました。
本当に必要なのでしょうか?</p>

<h3>使用感</h3>

<p>最初の画面で円グラフが表示されているなど、
見た目は良く、
前回試した時に比べて機能も増えているように感じました。</p>

<p>認証がなかったり、 <code>-api-enable-cors</code> が必要と書いていたりして
セキュリティ的に気になる点がありました。</p>

<p>VM の中で動かすだけなので、セキュリティ的なことは気にしないとか、
firewall などで別途セキュリティは確保できるという状態なら
良いのではないでしょうか。</p>

<h3>dokku 環境にインストール</h3>

<p>もうちょっと調べていたところ、
<a href="https://github.com/crosbymichael/dockerui/pull/14">Makes dockerui compatible with dokku</a>
という変更が入っているようなので、
<code>dokku</code> 環境では <code>docker pull</code> の代わりに
<code>dokku</code> への <code>git push</code> で簡単に最新版を使えるようになるようです。</p>

<p><code>dokku</code> への <code>git push</code> は Installing のところで少し時間がかかります。</p>

<p>deploy 出来れば他の <code>dokku</code> に deploy したアプリと同じように
<code>http://dockerui.deploy.127.0.0.1.xip.io</code>
のような <code>dokku</code> で設定した URL で見えるようになります。</p>

<p>参考のため、実際に試したログを載せておきます。
<code>~/.ssh/config</code> で <code>raring64</code> という名前で <code>ssh</code> 接続できるようにしていて、
<code>dokku</code> ユーザーに接続する必要があるので、
<code>dokku@raring64</code> になっています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">%</span> git clone https://github.com/crosbymichael/dockerui
</span><span class='line'><span class="go">Cloning into &#39;dockerui&#39;...</span>
</span><span class='line'><span class="go">remote: Counting objects: 709, done.</span>
</span><span class='line'><span class="go">remote: Compressing objects: 100% (385/385), done.</span>
</span><span class='line'><span class="go">remote: Total 709 (delta 315), reused 705 (delta 314)</span>
</span><span class='line'><span class="go">Receiving objects: 100% (709/709), 2.50 MiB | 585.00 KiB/s, done.</span>
</span><span class='line'><span class="go">Resolving deltas: 100% (315/315), done.</span>
</span><span class='line'><span class="go">Checking connectivity... done.</span>
</span><span class='line'><span class="gp">%</span> <span class="nb">cd </span>dockerui
</span><span class='line'><span class="gp">%</span> git remote add raring64 dokku@raring64:dockerui
</span><span class='line'><span class="gp">%</span> git push raring64 master
</span><span class='line'><span class="go">Counting objects: 705, done.</span>
</span><span class='line'><span class="go">Delta compression using up to 4 threads.</span>
</span><span class='line'><span class="go">Compressing objects: 100% (389/389), done.</span>
</span><span class='line'><span class="go">Writing objects: 100% (705/705), 2.50 MiB | 0 bytes/s, done.</span>
</span><span class='line'><span class="go">Total 705 (delta 313), reused 698 (delta 306)</span>
</span><span class='line'><span class="go">-----&gt; Cleaning up ...</span>
</span><span class='line'><span class="go">-----&gt; Building dockerui ...</span>
</span><span class='line'><span class="go">       Go app detected</span>
</span><span class='line'><span class="go">-----&gt; Installing Go 1.1.2... done</span>
</span><span class='line'><span class="go">       Installing Virtualenv... done</span>
</span><span class='line'><span class="go">       Installing Mercurial... done</span>
</span><span class='line'><span class="go">       Installing Bazaar... done</span>
</span><span class='line'><span class="go">-----&gt; Running: go get -tags heroku ./...</span>
</span><span class='line'><span class="go">-----&gt; Discovering process types</span>
</span><span class='line'><span class="go">       Procfile declares types -&gt; web</span>
</span><span class='line'><span class="go">-----&gt; Releasing dockerui ...</span>
</span><span class='line'><span class="go">-----&gt; Deploying dockerui ...</span>
</span><span class='line'><span class="go">=====&gt; Application deployed:</span>
</span><span class='line'><span class="go">       http://dockerui.deploy.127.0.0.1.xip.io</span>
</span><span class='line'>
</span><span class='line'><span class="go">To dokku@raring64:dockerui</span>
</span><span class='line'><span class="go"> * [new branch]      master -&gt; master</span>
</span><span class='line'><span class="go">Killed by signal 1.</span>
</span><span class='line'><span class="gp">%</span> ssh dokku@raring64 config:set dockerui <span class="nv">DOCKER_ENDPOINT</span><span class="o">=</span>http://10.0.2.15:4243
</span><span class='line'><span class="go">-----&gt; Setting config vars and restarting dockerui</span>
</span><span class='line'><span class="go">DOCKER_ENDPOINT: http://10.0.2.15:4243</span>
</span><span class='line'><span class="go">-----&gt; Releasing dockerui ...</span>
</span><span class='line'><span class="go">-----&gt; Release complete!</span>
</span><span class='line'><span class="go">-----&gt; Deploying dockerui ...</span>
</span><span class='line'><span class="go">-----&gt; Deploy complete!</span>
</span><span class='line'><span class="go">Killed by signal 1.</span>
</span></code></pre></td></tr></table></div></figure>


<p>最初は pull request の説明にあった <code>config:add</code> で試していて、
<code>ssh dokku@raring64 logs dockerui</code> で確認してみても
<code>http: proxy error: unsupported protocol scheme ""</code>
とログに出ているだけでうまく情報がとれていないと思ったら、
<code>config:set</code> が正しい、というのが原因でした。</p>

<h2>まとめ</h2>

<p>以前に試した時は <code>Shipyard</code>
が一番高機能で開発も活発に見えて良さそうに感じましたが、
今は <code>DockerUI</code> も機能が増えていて、
今後、どちらも主流になる可能性があるように感じました。</p>

<p><code>DockerUI</code> の方は認証がなかったり、
docker の設定に <code>-api-enable-cors</code> が必要と書いていたりするので、
セキュリティを気にするのなら、
<code>Shipyard</code> の方がお勧めできると思いました。</p>

<p><code>Dockland</code> は <code>docker images -viz</code> を使っているというアイデアは
良さそうに感じたので、ぜひ他の Web UI でも採用されると便利そうだと
思いました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[upstart-socket-bridgeとrubyを組み合わせる]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-14-upstart-socket-bridge-with-ruby.html"/>
    <updated>2013-12-14T00:45:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/upstart-socket-bridge-with-ruby</id>
    <content type="html"><![CDATA[<p><a href="http://gihyo.jp/admin/clip/01/ubuntu-topics/201312/06">Ubuntu Weekly Topics 2013年12月6日号</a>
の「その他のニュース」で紹介されていた
「upstart-socket-bridgeをxinetdライクなソケット待ち受け管理機構として扱う
<a href="http://cheesehead-techblog.blogspot.jp/2013/12/upstart-socket-bridge.html">アプリケーションの作り方</a>
。」
が python3 で書かれていて、
同じことが ruby で実装できるのか気になったので、
IRC でちょっと助言を受けつつ移植してみました。</p>

<!--more-->


<h2>試した環境</h2>

<ul>
<li>amd64 の Ubuntu 13.10 (saucy)</li>
<li><code>/usr/bin/ruby</code> は <code>ruby 1.9.3p194 (2012-04-20 revision 35410) [x86_64-linux]</code></li>
</ul>


<h2>ruby で試す</h2>

<p>必須なのはソケット周りだけですが、
デバッグ用のメッセージをファイルに残すようにして
動作確認していたので、
その部分も残しています。</p>

<figure class='code'><figcaption><span>/tmp/test-service.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="c1">#!/usr/bin/ruby</span>
</span><span class='line'> <span class="nb">require</span> <span class="s1">&#39;socket&#39;</span>
</span><span class='line'> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/tmp/test.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>   <span class="no">ENV</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
</span><span class='line'>     <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>   <span class="k">begin</span>
</span><span class='line'>     <span class="n">serv_socket</span> <span class="o">=</span> <span class="no">Socket</span><span class="o">.</span><span class="n">for_fd</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;UPSTART_FDS&quot;</span><span class="o">].</span><span class="n">to_i</span><span class="p">)</span>
</span><span class='line'>     <span class="n">client_socket</span><span class="p">,</span> <span class="n">client_addrinfo</span> <span class="o">=</span> <span class="n">serv_socket</span><span class="o">.</span><span class="n">accept</span>
</span><span class='line'>     <span class="n">message</span> <span class="o">=</span> <span class="n">client_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span><span class='line'>     <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="n">message</span>
</span><span class='line'>     <span class="n">client_socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;I got your message: </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>     <span class="n">client_socket</span><span class="o">.</span><span class="n">close</span>
</span><span class='line'>   <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>     <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="n">e</span><span class="o">.</span><span class="n">inspect</span>
</span><span class='line'>     <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>   <span class="n">f</span><span class="o">.</span><span class="n">puts</span> <span class="s2">&quot;finished&quot;</span>
</span><span class='line'> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>バグとしては
<code>for_fd</code> の引数の <code>to_i</code> を忘れていたり、
<code>send</code> の引数が足りなかったりしました。</p>

<figure class='code'><figcaption><span>/etc/init/socket-test.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'> description &quot;upstart-socket-bridge test&quot;
</span><span class='line'> start on socket PROTO=inet PORT=34567 ADDR=127.0.0.1  # 34567 番ポートで待ち受け
</span><span class='line'> setuid exampleuser                                    # root ではなく exampleuser で動作
</span><span class='line'> exec /usr/bin/ruby /tmp/test-service.rb               # サービス起動
</span></code></pre></td></tr></table></div></figure>


<p><code>nc</code> コマンドで接続して動作確認します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go"> $ nc localhost 34567</span>
</span><span class='line'><span class="go"> Hello Ruby</span>
</span><span class='line'><span class="go"> I got your message: Hello Ruby</span>
</span></code></pre></td></tr></table></div></figure>


<p>最後にテストで作成したファイルを削除しておきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go"> $ sudo rm /etc/init/socket-test.conf  # ブリッジとの接続解除</span>
</span><span class='line'><span class="go"> $ rm /tmp/test-service.rb             # テストサービス削除</span>
</span><span class='line'><span class="go"> $ rm /tmp/test.log                    # ログファイル削除</span>
</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>python3 の <code>socket.fromfd</code> に相当するのは
ruby だと <code>BasicSocket.for_fd</code> で、
<code>BasicSocket</code> クラスには <code>accept</code> がないので、
<code>BasicSocket</code> クラスを継承している <code>Socket</code> クラスの
<code>Socket#for_fd</code> を使いました。</p>

<p><code>inetd</code> や <code>xinetd</code> だと標準入出力にソケットをつないでくれて、
サービスは簡単にかけるのに、
<code>upstart</code> だと <code>accept</code> して <code>accept</code> から返ってきたソケットを
<code>close</code> するまでがサービス側でやらないといけないようになっていて、
ちょっと面倒に感じました。</p>

<p>たまたま目についたプログラムを移植してみただけで、
深追いはしていないのですが、
どういう利点があるものなのか、
調べてみるのも良いのかもしれません。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[dockerのカスタムベースイメージを作成する]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-13-docker-custom-base-image.html"/>
    <updated>2013-12-13T18:49:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/docker-custom-base-image</id>
    <content type="html"><![CDATA[<p>例などにある ubuntu の base image は
apt-line が archive.ubuntu.com になっていて、
apt-get install などが遅いです。</p>

<p>日本で使うのなら日本のミラーを使った方が良いので、
そういう base image を作ります。</p>

<p>base image はあまりカスタマイズせずに、
派生するイメージにDockerfile などを使って
カスタマイズをした方が望ましいのですが、
ほぼ必須のものを毎回インストールするのは無駄なので、
ついでに日本語 locale を入れるというカスタマイズもしておきます。</p>

<!--more-->


<h2>docker 向けのポイント</h2>

<p>最初に docker 向けのポイントをまとめておきます。</p>

<ul>
<li>最小限にするなら <code>--variant=minbase</code></li>
<li><code>--include=iproute</code> などで <code>iproute</code> パッケージを入れておかないとネットワークにつながらない</li>
<li><code>policy-rc.d</code> とか <code>initctl</code> を対処しておかないとパッケージのインストール時に変なことになるかも</li>
<li><code>dpkg</code> に <code>force-unsafe-io</code> を設定すると <code>apt</code> を高速化できる</li>
<li><a href="https://github.com/dotcloud/docker/blob/master/contrib/mkimage-debootstrap.sh">mkimage-debootstrap.sh</a> をそのまま使う場合も日本のミラーを指定する方が良い</li>
</ul>


<h2>base image の作り方</h2>

<p>公式ドキュメントの
<a href="http://docs.docker.io/en/latest/use/baseimages/">Base Image Creation</a>
を参考にして、基本は
<a href="https://github.com/dotcloud/docker/blob/master/contrib/mkimage-debootstrap.sh">mkimage-debootstrap.sh</a>
の手順を使います。</p>

<p>カスタマイズのため、手順を追いかけるだけで直接は使いません。</p>

<h2>debootstrap の実行</h2>

<p>最初は以下のように <code>/tmp/wheezy64</code> などの適当な場所に
<code>debootstrap</code> で <code>chroot</code> 環境を作成します。
proxy 環境なら <code>sudo http_proxy=$http_proxy debootstrap ...</code>
のように指定すれば良いようです。</p>

<p>Debian での例:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> sudo debootstrap --verbose --variant=minbase --include=iproute --arch=amd64 wheezy /tmp/wheezy64 http://cdn.debian.or.jp/debian</span></code></pre></td></tr></table></div></figure>


<p>Ubuntu での例:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> sudo debootstrap --verbose --variant=minbase --arch=amd64 precise /tmp/precise64 http://ftp.jaist.ac.jp/pub/Linux/ubuntu/</span></code></pre></td></tr></table></div></figure>


<h3>variant</h3>

<p><code>variant</code> で <code>minbase</code> を指定するとインストールされるパッケージが減って、
本当に最小限の環境になります。
具体的には <code>Essential: yes</code> のパッケージ
( <code>aptitude search '~E'</code> または <code>aptitude search '?essential'</code> で一覧)
と <code>apt</code> がインストールされます。</p>

<p><code>buildd</code> という <code>variant</code> もあって <code>minbase</code> に加えて
<code>build-essential</code> が追加でインストールされるようなので、
CI 環境用などの base image なら <code>--variant=buildd</code> の方が
良いかもしれません。</p>

<p>デフォルトだと <code>Priority</code> が <code>imporant</code> のパッケージ
( <code>aptitude search '~pimportant</code> または <code>aptitude search '?priority(important)' で一覧)
がインストールされるようです。
インストールされるパッケージの差分は
</code>aptitude search &lsquo;~pimportant!~E`
で調べられます。</p>

<h3>include</h3>

<p>元の <code>mkimage-debootstrap.sh</code> では <code>iproute,iputils-ping</code> と指定してますが、
<code>iputils-ping</code> は必須ではないのでここでは省略しています。</p>

<p><code>iproute</code> は docker 環境では必須です。
このパッケージに含まれる <code>ip</code> コマンドが入っていないとネットワークにつながりません。</p>

<p><code>iproute</code> パッケージは <code>Priority</code> が <code>optional</code> なので
普通に <code>debootstrap</code> を実行しても入らないので、
注意が必要です。</p>

<h3>その他の引数</h3>

<p>arch の指定とか suite の指定とか生成先ディレクトリの指定とか、
ミラーの指定とかは見てわかる通りです。</p>

<h2>docker 向けのカスタマイズ</h2>

<p>次に生成されたディレクトリの中で
<code>mkimage-debootstrap.sh</code>
にデフォルト (<code>-d</code> オプションが指定されなかったとき) の処理をしていきます。</p>

<h3>policy-rc.d</h3>

<p>ファイルの作成方法は何でも良いのですが、
exit status で 101 を返す <code>usr/sbin/policy-rc.d</code> を作成して、
パッケージのインストールやアップデートなどで init スクリプトが
実行されないようにします。</p>

<p>ちなみに
<code>$'...'</code> は bash に <code>\n</code> を解釈させるための書き方なので、
<code>'...'</code> や <code>"..."</code> の間違いではありません。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> echo $'#!/bin/sh\nexit 101' | sudo tee usr/sbin/policy-rc.d &gt; /dev/null
</span><span class='line'> sudo chmod +x usr/sbin/policy-rc.d</span></code></pre></td></tr></table></div></figure>


<p><code>policy-rc.d</code> については <code>invoke-rc.d</code> の man を参照してください。</p>

<h3>sbin/initctl</h3>

<p>initctl を実行してしまう upstart スクリプトがあるらしく、
その対処もします。</p>

<p>policy-rc.d は存在しなかったので、作成するだけでしたが、
<code>sbin/initctl</code> はパッケージ管理のファイルとして存在するので
<code>dpkg-divert</code> でパッケージの更新などで上書きされないようにしています。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> sudo chroot . dpkg-divert --local --rename --add /sbin/initctl
</span><span class='line'> sudo ln -sf /bin/true sbin/initctl</span></code></pre></td></tr></table></div></figure>


<h3>パッケージのキャッシュの削除</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> sudo chroot . apt-get clean</span></code></pre></td></tr></table></div></figure>


<p>を実行して不要な deb ファイルなどを削除して、
イメージのサイズを削減しています。</p>

<p>後で独自カスタマイズのところでパッケージをインストールして、
その後でまた実行するので、その場合はここでは実行しなくてもかまいません。</p>

<h3>apt の高速化など</h3>

<p><code>mkimage-debootstrap.sh</code> のコメントには
<code>dpkg</code> がパッケージの展開後に <code>sync()</code> を呼んでいるのが
原因で無駄に遅くなっているので、
強制的に <code>sync()</code> を呼ばなくさせると書いています。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> echo 'force-unsafe-io' | sudo tee etc/dpkg/dpkg.cfg.d/02apt-speedup &gt; /dev/null</span></code></pre></td></tr></table></div></figure>


<p>それから、 deb ファイルを残さないようにして image ファイルが大きくならないようにしています。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> echo 'DPkg::Post-Invoke {"/bin/rm -f /var/cache/apt/archives/*.deb || true";};' | sudo tee etc/apt/apt.conf.d/no-cache &gt; /dev/null</span></code></pre></td></tr></table></div></figure>


<h3>元に戻す方法</h3>

<p><code>mkimage-debootstrap.sh</code> のコメントに
元に戻す方法も書いてありました。
<code>dpkg-divert</code> 以外はファイルを消すだけです。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> rm /usr/sbin/policy-rc.d
</span><span class='line'> rm /sbin/initctl; dpkg-divert --rename --remove /sbin/initctl
</span><span class='line'> rm /etc/dpkg/dpkg.cfg.d/02apt-speedup
</span><span class='line'> rm /etc/apt/apt.conf.d/no-cache</span></code></pre></td></tr></table></div></figure>


<h3>apt-line の変更</h3>

<p><code>etc/apt/sources.list</code> をみると</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> deb http://cdn.debian.or.jp/debian wheezy main</span></code></pre></td></tr></table></div></figure>


<p>だけになっているので、 <code>updates</code> と <code>security</code> を追加します。</p>

<p><code>mkimage-debootstrap.sh</code> もデフォルト
(<code>-d</code> も <code>-s</code> も指定されていないとき)
の動作では追加します。</p>

<p>この例では以下のようにしました。</p>

<p>debian での例:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> deb http://cdn.debian.or.jp/debian wheezy main
</span><span class='line'> deb http://cdn.debian.or.jp/debian wheezy-updates main
</span><span class='line'> deb http://security.debian.org/ wheezy/updates main</span></code></pre></td></tr></table></div></figure>


<p>ubuntu での例:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> deb http://ftp.jaist.ac.jp/pub/Linux/ubuntu precise main universe
</span><span class='line'> deb http://ftp.jaist.ac.jp/pub/Linux/ubuntu precise-updates main universe
</span><span class='line'> deb http://ftp.jaist.ac.jp/pub/Linux/ubuntu precise-security main universe</span></code></pre></td></tr></table></div></figure>


<p>main 以外を追加したい場合はここで追加しておくと良さそうです。
<code>mkimage-debootstrap.sh</code> でも ubuntu の場合は <code>universe</code> が追加されていました。</p>

<h2>独自カスタマイズ</h2>

<p>ここから独自カスタマイズになります。</p>

<h3>アップデート実行</h3>

<p>base image にセキュリティアップデートも入れておきたいなら、
更新しておきます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> sudo chroot . apt-get update
</span><span class='line'> sudo chroot . apt-get dist-upgrade</span></code></pre></td></tr></table></div></figure>


<h3>日本語 locale 追加</h3>

<p>debian の場合は
別環境で <code>debconf-get-selections</code> で調べておいた設定を使って、
<code>debconf-set-selections</code> で設定を入れておいて
<code>DEBIAN_FRONTEND=noninteractive</code> でインストールします。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> echo locales locales/locales_to_be_generated multiselect ja_JP.EUC-JP EUC-JP, ja_JP.UTF-8 UTF-8 | sudo chroot . debconf-set-selections
</span><span class='line'> echo locales locales/default_environment_locale select ja_JP.UTF-8 | sudo chroot . debconf-set-selections
</span><span class='line'> sudo chroot . env DEBIAN_FRONTEND=noninteractive apt-get install locales</span></code></pre></td></tr></table></div></figure>


<p>ubuntu の場合は
<code>language-pack-ja</code> パッケージを入れても良いのですが、
不要なパッケージを入れるのが嫌なら <code>locale-gen</code> コマンドで
生成しても良いです。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> sudo chroot . locale-gen ja_JP.UTF-8
</span><span class='line'> sudo chroot . locale-gen ja_JP.EUC-JP</span></code></pre></td></tr></table></div></figure>


<h3>パッケージのキャッシュの削除</h3>

<p>カスタマイズが終わったら clean を実行しておきます。
<code>etc/apt/apt.conf.d/no-cache</code> を作成していれば不要かもしれません。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> sudo chroot . apt-get clean</span></code></pre></td></tr></table></div></figure>


<h2>イメージ作成と取り込み</h2>

<h3>tarball 作成</h3>

<p><code>mkimage-debootstrap.sh</code> は <code>-t</code> オプションが指定されたときに
docker のイメージではなく tarball を作成します。
直接取り込むならこの手順は不要です。</p>

<p>作成方法としては
最初に <code>touch</code> で一般ユーザー権限のファイルになるようにしておいて、
中身は <code>root</code> 権限で入れるようにしています。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> touch /tmp/wheezy64.tar.xz
</span><span class='line'> sudo tar --numeric-owner -caf /tmp/wheezy64.tar.xz .</span></code></pre></td></tr></table></div></figure>


<h3>イメージ取り込み</h3>

<p><code>sudo docker</code> は root 権限が不要な設定にいていれば <code>docker</code> だけでかまいません。</p>

<p><code>mkimage-debootstrap.sh</code> は安定版や LTS に <code>latest</code> タグを設定したり、
<code>etc/debian_version</code> や <code>etc/lsb-release</code> をみて
タグを設定しているので、必要に応じて設定しておきます。</p>

<p>イメージ名としては「ユーザー名/レポジトリ名」という形式が推奨されていますが、
ここでは例として「ユーザー名」の部分は「local」にしておきます。
そして「レポジトリ名」としては日本語 locale を入れたということで
<code>-ja</code> を付けました。
日本のミラーを使っているということで <code>-ja-jp</code> にしても良かったのですが、
長かったので、 <code>-ja</code> だけにしました。</p>

<p>Debian での例:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> sudo tar --numeric-owner -c . | sudo docker import - local/debian-ja:wheezy
</span><span class='line'> sudo docker tag local/debian-ja:wheezy local/debian-ja:latest
</span><span class='line'> sudo docker tag local/debian-ja:wheezy local/debian-ja:7.2</span></code></pre></td></tr></table></div></figure>


<p>Ubuntu での例:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> sudo tar --numeric-owner -c . | sudo docker import - local/ubuntu-ja:precise
</span><span class='line'> sudo docker tag local/ubuntu-ja:precise local/ubuntu-ja:latest
</span><span class='line'> sudo docker tag local/ubuntu-ja:precise local/ubuntu-ja:12.04</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p><a href="https://github.com/dotcloud/docker/blob/master/contrib/mkimage-debootstrap.sh">mkimage-debootstrap.sh</a>
で何をやっているのか、
同じことを手動でやるのはどうするのかということを説明しました。</p>

<p>最初のポイントにも書きましたが
<code>mkimage-debootstrap.sh</code>
を直接使うのも良いですが、
最低限ミラーを指定するのがおすすめです。</p>

<p>目的によっては <code>variant</code> を変更したり、
<code>include</code> でインストールするパッケージを増やしておくだけでも
便利になると思います。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[zshのPATHの自動重複削除や余計なPATHの削除]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-12-zsh-cleanup-path.html"/>
    <updated>2013-12-12T00:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/zsh-cleanup-path</id>
    <content type="html"><![CDATA[<p>シェルの中から <code>exec zsh</code> をしたり、
GNU screen や tmux を経由して間接的にシェルの中でシェルを開いたりするときに
何も考えずに <code>PATH</code> を追加していくと
どんどん長くなっていってしまうと思います。</p>

<p><code>bash</code> などでも使えるように汎用的にしようとすると自前で頑張らないといけないのですが、
<code>zsh</code> では <code>zsh</code> 自体の機能で簡単に重複を防げます。</p>

<p>また、パスに望ましくないものが入っていた時に削除する方法も紹介します。</p>

<p>この投稿は
<a href="http://qiita.com/advent-calendar/2013/zsh">zsh Advent Calendar 2013</a>
の12日目の記事です。</p>

<!--more-->


<h2>重複削除</h2>

<p>重複を削除するには</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>typeset -U path PATH</span></code></pre></td></tr></table></div></figure>


<p>で <code>path</code> と <code>PATH</code> に unique という属性を付けて、
重複した値の最初だけ残すようにします。</p>

<p>ちゃんと設定できていれば、パラメーター展開の <code>t</code>
で調べた時に <code>unique</code> が付いています。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% echo ${(t)path}
</span><span class='line'>array-unique-special
</span><span class='line'>% echo ${(t)PATH}
</span><span class='line'>scalar-export-unique-special</span></code></pre></td></tr></table></div></figure>


<h2>望ましくないパスの削除</h2>

<p>ここでは 3 種類のパスを望ましくないものとして
除外するようにしました。</p>

<ol>
<li><code>NULL_GLOB</code> の <code>N</code> を使って存在しないディレクトリを除外</li>
<li><code>-/</code> を使ってシンボリックリンクの場合のリンク先もチェックした上でディレクトリのみ残す</li>
<li><code>^W</code> で world-writable という実行ファイルのパスとしては危険なパーミッションになっているディレクトリを除外</li>
</ol>


<p>Glob Qualifiers なので <code>PATH</code> ではなく <code>path</code> を使ってフィルタリングしています。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>path=(
</span><span class='line'>    # allow directories only (-/)
</span><span class='line'>    # reject world-writable directories (^W)
</span><span class='line'>    $path(N-/^W)
</span><span class='line'>)</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>ここでは <code>zsh</code> の機能を活用してコマンド探索パス <code>PATH</code> をきれいにする方法を紹介しました。</p>

<p>これを応用して <code>fpath</code> などにも適用してみると良いかもしれません。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[mailmanでDKIM-Signatureヘッダを削除する]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-11-mailman-strip-dkim-signature.html"/>
    <updated>2013-12-11T12:30:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/mailman-strip-dkim-signature</id>
    <content type="html"><![CDATA[<p>fml から移行した mailman で Subject の書き換える設定をしていると、
元の <code>DKIM-Signature</code> が残っていると受け取った側で
メールを改ざんしているのと区別がつかないので、
<code>DKIM</code> の検証に失敗してしまいます。</p>

<p>そこで mailman で <code>DKIM-Signature</code> を削除するように設定しました。</p>

<!--more-->


<h2>mailman の設定</h2>

<p><code>REMOVE_DKIM_HEADERS</code> という設定があったので、
<code>/etc/mailman/mm_cfg.py</code> の末尾に</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>REMOVE_DKIM_HEADERS = Yes</span></code></pre></td></tr></table></div></figure>


<p>という設定を追加して、
<code>sudo service mailman restart</code>
しました。</p>

<p><code>mm_cfg.py</code> での設定なので、
ML 個別の設定ではなく
mailman 全体の設定になるようです。</p>

<h2>参考</h2>

<p><a href="https://bugs.launchpad.net/mailman/+bug/557493">Bug #557493 “Mailman must not strip DKIM-Signature headers” : Bugs : GNU Mailman</a>
という話があって、設定が追加されたようです。</p>

<p><code>mm_cfg.py</code> で設定できる項目の一覧は
<code>/usr/lib/mailman/Mailman/Defaults.py</code>
にあります。
このファイルを良く見ていれば、もっと早くこの設定項目に気付けたのかもしれません。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[emacsのmode-lineのminor-modeなどに色をつける]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-11-emacs-color-mode-line.html"/>
    <updated>2013-12-11T00:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/emacs-color-mode-line</id>
    <content type="html"><![CDATA[<p>emacs の mode-line の minor mode の表示が長いので短くしているのですが、
単純に短くするとわかりにくいので、色もつけています。</p>

<p>ところが、変数で設定できるようになっているものだと単純に
<code>propertize</code> して <code>setq</code> するだけでは色がつかなかったので、
その対処も含めてまとめてみました。</p>

<p>この投稿は
<a href="http://qiita.com/advent-calendar/2013/dot-emacs">.emacs Advent Calendar 2013</a>
の11日目の記事です。</p>

<!--more-->


<h2>単純に短くする</h2>

<p>単純に短くするには <code>minor-mode-alist</code> の文字列を直接変更してしまうだけです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='common-lisp'><span class='line'><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">consp</span> <span class="p">(</span><span class="nv">assq</span> <span class="ss">&#39;abbrev-mode</span> <span class="nv">minor-mode-alist</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">setcar</span> <span class="p">(</span><span class="nb">cdr</span> <span class="p">(</span><span class="nv">assq</span> <span class="ss">&#39;abbrev-mode</span> <span class="nv">minor-mode-alist</span><span class="p">))</span> <span class="s">&quot; ab&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">consp</span> <span class="p">(</span><span class="nv">assq</span> <span class="ss">&#39;auto-fill-function</span> <span class="nv">minor-mode-alist</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">setcar</span> <span class="p">(</span><span class="nb">cdr</span> <span class="p">(</span><span class="nv">assq</span> <span class="ss">&#39;auto-fill-function</span> <span class="nv">minor-mode-alist</span><span class="p">))</span> <span class="s">&quot; Fil&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>色も付ける</h2>

<p><code>propertize</code> で <code>face</code> を付けた文字列を設定すると色が付きます。</p>

<p><code>face</code> プロパティの設定としては、
最低限 <code>:foreground</code> と <code>:background</code> を知っておけば良いと思います。
指定できる色は <code>list-colors-display</code> で一覧できます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='common-lisp'><span class='line'><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">consp</span> <span class="p">(</span><span class="nv">assq</span> <span class="ss">&#39;abbrev-mode</span> <span class="nv">minor-mode-alist</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">setcar</span> <span class="p">(</span><span class="nb">cdr</span> <span class="p">(</span><span class="nv">assq</span> <span class="ss">&#39;abbrev-mode</span> <span class="nv">minor-mode-alist</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">propertize</span> <span class="s">&quot;省&quot;</span> <span class="ss">&#39;face</span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">:foreground</span> <span class="s">&quot;green&quot;</span><span class="p">))))</span>
</span><span class='line'><span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">consp</span> <span class="p">(</span><span class="nv">assq</span> <span class="ss">&#39;auto-fill-function</span> <span class="nv">minor-mode-alist</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">setcar</span> <span class="p">(</span><span class="nb">cdr</span> <span class="p">(</span><span class="nv">assq</span> <span class="ss">&#39;auto-fill-function</span> <span class="nv">minor-mode-alist</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">propertize</span> <span class="s">&quot;詰&quot;</span> <span class="ss">&#39;face</span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">:foreground</span> <span class="s">&quot;yellow&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>設定対象の探し方</h2>

<p>ここでは例として <code>abbrev-mode</code> と <code>auto-fill-mode</code> をあげていますが、
<code>auto-fill-mode</code> が <code>auto-fill-function</code> になっているなど、
単純に決まっているものだけではなさそうなので、
他の設定をどうするのかは、
<code>describe-variable</code> で <code>minor-mode-alist</code> をみて探すのが良さそうでした。</p>

<h2>設定用関数</h2>

<p>毎回長々と書くのは面倒なので、以下の関数を定義して使っています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='common-lisp'><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">my-shorten-minor-mode-name</span> <span class="p">(</span><span class="nv">mode-sym</span> <span class="nv">short-name</span> <span class="k">&amp;optional</span> <span class="nv">face</span><span class="p">)</span>
</span><span class='line'>  <span class="s">&quot;minor-modeの名前を短くする。&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">cell</span> <span class="p">(</span><span class="nv">assq</span> <span class="nv">mode-sym</span> <span class="nv">minor-mode-alist</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">consp</span> <span class="nv">cell</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="k">if</span> <span class="nv">face</span>
</span><span class='line'>          <span class="p">(</span><span class="k">setq</span> <span class="nv">short-name</span> <span class="p">(</span><span class="nv">propertize</span> <span class="nv">short-name</span> <span class="ss">&#39;face</span> <span class="nv">face</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="k">setq</span> <span class="nv">short-name</span> <span class="p">(</span><span class="nv">concat</span> <span class="s">&quot; &quot;</span> <span class="nv">short-name</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">setcar</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">cell</span><span class="p">)</span> <span class="nv">short-name</span><span class="p">))</span>
</span><span class='line'>    <span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>起動時に読み込まれていない minor-mode の設定</h2>

<p><code>view-mode</code> のように起動時に読み込まれていない <code>minor-mode</code> は
<code>.emacs</code> のタイミングで書き換えようとしても
<code>minor-mode-alist</code> に登録されていないのでうまくいきません。
こういう場合は <code>eval-after-load</code> で設定しています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='common-lisp'><span class='line'><span class="p">(</span><span class="nv">eval-after-load</span> <span class="s">&quot;view&quot;</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">(</span><span class="nv">my-shorten-minor-mode-name</span>
</span><span class='line'>    <span class="ss">&#39;view-mode</span> <span class="s">&quot;見&quot;</span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">:foreground</span> <span class="s">&quot;white&quot;</span> <span class="ss">:background</span> <span class="s">&quot;DeepPink1&quot;</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>変数で設定できる場合</h2>

<p><code>eldoc-minor-mode</code> のように変数で設定できるようになっているものがあります。
こういう場合は単純に <code>propertize</code> した文字列を <code>setq</code> しても
プロパティが無視されて色がつきません。</p>

<p>理由は <code>mode-line-format</code> のドキュメントの
<a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Properties-in-Mode.html#Properties-in-Mode">23.4.6 Properties in the Mode Line</a>
に書いてあって、
<code>risky-local-variable</code> が non-nil じゃないとテキストプロパティが
無視されるということでした。</p>

<p>そこで <code>risky-local-variable</code> に <code>t</code> を設定すれば色がつくようになりました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='common-lisp'><span class='line'><span class="p">(</span><span class="nv">put</span> <span class="ss">&#39;eldoc-minor-mode-string</span> <span class="ss">&#39;risky-local-variable</span> <span class="no">t</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">setq</span> <span class="nv">eldoc-minor-mode-string</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">propertize</span> <span class="s">&quot;d&quot;</span> <span class="ss">&#39;face</span> <span class="o">&#39;</span><span class="p">(</span><span class="ss">:foreground</span> <span class="s">&quot;purple&quot;</span> <span class="ss">:background</span> <span class="s">&quot;yellow&quot;</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>anzu.el での例</h2>

<p>他の例も挙げておくと
<a href="http://qiita.com/syohex/items/56cf3b7f7d9943f7a7ba">anzu.el</a>
なら以下のように設定しています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='common-lisp'><span class='line'>  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;anzu</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">put</span> <span class="ss">&#39;anzu-mode-lighter</span> <span class="ss">&#39;risky-local-variable</span> <span class="no">t</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">setq</span> <span class="nv">anzu-mode-lighter</span> <span class="p">(</span><span class="nv">propertize</span> <span class="s">&quot;杏&quot;</span> <span class="ss">&#39;face</span> <span class="ss">&#39;anzu-mode-line</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">global-anzu-mode</span> <span class="mi">+1</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>ここでは <code>minor-mode</code> を中心に <code>mode-line</code> を短くして、
色をつける方法に付いて紹介しました。
<code>major-mode</code> も含めて実際に使っている設定は
<a href="https://github.com/znz/dot-emacs/blob/8434c73ba833791eedc1411360e10441e52b370e/init.el.d/50mode-line.el">50mode-line.el</a>
に公開しているので、参考にしてください。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[.zshrcの自動再コンパイル]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-10-auto-zshrc-recompile.html"/>
    <updated>2013-12-10T00:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/auto-zshrc-recompile</id>
    <content type="html"><![CDATA[<p>zsh のスクリプトは <code>zcompile</code> コマンドでコンパイルすることができます。
<code>.zshrc</code> も大きくなって読み込みに時間がかかるようになったらコンパイルすれば良さそうですが、
変更したときに手動でコンパイルし直すのは面倒なので、
自動で再コンパイルする設定を紹介します。</p>

<p>この投稿は
<a href="http://qiita.com/advent-calendar/2013/zsh">zsh Advent Calendar 2013</a>
の10日目の記事です。</p>

<!--more-->


<h2>設定方法</h2>

<p><code>.zshrc</code> の適当な場所に以下の設定を追加します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="k">if</span> <span class="o">[</span> ~/.zshrc -nt ~/.zshrc.zwc <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span>zcompile ~/.zshrc
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>これで <code>.zshrc.zwc</code> より <code>.zshrc</code> の方が新しい時に
<code>zcompile .zshrc</code> が自動で実行されます。</p>

<p><code>.zshrc.zwc</code> がある時だけ実行されるので、
最初に <code>zcompile ~/.zshrc</code> を手動で実行しておきます。</p>

<h2>読み込み順序</h2>

<p>zsh 自体が <code>file.zwc</code> よりも <code>file</code> の方が新しい時に
<code>file</code> の方を読み込むようになっているので、
<code>.zshrc</code> の方が新しくて <code>zcompile</code> し直していないときに
<code>.zshrc.zwc</code> が読み込まれて
古い設定のままになるということはありません。</p>

<h2>自動作成もする場合</h2>

<p>ファイルを分割していて <code>.zshrc</code> はコンパイルする必要がない環境では
何もしない挙動になってほしいので、
こうしていますが、
最初から自動作成してほしいのなら、
存在チェックも付けて以下のようにすれば良いと思います。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="k">if</span> <span class="o">[</span> ! -f ~/.zshrc.zwc -o ~/.zshrc -nt ~/.zshrc.zwc <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span>zcompile ~/.zshrc
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>ここでは <code>.zshrc</code> だけを対象にしましたが、
他にも自前の <code>fpath</code> のファイルなどで自動で再コンパイルしたいファイルがあれば
同様のことをするのがよいかもしれません。</p>

<p>あまり変更しないファイルなら更新チェックの無駄の方が大きいかもしれないので、
そのトレードオフは考えておく必要がありそうです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rail 3.2でcache_digestsを使ってみた]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-08-cache-digests.html"/>
    <updated>2013-12-08T00:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/cache-digests</id>
    <content type="html"><![CDATA[<p>まだ Rails 3.2.16 のままのアプリで <code>cache_digests</code> gem を使って
fragment cache を導入してみました。</p>

<p>Rails 4.0 では標準になっているはずなので、
使い方は同じだと思います。</p>

<p>この投稿は
<a href="http://qiita.com/advent-calendar/2013/ruby-on-rails">Ruby on Rails Advent Calendar 2013</a>
の8日目の記事です。</p>

<!--more-->


<h2>インストール</h2>

<p>まず <code>Gemfile</code> に以下の gem の指定を追加してインストールしました。</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;cache_digests&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;dalli&#39;</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="ss">:production</span>
</span></code></pre></td></tr></table></div></figure>


<h2>環境設定</h2>

<p>キャッシュの影響の確認などのデバッグ用に <code>development</code> 環境でも
キャッシュを有効にしました。
ちゃんとキャッシュで来ているかどうかの確認や削除がしやすいように
保存先はデフォルトの <code>:file_store</code> のままにしています。</p>

<figure class='code'><figcaption><span>config/environments/development.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">action_controller</span><span class="o">.</span><span class="n">perform_caching</span> <span class="o">=</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>production</code> 環境では <code>dalli</code> を使って <code>memcached</code> に保存するようにしました。
<code>dalli</code> の設定はこの記事の本題ではないので、
<code>memcached</code> の設定などは他のサイトを参考にしてください。</p>

<figure class='code'><figcaption><span>config/environments/production.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">cache_store</span> <span class="o">=</span> <span class="ss">:dalli_store</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>staging</code> 環境もあったので <code>config/environments/staging.rb</code> にも同様の設定をしました。</p>

<h2>fragment cache</h2>

<p>すでに
<code>app/views/comments/_comment.html.haml</code> や
<code>app/views/posts/_post.html.haml</code> のような view を使って
<code>render @comments</code> や <code>render @posts</code> のように使っていたので、</p>

<figure class='code'><figcaption><span>app/views/comments/_comment.html.haml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>- cache comment do
</span><span class='line'>  -# 今までの内容
</span></code></pre></td></tr></table></div></figure>


<p>のように <code>cache comment do ... end</code> で今までの内容をくくるだけでした。
<code>cache</code> メソッド自体の返り値は <code>=</code> で埋め込んだりせずにそのまま呼ぶだけで大丈夫でした。</p>

<h2>動作確認</h2>

<p><code>log/developement.log</code> などを <code>fragment</code> で検索してみると</p>

<figure class='code'><figcaption><span>log/developement.log</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Write fragment views/comments/29-20130905083500/96f0ec0ce36af8132826f3bfbe0079db 0.5ms
</span><span class='line'>Read fragment views/comments/30-20130905083518/96f0ec0ce36af8132826f3bfbe0079db 0.4ms
</span></code></pre></td></tr></table></div></figure>


<p>などと記録されていて、キャッシュが使われていることが確認できました。</p>

<p><code>development</code> 環境では実際のキャッシュファイルは <code>tmp/cache/</code> 以下にありました。</p>

<h2>キャッシュの無効化 (invalidate)</h2>

<p>キャッシュが古くなってもう有効ではないという状態にすることを invalidate というと思いますが、
内容が更新された時に古いキャッシュが使われると問題があるので、
その対処をする必要があります。</p>

<p><code>cache</code> メソッドの引数に <code>ActiveRecord</code> のオブジェクトを渡した時の
キャッシュのキーは先ほどの例だと
<code>views/comments/:id-:updated_at/:md5</code>
という感じで <code>comment</code> オブジェクトの <code>id</code> と <code>updated_at</code> と
<code>app/views/comments/_comment.html.haml</code> の MD5 が使われていて、
view のファイルが変更したり、
<code>comment</code> ファイルの <code>updated_at</code> を更新したりした時に
自動で無効になるようです。</p>

<p>つまり、この view の中で別の partial render を使っていると
反映されないということなので、
内側の方でも <code>cache</code> を使うなどの対処が必要そうです。
実際に <code>_post.html.haml</code> の中で <code>render post.comments</code> のようなことをしました。</p>

<p>さらに以下のように <code>belongs_to</code> に <code>touch: true</code> を付けて、
コメントが付いた時に <code>post</code> の <code>updated_at</code> も更新されるようにしました。</p>

<figure class='code'><figcaption><span>app/models/comment.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:commentable</span><span class="p">,</span> <span class="ss">polymorphic</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">touch</span><span class="p">:</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<h2>キャッシュの完全削除</h2>

<p><code>rails console</code> で <code>Rails.cache.clear</code> を実行すれば削除できました。
他の sass などのキャッシュも <code>tmp/cache/</code> の中にあるので
一緒に削除されてしまうようです。</p>

<h2>まとめ</h2>

<p>とりあえず使い始めるための最低限の知識をまとめてみました。</p>

<p>後は
<a href="http://ja.asciicasts.com/episodes/387-cache-digests">ASCIIcasts &ndash; “Episode 387 &ndash; Cache Digests”</a>
で説明されている
<code>rake cache_digests:nested_dependencies</code>
などを知っておけば良さそうです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ansibleで1ファイルのplaybookからroleに書き換える方法]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-07-ansible-split-playbook.html"/>
    <updated>2013-12-07T01:30:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/ansible-split-playbook</id>
    <content type="html"><![CDATA[<p><code>ansible</code> を使い始める時は1個の YAML ファイルから始めるのが手軽で良いのですが、
それを
<a href="http://www.ansibleworks.com/docs/playbooks_best_practices.html">Best Practices</a>
にあわせて <code>roles</code> にしようとしたら、
対応がよくわからなくて困ったことがあったので、
書き換え方をまとめてみました。</p>

<p>この投稿は
<a href="http://qiita.com/advent-calendar/2013/ansible">Ansible Advent Calendar 2013</a>
の7日目の記事です。</p>

<!--more-->


<p>全体的に動作確認せずに以前使ったファイルを参考にしているので、
間違っている部分があるかもしれないので、その時はコメントなどで
教えてください。</p>

<h2>1個の YAML ファイルの例</h2>

<p>仮にこんな感じの <code>playbook.yml</code> があって、
これを <code>roles</code> にしたいとします。</p>

<figure class='code'><figcaption><span>playbook.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo-servers</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">adminuser</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vagrant</span>
</span><span class='line'>    <span class="l-Scalar-Plain">admingroup</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vagrant</span>
</span><span class='line'>    <span class="l-Scalar-Plain">homedir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/vagrant</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pkg=zsh</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=zshrc dest=/.zshrc owner= group= mode=0644</span>
</span></code></pre></td></tr></table></div></figure>


<p>この例だとテンプレートファイルとして <code>zshrc</code> ファイルが同じディレクトリにあります。</p>

<h2>role 作成</h2>

<p>ここでは role の名前を <code>zsh</code> にしてみます。</p>

<p>元の <code>playbook.yml</code> と <code>zshrc</code> から</p>

<ul>
<li><code>roles/zsh/tasks/main.yml</code></li>
<li><code>roles/zsh/templates/zshrc.j2</code></li>
<li><code>roles/zsh/vars/main.yml</code></li>
</ul>


<p>というファイルを作ることになります。</p>

<h3>roles/zsh/tasks/main.yml</h3>

<p>処理のメイン部分です。
元の <code>playbook.yml</code> の <code>tasks</code> の値に並んでいた配列を書きます。</p>

<figure class='code'><figcaption><span>roles/zsh/tasks/main.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pkg=zsh</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=zshrc dest=/.zshrc owner= group= mode=0644</span>
</span></code></pre></td></tr></table></div></figure>


<h3>roles/zsh/templates/zshrc.j2</h3>

<p>元の <code>zshrc</code> にテンプレート言語がわかりやすいように拡張子を付けただけです。
例として <code>zshrc</code> にしてしまっただけなので、
本来は <code>vars</code> の変数を展開したいファイルを使うことになると思います。</p>

<h3>roles/zsh/vars/main.yml</h3>

<p>変数の定義部分です。
元の <code>playbook.yml</code> の <code>vars</code> の値に並んでいたハッシュを書きます。</p>

<figure class='code'><figcaption><span>roles/zsh/vars/main.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">adminuser</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vagrant</span>
</span><span class='line'><span class="l-Scalar-Plain">admingroup</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vagrant</span>
</span><span class='line'><span class="l-Scalar-Plain">homedir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/vagrant</span>
</span></code></pre></td></tr></table></div></figure>


<h3>その他</h3>

<p><code>roles/zsh/handleres/main.yml</code> のような他のディレクトリとか、
<code>main.yml</code> 以外の <code>*.yml</code> ファイルとかも使えますが、
一番最初の段階では知らなくても大丈夫だと思います。</p>

<h2>読み込み側 YAML</h2>

<p><code>vars</code> とか <code>tasks</code> を並べていた代わりに <code>roles</code> を使って読み込みます。
今回は <code>role: zsh</code> で読み込みましたが、他の例をみてみると <code>- zsh</code> だけでも良さそうです。</p>

<figure class='code'><figcaption><span>site.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo-servers</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zsh</span>
</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>最初は 1ファイルの YAML と roles 用の複数の YAML ファイルの対応関係がよくわからなくて、
roles 用の YAML ファイルに余計な記述をしてここでは使えないと言われたりして悩んだので、
簡単に対応関係をまとめてみました。</p>

<p>まだあまり使っていなくて、間違っているところもあるかもしれないので、
何かあればコメントなどで指摘してもらえるとありがたいです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[debian-goodiesのcheckrestartで再起動が必要なプロセスを調べる]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-06-checkrestart.html"/>
    <updated>2013-12-06T14:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/checkrestart</id>
    <content type="html"><![CDATA[<p><a href="http://qiita.com/advent-calendar/2013/distro-pm">ディストリビューション/パッケージマネージャー Advent Calendar 2013</a> の 12/6 のところが空いていたので、後から書いています。</p>

<p>この投稿は
<a href="http://qiita.com/advent-calendar/2013/distro-pm">ディストリビューション/パッケージマネージャー Advent Calendar 2013</a>
の6日目の記事です。</p>

<!--more-->


<h2>debian-goodies パッケージ</h2>

<p><a href="http://packages.qa.debian.org/d/debian-goodies.html">debian-goodies パッケージ</a>
には <code>/usr/bin/</code> に複数のコマンドと <code>/usr/sbin/checkrestart</code> が入っています。</p>

<p><code>/usr/bin/</code> のコマンドについては
<a href="http://uwabami.junkhub.org/log/20131204.html#p01">uwabami さんの記事</a>
を参照してください。</p>

<p>ここでは <code>checkrestart</code> を紹介します。</p>

<h2>checkrestart</h2>

<p>ライブラリのパッケージが更新されたときに、
特にセキュリティアップデートだと
そのライブラリを使っているデーモンなども再起動したいと
思うことが多いと思います。</p>

<p>そういうときに <code>checkrestart</code> コマンドを使うと
どのプロセスが置き換えられたライブラリを使っているか
調べることが出来ます。</p>

<h2>使用例 1</h2>

<p>例えば init スクリプトから起動している <code>whoopsie</code>
の再起動が必要なときは以下のようなメッセージが出てくるので、
<code>sudo /etc/init.d/whoopsie restart</code> とか
<code>sudo service whoopsie restart</code> とかで再起動すれば良いと思います。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo checkrestart
</span><span class='line'>Found 1 processes using old versions of upgraded files
</span><span class='line'>(1 distinct program)
</span><span class='line'>(1 distinct packages)
</span><span class='line'>
</span><span class='line'>Of these, 1 seem to contain init scripts which can be used to restart them:
</span><span class='line'>The following packages seem to have init scripts that could be used
</span><span class='line'>to restart them:
</span><span class='line'>whoopsie:
</span><span class='line'>        953     /usr/bin/whoopsie
</span><span class='line'>
</span><span class='line'>These are the init scripts:
</span><span class='line'>/etc/init.d/whoopsie restart</span></code></pre></td></tr></table></div></figure>


<h2>使用例 2</h2>

<p>デーモン以外などで起動しているプロセスが使っているファイルが置き換えられた場合、以下のように対応する init script がわからないというメッセージが出てきます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo checkrestart
</span><span class='line'>Found 1 processes using old versions of upgraded files
</span><span class='line'>(1 distinct program)
</span><span class='line'>(1 distinct packages)
</span><span class='line'>These processes do not seem to have an associated init script to restart them:
</span><span class='line'>ruby1.8:
</span><span class='line'>        906     /usr/bin/ruby1.8</span></code></pre></td></tr></table></div></figure>


<p>こういうときは
<code>sudo ls -l /proc/906</code> や
<code>sudo cat -v /proc/906/cmdline</code>
などで対応するプログラムを調べて再起動します。</p>

<h2>使用例 3</h2>

<p>再起動が必要なものがみつからなかった場合は以下のようなメッセージが出てきます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo checkrestart
</span><span class='line'>Found 0 processes using old versions of upgraded files</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>今回は <code>debian-goodies</code> の中から <code>checkrestart</code> を紹介しました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails 4.0.2のi18nで出るようになったdeprecated警告の対策方法]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-04-rails-i18n-deprecated-warning.html"/>
    <updated>2013-12-04T10:59:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/rails-i18n-deprecated-warning</id>
    <content type="html"><![CDATA[<p>Ruby on Rails のセキュリティアップデートがあって、
4.0.2 にあげたら i18n gem も 0.6.5 から 0.6.9 にあがって
<code>locale</code> の設定変更をしているところで
<code>[deprecated] I18n.enforce_available_locales will default to true in the future. If you really want to skip validation of your locale you can set I18n.enforce_available_locales = false to avoid this message.</code>
という警告が出るようになりました。</p>

<!--more-->


<h2>警告の出るタイミング</h2>

<p><a href="http://stackoverflow.com/questions/20361428/rails-4-0-2-i18n-validation-deprecation-warning">deprecated &ndash; Rails 4.0.2 I18n validation deprecation warning &ndash; Stack Overflow</a>
経由で
<a href="https://github.com/svenfuchs/i18n/commit/3b6e56e06fd70f6e4507996b017238505e66608c9">Add I18n.locale_available? and enforce available locales</a>
のコミットから入った変更ということで、
コミットログをみてみると、</p>

<ul>
<li><code>I18n.config.default_locale=</code></li>
<li><code>I18n.config.locale=</code></li>
<li><code>I18n.translate</code></li>
<li><code>I18n.localize</code></li>
<li><code>I18n.transliterate</code></li>
</ul>


<p>を呼んだときに影響するようです。
つまり <code>rails new</code> で作っただけだと <code>config/application.rb</code> の
<code>config.i18n.default_locale = :de</code> がコメントアウトされていて、
警告は出ません。</p>

<h2>日本語のみで使う場合</h2>

<p>日本語のみで使うのなら、
将来のデフォルトの
<code>I18n.enforce_available_locales = true</code>
にしてしまってから、
普通に日本語をデフォルトにする
<code>config.i18n.default_locale = :ja</code>
を呼べば良いと思います。</p>

<figure class='code'><figcaption><span>config/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">I18n</span><span class="o">.</span><span class="n">enforce_available_locales</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">i18n</span><span class="o">.</span><span class="n">default_locale</span> <span class="o">=</span> <span class="ss">:ja</span>
</span></code></pre></td></tr></table></div></figure>


<p>ただし、先にちゃんと日本語の locale ファイルを作っておかないと
<code>I18n::InvalidLocale</code>
という例外が発生して、
<code>rake</code> などで
<code>:ja is not a valid locale</code>
と言われてしまいます。</p>

<h2>今まで通りの挙動にする場合</h2>

<p><code>I18n.enforce_available_locales = false</code>
にすれば今まで通りの挙動になり、
存在しない <code>locale</code> を設定しても例外は発生しません。</p>

<h2>今のデフォルト</h2>

<p>今は
<code>I18n.enforce_available_locales = nil</code>
がデフォルトになっていて、
<code>nil</code> だと警告がでる、
ということのようです。</p>
]]></content>
  </entry>
  
</feed>
