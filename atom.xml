<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[@znz blog]]></title>
  <link href="http://blog.n-z.jp/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2014-07-15T23:27:54+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[doorkeeper providerサンプルアプリに対応するOAuthクライアントをdeviseで作成した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-07-15-doorkeeper-devise-client.html"/>
    <updated>2014-07-15T18:50:40+09:00</updated>
    <id>http://blog.n-z.jp/blog/doorkeeper-devise-client</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/znz/doorkeeper-provider-app">doorkeeper-provider-app</a>
を使って SSO (Single Sign On) のように使うクライアントアプリを作成しました。
<a href="https://github.com/znz/doorkeeper-devise-client-app">doorkeeper-devise-client-app</a>
で公開しています。</p>

<p>SSO は OAuth 2.0 の本来の使い方ではないので、不便な部分もありますが、
クライアント側の例として参考になると思います。</p>

<!--more-->


<h2>動作確認バージョン</h2>

<ul>
<li>ruby 2.1.2</li>
<li>rails 4.1.4</li>
<li>bootstrap 3.2.0</li>
<li>devise 3.2.4</li>
<li>omniauth 1.2.2</li>
<li>omniauth-oauth2 1.2.0</li>
<li>bootstrap-sass 3.2.0.0</li>
<li>dotenv-rails 0.11.1</li>
</ul>


<h2>簡単な役割解説</h2>

<p>provider は doorkeeper gem を入れている rails アプリ側で認証や認可を受け持ちます。
(OAuth の仕様的には認証と認可が別々のサーバーのこともあります。)</p>

<p>ここでいう OAuth クライアントは devise + omniauth + omniauth-oauth2 を使った rails アプリのことです。
ブラウザーなどのユーザー側にあるクライアントではなく、ユーザーから見れば、これもサーバーです。</p>

<p>詳しいことは OAuth 2.0 の仕様を調べてください。</p>

<h2>大まかな流れ</h2>

<ol>
<li><code>lib/omniauth/strategies/doorkeeper.rb</code> 作成</li>
<li><code>config/initializers/devise.rb</code> で <code>config.omniauth :doorkeeper, ...</code></li>
<li><code>app/controllers/users/omniauth_callbacks_controller.rb</code> 作成
(<code>uid</code> でユーザーを自動作成したり、 <code>access_token</code> (<code>credentials.token</code>) を保存したり)</li>
<li><code>config/routes.rb</code> に設定</li>
<li><code>user</code> に <code>provider</code> を追加</li>
<li><code>app/models/user.rb</code> で <code>devise :omniauthable</code> や <code>uid</code> を使った処理を実装</li>
<li><code>OAuth2::AccessToken</code> を生成</li>
<li>それを使って API アクセス</li>
</ol>


<p><code>access_token</code> を session に保存するかデータベースに保存するかは
アプリケーションのポリシー次第になります。
このアプリでは session に保存しています。</p>

<p>別途 callback uri として <code>http://localhost:3000/users/auth/doorkeeper/callback</code> のような URL を指定して
doorkeeper 側の <code>oauth/applications</code> に登録しておく必要があります。</p>

<h2><code>lib/omniauth/strategies/doorkeeper.rb</code> 作成</h2>

<p>例として
<a href="https://github.com/doorkeeper-gem/doorkeeper-devise-client" title="Dookreeper Devise+Omniauth Client">Dookreeper Devise+Omniauth Client</a>
と比較して <code>info</code> に <code>name</code> を増やしています。</p>

<p>コントローラーを <code>users</code> の下の <code>Users::OmniauthCallbacksController</code> にしたので、
戻り先の <code>authorize_path</code> は <code>'/oauth/authorize'</code> ではなく <code>'/users/oauth/authorize'</code> になっています。</p>

<p>info のハッシュはサーバーから受け取れていて、後の処理でもっと欲しい情報があれば自由に増やせます。</p>

<figure class='code'><figcaption><span>lib/omniauth/strategies/doorkeeper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">OmniAuth</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Strategies</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Doorkeeper</span> <span class="o">&lt;</span> <span class="ss">OmniAuth</span><span class="p">:</span><span class="ss">:Strategies</span><span class="o">::</span><span class="no">OAuth2</span>
</span><span class='line'>      <span class="n">option</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:doorkeeper</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">option</span> <span class="ss">:client_options</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="ss">site</span><span class="p">:</span> <span class="s1">&#39;http://localhost:4000&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">authorize_path</span><span class="p">:</span> <span class="s1">&#39;/users/oauth/authorize&#39;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">uid</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">raw_info</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">info</span> <span class="k">do</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="ss">email</span><span class="p">:</span> <span class="n">raw_info</span><span class="o">[</span><span class="s1">&#39;email&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="nb">name</span><span class="p">:</span> <span class="n">raw_info</span><span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">raw_info</span>
</span><span class='line'>        <span class="vi">@raw_info</span> <span class="o">||=</span> <span class="n">access_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/api/v1/me.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">parsed</span> <span class="o">||</span> <span class="p">{}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2><code>config/initializers/devise.rb</code> で設定</h2>

<p><a href="https://github.com/doorkeeper-gem/doorkeeper-devise-client">サンプルアプリ</a>
では</p>

<figure class='code'><figcaption><span>config/initializers/devise.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:doorkeeper</span><span class="p">,</span>  <span class="no">DOORKEEPER_APP_ID</span><span class="p">,</span> <span class="no">DOORKEEPER_APP_SECRET</span><span class="p">,</span> <span class="ss">:client_options</span> <span class="o">=&gt;</span>  <span class="p">{</span><span class="ss">:site</span> <span class="o">=&gt;</span> <span class="no">DOORKEEPER_APP_URL</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>となっていました。</p>

<p><code>scope</code> も追加すると以下のようになります。
<code>dotenv</code> を使って <code>ENV</code> から取るようにしました。</p>

<figure class='code'><figcaption><span>config/initializers/devise.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">omniauth</span> <span class="ss">:doorkeeper</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;DOORKEEPER_APP_ID&#39;</span><span class="o">]</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;DOORKEEPER_APP_SECRET&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">client_options</span><span class="p">:</span> <span class="p">{</span><span class="ss">site</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;DOORKEEPER_APP_URL&#39;</span><span class="o">]</span> <span class="p">},</span> <span class="ss">scope</span><span class="p">:</span> <span class="s1">&#39;public write&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>scope</code> は <code>'public,write'</code> だと <code>The requested scope is invalid, unknown, or malformed.</code> というエラーになってしまったので、
<code>,</code> 区切りではなくスペース区切りにしています。</p>

<h2><code>app/controllers/users/omniauth_callbacks_controller.rb</code> 作成</h2>

<p>callback で認証結果を受け取る部分を作成します。
ここで認証結果を受け取って、ユーザーを必要に応じてひも付けたり、
後で API アクセスに使うアクセストークンを保存したりします。</p>

<p>認証に失敗した時はログイン画面 (あれば) か <code>root_path</code> に戻すようにしています。</p>

<figure class='code'><figcaption><span>app/controllers/users/omniauth_callbacks_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Users</span><span class="o">::</span><span class="no">OmniauthCallbacksController</span> <span class="o">&lt;</span> <span class="ss">Devise</span><span class="p">:</span><span class="ss">:OmniauthCallbacksController</span>
</span><span class='line'>  <span class="c1"># https://github.com/plataformatec/devise/issues/2432</span>
</span><span class='line'>  <span class="n">protect_from_forgery</span> <span class="ss">except</span><span class="p">:</span> <span class="ss">:doorkeeper</span>
</span><span class='line'>  <span class="n">skip_filter</span> <span class="ss">:auto_authenticate_omniauth_user!</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="ss">:doorkeeper</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">doorkeeper</span>
</span><span class='line'>    <span class="c1"># You need to implement the method below in your model (e.g. app/models/user.rb)</span>
</span><span class='line'>    <span class="n">oauth_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_or_create_for_doorkeeper_oauth</span><span class="p">(</span><span class="n">oauth_data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:doorkeeper_token</span><span class="o">]</span> <span class="o">=</span> <span class="n">oauth_data</span><span class="o">[</span><span class="s1">&#39;credentials&#39;</span><span class="o">][</span><span class="s1">&#39;token&#39;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">persisted?</span>
</span><span class='line'>      <span class="n">sign_in_and_redirect</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:event</span> <span class="o">=&gt;</span> <span class="ss">:authentication</span> <span class="c1">#this will throw if @user is not activated</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">is_navigational_format?</span>
</span><span class='line'>        <span class="n">set_flash_message</span><span class="p">(</span><span class="ss">:notice</span><span class="p">,</span> <span class="ss">:success</span><span class="p">,</span> <span class="ss">kind</span><span class="p">:</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;DOORKEEPER_APP_NAME&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;Doorkeeper&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="c1"># hide flash message after auto sign in</span>
</span><span class='line'>        <span class="c1">#flash.delete(:notice)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">session</span><span class="o">[</span><span class="s1">&#39;devise.doorkeeper_data&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span>
</span><span class='line'>      <span class="k">if</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="ss">:new_user_registration_url</span><span class="p">)</span>
</span><span class='line'>        <span class="n">redirect_to</span> <span class="n">new_user_registration_url</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">redirect_to</span> <span class="n">root_url</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">after_omniauth_failure_path_for</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="ss">:new_session_path</span><span class="p">)</span>
</span><span class='line'>      <span class="n">new_session_path</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">root_path</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>自動ログイン後のメッセージが不要なら <code>set_flash_message</code> の部分を <code>flash.delete(:notice)</code> に置き換えます。
「Doorkeeper でログインしました」だとどのサイトか区別がつかないので、
<code>ENV['DOORKEEPER_APP_NAME']</code> で表示用の名前を設定できるようにしています。</p>

<h2><code>config/routes.rb</code> に設定</h2>

<p><code>config/routes.rb</code> で <code>omniauth_callbacks</code> として独自のものを使うように設定します。</p>

<p>今回は認証必須なので不要ですが、
例として <code>sign_in</code> と <code>sign_out</code> の URL も入れました。
実際に試してみるとすぐに自動ログインで再ログインしてしまいます。</p>

<p><code>sign_out</code> が <code>get</code> か <code>delete</code> か違うことがあるので、
<code>sign_out_via</code> を使ってどちらでも対応できるようにしました。</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">devise_for</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">controllers</span><span class="p">:</span> <span class="p">{</span> <span class="n">omniauth_callbacks</span><span class="p">:</span> <span class="s1">&#39;users/omniauth_callbacks&#39;</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">devise_scope</span> <span class="ss">:user</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">get</span> <span class="s1">&#39;sign_in&#39;</span><span class="p">,</span>  <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;devise/sessions#new&#39;</span><span class="p">,</span>     <span class="ss">as</span><span class="p">:</span> <span class="ss">:new_user_session</span>
</span><span class='line'>    <span class="nb">__send__</span> <span class="no">Devise</span><span class="o">.</span><span class="n">sign_out_via</span><span class="p">,</span> <span class="s1">&#39;sign_out&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="s1">&#39;devise/sessions#destroy&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:destroy_user_session</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>timeoutable 設定</h2>

<p>SSO 的に使うのは
OAuth 2.0 の本来の目的ではないので、
ログアウトは難しい問題です。
たとえば
doorkeeper
と連携するアプリが複数あるときにまとめてログアウト出来ないなどの問題があります。</p>

<p>そのため、このアプリでは一定時間で再ログインが必要になるように <code>timeoutable</code> を使って、
こまめに認証し直すようにしてログアウト問題を緩和しています。</p>

<p>その副作用として入力に時間のかかるフォームがあると入力途中でタイムアウトしてしまって
投稿に失敗するなどの問題も起きるので、その点を考慮しておく必要があります。</p>

<figure class='code'><figcaption><span>config/initializers/devise.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># Default is 30 minutes.</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">timeout_in</span> <span class="o">=</span> <span class="mi">1</span><span class="o">.</span><span class="n">minutes</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">expire_auth_token_on_timeout</span> <span class="o">=</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<h2>app/models/user.rb に実装</h2>

<p><code>find_or_create_for_doorkeeper_oauth</code> の実装は <code>concerns</code> に分けてみました。
<code>omniauthable</code> に <code>omniauth_providers</code> も設定して余計な route が生成されないようにしています。
<code>timeoutable</code> も入れています。</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">devise</span> <span class="ss">:omniauthable</span><span class="p">,</span> <span class="n">omniauth_providers</span><span class="p">:</span> <span class="o">[</span><span class="ss">:doorkeeper</span><span class="o">]</span>
</span><span class='line'>  <span class="n">devise</span> <span class="ss">:timeoutable</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">DoorkeeperOauthFinder</span>
</span></code></pre></td></tr></table></div></figure>


<p>ログインしたときに <code>name</code> や <code>email</code> が変わっていたら反映するようにしています。</p>

<p><code>id</code> を統一したいのなら、 <code>create</code> のときに <code>id</code> まで指定すると
doorkeeper gem による OAuth provider 側とユーザーの ID を統一できます。</p>

<p>SSO 的に使うのならパスワードは不要なので、
ここではコメントアウトしています。</p>

<figure class='code'><figcaption><span>app/models/concerns/doorkeeper_oauth_finder.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">DoorkeeperOauthFinder</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">find_or_create_for_doorkeeper_oauth</span><span class="p">(</span><span class="n">oauth_data</span><span class="p">)</span>
</span><span class='line'>      <span class="n">uid</span> <span class="o">=</span> <span class="n">oauth_data</span><span class="o">.</span><span class="n">uid</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>      <span class="nb">id</span> <span class="o">=</span> <span class="n">uid</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>      <span class="n">user</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">provider</span><span class="p">:</span> <span class="n">oauth_data</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span> <span class="ss">uid</span><span class="p">:</span> <span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">user</span>
</span><span class='line'>        <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">oauth_data</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>        <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">oauth_data</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">email</span>
</span><span class='line'>        <span class="n">user</span><span class="o">.</span><span class="n">save!</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">changed?</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">user</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">create!</span><span class="p">({</span>
</span><span class='line'>          <span class="nb">id</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span> <span class="c1"># use same id</span>
</span><span class='line'>          <span class="nb">name</span><span class="p">:</span> <span class="n">oauth_data</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">provider</span><span class="p">:</span> <span class="n">oauth_data</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">uid</span><span class="p">:</span> <span class="n">uid</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">email</span><span class="p">:</span> <span class="n">oauth_data</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>          <span class="c1">#password: Devise.friendly_token[0,20]</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">user</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>データベースの migration の方でも削除して unique index の制約なども不要なものは外しておきます。</p>

<figure class='code'><figcaption><span>db/migrate/*_devise_create_users.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1">## Database authenticatable</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span><span class="p">,</span>              <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>  <span class="c1"># t.string :encrypted_password, null: false, default: &quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>代わりに <code>provider</code> と <code>uid</code> と <code>name</code> を追加しました。
このアプリは Doorkeeper 専用なので、直接 <code>users</code> に追加していますが、
複数プロバイダに対応するには <code>provider</code> と <code>uid</code> の組を別テーブルにします。</p>

<figure class='code'><figcaption><span>db/migrate/*_add_omniauth_columns_to_users.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddOmniauthColumnsToUsers</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:provider</span><span class="p">,</span> <span class="ss">:string</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">:string</span>
</span><span class='line'>    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span>
</span><span class='line'>    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="o">[</span><span class="ss">:provider</span><span class="p">,</span> <span class="ss">:uid</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2><code>OAuth2::AccessToken</code> を生成</h2>

<p><code>OAuth2::Client</code> と保存しておいた <code>access_token</code> を引数にして <code>OAuth2::AccessToken</code> を生成します。
ここでは <code>concerns</code> に分けて必要なコントローラーでだけ <code>include DoorkeeperApiV1</code> するようにしました。
全体で使いたいのなら <code>ApplicationController</code> に <code>include</code> すれば良いと思います。</p>

<figure class='code'><figcaption><span>app/controllers/concerns/doorkeeper_api_v1.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">DoorkeeperApiV1</span>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">access_token</span>
</span><span class='line'>    <span class="k">return</span> <span class="vi">@access_token</span> <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="vi">@access_token</span><span class="p">)</span>
</span><span class='line'>    <span class="n">config</span> <span class="o">=</span> <span class="no">Devise</span><span class="o">.</span><span class="n">omniauth_configs</span><span class="o">[</span><span class="ss">:doorkeeper</span><span class="o">]</span>
</span><span class='line'>    <span class="n">strategy</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">strategy_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">config</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="n">token</span> <span class="o">=</span> <span class="n">session</span><span class="o">[</span><span class="ss">:doorkeeper_token</span><span class="o">]</span>
</span><span class='line'>    <span class="vi">@access_token</span> <span class="o">=</span> <span class="ss">OAuth2</span><span class="p">:</span><span class="ss">:AccessToken</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">strategy</span><span class="o">.</span><span class="n">client</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get_me</span>
</span><span class='line'>    <span class="n">access_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/me.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">parsed</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">get_microposts</span>
</span><span class='line'>    <span class="n">access_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/microposts.json&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">parsed</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">MICROPOST_CONTENT_MAX_LENGTH</span> <span class="o">=</span> <span class="mi">140</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">post_micropost</span><span class="p">(</span><span class="n">micropost</span><span class="p">)</span>
</span><span class='line'>    <span class="n">micropost</span><span class="o">[</span><span class="ss">:content</span><span class="o">]</span> <span class="o">=</span> <span class="n">micropost</span><span class="o">[</span><span class="ss">:content</span><span class="o">].</span><span class="n">truncate</span><span class="p">(</span><span class="no">MICROPOST_CONTENT_MAX_LENGTH</span><span class="p">)</span>
</span><span class='line'>    <span class="n">access_token</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/api/v1/microposts&quot;</span><span class="p">,</span> <span class="ss">params</span><span class="p">:</span> <span class="p">{</span> <span class="ss">micropost</span><span class="p">:</span> <span class="n">micropost</span> <span class="p">})</span><span class="o">.</span><span class="n">parsed</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>使い方は <code>get_me</code> などを呼び出すだけなので省略します。</p>

<h2>ログインを強制する</h2>

<p>常に Doorkeeper の方でログインさせておきたいアプリの場合は、
User クラスを使っている場合の devise での戻り先の <code>session[:user_return_to]</code> に URL を保存しておいて、
<code>user_omniauth_authorize_path(:doorkeeper)</code> に強制的にリダイレクトしています。
<code>main_app.</code> をつけているのは route で mount している engine の中で問題が起きたことがあったためです。</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="kp">include</span> <span class="no">AuthDoorkeeper</span>
</span><span class='line'>  <span class="n">before_action</span> <span class="ss">:auto_authenticate_omniauth_user!</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/controllers/concerns/auth_doorkeeper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">AuthDoorkeeper</span>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">auto_authenticate_omniauth_user!</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">if</span> <span class="n">current_user</span>
</span><span class='line'>    <span class="n">session</span><span class="o">[</span><span class="ss">:user_return_to</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">original_url</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">main_app</span><span class="o">.</span><span class="n">user_omniauth_authorize_path</span><span class="p">(</span><span class="ss">:doorkeeper</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>テストについて</h2>

<p>API 呼び出しの部分の対処が出来ていなくて、まだテストが通る状態には出来ていません。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[apt-cacher-ngでliveイメージ作成を繰り返す時の無駄なダウンロードを減らす]]></title>
    <link href="http://blog.n-z.jp/blog/2014-07-14-apt-cacher-ng.html"/>
    <updated>2014-07-14T23:53:14+09:00</updated>
    <id>http://blog.n-z.jp/blog/apt-cacher-ng</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/znz/rubylive-builder" title="rubylive-builder">rubylive-builder</a>
で
<a href="https://github.com/znz/rubylive" title="RubyLive">RubyLive</a>
という Debian wheezy ベースの Live イメージを作成するときに
<code>apt-get update</code> などで何度も無駄にダウンロードしてしまうので、
<code>apt-cacher-ng</code> で Live イメージ作成を繰り返す時の無駄なダウンロードを減らすことにしました。</p>

<!--more-->


<h2>Vagrant の provision でインストール</h2>

<p>Vagrantfile では</p>

<figure class='code'><figcaption><span>Vagrantfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:shell</span> <span class="k">do</span> <span class="o">|</span><span class="n">shell</span><span class="o">|</span>
</span><span class='line'>    <span class="n">shell</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;provision.sh&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>のようにシェルスクリプトでプロビジョニングしているだけだったので、
その中で以下のようにインストールして設定するようにしました。</p>

<figure class='code'><figcaption><span>provision.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>apt-get install -y apt-cacher-ng
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;Acquire::http::Proxy &quot;http://localhost:3142/&quot;;&#39;</span> &gt;/etc/apt/apt.conf.d/02proxy
</span></code></pre></td></tr></table></div></figure>


<p>Vagrantfile で以下のようにポートフォワーディングを設定していれば
<a href="http://gihyo.jp/admin/serial/01/ubuntu-recipe/0315" title="第315回　apt-cacher-ngを使ってAPT用キャッシュプロキシの構築：Ubuntu Weekly Recipe｜gihyo.jp … 技術評論社">第315回　apt-cacher-ngを使ってAPT用キャッシュプロキシの構築：Ubuntu Weekly Recipe｜gihyo.jp … 技術評論社</a>
の2ページ目に説明があるようにヒット率などを確認できます。</p>

<figure class='code'><figcaption><span>Vagrantfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># apt-cacher-ng</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;forwarded_port&quot;</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">3142</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">3142</span>
</span></code></pre></td></tr></table></div></figure>


<h2>rake コマンドで環境変数を渡す</h2>

<p><code>APT_HTTP_PROXY=http://localhost:3142 rake</code> でも良かったのですが、
rake コマンドは引数の <code>FOO=bar</code> を <code>ENV</code> に設定してくれるので、
<code>rake APT_HTTP_PROXY=http://localhost:3142</code> で渡して、
Rakefile の中では以下のように受け取って <code>lb config</code> に渡しました。</p>

<figure class='code'><figcaption><span>Rakefile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s2">&quot;config RubyLive&quot;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:config</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:clean</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">sh</span> <span class="s1">&#39;lb config&#39;</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;APT_HTTP_PROXY&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">sh</span> <span class="s2">&quot;lb config --apt-http-proxy </span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;APT_HTTP_PROXY&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>live-build で apt-cacher-ng を使う</h2>

<p>既に出てきたように
<code>lb config</code> の <code>--apt-http-proxy</code> オプションや <code>--apt-ftp-proxy</code> オプションで指定すると
Live イメージ作成の時に proxy を使ってくれるようになります。
今回は apt-line に <code>http</code> しか使っていないので
<code>--apt-http-proxy</code> だけ指定しています。</p>

<p>もちろん、作成後の Live イメージには proxy 設定は残りません。</p>

<h2>感想</h2>

<p>live-build は cache ディレクトリにも、かなりキャッシュしてくれるのですが、
<code>apt-get update</code> などの proxy じゃないとキャッシュしにくいものもあるので、
どんな場合でもダウンロード量削減に役に立ちそうだと思いました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RubyLiveを仮想環境で作成]]></title>
    <link href="http://blog.n-z.jp/blog/2014-07-13-build-rubylive-on-vm.html"/>
    <updated>2014-07-13T09:35:02+09:00</updated>
    <id>http://blog.n-z.jp/blog/build-rubylive-on-vm</id>
    <content type="html"><![CDATA[<p>最近流行りの仮想環境を使ってクリーンな wheezy 環境で RubyLive を作成できるようにしました。</p>

<p>VirtualBox + Vagrant は特殊な制限のない仮想環境なので Live イメージが作成できたのですが、
docker は後述の制限のために作成できませんでした。</p>

<!--more-->


<h2>RubyLive を Vagrant で作成</h2>

<p>Vagrant を使ってクリーンな wheezy 環境で RubyLive の ISO を作成できるようにしました。
こちらは問題なく作成できました。</p>

<h3>動作確認バージョン</h3>

<ul>
<li>VirtualBox 4.3.12</li>
<li>Vagrant 1.6.3</li>
</ul>


<h3>使い方</h3>

<ul>
<li>VirtualBox と Vagrant をインストールしておきます。</li>
<li><code>git clone https://github.com/znz/rubylive-builder</code> で取得します。</li>
<li><code>cd rubylive-builder</code> で中に入ります。</li>
<li><code>VM_MEMORY=512 vagrant up</code> のように適当なメモリ容量を指定して起動します。 (指定なしなら 1024)

<ul>
<li>他の項目も環境変数である程度変更できるようにしています。</li>
<li>初回起動時は box をダウンロードするので非常に時間がかかります。</li>
<li>provision で live-build などの必要なパッケージをインストールしています。</li>
</ul>
</li>
<li><code>vagrant ssh</code> でゲストにログインします。</li>
<li><code>/vagrant/rubylive.sh</code> を実行すると <code>/home/vagrant/rubylive</code> で RubyLive のイメージを作成します。

<ul>
<li>実行するたびにタイムスタンプの入ったファイル名の ISO ファイルが作成されます。</li>
<li>ネットワークの速度やマシンスペックに影響を受けると思いますが、試した環境では約1時間かかりました。</li>
</ul>
</li>
<li>作成できた <code>/home/vagrant/rubylive/*.iso</code> を <code>/vagrant</code> にコピーまたは移動して、ホスト OS 側に取り出します。</li>
<li>取り出した ISO ファイルを使用します。</li>
</ul>


<p>なぜか</p>

<pre><code>chroot: failed to run command `/usr/bin/env': No such file or directory
</code></pre>

<p>で失敗することがありましたが、再度 <code>/vagrant/rubylive.sh</code> を実行すれば問題なく作成できました。</p>

<h3>片付け方</h3>

<ul>
<li><code>vagrant destroy</code> で VM を破棄します。</li>
<li><code>git clone</code> した作業ディレクトリを削除します。</li>
<li>wheezy の box が不要なら <code>vagrant box remove opscode_debian-7.4_chef-provisionerless</code> で削除します。</li>
<li>Vagrant や VirtualBox も不要ならアンインストールします。</li>
</ul>


<h2>RubyLive を Docker で作成 (失敗)</h2>

<p>docker 環境の中では <code>chroot /rubylive/chroot mount -t proc proc /proc</code> が <code>EPERM</code> で失敗するため、作成できませんでした。</p>

<h3>動作確認バージョン</h3>

<ul>
<li>docker 1.1.1</li>
</ul>


<h3>試し方</h3>

<ul>
<li>docker をインストールしておきます。</li>
<li><code>git clone https://github.com/znz/rubylive-builder</code> で取得します。</li>
<li><code>docker build rubylive-builder</code> で作成に挑戦します。

<ul>
<li>または <code>cd rubylive-builder</code> で中に入って <code>docker build .</code> です。</li>
</ul>
</li>
<li><code>docker ps -a</code> で最近の CREATED の IMAGE を確認します。

<ul>
<li>もしくは <code>docker images</code> で確認します。</li>
<li>最後の失敗した後の状態は残っていないようでした。</li>
</ul>
</li>
<li><code>docker run -i -t --rm 4b8bc4523794 /bin/bash</code> のように中に入ります。

<ul>
<li>4b8bc4523794 のところは確認した IMAGE の ID にしてください。</li>
</ul>
</li>
<li><code>cd rubylive</code> で rubylive ディレクトリに入って <code>rake</code> で作成に再挑戦します。</li>
<li><code>less /rubylive/chroot/debootstrap/debootstrap.log</code> でログを確認したり、
<code>chroot /rubylive/chroot mount -t proc proc /proc</code> や
<code>mount -t proc proc /rubylive/chroot/proc</code> を直接実行してみたりして
原因を確認します。</li>
</ul>


<h3>失敗部分のメッセージ</h3>

<pre><code>W: Failure trying to run: chroot /rubylive/chroot mount -t proc proc /proc
W: See /rubylive/chroot/debootstrap/debootstrap.log for details
P: Begin unmounting filesystems...
P: Saving caches...
/usr/bin/env: apt-get: No such file or directory
rake aborted!
Command failed with status (1): [sudo lb build...]
</code></pre>

<p><code>/rubylive/chroot/debootstrap/debootstrap.log</code> をみると <code>mount: permission denied</code> と出ていました。</p>

<h3>Dockerfile 直接指定 (失敗)</h3>

<p><code>docker build https://raw.githubusercontent.com/znz/rubylive-builder/master/Dockerfile</code>
のように直接 URL を指定する方法は
<code>sources.list</code> を国内ミラーに差し替える部分が失敗して使えませんでした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Debian 7 (wheezy) の RubyLive をカスタマイズ中]]></title>
    <link href="http://blog.n-z.jp/blog/2014-07-12-debian-ruby-live.html"/>
    <updated>2014-07-12T10:08:26+09:00</updated>
    <id>http://blog.n-z.jp/blog/debian-ruby-live</id>
    <content type="html"><![CDATA[<p>今年の
<a href="https://k-of.jp/2014/" title="KOF 2014：関西オープンフォーラム2014">KOF 2014：関西オープンフォーラム2014</a>
に向けて
<a href="https://github.com/znz/rubylive" title="RubyLive">RubyLive</a>
を作成しています。
fork 元の <a href="https://github.com/no6v/rubylive">no6v 版</a> との違いをまとめていきます。</p>

<!--more-->


<h2>カスタマイズの基本</h2>

<p>README から今回に関係する部分を引用しておくと以下のようになっています。</p>

<ul>
<li>config/hooks/

<ul>
<li>インストールの最後の方で実行するフックスクリプトを置くディレクトリ。</li>
<li>拡張子を .chroot にして実行権限を付けておく。</li>
</ul>
</li>
<li>config/includes.chroot/

<ul>
<li>このディレクトリを root に見立てて LiveCD 環境にコピーしたいファイルを置くディレクトリ。</li>
</ul>
</li>
<li>config/package-lists/

<ul>
<li>特別にインストールしたいパッケージのリストを置くディレクトリ。</li>
<li>拡張子を .list.chroot にしてパッケージ名を列挙する。</li>
</ul>
</li>
</ul>


<h2>壁紙などの変更</h2>

<p><code>resources.yml</code> で設定されたファイルは <code>url</code> から自動ダウンロードして <code>path</code> に置くようになっています。</p>

<p><code>size</code> と <code>sha256sum</code> をチェックするだけで違っていても削除はしないようなので、
ダウンロードに失敗した時は<code>path</code> のファイルは手動で削除する必要がありました。</p>

<p><code>path</code> を変更した時も古いファイルが残ってしまうので、削除する必要がありました。</p>

<h2>dconf の設定</h2>

<p><code>config/includes.chroot/etc/skel/.config/dconf/user</code>
に設定変更後のバイナリが置かれていて、
これはひどいと思ったので、
<code>config/includes.chroot/etc/skel/.gnomerc</code>
で <code>gsettings set</code> を使って設定するようにしました。</p>

<h3>壁紙の変更</h3>

<p>起動後の <code>dconf-editor</code> で選択肢を確認しつつ、
<code>gsettings set org.gnome.desktop.background picture-options centered</code>
にしたり、
<code>gsettings set org.gnome.desktop.background picture-uri 'file:///usr/share/images/desktop-base/RubyKaigi2014-commonLogo.svg</code>
にしたりしました。</p>

<p>2014-07-13 追記:
生成後のイメージに CC-BY 3.0 の説明がないのは良くないと思って、
<code>config/includes.chroot/etc/skel/README.txt</code>
に説明を追加することにしました。</p>

<h3>デスクトップのアイコン</h3>

<p>以前は <code>gnome-panel</code> (上のバーのところ) に起動用のアイコンを追加していたようですが、
<code>gsettings set</code> で設定しようとすると
<code>org.gnome.gnome-panel.layout object-id-list</code> の他に
<code>org.gnome.gnome-panel.layout.objects.object-0</code> や
<code>org.gnome.gnome-panel.layout.objects.object-0.instance-config</code> などの
複数設定が必要で管理の手間もかかりそうだったので、
<code>gsettings set org.gnome.desktop.background show-desktop-icons true</code>
でデスクトップのアイコンが見えるように変更しました。</p>

<h3>スクリーンセーバーの停止</h3>

<p><code>gsettings set org.gnome.desktop.screensaver idle-activation-enabled false</code>
で止めました。</p>

<h2>chm の変更</h2>

<p><a href="http://ruby.morphball.net/refm-remix.html" title="Rubyリファレンスマニュアル chm版リミックス">Rubyリファレンスマニュアル chm版リミックス</a>
の標準テーマのRuby 2.1.0向け chm に差し替えました。
zip ファイルなので、先ほどの <code>.gnomerc</code> でデスクトップに展開するようにしました。</p>

<p>xCHM v. 1.20 で背景画像や色とかがつかないようなので、サイズが小さい標準を選びました。</p>

<h2>パッケージ変更</h2>

<p><code>jfbterm</code> の代わりに <code>fbterm</code> にしたり、
<code>ruby-build</code> でビルドに必要なパッケージを追加したり、
<code>config/includes.chroot/etc/iceweasel/profile/prefs.js</code> の代わりに <code>iceweasel-l10n-ja</code> を追加したり、
<code>bash-completion</code> などを追加したりしました。</p>

<h2>ruby-build で ruby 2.1.2 のインストール</h2>

<p><a href="http://qiita.com/takahashim/items/406421d515ef1d4f1189" title="[ReVIEW Tips] DockerでRe:VIEW - Qiita">[ReVIEW Tips] DockerでRe:VIEW &ndash; Qiita</a>
を参考にして rbenv は使わずに ruby-build だけ使って <code>/usr/local</code> に ruby 2.1.2 をインストールしました。</p>

<h2>localepurge</h2>

<p>locale の設定は live-config で起動時にやっていて hook の中で
<code>DEBIAN_FRONTEND=noninteractive dpkg-reconfigure localepurge</code>
としても起動後と違って ja locale の設定がなかったので、
起動後や設定した後に <code>debconf-show localepurge</code> で確認した値を使って、
<code>localepurge/nopurge</code> が <code>NEEDSCONFIGFIRST</code> のままなら
<code>echo localepurge localepurge/nopurge string "ja, ja_JP.UTF-8" | debconf-set-selections</code>
で設定することにしました。</p>

<p>これで約 200MB ぐらい小さくなりました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails 4.1 で Doorkeeper を使った OAuth2 Provider のサンプルを実装した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-07-11-doorkeeper-provider-example-app.html"/>
    <updated>2014-07-11T23:30:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/doorkeeper-provider-example-app</id>
    <content type="html"><![CDATA[<p>ソースは github の
<a href="https://github.com/znz/doorkeeper-provider-app" title="znz/doorkeeper-provider-app">znz/doorkeeper-provider-app</a>
で公開しています。</p>

<p>基本的にはソースをみて参考にしてもらうと良いと思いますが、
説明が必要な部分を続きに書いてみました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>ruby 2.1.2</li>
<li>rails 4.1.4</li>
<li>bootstrap-sass 3.2.0.0</li>
<li>devise 3.2.4</li>
<li>devise-i18n-views 0.2.8</li>
<li>doorkeeper 1.3.1</li>
<li>cancancan 1.8.4</li>
<li>rolify 3.4.0</li>
<li>rspec-rails 3.0.1</li>
</ul>


<h2>試し方</h2>

<p>README に書いたようにローカルで動かすか heroku に deploy して
<a href="https://github.com/doorkeeper-gem/doorkeeper/wiki/Example-Applications" title="Example Applications">Example Applications</a>
にある Client examples の Sinatra and OAuth2 gem の
<a href="https://github.com/doorkeeper-gem/doorkeeper-sinatra-client" title="Doorkeeper Sinatra Client">Doorkeeper Sinatra Client</a>
を使って試しました。</p>

<h2>初期設定</h2>

<p>devise, doorkeeper, cancancan, rolify, rspec の個別の初期設定は普通に <code>rails generate</code> を使いました。</p>

<h2>ユーザー情報追加</h2>

<p>とれる情報を増やすために <code>User</code> に <code>name</code> を追加しました。
<code>devise-i18n-views</code> を使っている関係で view のカスタマイズはしていないので、
<code>rake db:seed</code> で設定したユーザーだけ <code>name</code> が設定されています。</p>

<p>必要に応じて view もカスタマイズしてください。</p>

<p>また <code>devise-i18n</code> の ja.yml を devise.ja.yml として入れています。
これは flash のメッセージやメールのメッセージなど、
<code>app/views</code> 以外の翻訳になるようです。</p>

<p><code>devise-i18n-views</code> は <code>app/views</code> を翻訳可能な view にするプロジェクトです。
なぜ <code>devise</code> とは別プロジェクトでやっているのかはよくわかりません。</p>

<h2><code>I18n.available_locales</code></h2>

<p><code>devise-i18n-views</code> を入れてしまうと <code>I18n.available_locales</code> が増えてしまうので、
困るのなら、カスタマイズ用の view を generate して、必要な言語だけ取り込んで
<code>Gemfile</code> から外してしまうのが良いと思います。</p>

<p>今回はそのまま残して右上の <code>Locale</code> で選択できるようにしています。
選択肢の翻訳は Wikipedia の左や www.debian.org の下などを参考にしたのですが <code>es-AR</code> はわからなかったので、
<code>es</code> と同じになってしまっています。</p>

<h2><code>/oauth/applications</code> のアクセス制限</h2>

<p><code>cancancan</code> と <code>rolify</code> を使って admin role があるユーザーだけに制限しています。
secret も見えてしまうので、 read 権限までしっかり制限する必要があるようです。</p>

<p><code>load_and_authorize_resource</code> でのロードと親クラス (<code>Doorkeeper::ApplicationsController</code>) の中でのロードでモデルの読み込みが二重になってしまうのですが、変更を少なくするためにそこは許容しました。</p>

<h2><code>GET /api/v1/me.json</code></h2>

<p>Doorkeeper gem の Wiki の例にあるようにユーザー情報をとれるようにしています。
制限していないと以下のような情報がとれました。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;admin@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;created_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2014-07-11T06:32:22.077Z&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;updated_at&quot;</span><span class="p">:</span> <span class="s2">&quot;2014-07-11T09:33:42.143Z&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>制限したり関連するモデルの情報を増やしたりするなら
<a href="http://sugamasao.hatenablog.com/entry/20100914/1284415669" title="Rails のモデル関係と to_json(to_xml) - すがブロ">Rails のモデル関係と to_json(to_xml) &ndash; すがブロ</a>
に書いてあるように <code>respond_with</code> に <code>:only</code> をつけたり <code>:include</code> をつけたりすると出来るようです。</p>

<p>入ったり入らなかったりする条件がよくわからなかったのですが、
<code>devise</code> 関連では <code>authentication_token</code> が入っていることがあったので、
User モデルにいろんな情報を入れているなら、
きちんと制限した方が良さそうに思いました。</p>

<h2>microposts</h2>

<p><a href="http://railstutorial.jp/" title="Ruby on Rails チュートリアル：実例を使って Rails を学ぼう">Ruby on Rails チュートリアル：実例を使って Rails を学ぼう</a>
のように <code>Micropost</code> モデルを作成して、 API からも投稿できるようにしました。</p>

<p>投稿は scope で制限していて、デフォルトの <code>public</code> のみでは書き込めずに <code>write</code> も必要にしています。</p>

<p>API としては</p>

<ul>
<li><code>GET /api/v1/microposts</code> で投稿一覧</li>
<li><code>POST /api/v1/microposts</code> で新規投稿</li>
</ul>


<p>を用意しています。</p>

<h3><code>Can't verify CSRF token authenticity</code></h3>

<p>(2014-07-15 追記)</p>

<p>新規投稿の <code>POST</code> は <code>CSRF</code> チェックにひっかかってしまうので、
<code>skip_before_action :verify_authenticity_token</code>
を入れました。</p>

<p>以前から doorkeeper gem を使っているアプリでは
<code>Can't verify CSRF token authenticity</code>
というメッセージが出るだけで投稿自体は出来ていたのですが、
サンプルアプリでは投稿できなかったので、
<code>skip_before_action</code> を入れました。
(Rails 4 なので <code>skip_before_filter</code> ではなく <code>skip_before_action</code>)</p>

<h2>その後の変更点 (2014-07-15 追記)</h2>

<p>その後 <code>kaminari</code> 対応などを入れました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[devise で通常ログイン出来るユーザーが他の複数サービス連携でログインできるようにした]]></title>
    <link href="http://blog.n-z.jp/blog/2014-07-08-devise-omniauth.html"/>
    <updated>2014-07-08T08:30:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/devise-omniauth</id>
    <content type="html"><![CDATA[<p><code>devise</code> でデータベース認証を実装している Rails アプリに Twitter などでもログインできるように
実装を追加してみました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>ruby 2.1.2</li>
<li>rails 4.1.4</li>
<li>devise 3.2.4</li>
<li>omniauth 1.2.1</li>
<li>omniauth-facebook 1.6.0</li>
<li>omniauth-github 1.1.2</li>
<li>omniauth-google-oauth2 0.2.4</li>
<li>omniauth-twitter 1.0.1</li>
<li>(dotenv 0.11.1) (key と secret の管理)</li>
<li>(font-awesome-sass 4.1.0) (view での <code>icon</code> メソッド)</li>
</ul>


<h2>前提条件</h2>

<ul>
<li>devise で通常の User モデルにメールアドレスとパスワードによる認証は実装されている。</li>
<li>複数サービスとの連携をするために User モデルには連携サービスの情報は直接持たずに UserAuth モデルに分ける。</li>
<li>連携対象サービスは Facebook, GitHub, Google+, Twitter</li>
<li>連携サービスからの追加情報はメールアドレスなども含めて一切とらずに認証だけに利用する。</li>
<li>どの連携サービス (provider) かと識別するための ID だけ保存する。</li>
<li>key や secret は環境変数で渡す。 (今回は dotenv を使ったが、 config/secrets.yml 経由でも良さそう)</li>
<li>今回はテストは未実装 (連携部分のテストの書き方をまだ調べていないため)</li>
<li>今回の実装範囲では I18n は使わずにメッセージは日本語固定</li>
</ul>


<h2>実装</h2>

<p>今回は以下のように実装を追加すると連携サービスでログインできるようになりました。</p>

<h3>Gemfile</h3>

<p>OmniAuth と使用するサービスを追加します。</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;omniauth&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;omniauth-facebook&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;omniauth-github&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;omniauth-google-oauth2&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;omniauth-twitter&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>initializer 追加</h3>

<p>key と secret があれば provider 登録するようにしました。</p>

<p>view で使うために、
登録されている provider の情報の取り方がわからなかったのと
追加で名前や Font Awesome のアイコン名も入れたかったので、
<code>AUTH_PROVIDERS</code> という配列にハッシュを入れるようにしています。</p>

<figure class='code'><figcaption><span>config/initializers/omniauth.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">AUTH_PROVIDERS</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="ss">OmniAuth</span><span class="p">:</span><span class="ss">:Builder</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">key</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;FACEBOOK_KEY&#39;</span><span class="o">]</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;FACEBOOK_SECRET&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">secret</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">:facebook</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">secret</span>
</span><span class='line'>    <span class="no">AUTH_PROVIDERS</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">provider</span><span class="p">:</span> <span class="ss">:facebook</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Facebook&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">key</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;GITHUB_CONSUMER_KEY&#39;</span><span class="o">]</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;GITHUB_CONSUMER_SECRET&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">secret</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">:github</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">secret</span>
</span><span class='line'>    <span class="no">AUTH_PROVIDERS</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">provider</span><span class="p">:</span> <span class="ss">:github</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;GitHub&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">key</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;GOOGLE_CLIENT_ID&#39;</span><span class="o">]</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;GOOGLE_CLIENT_SECRET&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">secret</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">:google_oauth2</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">secret</span>
</span><span class='line'>    <span class="no">AUTH_PROVIDERS</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">provider</span><span class="p">:</span> <span class="ss">:google_oauth2</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Google&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">icon</span><span class="p">:</span> <span class="ss">:google</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">key</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;TWITTER_CONSUMER_KEY&#39;</span><span class="o">]</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;TWITTER_CONSUMER_SECRET&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">secret</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">:twitter</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">secret</span>
</span><span class='line'>    <span class="no">AUTH_PROVIDERS</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
</span><span class='line'>      <span class="ss">provider</span><span class="p">:</span> <span class="ss">:twitter</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Twitter&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">AUTH_PROVIDERS</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">provider</span><span class="o">|</span>
</span><span class='line'>    <span class="n">provider</span><span class="o">[</span><span class="ss">:icon</span><span class="o">]</span> <span class="o">||=</span> <span class="n">provider</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>UserAuth モデル作成</h3>

<p><code>rails g model UserAuth user:references uid:string provider:string</code> で作成します。</p>

<p>モデルクラスは生成されたまま使いましたが、
validation を追加した方が良さそうです。</p>

<figure class='code'><figcaption><span>app/models/user_auth.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UserAuth</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:user</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>データベースの方は <code>null: false</code> や index を追加しました。</p>

<figure class='code'><figcaption><span>db/migrate/*_create_user_auths.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CreateUserAuths</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">change</span>
</span><span class='line'>    <span class="n">create_table</span> <span class="ss">:user_auths</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">index</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:provider</span><span class="p">,</span> <span class="ss">null</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">add_index</span> <span class="ss">:user_auths</span><span class="p">,</span> <span class="o">[</span><span class="ss">:uid</span><span class="p">,</span> <span class="ss">:provider</span><span class="o">]</span><span class="p">,</span> <span class="ss">unique</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>rake db:migrate</code></h3>

<p><code>rake db:migrate</code> で反映しておきます。</p>

<h3>User クラス側</h3>

<p><code>has_many</code> を追加しておきます。</p>

<figure class='code'><figcaption><span>app/models/user.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">has_many</span> <span class="ss">:user_auths</span><span class="p">,</span> <span class="ss">dependent</span><span class="p">:</span> <span class="ss">:destroy</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ルーティング追加</h3>

<p>まず、どう使われるのか把握するためにルーティングを追加します。</p>

<p><code>auth_help</code> は後でプライバシーポリシーなどを書いています。</p>

<figure class='code'><figcaption><span>config/routes.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">get</span> <span class="s1">&#39;/auth/help&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;auth#help&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:auth_help</span>
</span><span class='line'>  <span class="n">get</span> <span class="s1">&#39;/auth/:provider/callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;auth#create&#39;</span>
</span><span class='line'>  <span class="n">delete</span> <span class="s1">&#39;/auth/destroy/:provider&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;auth#destroy&#39;</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:destroy_connection</span>
</span></code></pre></td></tr></table></div></figure>


<p>ここには出てきていませんが、
OmniAuth で <code>/auth/:provider</code> がルーティングされるようです。</p>

<h3>AuthController 実装</h3>

<p>参考サイトの実装例を参考にして AuthController を実装しました。</p>

<p>help は静的な情報を表示するだけなので、実装は空です。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AuthController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">skip_before_filter</span> <span class="ss">:authenticate_user!</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="o">[</span><span class="s1">&#39;omniauth.auth&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">uid</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">provider</span> <span class="o">=</span> <span class="n">auth</span><span class="o">[</span><span class="s1">&#39;provider&#39;</span><span class="o">]</span>
</span><span class='line'>    <span class="n">auth</span> <span class="o">=</span> <span class="no">UserAuth</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">uid</span><span class="p">:</span> <span class="n">uid</span><span class="p">,</span> <span class="ss">provider</span><span class="p">:</span> <span class="n">provider</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">auth</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="si">}</span><span class="s2">でログインしました。&quot;</span>
</span><span class='line'>      <span class="n">sign_in_and_redirect</span> <span class="n">auth</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="ss">event</span><span class="p">:</span> <span class="ss">:authentication</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">authenticate_user!</span>
</span><span class='line'>      <span class="no">UserAuth</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">uid</span><span class="p">:</span> <span class="n">uid</span><span class="p">,</span> <span class="ss">provider</span><span class="p">:</span> <span class="n">provider</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="si">}</span><span class="s2">と連携しました。&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">destroy</span>
</span><span class='line'>    <span class="n">provider</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:provider</span><span class="p">)</span>
</span><span class='line'>    <span class="n">authenticate_user!</span>
</span><span class='line'>    <span class="n">auth</span> <span class="o">=</span> <span class="no">UserAuth</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">provider</span><span class="p">:</span> <span class="n">provider</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>    <span class="n">auth</span><span class="o">.</span><span class="n">destroy</span> <span class="k">if</span> <span class="n">auth</span>
</span><span class='line'>    <span class="n">redirect_to</span> <span class="n">root_url</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="si">}</span><span class="s2">と連携解除しました。&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">help</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>まだ連携を登録していない状態で</p>

<ul>
<li>ログアウト状態</li>
<li>連携サービスで認証・連携許可</li>
<li>戻ってきて通常ログイン</li>
<li><code>auth/failure</code> に飛ばされる</li>
</ul>


<p>ということがおきているのですが、
<code>auth/failure</code>
を実装していないので、デフォルトの 404 エラー画面になってしまいます。</p>

<h3>view helpers 実装</h3>

<p>以前から使っていた <code>link_to_sign_in_or_out</code> の実装も同じファイルに持ってきて、
<code>link_to_provider</code> という汎用的なメソッドを実装しました。
使い方は後述します。</p>

<p><code>AUTH_PROVIDERS</code> のハッシュはここで使っています。</p>

<figure class='code'><figcaption><span>app/helpers/link_to_auth_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span class='line'><span class="k">module</span> <span class="nn">LinkToAuthHelper</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">link_to_sign_in_or_out</span><span class="p">(</span><span class="n">html_options</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">user_signed_in?</span>
</span><span class='line'>      <span class="n">body</span> <span class="o">=</span> <span class="n">icon</span><span class="p">(</span><span class="ss">:&#39;sign-out&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span><span class="p">(</span><span class="ss">:&quot;devise.shared.links.sign_out&quot;</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="s2">&quot;Sign out&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">html_options</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">}</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">html_options</span><span class="p">)</span>
</span><span class='line'>      <span class="n">link_to</span> <span class="n">body</span><span class="p">,</span> <span class="ss">:destroy_user_session</span><span class="p">,</span> <span class="n">html_options</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">body</span> <span class="o">=</span> <span class="n">icon</span><span class="p">(</span><span class="ss">:&#39;sign-in&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span><span class="p">(</span><span class="ss">:&quot;devise.shared.links.sign_in&quot;</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="s2">&quot;Sign in&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">link_to</span> <span class="n">body</span><span class="p">,</span> <span class="ss">:new_user_session</span><span class="p">,</span> <span class="n">html_options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">link_to_provider</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">html_options</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">current_user</span>
</span><span class='line'>      <span class="k">if</span> <span class="no">UserAuth</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="ss">provider</span><span class="p">:</span> <span class="n">provider</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">exists?</span>
</span><span class='line'>        <span class="n">html_options</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">method</span><span class="p">:</span> <span class="ss">:delete</span> <span class="p">}</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">html_options</span><span class="p">)</span>
</span><span class='line'>        <span class="n">link_to</span> <span class="n">icon</span><span class="p">(</span><span class="n">provider</span><span class="o">[</span><span class="ss">:icon</span><span class="o">]</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">との連携を解除&quot;</span><span class="p">,</span> <span class="n">destroy_connection_path</span><span class="p">(</span><span class="ss">provider</span><span class="p">:</span> <span class="n">provider</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span><span class="p">),</span> <span class="n">html_options</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">link_to</span> <span class="n">icon</span><span class="p">(</span><span class="n">provider</span><span class="o">[</span><span class="ss">:icon</span><span class="o">]</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">と連携&quot;</span><span class="p">,</span> <span class="s2">&quot;/auth/</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">html_options</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">link_to</span> <span class="n">icon</span><span class="p">(</span><span class="n">provider</span><span class="o">[</span><span class="ss">:icon</span><span class="o">]</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">でログイン&quot;</span><span class="p">,</span> <span class="s2">&quot;/auth/</span><span class="si">#{</span><span class="n">provider</span><span class="o">[</span><span class="ss">:provider</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">html_options</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>view に追加</h3>

<p>ナビゲーションに以下のように追加しました。
認証連携がないときは従来のログイン・ログアウトだけ表示しています。</p>

<p><code>AUTH_PROVIDERS</code> に登録されているときだけ連携のリンクを表示するようにしています。</p>

<figure class='code'><figcaption><span>app/views/layouts/_navigation.html.slim</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>    li.dropdown
</span><span class='line'>      a.dropdown-toggle data-toggle=&quot;dropdown&quot;
</span><span class='line'>        = icon(:user) + &#39;ログイン管理&#39;
</span><span class='line'>        b.caret
</span><span class='line'>      ul.dropdown-menu
</span><span class='line'>        li= link_to_sign_in_or_out
</span><span class='line'>        - unless AUTH_PROVIDERS.empty?
</span><span class='line'>          li= link_to icon(:info)+&quot;認証連携のヘルプ&quot;, auth_help_path
</span><span class='line'>        - AUTH_PROVIDERS.each do |provider|
</span><span class='line'>          li= link_to_provider(provider)
</span></code></pre></td></tr></table></div></figure>


<h3>twitter 連携</h3>

<p>Twitter は複数アカウントを使うことも通常の使用範囲として想定されていて、
アプリ専用のアカウントもとりやすいので、
Twitter 連携から試してみました。</p>

<p><a href="https://apps.twitter.com/">https://apps.twitter.com/</a> から <code>Create New App</code> で作成します。</p>

<ul>
<li>Name: Twitter 全体で一意になるアプリケーションの ID 的にも使われるもの。ツイートの時にツイートしたアプリ名としても埋め込まれるが、今回は認証のみなので、他とぶつからないような名前という以上はこだわらなかった。</li>
<li>Description: 認証のときに出てくる説明。</li>
<li>Website: たとえば <code>http://app.127.0.0.1.xip.io:3000/</code> など</li>
<li>Callback URL: たとえば <code>http://app.127.0.0.1.xip.io:3000/auth/twitter/callback</code> のように <code>/auth/twitter/callback</code> にする。実サイトなら <code>https</code> にすべき。</li>
</ul>


<p>作成後には <code>Allow this application to be used to Sign in with Twitter</code> のチェックを入れておきます。
チェックがないと Twitter 連携でのログインがうまくいかないようです。</p>

<p>アイコンや Organization なども必要に応じて変更します。</p>

<p>API keys タブで key と secret を取得します。</p>

<ul>
<li>API key : 環境変数 <code>TWITTER_CONSUMER_KEY</code> に設定</li>
<li>API secret : 環境変数 <code>TWITTER_CONSUMER_SECRET</code> に設定</li>
</ul>


<p>dotenv を使っているので <code>.env</code> に以下のような感じで設定しました。
ランダムな文字列のように見えます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>TWITTER_CONSUMER_KEY=&quot;xxxxXXxxXxXxXXXxXxXXXXxxx&quot;
</span><span class='line'>TWITTER_CONSUMER_SECRET=&quot;xxXXxXXxxxxxxXXXXXxXxXXxxXXXxXXxxxxXXxxXxxXXxxXxxx&quot;
</span></code></pre></td></tr></table></div></figure>


<h3>動作確認</h3>

<ul>
<li>通常のログインをした状態で「Twitter と連携」で Twitter の許可画面に飛びます。</li>
<li>許可すると「Twitter 側に許可情報」と「UserAuth に連携情報」が保存されます。</li>
<li>「Twitter との連携を解除」で「UserAuth が削除」されます。</li>
<li>「ログアウト」して「Twitter でログイン」すると「ログイン画面」に戻ります。</li>
<li>ログインすると <code>auth/failure</code> が 404 エラーになります。ここは後で実装する予定です。</li>
<li>再度ログイン後の画面を直接開きます。</li>
<li>再度「Twitter と連携」で「UserAuth に連携情報」が保存されます。「Twitter 側の許可情報」は古いままです。</li>
<li>「ログアウト」して「Twitter でログイン」でログインできます。</li>
<li><a href="https://twitter.com/settings/applications">https://twitter.com/settings/applications</a> で許可を取り消します。</li>
<li>「ログアウト」して「Twitter でログイン」で Twitter の許可画面に飛びます。</li>
<li>許可すると「Twitter 側に許可情報」が保存されて、「UserAuth」は残っているので、そのままログインできます。</li>
</ul>


<h3>GitHub 連携</h3>

<p>GitHub 連携は作成後にすぐに使えるので、アプリケーション作成に使っても良いアカウントがあれば一番簡単です。</p>

<p><a href="https://github.com/settings/applications">https://github.com/settings/applications</a> から <code>Register new application</code> で作成します。</p>

<ul>
<li>Application name: 適切な名前を設定</li>
<li>Homepage URL: たとえば <code>http://app.127.0.0.1.xip.io:3000/</code> など</li>
<li>Application description: ユーザーが許可するときにわかりやすい説明</li>
<li>Authorization callback URL: たとえば <code>http://app.127.0.0.1.xip.io:3000/auth/github/callback</code> のように <code>/auth/github/callback</code> にする。実サイトなら <code>https</code> にすべき。</li>
</ul>


<p>右上に見えている Client ID と Client Secret を使います。</p>

<ul>
<li>Client ID : 環境変数 <code>GITHUB_CONSUMER_KEY</code> に設定</li>
<li>Client Secret : 環境変数 <code>GITHUB_CONSUMER_SECRET</code> に設定</li>
</ul>


<p>dotenv を使っているので <code>.env</code> に以下のような感じで設定しました。
十六進数の数字のように見えます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>GITHUB_CONSUMER_KEY=&quot;xxxxxxxxxxxxxxxxxxxx&quot;
</span><span class='line'>GITHUB_CONSUMER_SECRET=&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;
</span></code></pre></td></tr></table></div></figure>


<h2>Facebook 連携</h2>

<p><a href="https://developers.facebook.com/">https://developers.facebook.com/</a> から上の <code>Apps</code> の中にある <code>Craete a New App</code> で作成します。
最初は作成前に開発者関連の規約などに同意する必要があるようです。</p>

<ul>
<li>Display Name: 適切な名前を設定します。</li>
<li>Namespace: optional なので空欄のままで良いようです。</li>
<li>カテゴリ: 適当に選択します。</li>
</ul>


<p>セキュリティチェックがあるので、入力すると作成できます。</p>

<p>右上に見えている App ID と App Secret (Show を押すとパスワード認証の後に内容表示) を使います。</p>

<ul>
<li>App ID : 環境変数 <code>FACEBOOK_KEY</code> に設定</li>
<li>App Secret : 環境変数 <code>FACEBOOK_SECRET</code> に設定</li>
</ul>


<p>dotenv を使っているので <code>.env</code> に以下のような感じで設定しました。
十進数と十六進数の数字のように見えます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>FACEBOOK_KEY=&quot;xxxxxxxxxxxxxxx&quot;
</span><span class='line'>FACEBOOK_SECRET=&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;
</span></code></pre></td></tr></table></div></figure>


<p><code>Settings</code> の <code>Add Platform</code> で <code>Website</code> を選んで追加します。</p>

<ul>
<li>Site URL: たとえば <code>http://app.127.0.0.1.xip.io:3000/</code> など</li>
<li>Mobile Site URL: 空欄のまま</li>
</ul>


<p>callback URL は設定が不要だったので、
Site URL の下ならどこでも良さそうです。</p>

<h3><code>google_oauth2</code> 連携</h3>

<p><a href="https://github.com/zquestz/omniauth-google-oauth2">https://github.com/zquestz/omniauth-google-oauth2</a> に書いてあるように
<a href="https://code.google.com/apis/console/">https://code.google.com/apis/console/</a> を開きます。</p>

<p>飛ばされる先で <code>API &amp; AUTH</code> の中の <code>Credentials</code> で <code>Create new Client ID</code> で作成します。</p>

<ul>
<li>Application type : Web application</li>
<li>Authorized JavaScript origins : たとえば <code>http://app.127.0.0.1.xip.io:3000</code> など</li>
<li>Authorized redirect URI : たとえば <code>http://app.127.0.0.1.xip.io:3000/auth/google_oauth2/callback</code> のように <code>/auth/google_oauth2/callback</code> にする。実サイトなら <code>https</code> にすべき。</li>
</ul>


<p>右に見えている Client ID と Client secret を使います。</p>

<ul>
<li>Client ID : 環境変数 <code>GOOGLE_CLIENT_ID</code> に設定</li>
<li>Client secret : 環境変数 <code>GOOGLE_CLIENT_SECRET</code> に設定</li>
</ul>


<p>dotenv を使っているので <code>.env</code> に以下のような感じで設定しました。
ドメインっぽい文字列とランダムな文字列のように見えます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>GOOGLE_CLIENT_ID=&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com&quot;
</span><span class='line'>GOOGLE_CLIENT_SECRET=&quot;XXxxxXxXxxxXXxXXxXxXXxxX&quot;
</span></code></pre></td></tr></table></div></figure>


<p>さらに <code>Consent screen</code> での設定が必要です。
しかも全アプリ共通のようなので、名前を分けたい場合はグーグルアカウントごと違うものにしないといけないように見えました。</p>

<ul>
<li>Email address : グーグルアカウントのアドレス選択</li>
<li>Product name : 適切な名前を設定</li>
<li>Homepage URL 以下 : 必要に応じて設定</li>
</ul>


<p>さらにエラーメッセージ (<code>"Access Not Configured. Please use Google Developers Console to activate the API for your project."</code>) で検索してわかったのですが、
<a href="http://qiita.com/aikyo02/items/459d03af304e1188f110" title="Google OAuth 2.0 loginが2014年9月に使えなくなる(Googleアカウントからのユーザ登録機能がある場合は注意)">Google OAuth 2.0 loginが2014年9月に使えなくなる(Googleアカウントからのユーザ登録機能がある場合は注意)</a>
に書いてあるように、
APIs で <code>Google+ API</code> も有効にする必要がありました。</p>

<h2>参考サイト</h2>

<ul>
<li><a href="http://xoyip.hatenablog.com/entry/2013/12/20/212109" title="Railsでログインとは別に複数のサービスとの連携を行う方法 - PILOG">Railsでログインとは別に複数のサービスとの連携を行う方法 &ndash; PILOG</a>
と<a href="https://github.com/xoyip/multi-oauth">その実装</a>は非常に参考になりました。</li>
<li><a href="http://qiita.com/aikyo02/items/459d03af304e1188f110" title="Google OAuth 2.0 loginが2014年9月に使えなくなる(Googleアカウントからのユーザ登録機能がある場合は注意)">Google OAuth 2.0 loginが2014年9月に使えなくなる(Googleアカウントからのユーザ登録機能がある場合は注意)</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[JAWS-UG三都物語2014に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-07-05-jawsug-santo.html"/>
    <updated>2014-07-05T13:07:03+09:00</updated>
    <id>http://blog.n-z.jp/blog/jawsug-santo</id>
    <content type="html"><![CDATA[<p><a href="http://santo2014.jaws-ug.jp/" title="夏のJAWS-UG 三都物語 2014">夏のJAWS-UG 三都物語 2014</a>
に午後から参加して、
主に Vagrant の話を聞いたのと、
CDP道場（初中級）に参加していました。</p>

<!--more-->


<h2>開発現場で活用する Vagrant</h2>

<div style="float:right">
<iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=znz-22&amp;o=9&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=B00F418SQ8" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>
</div>


<p>まず最初に Vagrant の話をきいてきました。</p>

<p><a href="http://www.amazon.co.jp/gp/product/B00F418SQ8/ref=as_li_ss_tl?ie=UTF8&amp;camp=247&amp;creative=7399&amp;creativeASIN=B00F418SQ8&amp;linkCode=as2&amp;tag=znz-22">Vagrant入門ガイド</a><img src="http://ir-jp.amazon-adsystem.com/e/ir?t=znz-22&amp;l=as2&amp;o=9&amp;a=B00F418SQ8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
がなぜか今200円になっていると言っていました。</p>

<p><a href="https://github.com/shin1x1/vagrant-demo-20140705">https://github.com/shin1x1/vagrant-demo-20140705</a> にデモの内容が公開されていますが、後で聞いてみたらスライドの番号では 4 が vagrant share だけだったので、番号がずれていると言っていました。</p>

<p>vagrant up だけで開発環境が構築できるようにしておくというのはマネしてみようと思いました。</p>

<p>ansible をゲスト OS 側に入れるのは vagrant up だけで済む (ホスト側に ansible を入れる必要がない) という他にホスト側の ansible のバージョンが上がって provisioning に影響が出るのを避けられるという利点もあると思いました。</p>

<h2>オンプレから AWS への劇的ビフォーアフター</h2>

<p>オンプレという言葉がさしているものが期待していたものと違ったので、あまり聞いていなくて他のことをしていました。</p>

<h2>AWS と mackerel で実践する Immutable Infrastructure</h2>

<p>他の作業がはかどっていたので、作業しながら聞いていました。</p>

<p>とりあえず、まだ流動的な部分もありそうで、
しばらく様子見な部分も多そうだと思いました。</p>

<h2>CDP 道場（初中級）</h2>

<p>CDP というのはクラウドデザインパターンという意味だったらしく、
クラウドを実際にどういう構成で使うのかというのが勉強になりました。</p>

<h2>その後</h2>

<p>懇親会が無料というのを知らなかったこともあり、
そのまま帰りました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GOPATHとghqの設定を変更した話とgitconfigのコマンドでの設定の話]]></title>
    <link href="http://blog.n-z.jp/blog/2014-07-05-ghq-gitconfig.html"/>
    <updated>2014-07-05T09:55:07+09:00</updated>
    <id>http://blog.n-z.jp/blog/ghq-gitconfig</id>
    <content type="html"><![CDATA[<p><a href="http://blog.kentarok.org/entry/2014/06/03/135300" title="ghqを使ったローカルリポジトリの統一的・効率的な管理について - delirious thoughts">ghqを使ったローカルリポジトリの統一的・効率的な管理について &ndash; delirious thoughts</a>
を参考にして、
go と ghq で同じディレクトリを使っていたのですが、
go で自動で追加ダウンロードされたものと
自分でダウンロードしたものが混ざるとわかりにくいと思ったので、
分けることにしました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>go version go1.3 darwin/amd64</li>
<li>git verseion 2.0.0</li>
<li>Mercurial Distributed SCM (version 3.0.1)</li>
<li>ghq version HEAD (2014-06-27 が最新コミットの状態)</li>
</ul>


<h2>go などのインストール</h2>

<p><a href="http://brew.sh/">Homebrew</a> を使って
<code>brew install go --cross-compile-common</code>
でインストールしました。</p>

<p>git と mercurial もインストールしておきました。</p>

<h2>シェルの設定 (GOPATH など)</h2>

<p>bash と zsh の共通の設定として
<a href="https://github.com/znz/dot-shell/blob/bb84c5aefc83eab5ce1841508abd726ee9db6577/profile.d/50gopath.sh" title="50gopath.sh">50gopath.sh</a>
で以下のように設定しています。</p>

<p>統合している時は go とか git とかの意味をかねて g だけにしていましたが、
今は go 専用にしています。</p>

<figure class='code'><figcaption><span>50gopath.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;${GOPATH:-}&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">export </span><span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$HOME</span>/g
</span><span class='line'>    <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$GOPATH</span>/bin
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>その後に zsh 専用の追加設定で
<a href="https://github.com/znz/dot-shell/blob/bb84c5aefc83eab5ce1841508abd726ee9db6577/profile.d/50gopath.zsh" title="50gopath.zsh">50gopath.zsh</a>
で以下のように設定しています。</p>

<p>GOPATH が PATH のように <code>:</code> 区切りで複数になる可能性を考慮してしまったのですが、
<a href="http://golang.org/doc/code.html#GOPATH" title="The GOPATH environment variable">The GOPATH environment variable</a>
をみるとそういうことはなさそうなので、
<code>${^${(s/:/)GOPATH}}</code> は単純に <code>${GOPATH}</code> でも良さそうです。</p>

<p>そして fpath に <code>_ghq</code> のパスを追加して <code>ghq</code> の引数を補完できるようにしています。</p>

<figure class='code'><figcaption><span>50gopath.zsh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">path</span><span class="o">=(</span> <span class="nv">$path</span> <span class="k">${</span><span class="p">^</span><span class="k">${</span><span class="p">(s/:/)GOPATH</span><span class="k">}}</span>/bin<span class="o">(</span>N<span class="o">)</span> <span class="o">)</span>
</span><span class='line'><span class="nv">fpath</span><span class="o">=(</span> <span class="nv">$fpath</span> <span class="k">${</span><span class="p">^</span><span class="k">${</span><span class="p">(s/:/)GOPATH</span><span class="k">}}</span>/src/*/*/ghq/zsh<span class="o">(</span>N<span class="o">)</span> <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ghq のインストール</h2>

<p><code>go get -v github.com/motemen/ghq</code>
でインストールしました。</p>

<h3><code>https://</code> の要不要</h3>

<p><code>ghq get</code> では <code>github.com</code> から書く時は <code>https://</code> が必須なのですが、
こちらは <code>https://</code> は不要というか、
むしろ付けるとエラーになりました。</p>

<h2>.gitconfig の設定</h2>

<p><a href="https://github.com/znz/dot-shell/blob/bb84c5aefc83eab5ce1841508abd726ee9db6577/git-config.sh" title="git-config.sh">git-config.sh</a>
で <code>user.name</code> や <code>user.email</code> 以外の共通のものはまとめて設定しています。</p>

<h3>コマンドでの設定の追加削除</h3>

<p>詳細はドキュメントをみてもらうとして、まとめておくと以下のようになります。</p>

<ul>
<li>単独の設定 : <code>git config --global section.key value</code></li>
<li>複数設定 : <code>git config --global section.key value</code> の後で <code>git config --global --add section.key value</code></li>
<li>複数設定削除 : <code>git config --global --unset-all section.key</code> (ただしセクションが空になっても残る)</li>
<li>セクションごと削除 : <code>git config --global --remove-section セクション</code></li>
</ul>


<h3>ghq の設定</h3>

<p><code>ghq.root</code> を <code>--unset-all</code> だけすると git-config.sh を実行する度に
ghq セクション、つまり <code>[ghq]</code> の行が増えていってしまったので、
<code>--remove-section</code> を使いました。
他に <code>ghq</code> セクションに設定を入れていたら、
それも消えてしまうので注意してください。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># ghq section</span>
</span><span class='line'>git config --global --remove-section <span class="s2">&quot;ghq&quot;</span> <span class="o">||</span> :
</span><span class='line'><span class="nv">GHQ_ROOT</span><span class="o">=</span><span class="s2">&quot;ghq.root&quot;</span>
</span><span class='line'><span class="c">#git config --global --unset-all &quot;$GHQ_ROOT&quot; || :</span>
</span><span class='line'>git config --global <span class="s2">&quot;$GHQ_ROOT&quot;</span> <span class="s2">&quot;$HOME/s&quot;</span>
</span><span class='line'>git config --global --add <span class="s2">&quot;$GHQ_ROOT&quot;</span> <span class="s2">&quot;$HOME/g/src&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>これで <code>ghq get</code> は <code>$HOME/s</code> に入って
<code>ghq look</code> では両方見えるようになりました。</p>

<h3>github の URL 統一の話</h3>

<p>github の URL は https に統一して、
gitconfig の設定で
push は ssh プロトコル、
pull などは git プロトコル (昔は Git Read-Only と書いてあった URL)
を使うようにしています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># github upload</span>
</span><span class='line'><span class="nv">GITHUB_URL_PREFIX</span><span class="o">=</span><span class="s2">&quot;url.git@github.com:&quot;</span>
</span><span class='line'>git config --global --remove-section <span class="s2">&quot;$GITHUB_URL_PREFIX&quot;</span> <span class="o">||</span> :
</span><span class='line'>git config --global <span class="s2">&quot;$GITHUB_URL_PREFIX&quot;</span>.pushInsteadOf <span class="s2">&quot;git://github.com/&quot;</span>
</span><span class='line'>git config --global --add <span class="s2">&quot;$GITHUB_URL_PREFIX&quot;</span>.pushInsteadOf <span class="s2">&quot;https://github.com/&quot;</span>
</span><span class='line'><span class="c"># gist upload</span>
</span><span class='line'>git config --global <span class="s2">&quot;url.git@gist.github.com:&quot;</span>.pushInsteadOf <span class="s2">&quot;https://gist.github.com/$(git config github.user)/&quot;</span>
</span><span class='line'><span class="c"># github download</span>
</span><span class='line'>git config --global url.<span class="s2">&quot;git://github.com/&quot;</span>.insteadOf <span class="s2">&quot;https://github.com/&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>詳細は
<a href="http://blog.n-z.jp/blog/2013-11-28-git-insteadof.html" title="githubでhttpsのURLを指定してもgitプロトコルやssh経由にする方法">githubでhttpsのURLを指定してもgitプロトコルやssh経由にする方法</a>
を参照してください。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Amagasakirb特別編 須藤さん関連プロダクツ勉強会に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-28-amagasakirb.html"/>
    <updated>2014-06-28T13:16:24+09:00</updated>
    <id>http://blog.n-z.jp/blog/amagasakirb</id>
    <content type="html"><![CDATA[<p><a href="http://kokucheese.com/event/index/186111/" title="6月28日 Amagasakirb特別編 須藤さん関連プロダクツ勉強会(兵庫県)">6月28日 Amagasakirb特別編 須藤さん関連プロダクツ勉強会(兵庫県)</a>
に参加しました。</p>

<!--more-->


<h2>自己紹介</h2>

<p>まず最初に、使っている須藤さん関連プロダクツの話を中心に自己紹介していました。
イベントのページには書いていませんでしたが、
<a href="http://docs.ruby-lang.org/ja/search/" title="るりまサーチ">るりまサーチ</a>
も須藤さん関連プロダクツでした。</p>

<h2>メモ</h2>

<p>その後は須藤さん関連プロダクツの話をいろいろしていたので、
その中からのメモです。
話としては groonga 関連と ActiveLdap 関連が多かったです。</p>

<h3>groonga 関連</h3>

<ul>
<li><a href="http://ongaeshi.hatenablog.com/entry/honyomi-init" title="数万の電子書籍から目的のページを一瞬で見つけ出す、Honyomi - ブログのおんがえし">数万の電子書籍から目的のページを一瞬で見つけ出す、Honyomi &ndash; ブログのおんがえし</a></li>
<li><a href="http://milkode.ongaeshi.me/" title="Milkode - 行指向のソースコード検索エンジン">Milkode &ndash; 行指向のソースコード検索エンジン</a></li>
<li><a href="http://patentfield.com/%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%9A%E3%83%BC%E3%82%B8" title="PatentField | 無料特許検索">PatentField | 無料特許検索</a></li>
</ul>


<h3>ActiveLdap 関連</h3>

<ul>
<li>値が1個しかなくても常に配列を返す使い方も出来る</li>
<li>使い方が Net-LDAP より直感的</li>
</ul>


<h3>groonga と競合する?プロダクト</h3>

<ul>
<li>solr</li>
<li>lucene</li>
<li>xapian</li>
</ul>


<h3>mroonga 関連メモ</h3>

<p>他の話はメモしきれなかったので、
テーブルの情報取得に</p>

<ul>
<li><code>show create table test;</code></li>
<li><code>desc test;</code></li>
</ul>


<p>の2種類の方法を使っていたことぐらいはメモしておきたいと思いました。</p>

<h3>ChupaText</h3>

<ul>
<li>チュパカブラが名前の由来</li>
<li>groonga と組み合わせれば Hyper Estraier のようなものが作れるかも</li>
</ul>


<h3>Jekyll のコンテンツの翻訳の話</h3>

<ul>
<li><a href="http://www.clear-code.com/blog/2014/4/23.html" title="Jekyllで複数言語のコンテンツを継続してメンテナンスする方法 - ククログ(2014-04-23)">Jekyllで複数言語のコンテンツを継続してメンテナンスする方法 &ndash; ククログ(2014-04-23)</a></li>
<li><a href="https://www.ruby-lang.org/admin/translation-status/" title="www.ruby-lang.org - News Post Translation Status">www.ruby-lang.org &ndash; News Post Translation Status</a></li>
</ul>


<h3>須藤さん関連</h3>

<ul>
<li><a href="http://slide.rabbit-shocker.org/authors/kou/">http://slide.rabbit-shocker.org/authors/kou/</a></li>
<li><a href="https://github.com/kou">https://github.com/kou</a></li>
<li><a href="https://github.com/clear-code/sezemi-2014-readable-code">https://github.com/clear-code/sezemi-2014-readable-code</a></li>
</ul>


<h3>最後に須藤さんの過去のプレゼンから</h3>

<ul>
<li><a href="http://slide.rabbit-shocker.org/authors/kou/devmi-2013/">http://slide.rabbit-shocker.org/authors/kou/devmi-2013/</a></li>
</ul>


<h2>rabbiter 問題</h2>

<p>自己紹介の時に rabbit を使ったので、せっかくなので、
rabbiter を使おうとしたのですが、今回も事前に動かせる状態までは
もっていけませんでした。</p>

<p>しかし、
Homebrew で rabbiter がインストールできなかったり、動かなかったりしたのが、
須藤さんの助言で解決しました。</p>

<p>まず <code>libffi</code> は <code>PKG_CONFIG_PATH</code> で <code>libffi.pc</code> の場所を指定すれば通りました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export PKG_CONFIG_PATH=/usr/local/Cellar/libffi/3.0.13/lib/pkgconfig
</span><span class='line'>gem install rabbiter</span></code></pre></td></tr></table></div></figure>


<p>この件は <code>/usr/local/lib/pkgconfig</code> に symlink がないのが問題なので、
<a href="https://github.com/Homebrew/homebrew/pull/30516">Homebrew 側の問題の修正</a>
を pull request してみました。</p>

<p>次に <code>rabbiter --filter twitter</code> のように起動しても
<code>(rabbiter:99703): GLib-GIO-ERROR **: No GSettings schemas are installed on the system</code>
ですぐに落ちてしまうという問題が起きました。</p>

<p>これは須藤さんに調べてもらって、環境変数 <code>GSETTINGS_SCHEMA_DIR</code> で <code>schemas</code> のディレクトリを指定すれば良いということで、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export GSETTINGS_SCHEMA_DIR=/usr/local/Cellar/gsettings-desktop-schemas/3.12.2/share/glib-2.0/schemas
</span><span class='line'>rabbiter --filter 'twitter'</span></code></pre></td></tr></table></div></figure>


<p>のように起動して解決しました。</p>

<p>こちらは対処方法がわからなかったので、
<a href="https://github.com/Homebrew/homebrew/issues/26455">gsettings-desktop-schemas crashes under current configure options</a>
という同様の現象が報告されている issue に回避策をコメントしておきました。</p>

<p>その後も以下のエラーで動いていませんでしたが、これは
<code>~/.rabbit/twitter-oauth.yaml</code>
が古いままで、アプリ連携の許可を取り消してしまっていたためで、
ファイルを削除して許可し直せば直りました。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% rabbiter --filter 'twitter'
</span><span class='line'>[エラー]
</span><span class='line'>[twitter] invalid status code: 401.</span></code></pre></td></tr></table></div></figure>


<h2>自分のスライド</h2>

<p>最後に自分の自己紹介の時に使ったスライドを載せておきます。
<code>ActiveLdap</code> と書いていますが、
<code>ActiveSambaLdap</code> の間違いでした。</p>

<iframe src="http://slide.rabbit-shocker.org/authors/znz/amagasakirb-201406/viewer.html"
        width="640" height="524"
        frameborder="0"
        marginwidth="0"
        marginheight="0"
        scrolling="no"
        style="border: 1px solid #ccc; border-width: 1px 1px 0; margin-bottom: 5px"
        allowfullscreen> </iframe>


<div style="margin-bottom: 5px">
  <a href="http://slide.rabbit-shocker.org/authors/znz/amagasakirb-201406/" title="普段使っている須藤さん関連プロダクツ">普段使っている須藤さん関連プロダクツ</a>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[環境変数にハッシュの配列を入れてみた]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-25-env-array-hash.html"/>
    <updated>2014-06-25T21:37:22+09:00</updated>
    <id>http://blog.n-z.jp/blog/env-array-hash</id>
    <content type="html"><![CDATA[<p><a href="https://twitter.com/znz/status/481691675136245760">環境変数にハッシュを入れたいと思って、ちょっと考えてみたら LTSV を使えば良いということに気づいた</a>ので、
実装してみました。
実際には単独のハッシュではなくハッシュの配列がほしかったので、
連続する数値を末尾に付けて複数受け取れるようにしています。</p>

<!--more-->


<h2>実装</h2>

<p>キーワード引数を使っているので、
以下の実装のままだと ruby 2.0.0 以降必須です。
必要なら適当に変更して使ってください。</p>

<div><script src='https://gist.github.com/849166c048a2117c341d.js?file=env_ltsv_each.rb'></script>
<noscript><pre><code># -*- coding: utf-8 -*-
# env_ltsv_each.rb
# copyright (c) 2014 Kazuhiro NISHIYAMA
# This software is released under the MIT License.
# http://opensource.org/licenses/MIT
require &#39;ostruct&#39;

def env_ltsv_each(prefix, start: 0, encoding: Encoding::UTF_8, scrub: false)
  block_given? or return enum_for(__method__)
  i = start
  loop do
    ltsv = ENV[&quot;#{prefix}_#{i}&quot;]
    i = i.succ
    break unless ltsv
    h = OpenStruct.new
    ltsv.split(/\t/).each do |pair|
      key, value = pair.split(&#39;:&#39;, 2)
      value.force_encoding(encoding)
      value.scrub! if scrub
      h[key] = value
    end
    yield h
  end
  nil
end

if __FILE__ == $0
  ENV[&#39;NAVI_0&#39;] = &#39;icon:top label:Top   uri:/&#39;
  ENV[&#39;NAVI_1&#39;] = &#39;icon:posts   label:Listing Posts uri:/posts&#39;
  ENV[&#39;NAVI_2&#39;] = &#39;icon:users   label:Listing Users uri:/users&#39;
  env_ltsv_each(&#39;NAVI&#39;) do |h|
    puts %Q(&lt;a href=&quot;#{h.uri}&quot;&gt;&lt;img src=&quot;#{h.icon}.png&quot; alt=&quot;#{h.label}&quot;&gt;&lt;/a&gt;)
    #=&gt;
    # &lt;a href=&quot;/&quot;&gt;&lt;img src=&quot;top.png&quot; alt=&quot;Top&quot;&gt;&lt;/a&gt;
    # &lt;a href=&quot;/posts&quot;&gt;&lt;img src=&quot;posts.png&quot; alt=&quot;Listing Posts&quot;&gt;&lt;/a&gt;
    # &lt;a href=&quot;/users&quot;&gt;&lt;img src=&quot;users.png&quot; alt=&quot;Listing Users&quot;&gt;&lt;/a&gt;
  end
end
</code></pre></noscript></div>


<h2>詳細</h2>

<p><code>String#scrub!</code> は 2.1.0 以降か
<a href="https://rubygems.org/gems/string-scrub">string-scrub gem</a>
が必要なのでデフォルトでは呼ばないようにしています。</p>

<p><code>Hash</code> だと取り出すのが面倒だったので、
<code>OpenStruct</code> を使ってみました。
メソッド名として問題がある場合は
<code>h['send']</code> のように普通の <code>Hash</code> のように取り出せます。</p>

<p>添字をまわすのに <code>succ</code> を使っているので <code>FOO_A</code>, <code>FOO_B</code>, &hellip; のような使い方も出来ると思います。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[caffでキーサインした]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-22-key-sign-caff.html"/>
    <updated>2014-06-22T19:07:19+09:00</updated>
    <id>http://blog.n-z.jp/blog/key-sign-caff</id>
    <content type="html"><![CDATA[<p><a href="https://wiki.debian.org/KansaiDebianMeeting/20140622" title="第 85 回 関西 Debian 勉強会">第 85 回 関西 Debian 勉強会</a>
で
<a href="https://launchpad.net/~mocchi">坂本さん</a>とキーサインをしたので、そのメモです。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>Ubuntu 12.04.4 LTS</li>
<li>gnupg 1.4.11-3ubuntu2.5</li>
<li>signing-party 1.1.4-1</li>
</ul>


<h2>事前準備</h2>

<p>事前にキーサインをするとわかっていれば <code>gpg-key2ps</code> コマンドで fingerprint の紙を用意しておくと良いと思います。
今回は少人数だったので、
fingerprint は画面上で見せて確認してもらいました。</p>

<h2>本人確認</h2>

<p>対面で運転免許証などの写真付きの身分証明書で名前を確認して、
それと署名対象の鍵の uid に入っている名前が一致するのを確認しておきます。
また、後で署名するために fingerprint の情報も入手しておきます。</p>

<h2>caff の設定</h2>

<p>基本的には
<a href="http://tokyodebian.alioth.debian.org/pdf/debianmeetingresume200910-presentation.pdf">Why GPG Key sign? 東京エリア Debian 勉強会 in OSC 2009 Tokyo/Fall</a>
の PDF の内容のままです。</p>

<h3>.caffrc</h3>

<p>自分の鍵 ID を <code>gpg --list-secret-keys</code> で確認すると、
<code>4096R/B4222F7A</code> とわかるので、
<code>gpg --fingerprint B4222F7A</code>
で fingerprint 全体を確認しておきます。
(fingerprint の末尾が鍵 ID です。)</p>

<p>spam よけのために email のところはちょっと改変していますが、
<code>~/.caffrc</code> は以下のように設定しています。
<code>keyid</code> は fingerprint の末尾のうち、
設定例と同じ長さだけ普通の鍵 ID よりちょっと長めに取り出して設定しています。
<code>owner</code> と <code>email</code> はメール送信の時に使われます。</p>

<figure class='code'><figcaption><span>~/.caffrc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1"># .caffrc -- vim:ft=perl:</span>
</span><span class='line'><span class="c1"># This file is in perl(1) format - see caff(1) for details.</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$CONFIG</span><span class="p">{</span><span class="s">&#39;owner&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;Kazuhiro NISHIYAMA&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$CONFIG</span><span class="p">{</span><span class="s">&#39;email&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="s">&#39;zn mbf.nifty.com&#39;</span><span class="p">;</span>
</span><span class='line'><span class="c1">#$CONFIG{&#39;reply-to&#39;} = &#39;foo@bla.org&#39;;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># You can get your long keyid from</span>
</span><span class='line'><span class="c1">#   gpg --with-colons --list-key &lt;yourkeyid|name|emailaddress..&gt;</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># If you have a v4 key, it will simply be the last 16 digits of</span>
</span><span class='line'><span class="c1"># your fingerprint.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Example:</span>
</span><span class='line'><span class="c1">#   $CONFIG{&#39;keyid&#39;} = [ qw{FEDCBA9876543210} ];</span>
</span><span class='line'><span class="c1">#  or, if you have more than one key:</span>
</span><span class='line'><span class="c1">#   $CONFIG{&#39;keyid&#39;} = [ qw{0123456789ABCDEF 89ABCDEF76543210} ];</span>
</span><span class='line'><span class="nv">$CONFIG</span><span class="p">{</span><span class="s">&#39;keyid&#39;</span><span class="p">}</span> <span class="o">=</span> <span class="p">[</span> <span class="sx">qw{262ED8DBB4222F7A}</span> <span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Select this/these keys to sign with</span>
</span><span class='line'><span class="c1">#$CONFIG{&#39;local-user&#39;} = [ qw{EE739B28C657086C 9B585538ED7E1B73 262ED8DBB4222F7A C9429DABCB28285B} ];</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Additionally encrypt messages for these keyids</span>
</span><span class='line'><span class="c1">#$CONFIG{&#39;also-encrypt-to&#39;} = [ qw{EE739B28C657086C 9B585538ED7E1B73 262ED8DBB4222F7A C9429DABCB28285B} ];</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Mail template to use for the encrypted part</span>
</span><span class='line'><span class="c1">#$CONFIG{&#39;mail-template&#39;} = &lt;&lt; &#39;EOM&#39;;</span>
</span><span class='line'><span class="c1">#Hi,</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#please find attached the user id{(scalar @uids &gt;= 2 ? &#39;s&#39; : &#39;&#39;)}</span>
</span><span class='line'><span class="c1">#{foreach $uid (@uids) {</span>
</span><span class='line'><span class="c1">#    $OUT .= &quot;\t&quot;.$uid.&quot;\n&quot;;</span>
</span><span class='line'><span class="c1">#};}of your key {$key} signed by me.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#If you have multiple user ids, I sent the signature for each user id</span>
</span><span class='line'><span class="c1">#separately to that user id&#39;s associated email address. You can import</span>
</span><span class='line'><span class="c1">#the signatures by running each through `gpg --import`.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#Note that I did not upload your key to any keyservers. If you want this</span>
</span><span class='line'><span class="c1">#new signature to be available to others, please upload it yourself.</span>
</span><span class='line'><span class="c1">#With GnuPG this can be done using</span>
</span><span class='line'><span class="c1">#       gpg --keyserver pool.sks-keyservers.net --send-key {$key}</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#If you have any questions, don&#39;t hesitate to ask.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#Regards,</span>
</span><span class='line'><span class="c1">#{$owner}</span>
</span><span class='line'><span class="c1">#EOM</span>
</span></code></pre></td></tr></table></div></figure>


<h3>~/.caff/gnupghome/gpg.conf の設定</h3>

<p>以前参考にした設定のまま</p>

<figure class='code'><figcaption><span>~/.caff/gnupghome/gpg.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>keyserver pgp.mit.edu
</span><span class='line'>cert-digest-algo SHA256
</span><span class='line'>personal-digest-preferences SHA256
</span></code></pre></td></tr></table></div></figure>


<p>となっていました。
PDF では SHA512 になっていたので、
SHA256 から SHA512 に変更しました。
今日の caff での署名した時点では SHA256 のままだったので、
次回から変わる予定です。</p>

<figure class='code'><figcaption><span>~/.caff/gnupghome/gpg.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>keyserver pgp.mit.edu
</span><span class='line'>cert-digest-algo SHA512
</span><span class='line'>personal-digest-preferences SHA512
</span></code></pre></td></tr></table></div></figure>


<h2>caff -u で署名</h2>

<p>spam よけのためメールアドレスの所は改変した状態のログは以下の通りです。
「本当に署名しますか? (y/N)」のところで身分証明書と一緒に確認した fingerprint と合っているか確認します。</p>

<p>最後にメールを送信して終了です。
相手の鍵で暗号化されたメールが localhost の SMTP サーバー送信されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">%</span> caff -u B4222F7A D66FD341
</span><span class='line'><span class="go">[INFO] Importing key 262ED8DBB4222F7A from your normal GnuPGHome.</span>
</span><span class='line'><span class="go">[INFO] fetching keys, this will take a while...</span>
</span><span class='line'><span class="go">[INFO] Sign the following keys according to your policy, then exit gpg with &#39;save&#39; after signing each key</span>
</span><span class='line'><span class="go">gpg --local-user B4222F7A --homedir=/home/kazu/.caff/gnupghome --secret-keyring /home/kazu/.gnupg/secring.gpg --no-auto-check-trustdb --trust-model=always --edit 25DA5B9699F132DB74BD2270B5A586C7D66FD341 sign</span>
</span><span class='line'><span class="go">gpg (GnuPG) 1.4.11; Copyright (C) 2010 Free Software Foundation, Inc.</span>
</span><span class='line'><span class="go">This is free software: you are free to change and redistribute it.</span>
</span><span class='line'><span class="go">There is NO WARRANTY, to the extent permitted by law.</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="go">pub  4096R/D66FD341  作成: 2014-06-22  満了: 無期限       利用法: SC</span>
</span><span class='line'><span class="go">sub  4096R/5D3BA622  作成: 2014-06-22  満了: 無期限       利用法: E</span>
</span><span class='line'><span class="go">[ unknown] (1). Takashi Sakamoto &lt;o-takashi sakamocchi.jp&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="go">pub  4096R/D66FD341  作成: 2014-06-22  満了: 無期限       利用法: SC</span>
</span><span class='line'><span class="go"> 主鍵の指紋: 25DA 5B96 99F1 32DB 74BD  2270 B5A5 86C7 D66F D341</span>
</span><span class='line'>
</span><span class='line'><span class="go">     Takashi Sakamoto &lt;o-takashi sakamocchi.jp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="go">本当にこの鍵にあなたの鍵“Kazuhiro NISHIYAMA &lt;zn mbf.nifty.com&gt;”で署名してよいですか</span>
</span><span class='line'><span class="go">(B4222F7A)</span>
</span><span class='line'>
</span><span class='line'><span class="go">本当に署名しますか? (y/N) y</span>
</span><span class='line'>
</span><span class='line'><span class="go">次のユーザーの秘密鍵のロックを解除するには</span>
</span><span class='line'><span class="go">パスフレーズがいります:“Kazuhiro NISHIYAMA &lt;zn mbf.nifty.com&gt;”</span>
</span><span class='line'><span class="go">4096ビットRSA鍵, ID B4222F7A作成日付は2010-06-27</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="go">gpg&gt; save</span>
</span><span class='line'><span class="go">[INFO] B5A586C7D66FD341 1 Takashi Sakamoto &lt;o-takashi sakamocchi.jp&gt; done.</span>
</span><span class='line'><span class="go">[INFO] key 25DA5B9699F132DB74BD2270B5A586C7D66FD341 done.</span>
</span><span class='line'><span class="go">Mail signature for Takashi Sakamoto &lt;o-takashi sakamocchi.jp&gt; to &#39;o-takashi sakamocchi.jp&#39;? [Y/n]</span>
</span><span class='line'><span class="gp">%</span>
</span></code></pre></td></tr></table></div></figure>


<h2>caff からのメールを受け取った相手のすべきこと</h2>

<p>暗号化されたメールが届くので、
対応する秘密鍵を使って復号してメールを確認します。
さらにその中にある署名を自分の鍵束にインポートしてキーサーバーに送信します。</p>

<p>caff のやり方はここでメールアドレスの到達性もチェックしているようなので、
署名した側はキーサーバーに送信する必要はなさそうです。
むしろそういうことをしないようにするために
<code>~/.caff/gnupghome</code> に独自の鍵束を用意しているように思いました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第 85 回 関西 Debian 勉強会に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-22-kansai-debian-meeting.html"/>
    <updated>2014-06-22T13:43:06+09:00</updated>
    <id>http://blog.n-z.jp/blog/kansai-debian-meeting</id>
    <content type="html"><![CDATA[<p><a href="https://wiki.debian.org/KansaiDebianMeeting/20140622" title="第 85 回 関西 Debian 勉強会">第 85 回 関西 Debian 勉強会</a>
に参加してきました。</p>

<p>そのときのメモです。
詳細は勉強会のページからリンクされている資料を参照してください。</p>

<!--more-->


<h2>Intro</h2>

<ul>
<li>MATE 1.8 が Debian に入ったという話

<ul>
<li><a href="https://www.debian.org/News/weekly/2014/10/" title="Debian Project News - June 9th, 2014">Debian Project News &ndash; June 9th, 2014</a></li>
</ul>
</li>
<li>Debian 6 の LTS (long term support) の話

<ul>
<li>全パッケージが対象というわけではない</li>
<li>たとえば rails とか chromium とかは対象外</li>
</ul>
</li>
<li>Berkeley DB を post jessie で外す予定

<ul>
<li>AGPL に変わったから</li>
</ul>
</li>
<li>事前課題発表と自己紹介

<ul>
<li>おすすめの IM</li>
<li>webwml-git の運用</li>
<li>web-mode.el (melpa にはある)</li>
</ul>
</li>
</ul>


<h2>「Linuxのドライバメンテナになった体験記」(担当：坂本)</h2>

<ul>
<li>質問から派生して残った疑問点

<ul>
<li>character device とは何か (block device との違いは何か)</li>
</ul>
</li>
</ul>


<h2>「Debian での systemd とのつきあい方」(担当：佐々木)</h2>

<p>状況確認コマンドいろいろのメモです。
一部のコマンドは自動で <code>$PAGER</code> を通してくれるようですが、
<code>PAGER=lv</code> の場合は <code>LV=-c</code> がないとエスケープシーケンスが解釈されなくて読みにくくなります。</p>

<ul>
<li><code>systemd-analyze</code></li>
<li><code>systemd-analyze blame</code></li>
<li><code>systemd-analyze plot &gt; systemd-analyze_plot.svg</code></li>
<li><code>systemctl list-dependencies</code></li>
<li><code>systemctl status</code></li>
<li><code>systemctl list-unit-files</code></li>
<li><code>systemctl list-units</code></li>
<li><code>sudo LV=-c journalctl</code></li>
<li><code>systemd-cgls</code></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ansible使いのためのYAML入門]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-21-ansible-yaml.html"/>
    <updated>2014-06-21T20:39:38+09:00</updated>
    <id>http://blog.n-z.jp/blog/ansible-yaml</id>
    <content type="html"><![CDATA[<p>ansible の設定ファイルは YAML なのですが、
ansible の説明では YAML 由来のいろんな書き方についてはあまり説明がないので、
ansible の設定ファイルを書く時に知っておくと便利な YAML の知識についてまとめてみました。</p>

<!--more-->


<h2>YAML のバージョン</h2>

<p><a href="http://yaml.org/" title="The Official YAML Web Site">The Official YAML Web Site</a>
によると YAML の仕様としては
YAML 1.2 (3rd Edition)
まで存在するようですが、
ansible は PyYaml を使っていて、
libyaml binding なので
対応している YAML のバージョンは
<a href="http://yaml.org/spec/1.1/">YAML 1.1 (2nd Edition)</a>
になります。</p>

<h2>コレクション</h2>

<p>参考: <a href="http://yaml.org/spec/1.1/#id857181" title="2.1. Collections">2.1. Collections</a></p>

<h3>配列</h3>

<p><code>-</code> で列挙すると配列になります。
YAML は空白に敏感なので、
<code>-foo</code> のように書くとエラーになります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">foo</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">bar</span>
</span></code></pre></td></tr></table></div></figure>


<h3>マッピング</h3>

<p>プログラミング言語によってはハッシュとか連想配列とか言われているデータ構造です。
キーと値を <code>:</code> (コロンとスペース) で区切ります。</p>

<p>読みやすくするために <code>:</code> の前後の空白を増やしても良いようです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">foo</span><span class="p-Indicator">:</span>  <span class="l-Scalar-Plain">bar</span>
</span><span class='line'><span class="l-Scalar-Plain">hoge</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">fuga</span>
</span><span class='line'><span class="l-Scalar-Plain">bar</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">baz</span>
</span></code></pre></td></tr></table></div></figure>


<h3>マッピングと配列</h3>

<p>マッピングの値に配列を入れるとき</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">foo</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">bar</span>
</span></code></pre></td></tr></table></div></figure>


<p>のようにインデントするのが普通のようですが、</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">foo</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">bar</span>
</span></code></pre></td></tr></table></div></figure>


<p>のようにインデントせずに配列を書いても大丈夫です。</p>

<p>インデントを浅くできるので、個人的にはこの書き方を多用しています。</p>

<h3>フロースタイル</h3>

<p>フロースタイルというコンパクトな書き方も出来ます。
ansible の設定ファイルでは見覚えがないのですが、
知っておくと見た時に悩まなくて済むと思います。</p>

<p><a href="http://yaml.org/spec/1.1/#id857181" title="2.1. Collections">2.1. Collections</a>
の <code>Example 2.5. Sequence of Sequences</code> や <code>Example 2.6. Mapping of Mappings</code> を参考にしてみてください。</p>

<h2>構造</h2>

<p>参考: <a href="http://yaml.org/spec/1.1/#id857577" title="2.2. Structures">2.2. Structures</a></p>

<h3>ファイル冒頭の <code>---</code></h3>

<p>YAML ファイルの頭に <code>---</code> が入っていることがありますが、
これは複数 YAML ドキュメントを YAML ストリームとしてまとめるときに
YAML ドキュメントの開始部分を示すのに使うようです。</p>

<p>ansible などの用途では YAML ストリームは使わないので、
あってもなくても良いと思います。</p>

<p>迷うなら付けておけば YAML ファイルということがちょっとわかりやすくなると思います。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">%</span> cat example.yml
</span><span class='line'><span class="go">---</span>
</span><span class='line'><span class="go">foo: bar</span>
</span><span class='line'><span class="go">---</span>
</span><span class='line'><span class="go">hoge: fuga</span>
</span><span class='line'><span class="gp">%</span> ruby -r yaml -r pp -e <span class="s1">&#39;pp YAML.load(ARGF)&#39;</span> example.yml
</span><span class='line'><span class="go">{&quot;foo&quot;=&gt;&quot;bar&quot;}</span>
</span><span class='line'><span class="gp">%</span> ruby -r yaml -r pp -e <span class="s1">&#39;pp YAML.load_stream(ARGF)&#39;</span> example.yml
</span><span class='line'><span class="go">[{&quot;foo&quot;=&gt;&quot;bar&quot;}, {&quot;hoge&quot;=&gt;&quot;fuga&quot;}]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>コメント</h3>

<p><code>#</code> から行末までがコメントです。
行頭以外からでもコメントになります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">foo</span><span class="p-Indicator">:</span> <span class="c1"># ここはコメント</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">bar</span>
</span><span class='line'><span class="l-Scalar-Plain">hoge</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="c1"># ここもコメント</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">fuga</span>
</span></code></pre></td></tr></table></div></figure>


<h2>スカラー値</h2>

<p>参考: <a href="http://yaml.org/spec/1.1/#id858081" title="2.3. Scalars">2.3. Scalars</a></p>

<h3>リテラル形式と折り返し形式</h3>

<p><code>|</code> を使うと literal style で改行をそのまま使った文字列を指定できます。
ansible の設定では shell と組み合わせに便利です。</p>

<p><a href="https://github.com/znz/ansible-role-rbenv/blob/7fceb7b4f5155ba385d88cdcaf436ecd84238aca/tasks/rbenv.yml">https://github.com/znz/ansible-role-rbenv/blob/7fceb7b4f5155ba385d88cdcaf436ecd84238aca/tasks/rbenv.yml</a>
では以下のように <code>creates=</code> によるガード条件を最初の行に書いて、
次の行からシェルスクリプトの内容を書いています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rbenv install </span>
</span><span class='line'>  <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>   <span class="no">creates=/versions/</span>
</span><span class='line'>   <span class="no">set -e</span>
</span><span class='line'>   <span class="no">. /etc/profile.d/rbenv.sh</span>
</span><span class='line'>   <span class="no">export CONFIGURE_OPTS=&quot;--disable-install-doc&quot;</span>
</span><span class='line'>   <span class="no">rbenv install </span>
</span><span class='line'>   <span class="no">rbenv global </span>
</span></code></pre></td></tr></table></div></figure>


<p><code>&gt;</code> を使うと folded style になります。
literal style と違って改行も普通の空白に置き換えられるので、
ansible の設定ファイルでは使ったことがありません。</p>

<p>上の例からわかるように YAML としては <code>creates=</code> も文字列の一部で、
その文字列の一部をガード条件として解釈しているのは ansible の方になります。</p>

<h2>真偽値</h2>

<p>ansible の playbook ファイルで
<code>sudo: yes</code> だったり
<code>sudo: True</code> だったり
いくつかの書き方がありますが、
すべて YAML の解釈の時点で真偽値になっています。</p>

<p>以下の例では大文字小文字の差が多いので、フロースタイルでまとめています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">%</span> cat example.yml
</span><span class='line'><span class="go">---</span>
</span><span class='line'><span class="go">- [true, True, TRUE]</span>
</span><span class='line'><span class="go">- [false, False, FALSE]</span>
</span><span class='line'><span class="go">- [yes, Yes, YES]</span>
</span><span class='line'><span class="go">- [no, No, NO]</span>
</span><span class='line'><span class="go">- [on, On, ON]</span>
</span><span class='line'><span class="go">- [off, Off, OFF]</span>
</span><span class='line'><span class="gp">%</span> ruby -r yaml -r pp -e <span class="s1">&#39;pp YAML.load(ARGF)&#39;</span> example.yml
</span><span class='line'><span class="go">[[[true, true, true],</span>
</span><span class='line'><span class="go">  [false, false, false],</span>
</span><span class='line'><span class="go">  [true, true, true],</span>
</span><span class='line'><span class="go">  [false, false, false],</span>
</span><span class='line'><span class="go">  [true, true, true],</span>
</span><span class='line'><span class="go">  [false, false, false]]]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>文字列として解釈させる</h2>

<p>以上のように元に文字列以外として解釈される可能性があると文字列として指定したい時に困るので、
そういうときは <code>""</code> などでくくっておくか、
<code>!!str</code> で明示的に文字列型ということを指定します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">%</span> cat /tmp/example.yml
</span><span class='line'><span class="go">---</span>
</span><span class='line'><span class="go">- &quot;true&quot;</span>
</span><span class='line'><span class="go">- &#39;false&#39;</span>
</span><span class='line'><span class="go">- !!str yes</span>
</span><span class='line'><span class="gp">%</span> ruby -r yaml -r pp -e <span class="s1">&#39;pp YAML.load(ARGF)&#39;</span> /tmp/example.yml
</span><span class='line'><span class="go">[&quot;true&quot;, &quot;false&quot;, &quot;yes&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>まとめ</h2>

<p>ansible の設定ファイルを書く時に、自分が困ったり悩んだことを中心にまとめてみました。
同じようなことで悩んだり、どうすればいいのか困った時に参考にしてみてください。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[シェルで glob 結果を事前に確認する方法]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-21-confirm-glob.html"/>
    <updated>2014-06-21T13:16:56+09:00</updated>
    <id>http://blog.n-z.jp/blog/confirm-glob</id>
    <content type="html"><![CDATA[<p><code>rm *~</code> のつもりで <code>rm * ~</code> (半角スペースが混ざっている) のように実行してしまうような間違いをすると危険です。</p>

<p>その対策として <code>tcsh</code> には <code>rmstar</code> という設定があったり
<code>zsh</code> には <code>RM_STAR_SILENT</code> や <code>RM_STAR_WAIT</code> という設定があるのですが、
ちゃんと展開結果を確認してからコマンドを実行する方が安全です。</p>

<p>また <code>rm</code> 以外でも展開結果を事前に確認できると便利なことが多いです。</p>

<!--more-->


<h2>展開結果の確認方法</h2>

<p><code>bash</code> や <code>zsh</code> の一般的なキー割り当てだと <code>C-x g</code> (Control を押しながら x を押して Control を離して g) で展開結果を確認できます。</p>

<p>Tab キーだとコマンドライン中に展開されてしまいますが、
<code>C-x g</code> だと確認だけ出来ます。</p>

<h3>bash の場合</h3>

<p>たとえば <code>bash</code> なら以下のように展開結果が出て、
プロンプトの行が出てきます。</p>

<figure class='code'><figcaption><span>bash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> <span class="nb">echo</span> /etc/host*&lt;C-x&gt;g
</span><span class='line'><span class="go">host.conf    hostname     hosts        hosts.allow  hosts.deny</span>
</span><span class='line'><span class="gp">$</span> <span class="nb">echo</span> /etc/host*
</span></code></pre></td></tr></table></div></figure>


<h3>zsh の場合</h3>

<p><code>zsh</code> ならプロンプトの行の下に展開結果が出てきます。</p>

<figure class='code'><figcaption><span>zsh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">%</span> <span class="nb">echo</span> /etc/host*
</span><span class='line'><span class="go">/etc/host.conf    /etc/hostname     /etc/hosts        /etc/hosts.allow  /etc/hosts.deny</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Tab キーの動作</h2>

<p>比較のため Tab キーでの動作例も載せておきます。</p>

<h3>bash の場合</h3>

<p>実際には同じ行でしたが、最初の展開結果に置き換わりました。</p>

<figure class='code'><figcaption><span>bash</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">$</span> <span class="nb">echo</span> /etc/host*&lt;tab&gt;
</span><span class='line'><span class="gp">$</span> <span class="nb">echo</span> /etc/host.conf
</span></code></pre></td></tr></table></div></figure>


<h3>zsh の場合</h3>

<p>こちらも実際には同じ行ですが、すべての展開結果に置き換わりました。</p>

<figure class='code'><figcaption><span>zsh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">%</span> <span class="nb">echo</span> /etc/host*&lt;tab&gt;
</span><span class='line'><span class="gp">%</span> <span class="nb">echo</span> /etc/host.conf /etc/hostname /etc/hosts /etc/hosts.allow /etc/hosts.deny
</span></code></pre></td></tr></table></div></figure>


<p>glob で指定しにくい一部のファイルだけ除外するなど、展開された方が便利な時は
Tab キーで展開してからコマンドラインを編集して実行することもあります。</p>

<h2>まとめ</h2>

<p>一般的な bash 環境ならどこでも使えて、
複雑な glob の展開結果の確認にも便利なので、
<code>C-x g</code> は非常にオススメです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第 12 回 RubyMotion もくもく会 in Osaka に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-20-rubymotion-mokumoku-osaka.html"/>
    <updated>2014-06-20T19:27:13+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-mokumoku-osaka</id>
    <content type="html"><![CDATA[<p>第 1 回から第 11 回にも参加した RubyMotion もくもく会 in Osaka の
<a href="http://rubymotionjp.connpass.com/event/6666/">第 12 回 RubyMotion もくもく会 in Osaka</a>
に参加してきました。</p>

<p>次回の
<a href="http://rubymotionjp.connpass.com/event/7079/">第 13 回 RubyMotion もくもく会 in Osaka</a>
は 07/16(水) になりました。</p>

<!--more-->


<h2>メモ</h2>

<ul>
<li>一周年記念</li>
<li>RubyMotion は Android にも対応予定</li>
<li>RubyMotion のライセンスが expired して更新しても <code>rake</code> のときの <code>Your maintenance plan is expired. Run 'motion account' to renew it.</code> というメッセージはキャッシュの影響で 24 時間ぐらい待たないと消えないらしいという話</li>
<li>バージョンは 2.29 が最新</li>
<li>Swift が話題</li>
<li><a href="http://tools.msng.info/">割り勘電卓</a></li>
<li><a href="https://github.com/shin1x1/vagrantx">https://github.com/shin1x1/vagrantx</a> のソース公開</li>
<li><a href="https://github.com/MacFace/MacFace/tree/v2.0">MacFace v2</a> が Swift で作り直し中</li>
</ul>


<h2>やったこと</h2>

<p>Interface Builder と <code>gem 'ib'</code> で GUI を作り直そうとしていました。</p>

<p>GUI 作成は細かいサイズを気にしなくて良い Tcl/Tk の pack 方式や
Web での bootstrap のようなやり方の方が慣れていて、
GUI ツールで作成するのは GTK+2 の glade ぐらいしかまともに使ったことがなかったので、
使い方や良い感じに配置する方法で結構悩んでいました。
悩んでいた部分は最後の成果発表の時にいろいろ教えてもらったりしました。</p>

<p>コードとの組み合わせは、検索で見つけた</p>

<pre><code>@mainWindowController = MainWindow.alloc.initWithWindowNibName('MainWindow')
@mainWindowController.window.makeKeyAndOrderFront(self)
</code></pre>

<p>という方法で window は表示できたものの、
<code>@mainWindowController.window</code> が <code>nil</code> になっていて、
<code>makeKeyAndOrderFront</code> の呼び出しは失敗していました。</p>

<p>ひとまず現状は <a href="https://github.com/znz/urltrapper/tree/ib">ib ブランチ</a> に公開しています。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jus & USP友の会共催 シェルワンライナー勉強会@関西（第11回シェル芸勉強会） に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-14-jus-usp.html"/>
    <updated>2014-06-14T13:42:31+09:00</updated>
    <id>http://blog.n-z.jp/blog/jus-usp</id>
    <content type="html"><![CDATA[<p><a href="http://japanunixsociety.doorkeeper.jp/events/10184">jus &amp; USP友の会共催 シェルワンライナー勉強会@関西（第11回シェル芸勉強会）</a> に参加してきました。</p>

<p>USP の勉強会には初参加でしたが、楽しかったです。</p>

<p>今回の問題文は <a href="http://www.slideshare.net/ryuichiueda/20140614-35859423">20140614 【問題だけスライド】jus &amp; USP友の会共催 シェルワンライナー勉強会@関西（第11回シェル芸勉強会）</a> で公開されています。</p>

<!--more-->


<h2>準備</h2>

<p>持ち物のところで「open usp Tukubai の入ったUNIX/Linux環境のあるノートPC（Macでも可）」とあったので、
<a href="https://github.com/usp-engineers-community/Open-usp-Tukubai">https://github.com/usp-engineers-community/Open-usp-Tukubai</a> をインストールした Linux 環境を用意したのと、
<a href="https://uec.usp-lab.com/TUKUBAI/CGI/TUKUBAI.CGI?POMPA=TUKUBAI_ON_FREEBSD_DOWNLOAD">Tukubai on FreeBSDダウンロード</a>
から ova ファイルをダウンロードして VirtualBox にインポートして用意しておきました。</p>

<p>結局 open usp Tukubai は不要でしたが、
用意していた Linux 環境は動作確認に使いました。</p>

<h2>ソフトウェアツールとAWK・sedについて座学</h2>

<p>最初の「ソフトウェアツールとAWK・sedについて座学」の話からのメモです。</p>

<div style="float:right"><iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=znz-22&amp;o=9&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=4048660683" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe></div>


<ul>
<li><a href="http://www.amazon.co.jp/gp/product/4048660683?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=4048660683&amp;linkCode=shr&amp;tag=znz-22">フルスクラッチから1日でCMSを作る シェルスクリプト高速開発手法入門</a> という本が出ますという話</li>
<li>IEEE から出ている Netizens という本からの話

<ul>
<li>ed コマンド, grep コマンド</li>
<li>パイプとフィルタコマンド</li>
<li>sed, awk</li>
<li>現在の GNU coreutils に入っているようなコマンド群</li>
</ul>
</li>
<li>実際にコマンドを実行してみる話

<ul>
<li><code>echo です。ます。でした。 | sed 's/。/&amp;\n/g'</code>

<ul>
<li>OSX だと <code>echo です。ます。でした。 | sed 's/。/&amp;\本当に改行/g'</code> でOK (これは Linux でも OK)</li>
<li>bash や zsh なら <code>sed $'s/。/&amp;\\\n/g'</code> で本当の改行の代わりに <code>$'\n'</code> でも大丈夫</li>
</ul>
</li>
</ul>
</li>
<li><p>縦と横の話</p>

<ul>
<li><code>echo {1..10} | awk '{for(i=1;i&lt;=NF;i++){a+=$i};print a}'</code></li>
<li><code>echo {1..10} | tr ' ' '\n' | awk '{a+=$1}END{print a}'</code></li>
</ul>
</li>
<li><p>複雑な例 sm2 というのは tukubai のコマンドだが今回はなくても良い</p></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat input
</span><span class='line'>a 1
</span><span class='line'>b 3
</span><span class='line'>a 4
</span><span class='line'>b 2
</span><span class='line'>c 1
</span><span class='line'>$ cat input | awk '{x[$1]+=$2}END{for (k in x){print k,x[k]}}'
</span><span class='line'>a 5
</span><span class='line'>b 5
</span><span class='line'>c 1
</span><span class='line'>$ cat input | sort | sm2 1 1 2 2
</span><span class='line'>a 5
</span><span class='line'>b 5
</span><span class='line'>c 1</span></code></pre></td></tr></table></div></figure>


<h2>チーム分け</h2>

<p>結構適当でした。</p>

<h2>前半戦</h2>

<h3>1問目</h3>

<p><code>echo -12,135,123 135,123</code> を足すという問題。</p>

<ul>
<li>最初に試した方法 <code>echo -12,135,123 135,123 | tr -d ',' | tr ' ' '+' | bc</code></li>
<li>話の流れでいくと <code>echo -12,135,123 135,123 | sed 's/,//g' | awk '{print $1+$2}'</code></li>
<li>出力にも <code>,</code> を入れるなら <code>"%'d"</code> を使って <code>echo -12,135,123 135,123 | sed 's/,//g' | awk '{printf "%'"'"'d\n", $1+$2}'</code></li>
<li><code>,</code> を消すのも awk を使うなら <code>echo -12,135,123 135,123 | awk '{gsub(",","");printf "%'"'"'d\n", $1+$2}'</code></li>
</ul>


<h3>2問目</h3>

<p>以下のデータの順番を「名前 点数」に統一するという問題。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat score
</span><span class='line'>45 鎌田
</span><span class='line'>浜田 72
</span><span class='line'>今泉 84
</span><span class='line'>54 上田
</span><span class='line'>62 斉藤</span></code></pre></td></tr></table></div></figure>


<p>勘違いして点数の方を左にしてしまっていました。</p>

<ul>
<li><code>cat score | awk '$1~/[0-9]/{print $2,$1} $2~/[0-9]/{print $1,$2}'</code></li>
<li><code>cat score | sed 's/\([^0-9 ]*\) \([0-9]*\)/\2 \1/'</code></li>
</ul>


<p>twitter 上で出ていた解答に比べて全然ダメな感じでした。</p>

<h3>3問目</h3>

<p>m/s に変換する問題。 (1マイル=1609m)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat speed
</span><span class='line'>100km/h
</span><span class='line'>16mph</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>cat speed | sed 's,km/h,*1000/3600,;s,mph,*1609/3600,' | bc | sed 's,$,m/s,'</code></li>
<li><code>cat speed | awk '/km/{print $1*1000/3600,"m/s"}/mph/{print $1*1609/3600,"m/s"}'</code></li>
</ul>


<p><code>bc</code> だと整数になってしまうので、小数点以下の数値もほしければ <code>awk</code> を使って計算する方が良かったようです。
Google 電卓で検算できるのが便利でした。</p>

<h3>4問目</h3>

<p>さいとうさん、さわださん、ひろたさん、いとうさんの数を数えてください。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat name
</span><span class='line'>齋藤 斉藤 沢田 澤田 伊藤
</span><span class='line'>齋藤 齊藤 広田 廣田</span></code></pre></td></tr></table></div></figure>


<p>最初は総数を数えればいいのかと思って <code>egrep -o 'さいとう|さわだ|ひろた|いとう' | wc -l</code> というのを考えていたのですが、名前ごとにカウントだったようです。</p>

<p><a href="https://twitter.com/biwakonbu/status/477703196714868737">全くと言って良い程リダイレクトが無くて cat ばっかり</a>というツイートを受けて、頭に <code>&lt; input</code> を付ける方法に切り替えました。
<code>cat</code> を使っているのは入力を先頭に書きたいからのはず、ということも合わせて、
あまり使われているのを見かけませんが、頭に付けるようにしました。</p>

<p>kakasi をインストールするのは面倒そうだったので、
<code>sed</code> でがんばって
<code>&lt; name sed 's/[齋斉齊]藤/さいとう/g;s/[沢澤]田/さわだ/g;s/[広廣]田/ひろた/g;s/伊藤/いとう/g' | egrep -o 'さいとう|さわだ|ひろた|いとう' | sort | uniq -c | sort -n</code>
としました。</p>

<p>休憩時間中に Unicode の異体字データベースとかで同一視するためのデータがないか探してみたのですが、時間不足で見つけられませんでした。</p>

<h2>後半戦</h2>

<h3>csv</h3>

<p>csv の内容を全部足す問題。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat csv
</span><span class='line'>1,2,"123,456",-5,"-123,444"
</span><span class='line'>6,7,8,"12",9</span></code></pre></td></tr></table></div></figure>


<p>行ごととかいうこともなく、全部足せば良いという問題でした。</p>

<p><code>""</code> の処理はシェルに任せれば良いかと思ったら、
そういうことをするコマンドは <code>xargs</code> だったので、
<code>&lt;csv tr ',' ' ' | xargs -n1 | tr -d ' ' | awk '{a+=$1}END{print a}'</code>
という解答になりました。</p>

<p><a href="https://twitter.com/znz/status/477713093535866880">この解答</a>は<a href="https://twitter.com/ryuichiueda/status/477713692927066112">高い評価</a>をもらいました。</p>

<h3>matrix</h3>

<p>行列の転置。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat matrix
</span><span class='line'>a b c
</span><span class='line'>d e f
</span><span class='line'>g h i</span></code></pre></td></tr></table></div></figure>


<p>ファイルを複数回読むのはズルかと思って、
連想配列にためるようにして
<code>&lt; matrix awk '{for(i=1;i&lt;=NF;i++){m[i]=m[i]" "$i}}END{for(k in m){print m[k]}}'|sed 's/^ //'</code>
となりました。
端の処理がうまく出来なかったので、<code>sed</code> で後処理しました。
時間優先の時は、単独でうまく書けなくても、他の方法を組み合わせてなんとかする、と方法もありだと思います。</p>

<p>解答例では
<code>cat matrix | awk '{for(i=1;i&lt;=NF;i++){print NR,i,$i}}' | sort -k2,2 | awk '{print $3} | xargs -n 3</code>
ということで一度 <code>行番号 桁番号 内容</code> という形式に変換するのがポイントと言っていました。</p>

<h3>IPv6 その1</h3>

<p>IPv6 アドレスの省略された <code>0</code> を復元する問題。</p>

<p>とりあえず時間内に解けることを優先して、
<code>echo 2001:db8:20:3:1000:100:20:3 | xargs -d: -n1 | sed 's/^/0000/;s/.*\(....\)$/\1/' | xargs | tr ' ' : | sed -e 's/:0000$//'</code>
となりました。</p>

<p>後で確認したら <code>xargs -d:</code> は Mac OS X の <code>xargs</code> だと使えませんでした。
さらに <code>xargs -d: -n1</code> だと余計な改行が付くので、最後に <code>sed</code> で削除しているのですが、
<code>tr : ' ' | xargs -n1</code> にすればそもそも余計な改行が付かなかったようです。</p>

<p>それから、他の解答例をみると、前につめるのは <code>0000</code> じゃなくて <code>000</code> で十分でした。</p>

<h3>IPv6 その2</h3>

<p>時間内に解くために思いついた方法をどんどん試して
<code>&lt;ipv6 awk -F: '{n=8-NF;for(i=0;i&lt;=n;i++){sub("::",":0::")}sub("::",":")}1' | sed 's/:/:000/g;s/:[^:]*\([^:][^:][^:][^:]\)/:\1/g'</code>
となりました。</p>

<p>内容を書き換えると <code>NF</code> が壊れてしまうので <code>i&lt;=8-NF</code> だとうまくいきませんでした。
そこで一度 <code>n</code> に保存してから <code>for</code> ループで <code>0</code> をつめていきました。
つめる場所を保存するために <code>::</code> は残しておいて、後で <code>:</code> に置き換えています。</p>

<p><code>1</code> は <a href="http://golf.shinh.org/">Anarchy Golf</a> 関連で知っていた &lsquo;{print}&rsquo; の短縮のようなものです。</p>

<p>その1の時の方法は途中で複数行に分割していて、複数行の IPv6 アドレスを同時に扱うのには使えなかったので、
<code>sed 's/:/:000/g;s/:[^:]*\([^:][^:][^:][^:]\)/:\1/g'</code>
にかわりました。
後ろ4文字を残すというのは、素直に <code>[^:]</code> を列挙しても twitter に投稿できる文字数に収まりました。</p>

<p>今回の問題だけなら良いのですが、先頭が <code>2001</code> で既に4文字になっているのを利用して、処理を省略しているので、汎用的にするなら、そこも処理する必要があります。</p>

<p>ruby なら <code>ruby -r ipaddr -nle 'puts IPAddr.new($_).to_string' ipv6</code> で出来ました。</p>

<h2>感想</h2>

<p>twitter のハッシュタグ (<code>#シェル芸</code>) での他の人の解答を参考にしたり、自分の解答を紹介したりできたり、頭リダイレクトが流行ったりして面白かったです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[fluentd に drb で接続してみた]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-13-fluentd-drb.html"/>
    <updated>2014-06-13T22:41:08+09:00</updated>
    <id>http://blog.n-z.jp/blog/fluentd-drb</id>
    <content type="html"><![CDATA[<p>druby の口が公開されていたら、そのユーザーの権限で何でも実行できるはず、
ということで、ちょっと試してみました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li><code>ruby</code> 2.1.2</li>
<li><code>fluentd</code> 0.10.49</li>
</ul>


<h2>環境の準備</h2>

<p>vagrant 上で rbenv と ruby-build を使ってインストールした ruby 2.1.2 で</p>

<ul>
<li><code>gem install fluentd</code></li>
<li><code>fluentd --setup /vagrant/fluent</code></li>
<li><code>fluentd -c /vagrant/fluent/fluent.conf &amp;</code></li>
</ul>


<p>と起動して準備しておきました。</p>

<h2>実行例</h2>

<p><code>irb</code> を起動しているユーザーと同じユーザーで <code>fluentd</code> も起動しているので、
特に面白いことはできそうになかったのですが、
<code>/proc/$$/cmdline</code> を確認すると <code>irb</code> 側ではなく、
ちゃんと <code>fluentd</code> 側で任意のコマンドが実行できていることがわかります。</p>

<pre><code>vagrant@fluentd-vm:~$ rbenv exec irb -r irb/completion --simple-prompt
&gt;&gt; require 'drb'
=&gt; true
&gt;&gt; d = DRbObject.new_with_uri('druby://127.0.0.1:24230'); nil
=&gt; nil
&gt;&gt; d.method_missing(:send, :eval, "`id`")
=&gt; "uid=1000(vagrant) gid=1000(vagrant) groups=1000(vagrant)\n"
&gt;&gt; d.method_missing(:send, :eval, '`cat /proc/$PPID/cmdline`')
=&gt; "/opt/rbenv/versions/2.1.2/bin/ruby\x00/opt/rbenv/versions/2.1.2/bin/fluentd\x00-c\x00/vagrant/fluent/fluent.conf\x00"
</code></pre>

<h2>雑感</h2>

<p><code>root</code> 権限で起動しているなら <code>debug_agent</code> は有効にしない方が良さそうだし、
ローカルユーザーが <code>fluentd</code> の実行ユーザーの権限を使えるとまずい場合も有効にしない方が良さそうだと思いました。</p>

<p>また、知っている人には当たり前のことですが、
<code>drb</code> は外部に安全に公開できるものではないので、
使う場合も <code>localhost</code> だけ待ち受けるように制限すべきです。</p>

<p>td-agent は初期設定でそうなっているのですが、
<code>fluentd --setup</code> はそうなっていないので、
適切に設定を変更するなり firewall で塞ぐなりしておく必要がありそうです。</p>

<h2>td-agent 1.1.19-1 での初期設定</h2>

<p><code>127.0.0.1</code> だけで待ち受けるようになっていました。</p>

<pre><code>## live debugging agent
&lt;source&gt;
  type debug_agent
  bind 127.0.0.1
  port 24230
&lt;/source&gt;
</code></pre>

<h2><code>fluentd --setup</code> で生成される設定</h2>

<p>外からも受けつけるようになっていました。</p>

<pre><code># Listen DRb for debug
&lt;source&gt;
  type debug_agent
  port 24230
&lt;/source&gt;
</code></pre>

<h2>参考</h2>

<ul>
<li><a href="http://docs.ruby-lang.org/ja/2.1.0/library/drb.html">るりま の DRb</a> のセキュリティ</li>
<li><a href="http://docs.ruby-lang.org/en/2.1.0/DRb.html#module-DRb-label-Security">RDoc の DRb の Security の説明</a> (英語)</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ci_reporter から rspec_junit_formatter に移行した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-13-ci-reporter-to-rspec-junit-formatter.html"/>
    <updated>2014-06-13T22:33:12+09:00</updated>
    <id>http://blog.n-z.jp/blog/ci-reporter-to-rspec-junit-formatter</id>
    <content type="html"><![CDATA[<p>rspec 2 から rpsec 3 への移行で <code>ci_reporter</code> がうまく動かなくなって困っていたら、
<code>rspec_junit_formatter</code> というのを<a href="https://twitter.com/joker1007/status/477372843601055744">教えてもらった</a>ので、
移行してみました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li><code>ruby</code> 2.1.2</li>
<li><code>rails</code> 3.2.18</li>
<li><code>rspec-rails</code> 3.0.1</li>
<li><code>rspec_junit_formatter</code> 0.2.0</li>
</ul>


<h2>Gemfile の変更</h2>

<p><code>group :test</code> の <code>gem 'ci_reporter', require: false</code> を <code>gem 'rspec_junit_formatter'</code> に変更しました。</p>

<h2>jenkins で実行しているシェルスクリプトの変更</h2>

<p><code>bundle exec rake -f $(bundle show ci_reporter)/stub.rake ci:setup:rspec default SPEC_OPTS=--no-drb COVERAGE=on</code>
のように実行していたのを</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rm -rf spec/reports
</span><span class='line'>cat &gt;.rspec &lt;&lt;EOF
</span><span class='line'>--format RspecJunitFormatter
</span><span class='line'>--out spec/reports/rspec.xml
</span><span class='line'>EOF
</span><span class='line'>bundle exec rake COVERAGE=on</span></code></pre></td></tr></table></div></figure>


<p>に変更しました。
<code>spec/reports</code> は自動で作成してくれるようで、事前に作成しておく必要はないようです。
<code>ci_reporter</code> はタスクの最初の方で <code>spec/reports</code> を削除していたので、同様に削除するようにしました。</p>

<p><code>COVERAGE=on</code> は <code>simplecov</code>, <code>simplecov-rcov</code> を有効にするかどうかのフラグとして使っているので今回の移行とは無関係です。</p>

<p><a href="https://github.com/sj26/rspec_junit_formatter">RSpec JUnit Formatter の README</a> に書いてある
<code>rspec --format RspecJunitFormatter --out rspec.xml</code>
という実行方法だとテスト用データベースの初期化関連で問題がおきたので、
<code>rspec</code> コマンド直接ではなく <code>rake</code> コマンドのデフォルトタスクで実行するために、
<code>.rspec</code> ファイルを書き換えるようにしました。
<code>SPEC_OPTS</code> で指定する方法でも良かったかもしれません。</p>

<h2>Jenkins の設定</h2>

<p><code>ci_reporter</code> の設定のときに
<code>ビルド後の処理</code> で <code>JUnitテスト結果の集計</code> を追加していて、
<code>テスト結果XML</code> は <code>spec/reports/**/*.xml</code> という設定にしていて、
<code>RspecJunitFormatter</code> の出力先の方をそちらにあわせたので、
Jenkins 側の設定は変更していません。</p>

<h2>テスト結果</h2>

<p>Jenkins のテスト結果の表示では <code>spec.controllers</code> や <code>spec.models</code> などがパッケージになっていました。</p>

<p><code>spec/support/*.rb</code> で <code>shared_examples</code> を定義していたら、
<code>spec.support</code> がパッケージになってしまっているのが気になりましたが、
<code>ci_reporter</code> のときはほぼすべてが <code>(root)</code> というパッケージになっていたのに比べると
便利になったように思います。</p>

<h2><code>RSpec::Core::DeprecationError</code></h2>

<p><code>RSpec.configure do |config|</code> で <code>config.raise_errors_for_deprecations!</code> を実行していると</p>

<pre><code>.../gems/rspec-core-3.0.1/lib/rspec/core/formatters/deprecation_formatter.rb:186:in `puts': Treating `metadata[:execution_result]` as a hash is deprecated. Use the attributes methods to access the data instead. Called from .../rspec_junit_formatter-0.2.0/lib/rspec_junit_formatter/rspec3.rb:43:in `result_of'. (RSpec::Core::DeprecationError)`
</code></pre>

<p>というエラーになったので、
<code>config.raise_errors_for_deprecations!</code>
を外しました。</p>

<p><a href="https://github.com/sj26/rspec_junit_formatter/commit/96f0115f7dabbea623f04b60dc23519683f39cfa">github の master では直っている</a>ので、次のバージョンがリリースされたら解決しそうです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Debian squeeze (6.0) LTS の使い方]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-06-squeeze-lts.html"/>
    <updated>2014-06-06T14:07:35+09:00</updated>
    <id>http://blog.n-z.jp/blog/squeeze-lts</id>
    <content type="html"><![CDATA[<p>OpenSSL の脆弱性
(<a href="http://ccsinjection.lepidum.co.jp/ja.html">CCS Injection</a>,<a href="https://security-tracker.debian.org/tracker/CVE-2014-0224">CVE-2014-0224</a>)
の修正が
<a href="https://lists.debian.org/debian-lts-announce/2014/06/msg00002.html">squeeze の LTS に入ったというアナウンス</a>
があったのに、
今まで通り使っている squeeze には修正が入らないと思って調べてみたところ、
<a href="https://wiki.debian.org/LTS/Using#Add_squeeze-lts_to_your_sources.list">apt-line の追加</a>
が必要でした。</p>

<!--more-->


<h2>追加する apt-line</h2>

<p>既存の <code>/etc/apt/sources.list</code> に</p>

<pre><code>deb http://ftp.jp.debian.org/debian squeeze main non-free contrib
deb-src http://ftp.jp.debian.org/debian squeeze main non-free contrib

deb http://security.debian.org/ squeeze/updates main contrib non-free
deb-src http://security.debian.org/ squeeze/updates main contrib non-free

# squeeze-updates, previously known as 'volatile'
deb http://ftp.jp.debian.org/debian squeeze-updates main contrib non-free
deb-src http://ftp.jp.debian.org/debian squeeze-updates main contrib non-free
</code></pre>

<p>という apt-line を設定したとすると、</p>

<pre><code>deb http://ftp.jp.debian.org/debian squeeze-lts main non-free contrib
deb-src http://ftp.jp.debian.org/debian squeeze-lts main non-free contrib
</code></pre>

<p>を <strong>追加</strong> します。</p>

<p>ネタ元の Debian Wiki に書いてあるように適切に使うには squeeze と squeeze security の apt-line も残した上で squeeze lts の apt-line を <strong>追加</strong> する必要があります。</p>

<h2>apt pinning を使っている時の注意点</h2>

<p><code>/etc/apt/apt.conf</code> で</p>

<pre><code>APT::Default-Release "squeeze";
</code></pre>

<p>のように設定している場合はコメントアウトするか</p>

<pre><code>APT::Default-Release "squeeze-lts";
</code></pre>

<p>に書き換える必要があります。</p>

<h2>更新の反映</h2>

<p>いつも通り <code>apt-get update</code> と <code>apt-get upgrade</code> で更新できます。</p>

<h2>サポート対象外のパッケージを調べる</h2>

<p><code>squeeze-lts</code> の apt-line を追加すると <code>debian-security-support</code> というパッケージがインストールできるようになります。</p>

<p><code>debian-security-support</code> パッケージをインストール中にサポート対象外のパッケージについての情報が表示されます。
インストール後は <code>check-support-status</code> で同じ内容が表示できます。</p>

<p>Ubuntu には <code>ubuntu-support-status</code> というコマンドがあるので、似たようなものが Debian にもできたということでしょうか。
<code>debian-security-support</code> パッケージは今のところ <code>sid</code> と <code>squeeze-lts</code> にだけあるようです。</p>

<h2>aptitude 検索パターンで LTS に収録されているパッケージ一覧</h2>

<p><code>aptitude search '~A squeeze-lts'</code> で <code>squeeze-lts</code> に収録されているパッケージ一覧が調べられます。</p>

<p>今のところ、</p>

<ul>
<li><code>chkrootkit</code></li>
<li><code>debian-security-support</code></li>
<li><code>gnutls</code> 関係</li>
<li><code>hello</code></li>
<li><code>openssl</code> 関係</li>
</ul>


<p>がありました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Vagrant の Multi VM 間で IPsec を試した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-04-vagrant-multivm-ipsec-demo.html"/>
    <updated>2014-06-04T22:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/vagrant-multivm-ipsec-demo</id>
    <content type="html"><![CDATA[<p>正常に IPsec の暗号化通信ができているときの racoon のログなどを確認したかったので、
Vagrant と ansible で
IPsec で通信できる Multi VM 環境を作ってみました。</p>

<p>playbook は
<a href="https://github.com/znz/ansible-playbook-ipsec-demo">https://github.com/znz/ansible-playbook-ipsec-demo</a>
で公開しています。</p>

<!--more-->


<h2>動作確認バージョン</h2>

<ul>
<li>ホスト OS : Mac OS X 10.9.3</li>
<li>VirtualBox 4.3.12</li>
<li>Vagrant 1.6.3</li>
<li>ansible 1.6.2</li>
<li>ゲスト OS : Ubuntu 14.04 &times; 2</li>
</ul>


<p>Ubuntu は <a href="https://cloud-images.ubuntu.com/vagrant/trusty/current/">https://cloud-images.ubuntu.com/vagrant/trusty/current/</a> のイメージを使ったので、
daily build の状態によっては動作が変わっているかもしれません。</p>

<h2>ホストオンリーネットワーク</h2>

<p>使った後は</p>

<ul>
<li>vboxnet1 (192.168.50.1/24)</li>
<li>vboxnet2 (192.168.11.1/24)</li>
<li>vboxnet3 (192.168.12.1/24)</li>
</ul>


<p>が勝手に増えているので、不要なら設定で消しておくと良いと思います。</p>

<p>ネットワークとしては以下のように 192.168.50.0/24 の部分で IPsec 接続をして、
192.168.11.11 と 192.168.12.12 をつなぐ、という感じにしています。
デフォルトの eth0 は外部への接続用としてそのままにしています。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>192.168.11.11 (vm1:eth2)
</span><span class='line'>       |
</span><span class='line'>192.168.50.11 (vm1:eth1)
</span><span class='line'>       |
</span><span class='line'>192.168.50.12 (vm2:eth1)
</span><span class='line'>       |
</span><span class='line'>192.168.12.12 (vm2:eth2)</span></code></pre></td></tr></table></div></figure>


<h2>準備</h2>

<p>Usage に書いてあるように準備をしておきます。
先日作った <code>ja_jp</code> role は git submodule にしているので、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% git submodule init
</span><span class='line'>% git submodule update</span></code></pre></td></tr></table></div></figure>


<p>で取得する必要があります。</p>

<h2>試し方</h2>

<p><code>vagrant up</code>
すると
<code>/etc/ipsec-tools.conf</code>
と
<code>/etc/racoon/racoon.conf</code>
に設定が入っている状態になっているので、
始点アドレスを指定して
<code>ipsec-tools.conf</code>
に設定した経路を通るようにパケットを送ると
IPsec VPN がつながります。</p>

<p><code>ping</code> コマンドのように直接始点アドレスを指定するオプションがない場合は
<code>ping -I eth2 192.168.12.12</code> のように network interface で指定すれば
良いようです。</p>

<h2>動作確認</h2>

<p>以下のコマンドの出力が接続前後で変わることが確認できます。</p>

<ul>
<li><code>racoonctl -l show-sa isakmp</code></li>
<li><code>racoonctl -l show-sa ipsec</code></li>
<li><code>setkey -D</code></li>
</ul>


<p>racoon のログが <code>/var/log/syslog</code> に大量に出ているのを確認できます。
(<code>racoon.conf</code> で <code>log debug</code> にしているため)</p>

<h2>tshark でパケットの確認</h2>

<p><code>tshark</code> パッケージをインストールした後、
<code>sudo dpkg-reconfigure wireshark-common</code>
で一般ユーザーでも実行を許可するようにして、
実行を許可するユーザーを <code>wireshark</code> に追加します。</p>

<p>グループの追加を反映するためにログインし直すと、
<code>tshark -i eth1 -V 'port 500'</code>
などでパケットの確認ができるようになります。</p>

<p>暗号化されていて詳細はわかりませんが、
UDP の 500 番ポートで Informational のパケットが流れていることが確認できました。</p>

<p>GUI の wireshark の方では
<a href="http://ask.wireshark.org/questions/12019/how-can-i-decrypt-ikev1-andor-esp-packets">http://ask.wireshark.org/questions/12019/how-can-i-decrypt-ikev1-andor-esp-packets</a>
の方法で暗号化の解除もできるようです。</p>

<p>syslog の方で racoon のログをみると、
DPD のパケットらしいということが確認できました。
syslog の方で <code>#012</code> となっている部分がありますが、
これは rsyslog で改行が変換されたたもので空白として無視すれば良くて、
例えば</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Jun  4 17:54:43 vm1 racoon: DEBUG: new cookie:#012831d33d46e20f8e6
</span><span class='line'>Jun  4 17:54:43 vm1 racoon: DEBUG: final encryption key computed:
</span><span class='line'>Jun  4 17:54:43 vm1 racoon: DEBUG: #012932d361f fc62ddc2 6164d513 d40d211f b7364166 232cf490</span></code></pre></td></tr></table></div></figure>


<p>というログなら cookie は <code>831d33d46e20f8e6</code> になります。</p>

<p>鍵は <code>932d361ffc62ddc26164d513d40d211fb7364166232cf490</code> になると思ったのですが、
これを
Edit &ndash;> Preferences &ndash;> Protocols &ndash;> ISAKMP &ndash;> IKEv1 Decryption Table:
に設定すれば良いはずなのですが、試したところ decrypt されなかったので、
あっているのかどうかはわかりませんでした。
cookie の方は他のログなどで確認できたので、あっているはずです。</p>
]]></content>
  </entry>
  
</feed>
