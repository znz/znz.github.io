<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ansible | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/ansible/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2014-06-06T23:42:08+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[ansible-galaxy を使ってみた]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-02-ansible-galaxy.html"/>
    <updated>2014-06-02T22:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/ansible-galaxy</id>
    <content type="html"><![CDATA[<p>ansible の複数の playbook で role を共有するのに
<a href="https://galaxy.ansible.com/">Ansible Galaxy</a>
はどうだろうと思って登録してみました。</p>

<!--more-->


<h2>動作確認バージョン</h2>

<ul>
<li>ansible 1.6.2</li>
</ul>


<h2>アカウント登録</h2>

<p>後で github から role を import するということもあって、
github 連携でアカウントを登録しました。</p>

<p>アカウントは4文字以上必須ということで <code>znzj</code> にしました。
(<a href="https://index.docker.io/">docker index</a> とか
<a href="https://vagrantcloud.com/">Vagrant Cloud</a> とか
最近は4文字以上必須が多いのでしょうか?)</p>

<h2>role を github に公開</h2>

<p><code>ansible-galaxy init ansible-role-ja_jp</code> でひな形を作成して、
<code>provisioning/roles/ja_jp</code> というディレクトリの中身だったものを移行して
<a href="https://github.com/znz/ansible-role-ja_jp">https://github.com/znz/ansible-role-ja_jp</a> として公開しました。</p>

<p>apt のミラーサイトとして日本のミラーを使ったり、日本語 locale にしたり、タイムゾーンを JST にしたりする role です。</p>

<h2>Ansbile Galaxy に role を追加</h2>

<p>ログインした状態だと右上の方に出てくる <code>Add a Role</code> というリンクから登録します。</p>

<ul>
<li>Github Username/Account : znz</li>
<li>Github Repository : ansible-role-ja_jp</li>
<li>Alternate Name : ja_jp</li>
</ul>


<p>という内容で登録したところ、
<a href="https://galaxy.ansible.com/list#/roles/967">https://galaxy.ansible.com/list#/roles/967</a>
で見えるようになりました。</p>

<p>URL をみるとわかるように JavaScript オフだと個別の role は見えません。
ちょっと試した感じだと代用の URL も見つけられませんでした。</p>

<h2>動作確認</h2>

<p><code>ansible-galaxy install znzj.ja_jp</code> だと <code>/usr/local/etc/ansible/roles/znzj.ja_jp</code> にインストールされてしまった (Homebrew でインストールした ansible を使っている場合) ので、
<code>ansible-galaxy install --roles-path ./roles znzj.ja_jp</code>
でカレントディレクトリの中にインストールし直しました。</p>

<h2>感想</h2>

<p>これだけだと git submodule に比べて利点が見えてこないのですが、
依存関係やバージョン指定をちゃんと使えれば便利そうに思いました。</p>

<p>自分が登録した role にバージョンを指定する方法がわからず、
今のところバージョンなしのままなので、どうにかしたいです。</p>

<h2>参考サイト</h2>

<ul>
<li><a href="http://qiita.com/kiri/items/f329a35543022d6e45d0">AnsibleWorks Galaxyにroleを登録してみる &ndash; Qiita</a>

<ul>
<li>スクリーンショットをみると AnsibleWorks Galaxy になっているところが今は Ansible Galaxy なので、いつの間にか名前が変わっているようです。</li>
</ul>
</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[octopress で ansible の記事を書く時のエスケープ]]></title>
    <link href="http://blog.n-z.jp/blog/2014-05-20-octopress-ansible.html"/>
    <updated>2014-05-20T23:25:18+09:00</updated>
    <id>http://blog.n-z.jp/blog/octopress-ansible</id>
    <content type="html"><![CDATA[<p>octopress で ansible の記事を書く時に連続する <code>{</code> のエスケープに困ったので、
対処方法を調べました。</p>

<!--more-->


<h2>コードブロックのエスケープ</h2>

<p><a href="http://stackoverflow.com/questions/15786144/how-to-escape-in-markdown-on-octopress">How to escape  in markdown on Octopress? &ndash; Stack Overflow</a>
にあるように</p>

<pre><code>```種類 ファイル名
コードブロック
```
</code></pre>

<p>の外側を
<code>{% raw %}</code> と <code>{% endraw %}</code>
でくくればうまくいきました。</p>

<h2>文中の  のエスケープ</h2>

<p>先ほどのリンクのアンカーやこの節の見出しのような文の途中は</p>

<p></p>

<pre><code>{{ "{{" }}
</code></pre>

<p></p>

<p>のように書けばエスケープできました。</p>

<p>幅なしスペース (<code>&amp;#x200B;</code>) のような幅のない文字を挟んでごまかすという手もあるかもしれません。</p>

<h2>文中の <code>{%</code> のエスケープ</h2>

<p><code>{% raw %}</code> と <code>{% endraw %}</code> 自体をエスケープするのに</p>

<p></p>

<pre><code>{{ "{%" }}
</code></pre>

<p></p>

<p>を使って</p>

<p></p>

<pre><code>`{{ "{%" }} raw %}` と `{{ "{%" }} endraw %}`
</code></pre>

<p></p>

<p>のように書きました。</p>

<p><code>%}</code> まで <code>""</code> の中に入れようとして</p>

<p></p>

<pre><code>`{{ "{% raw %}" }}`
</code></pre>

<p></p>

<p>と書くと</p>

<p></p>

<pre><code>Liquid Exception: Variable '{{ "{% raw %}' was not properly terminated with regexp: /\}\}/
</code></pre>

<p></p>

<p>というエラーになってうまくいきませんでした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ansible で sources.list を変更したときに update する]]></title>
    <link href="http://blog.n-z.jp/blog/2014-05-20-ansible-apt-update.html"/>
    <updated>2014-05-20T22:58:09+09:00</updated>
    <id>http://blog.n-z.jp/blog/ansible-apt-update</id>
    <content type="html"><![CDATA[<p>ansible で sources.list を変更したときには
<code>apt-get update</code> して欲しいのですが、
毎回 update するのは無駄なので、
<code>cache_valid_time</code> も使いたいと思ったので対処しました。</p>

<!--more-->


<h2>動作確認バージョン</h2>

<ul>
<li>クライアント側 ansible 1.6.1</li>
<li>サーバー側 Ubuntu 12.04</li>
</ul>


<h2>やり方</h2>

<p><code>register</code> で <code>template</code> モジュールの実行結果を受けて、
<code>changed</code> の場合は必ず update して、
<code>skipped</code> の場合は <code>cache_valid_time</code> で情報が古い場合だけ update するようにしました。</p>

<p></p>

<h2>```yaml tasks/apt.yaml</h2>

<ul>
<li>template: src=sources.list.{{ ansible_distribution }}.j2 dest=/etc/apt/sources.list owner=root group=root mode=0644
register: apt_sources_list</li>
<li>apt: update_cache=yes
when: apt_sources_list|changed</li>
<li>apt: update_cache=yes cache_valid_time=3600
when: apt_sources_list|skipped
```
</li>
</ul>


<h2>テンプレートの内容</h2>

<p>gathering facts で設定された <code>ansible_distribution_release</code> と
<code>vars</code> で別途設定した <code>apt_ubuntu_uri</code> と <code>apt_ubuntu_components</code> を
組み合わせて apt-line を作るようにしました。</p>

<p>Ubuntu をインストールした直後の sources.list では
components が別の行になっているものもあったのですが、
1 行にまとめました。</p>

<p>
```text templates/sources.list.Ubuntu.j2
deb {{ apt_ubuntu_uri }} {{ ansible_distribution_release }} {{ apt_ubuntu_components | join(&ldquo; &rdquo;) }}
deb-src {{ apt_ubuntu_uri }} {{ ansible_distribution_release }} {{ apt_ubuntu_components | join(&ldquo; &rdquo;) }}
deb {{ apt_ubuntu_uri }} {{ ansible_distribution_release }}-updates {{ apt_ubuntu_components | join(&ldquo; &rdquo;) }}
deb-src {{ apt_ubuntu_uri }} {{ ansible_distribution_release }}-updates {{ apt_ubuntu_components | join(&ldquo; &rdquo;) }}</p>

<h1>deb {{ apt_ubuntu_uri }} {{ ansible_distribution_release }}-backports {{ apt_ubuntu_components | join(&ldquo; &rdquo;) }}</h1>

<h1>deb-src {{ apt_ubuntu_uri }} {{ ansible_distribution_release }}-backports {{ apt_ubuntu_components | join(&ldquo; &rdquo;) }}</h1>

<p>deb <a href="http://security.ubuntu.com/ubuntu">http://security.ubuntu.com/ubuntu</a> {{ ansible_distribution_release }}-security {{ apt_ubuntu_components | join(&ldquo; &rdquo;) }}
deb-src <a href="http://security.ubuntu.com/ubuntu">http://security.ubuntu.com/ubuntu</a> {{ ansible_distribution_release }}-security {{ apt_ubuntu_components | join(&ldquo; &rdquo;) }}
```
</p>

<p><code>backports</code> は使っていなかったのでコメントアウトしていますが、
<code>deb-src</code> も使わないのならコメントアウトしておいても良さそうです。</p>

<h2><code>vars</code> の内容</h2>

<p>例として jaist ミラーを使うようにしました。</p>

<h2>```yaml vars/main.yml</h2>

<p>apt_ubuntu_uri: &ldquo;<a href="http://ftp.jaist.ac.jp/pub/Linux/ubuntu/">http://ftp.jaist.ac.jp/pub/Linux/ubuntu/</a>&rdquo;
apt_ubuntu_components:
&ndash; main
&ndash; restricted
&ndash; universe
&ndash; multiverse
```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ansible で ppa を追加する]]></title>
    <link href="http://blog.n-z.jp/blog/2014-05-20-ansible-add-ppa.html"/>
    <updated>2014-05-20T22:47:22+09:00</updated>
    <id>http://blog.n-z.jp/blog/ansible-add-ppa</id>
    <content type="html"><![CDATA[<p>サーバーとしてインストールした Ubuntu だと
<code>add-apt-repository</code> コマンドが入っている
<code>python-software-properties</code> パッケージが入っていなくて
<code>ppa</code> の追加に困ることがありますが、
ansible を使えばサーバー自体に余計なパッケージを入れなくても
<code>ppa</code> の apt 設定を追加できました。</p>

<!--more-->


<h2>動作確認バージョン</h2>

<ul>
<li>クライアント側 ansible 1.6.1</li>
<li>サーバー側 Ubuntu 12.04</li>
</ul>


<h2>ansible コマンド直接</h2>

<p><code>apt_repository</code> モジュールの引数の <code>repo</code> に <code>ppa</code> を指定するだけです。</p>

<p><code>console
ansible all -s -K -i ./inventory_hosts -m apt_repository -a "repo='ppa:chris-lea/node.js'"
</code></p>

<h2>playbook.yml に書く</h2>

<p><code>- apt_repository: repo='ppa:chris-lea/node.js'</code>
のように書くだけです。
普通にインストールすればサーバーでも入っていると思うのですが、
<code>python-apt</code> に依存しているので、
<code>- apt: pkg=python-apt</code>
も書いておくと良いかもしれません。</p>

<p><a href="https://github.com/znz/ansible-playbook-passenger/blob/master/provisioning/roles/passenger/tasks/nodejs-ppa.yml">nodejs-ppa.yml</a>
が実際の使用例です。</p>

<h2>```yaml nodejs-ppa.yml</h2>

<ul>
<li>apt: pkg=python-apt</li>
<li>apt_repository: repo=&lsquo;ppa:chris-lea/node.js&rsquo;
when: ansible_distribution_release == &ldquo;precise&rdquo;
```</li>
</ul>


<p>Debian の場合や ubuntu 14.04 の場合は除外しても良いかと思って、
ubuntu 12.04 の時だけ実行するために
<code>when: ansible_distribution_release == "precise"</code>
で実行する環境を制限しています。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ansibleで1ファイルのplaybookからroleに書き換える方法]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-07-ansible-split-playbook.html"/>
    <updated>2013-12-07T01:30:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/ansible-split-playbook</id>
    <content type="html"><![CDATA[<p><code>ansible</code> を使い始める時は1個の YAML ファイルから始めるのが手軽で良いのですが、
それを
<a href="http://www.ansibleworks.com/docs/playbooks_best_practices.html">Best Practices</a>
にあわせて <code>roles</code> にしようとしたら、
対応がよくわからなくて困ったことがあったので、
書き換え方をまとめてみました。</p>

<p>この投稿は
<a href="http://qiita.com/advent-calendar/2013/ansible">Ansible Advent Calendar 2013</a>
の7日目の記事です。</p>

<!--more-->


<p>全体的に動作確認せずに以前使ったファイルを参考にしているので、
間違っている部分があるかもしれないので、その時はコメントなどで
教えてください。</p>

<h2>1個の YAML ファイルの例</h2>

<p>仮にこんな感じの <code>playbook.yml</code> があって、
これを <code>roles</code> にしたいとします。</p>

<h2>```yaml playbook.yml</h2>

<ul>
<li>hosts: foo-servers
sudo: yes
vars:
  adminuser: vagrant
  admingroup: vagrant
  homedir: /home/vagrant
tasks:

<ul>
<li>apt: pkg=zsh</li>
<li>template: src=zshrc dest=/.zshrc owner= group= mode=0644
```</li>
</ul>
</li>
</ul>


<p>この例だとテンプレートファイルとして <code>zshrc</code> ファイルが同じディレクトリにあります。</p>

<h2>role 作成</h2>

<p>ここでは role の名前を <code>zsh</code> にしてみます。</p>

<p>元の <code>playbook.yml</code> と <code>zshrc</code> から</p>

<ul>
<li><code>roles/zsh/tasks/main.yml</code></li>
<li><code>roles/zsh/templates/zshrc.j2</code></li>
<li><code>roles/zsh/vars/main.yml</code></li>
</ul>


<p>というファイルを作ることになります。</p>

<h3>roles/zsh/tasks/main.yml</h3>

<p>処理のメイン部分です。
元の <code>playbook.yml</code> の <code>tasks</code> の値に並んでいた配列を書きます。</p>

<h2>```yaml roles/zsh/tasks/main.yml</h2>

<ul>
<li>apt: pkg=zsh</li>
<li>template: src=zshrc dest=/.zshrc owner= group= mode=0644
```</li>
</ul>


<h3>roles/zsh/templates/zshrc.j2</h3>

<p>元の <code>zshrc</code> にテンプレート言語がわかりやすいように拡張子を付けただけです。
例として <code>zshrc</code> にしてしまっただけなので、
本来は <code>vars</code> の変数を展開したいファイルを使うことになると思います。</p>

<h3>roles/zsh/vars/main.yml</h3>

<p>変数の定義部分です。
元の <code>playbook.yml</code> の <code>vars</code> の値に並んでいたハッシュを書きます。</p>

<h2>```yaml roles/zsh/vars/main.yml</h2>

<p>adminuser: vagrant
admingroup: vagrant
homedir: /home/vagrant
```</p>

<h3>その他</h3>

<p><code>roles/zsh/handleres/main.yml</code> のような他のディレクトリとか、
<code>main.yml</code> 以外の <code>*.yml</code> ファイルとかも使えますが、
一番最初の段階では知らなくても大丈夫だと思います。</p>

<h2>読み込み側 YAML</h2>

<p><code>vars</code> とか <code>tasks</code> を並べていた代わりに <code>roles</code> を使って読み込みます。
今回は <code>role: zsh</code> で読み込みましたが、他の例をみてみると <code>- zsh</code> だけでも良さそうです。</p>

<h2>```yaml site.yml</h2>

<ul>
<li>hosts: foo-servers
sudo: yes
roles:

<ul>
<li>role: zsh
```</li>
</ul>
</li>
</ul>


<h2>まとめ</h2>

<p>最初は 1ファイルの YAML と roles 用の複数の YAML ファイルの対応関係がよくわからなくて、
roles 用の YAML ファイルに余計な記述をしてここでは使えないと言われたりして悩んだので、
簡単に対応関係をまとめてみました。</p>

<p>まだあまり使っていなくて、間違っているところもあるかもしれないので、
何かあればコメントなどで指摘してもらえるとありがたいです。</p>
]]></content>
  </entry>
  
</feed>
