<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: emacs | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/emacs/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2013-11-02T23:37:54+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[MavericksでEmacs.appが起動時にホームディレクトリにならない]]></title>
    <link href="http://blog.n-z.jp/blog/2013-11-01-emacs-on-mavericks.html"/>
    <updated>2013-11-01T18:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/emacs-on-mavericks</id>
    <content type="html"><![CDATA[<p>Mac OS X を Mavericks にあげたら homebrew で入れた
Emacs.app を起動した時に <code>default-directory</code>
がホームディレクトリから <code>/</code> に変わってしまっていたので、
原因を調べてみました。</p>

<!--more-->


<h2>調べたきっかけ</h2>

<p>きっかけは
<a href="http://qiita.com/ksato9700/items/1ec373895b9693529f82">Mavericksにアップデートして遭遇した不具合　まとめ</a>
を見て自分の環境だけで起きている現象ではないと知ったからです。</p>

<h2>原因</h2>

<p>Emacs のソースの以下の部分で <code>-psn</code> で始まる引数の有無で
ホームディレクトリに移動するかどうかを判定しているのに、
Mavericks だと引数なしで起動されるようになったからのようです。</p>

<p>```c emacs-24.3/src/emacs.c
 #ifdef HAVE_NS
   ns_pool = ns_alloc_autorelease_pool ();
   if (!noninteractive)</p>

<pre><code> {
</code></pre>

<p> #ifdef NS_IMPL_COCOA</p>

<pre><code>   if (skip_args &lt; argc)
     {
  /* FIXME: Do the right thing if getenv returns NULL, or if
     chdir fails.  */
       if (!strncmp (argv[skip_args], "-psn", 4))
         {
           skip_args += 1;
           chdir (getenv ("HOME"));
         }
       else if (skip_args+1 &lt; argc &amp;&amp; !strncmp (argv[skip_args+1], "-psn", 4))
         {
           skip_args += 2;
           chdir (getenv ("HOME"));
         }
     }
</code></pre>

<p> #endif  /<em> COCOA </em>/</p>

<pre><code> }
</code></pre>

<p> #endif /<em> HAVE_NS </em>/
```</p>

<h2>状況</h2>

<p>ちなみに Mac OS X 10.8.5 では、たとえば
<code>/usr/local/Cellar/emacs/24.3/Emacs.app/Contents/MacOS/Emacs -psn_0_29637698</code>
のように起動されていました。</p>

<p>Qiita の記事では Dock から起動した時のことを書いていますが、
<code>open -a Emacs.app</code> のように起動しても同じでした。</p>

<p>RubyMotion で最小限のカレントディレクトリを表示するだけのアプリを作って試してみたところ、
起動時にカレントディレクトリが <code>/</code> になっているのは
Cocoa アプリでは普通の動作のようでした。</p>

<h2>対応状況</h2>

<p><a href="http://osdir.com/ml/general/2013-10/msg61593.html">ML での情報</a>
によると trunk には対応がチェックインされているということで、
調べてみると
revision 114730 <!-- http://bzr.savannah.gnu.org/lh/emacs/trunk/revision/114730 -->
と
revision 114882 <!-- http://bzr.savannah.gnu.org/lh/emacs/trunk/revision/114882 -->
のパッチをあわせて以下のように対応すれば良さそうに見えました。</p>

<p>```diff emacs.c.diff
&mdash;&ndash; src/emacs.c.orig    2013-02-06 13:33:36.000000000 +0900
+++ src/emacs.c 2013-11-02 22:38:45.000000000 +0900
@@ -1158,10 +1158,13 @@
   if (!noninteractive)</p>

<pre><code> {
</code></pre>

<p> #ifdef NS_IMPL_COCOA
+      /<em> Started from GUI? </em>/
+      /<em> FIXME: Do the right thing if getenv returns NULL, or if
+         chdir fails.  </em>/
+      if (! inhibit_window_system &amp;&amp; ! isatty (0))
+        chdir (getenv (&ldquo;HOME&rdquo;));</p>

<pre><code>   if (skip_args &lt; argc)
     {
</code></pre>

<ul>
<li>  /* FIXME: Do the right thing if getenv returns NULL, or if</li>
<li><pre><code> chdir fails.  */
   if (!strncmp (argv[skip_args], "-psn", 4))
     {
       skip_args += 1;
</code></pre>

<p>```</p></li>
</ul>


<p>というわけで homebrew の方に
<a href="https://github.com/mxcl/homebrew/pull/23897">fix default-directory on Cocoa and Mavericks</a>
として pull request を出してみました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第8回 関西Emacs勉強会に参加しました]]></title>
    <link href="http://blog.n-z.jp/blog/2013-10-26-kansai-emacs.html"/>
    <updated>2013-10-26T14:19:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/kansai-emacs</id>
    <content type="html"><![CDATA[<p><a href="http://atnd.org/events/44155">(kansai-emacs #x08) #関西Emacs : ATND</a>
というイベントに参加してきました。</p>

<!--more-->


<h2>ポジションペーパー</h2>

<p>以前作りかけで一部は
<a href="http://regional.rubykaigi.org/kansai05">関西Ruby会議05</a>
の時に使った rabbit での自己紹介のスライドに
Emacs 関係の情報を追加して作った PDF だったので、
1ページにできずに複数ページになってしまいました。</p>

<p>会場への移動中に作成したのですが、
作成前に既にアップロードされているものを確認したら
複数ページのものがあるので、
まあいいかと思ったのも理由でした。</p>

<h2>会場到着から開始まで</h2>

<p>到着時点では知っている人がいなくて、
どうすればいいのかよくわからなかったので、
入り口近くで座って twitter とか見ながら待っていました。
13時を少しすぎたところで準備ができたらしく案内があったので、
席に移動しました。</p>

<h2>発表</h2>

<p><code>package-install</code> だと
環境を作り直した時に magit とかがバージョンアップで挙動が変わって
困ることがあるのでどうするのが良いのかという相談とか、
<code>ac-mozc</code> の紹介とか、ちゃんとメモをとっていなかったのですが、
いろいろありました。</p>

<p><code>ac-mozc</code> の質疑応答では</p>

<ul>
<li>英単語に続けて日本語を入力する時はスペースを入れて入力して、確定するとスペースが消える、スペースが必要な時はその直後に undo すればいい</li>
<li>英単語を入力していてローマ字ともみなせて不要なのに ac-mozc の候補が出てきたときは ac のキャンセルと同じように C-g で消せばいい</li>
<li>コメントの中とか文字列の中とかで一部だけ変換したい時とかは変換用のコマンドを直接呼び出せばいい</li>
</ul>


<p>のような話があったと記憶しています。</p>

<h2>やっていたこと</h2>

<h3>package.el</h3>

<p><a href="http://emacs-jp.github.io/packages/package-management/package-el.html">package.el &ndash; Emacs JP</a>
を参考にして <code>package.el</code> を使う設定をしました。</p>

<h3>shell-pop</h3>

<p>上のメモには書いていませんが、発表にあった <code>shell-pop</code> を
<code>package.el</code> を使って入れてみました。
昔ちょっと試したことがあって、その設定が悪さをしていて、
最初は
<code>(void-function shell-pop-set-internal-mode)</code>
というエラーになってしまっていましたが、
古い設定を削除すれば直りました。</p>

<p><a href="http://www.emacswiki.org/emacs/ShellPop">EmacsWiki の Shell Pop</a>
には上の方に小さく書いてあるだけですが、
github の方が新しくて互換性がなくなっているのが理由でした。</p>

<h3>ansi-term</h3>

<p><code>shell-pop</code> の設定例にある <code>ansi-term</code> を使ってみると
最下行で文字を入力すると一瞬上にスクロールして戻るという現象が出て、
<code>ansi-term</code> 単体でもおきたので、
<code>ansi-term</code> の問題かと思ってクリーンな環境でも試してみると発生しませんでした。</p>

<p>scroll 関係の設定があやしいと思って、
<code>scroll-margin</code> を <code>2</code> にしていたのを <code>0</code> にしたらなおったのですが、
クリーンな環境で <code>scroll-margin</code> だけ変更しても現象が出なかったので、
結局何が再現条件なのかはわかりませんでした。
<code>scroll-step</code> を <code>1</code> にしているのも関係しているかと思ったのですが、
関係ありませんでした。</p>

<h3>elscreen</h3>

<p><code>auto-install</code> でインストールしていた <code>elscreen.el</code> を
<code>package.el</code> でインストールしたものに変更しました。</p>

<p><code>(elscreen-start)</code> が必要になっているというのを知らなかったので、
うまく動かなくてかなり悩んでいましたが、教えてもらって解決しました。</p>

<h3>anything.el から helm への変更</h3>

<p><code>anything.el</code> は一時期はいろいろ設定を頑張っていたのですが、
結局デフォルトの <code>anything</code> 以外はほとんど使っていなかったので、
<code>helm-mini</code> に置き換えるだけで問題なさそうな感じでした。</p>

<p><code>anything.el</code> だとメニューに登録されていたり
<code>(anything-execute-anything-command)</code> とか
<code>(anything-call-source)</code> のようなメタ機能があったりして、
存在を知らない機能でも探しやすいのですが、
<code>helm</code> にはそういうものがあるのかどうかわかりませんでした。</p>

<p>ちなみに <code>M-x</code> で <code>helm-</code> で始まる <code>interactive</code> な関数を探すのは
<code>helm</code> 関係のバッファでのキーバインドようの関数が混ざっているので
この用途には使えません。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[elscreen で Symbol's value as variable is void: last-command-char]]></title>
    <link href="http://blog.n-z.jp/blog/2013-09-24-elscreen-last-command-char.html"/>
    <updated>2013-09-24T13:50:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/elscreen-last-command-char</id>
    <content type="html"><![CDATA[<p>elscreen で
<code>Symbol's value as variable is void: last-command-char</code>
というエラーになったので、
<a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=705436">elscreen: From Emacs 24.3: Symbol&rsquo;s value as variable is void: last-command-char</a>
のパッチを参考にして解決しました。</p>

<!--more-->


<p><code>Symbol's value as variable is void: last-command-char</code>
で検索すると
<a href="http://oku.edu.mie-u.ac.jp/~okumura/texwiki/?YaTeX">Emacs 24.3 は last-input-char, last-command-char が削除されています</a>
という話が一番目に見つかって、
<code>last-command-char elscreen</code>
で検索すると
<a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=705436">elscreen: From Emacs 24.3: Symbol&rsquo;s value as variable is void: last-command-char</a>
が一番目に見つかって解決方法がわかりました。</p>

<p>パッチを見てみると、
<code>xemacs</code>
の時は
<code>(event-to-character last-command-event)</code>
で、それ以外は
<code>last-command-event</code>
となっていて、
手元では GNU Emacs だけ対応出来れば良いので、
<a href="https://github.com/znz/dot-emacs/commit/12599e870f9b1a5b4411ef875c3cb647ef3096dd">defadvice で last-command-event を last-command-char に設定</a>
することにしました。</p>

<p>```scheme
  (defadvice elscreen-jump (around elscreen-last-command-char-event activate)</p>

<pre><code>(let ((last-command-char last-command-event))
  ad-do-it))
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
</feed>
