<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: letsencrypt | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/letsencrypt/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2016-09-09T23:16:02+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Let's Encrypt Subscriber Agreementの比較]]></title>
    <link href="http://blog.n-z.jp/blog/2016-07-27-letsencrypt-new-subscriber-agreement.html"/>
    <updated>2016-07-27T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/letsencrypt-new-subscriber-agreement</id>
    <content type="html"><![CDATA[<p>7月9日(土) に <code>Let's Encrypt Subscriber Agreement Update</code> というメールがきていて、
<code>Let's Encrypt Subscriber Agreement</code> が8月1日に v1.0.1 から v1.1.1 に更新されるというので、
内容をテキストファイルに落として diff をとってみました。</p>

<!--more-->


<h2>Let&rsquo;s Encrypt からのメール</h2>

<p>Let&rsquo;s Encrypt からのメールは必要最低限しかこないのですが、
今のところ staging 環境で取得していた証明書の期限切れ通知メールと
今回の <code>Let's Encrypt Subscriber Agreement Update</code> のお知らせメールしか届いていません。</p>

<p>お知らせメールの内容は以下の通りでした。</p>

<pre><code class="text">Let's Encrypt Subscriber,

We're writing to let you know that we are updating the Let's Encrypt Subscriber Agreement, effective August 1, 2016. You can find the updated agreement (v1.1.1) as well as the current agreement (v1.0.1) in the "Let's Encrypt Subscriber Agreement" section of the following page:

https://letsencrypt.org/repository/

Thank you for helping to secure the Web by using Let's Encrypt.

- The Let's Encrypt Team
</code></pre>

<h2>テキストへ変換</h2>

<p><code>poppler</code> に入っている <code>pdftotext</code> コマンドで PDF からテキストファイルに変換しました。</p>

<h2>diff</h2>

<p><code>git diff --no-index LE-SA-v1.*.txt</code> での比較結果は以下の通りでした。</p>

<pre><code class="diff">diff --git a/LE-SA-v1.0.1-July-27-2015.txt b/LE-SA-v1.1.1-August-1-2016.txt
index d5a0b9d..e5850ef 100644
--- a/LE-SA-v1.0.1-July-27-2015.txt
+++ b/LE-SA-v1.1.1-August-1-2016.txt
@@ -1,6 +1,6 @@
-Version 1.0.1
-July 27, 2015
-Page 1 of 6
+Version 1.1.1
+August 1, 2016
+Page 1 of 7

 LET’S ENCRYPT
 SUBSCRIBER AGREEMENT
@@ -38,15 +38,20 @@ Key.
 “Public Key” — In Public Key Cryptography, this is the publicly-disclosed key that is used by the recipient
 to (i) validate Digital Signatures created with the corresponding Private Key and (ii) encrypt messages or
 files to be decrypted with the corresponding Private Key.
+“Key Compromise”— A Private Key is said to be compromised if its value has been disclosed to an
+unauthorized person, an unauthorized person has had access to it, or there exists a practical technique by
+which an unauthorized person may discover its value. A Private Key is also considered compromised if
+methods have been developed that can easily calculate it based on the Public Key or if there is clear
+evidence that the specific method used to generate the Private Key was flawed.
+
+Version 1.1.1
+August 1, 2016
+Page 2 of 7
 “Public Key Cryptography” — A type of cryptography that uses a Key Pair to securely encrypt and
 decrypt messages. One key encrypts a message, and the other key decrypts the message. One key is kept
 secret (the Private Key), and one is made available to others (the Public Key). These keys are, in essence,
 large mathematically-related numbers that form a unique pair. Either key may be used to encrypt a
 message, but only the other corresponding key may be used to decrypt the message.
-
-Version 1.0.1
-July 27, 2015
-Page 2 of 6
 “Repository” — An online system maintained by ISRG for storing and retrieving Let’s Encrypt Certificates
 and other information relevant to Let’s Encrypt Certificates, including information relating validity or
 revocation.
@@ -54,7 +59,7 @@ revocation.
 (“Valid From” or “Activation” date), and ending on the expiration date indicated in such Certificate (“Valid
 To” or “Expiry” date).
 “Your Certificate” — A Let’s Encrypt Certificate issued to You.
-2.!
+2.

 Effective Date, Term, and Survival
 2.1
@@ -78,7 +83,7 @@ Sections in this Agreement concerning privacy, indemnification, disclaimer of wa
 liability, governing law, choice of forum, limitations on claims against ISRG, and prohibitions on the use of
 fraudulently-obtained Certificates and expired Certificates shall survive any termination or expiration of
 this Agreement.
-3.!
+3.

 Your Warranties and Responsibilities
 3.1
@@ -86,16 +91,10 @@ Your Warranties and Responsibilities
 Warranties

 By requesting, accepting, or using a Let’s Encrypt Certificate:
-•!
-
-•!
-
-•!
-•!
-•!
-•!
-•!
-3.2
+•
+•
+•
+•

 You warrant to ISRG and the public-at-large that You are the legitimate registrant of the
 Internet domain name that is, or is going to be, the subject of Your Certificate, or that You are
@@ -103,21 +102,30 @@ the duly authorized agent of such registrant.
 You warrant to ISRG and the public-at-large that either (1) You did not obtain control of
 such domain name as the result of a seizure of such domain name, or (2) such domain name
 had no ongoing lawful uses at the time of such seizure.
-You warrant that all information in Your Certificate regarding You or Your domain
-name is accurate, current, reliable, complete, and not misleading.
-You warrant that all information You have provided to ISRG is accurate, current,
-complete, reliable, complete, and not misleading.
-You warrant that You rightfully hold the Private Key corresponding to the Public Key
-listed in Your Certificate.
-You warrant that You have taken all appropriate, reasonable, and necessary steps to secure
-and keep your Private Key secret.
-You warrant that You will not use Your Certificates to attack, defraud or intercept the
-traffic of others.
+You warrant to ISRG and the public-at-large that all information in Your Certificate
+regarding You or Your domain name is accurate, current, reliable, complete, and not
+misleading.
+You warrant to ISRG and the public-at-large that all information You have provided to
+ISRG is, and You agree that all information you will provide to ISRG at any time will be,
+accurate, current, complete, reliable, and not misleading.
+
+Version 1.1.1
+August 1, 2016
+Page 3 of 7
+•
+•
+
+3.2
+
+You warrant to ISRG and the public-at-large that You rightfully hold the Private Key
+corresponding to the Public Key listed in Your Certificate.
+You warrant to ISRG and the public-at-large that You have taken, and You agree that at
+all times You will take, all appropriate, reasonable, and necessary steps to maintain sole
+control of, secure, properly protect and keep secret and confidential the Private Key
+corresponding to the Public Key in Your Certificate (and any associated activation data or
+device, e.g. password or token).
 Changes in Certificate Information

-Version 1.0.1
-July 27, 2015
-Page 3 of 6
 If at any time You no longer control the Internet domain names associated with any of Your Certificates, or
 if any of the warranties in Section 3.1 above are no longer true with respect to any of Your Certificates in
 any other way, You will immediately request that ISRG revoke the affected Certificates. You may request
@@ -141,7 +149,7 @@ Key Pair Generation
 Your Key Pair (Public and Private Keys) will be generated by You or Your ACME Client Software on
 Your systems. You will submit the corresponding Public Key to ISRG and it will be incorporated into
 Your Certificate. ISRG will store Your Certificate in its Repository. ISRG will not have access to Your
-Private Key.
+Private Key. Your Private and Public Keys will remain Your property.
 We will use technical methods and protocols to verify that You have exclusive control over the subject
 Internet domain name. This verification is done solely to assist ISRG in determining whether to issue a
 Let’s Encrypt Certificate and is not a service being performed for Your benefit or on Your behalf.
@@ -149,46 +157,59 @@ Let’s Encrypt Certificate and is not a service being performed for Your benefi

 Inspection and Acceptance of Certificates

-You agree to immediately inspect the contents of Your Certificate (“Initial Inspection”), and to
-immediately request revocation if you become aware of any inaccuracies, errors, defects, or other
-problems (collectively, “Certificate Problems”) with Your Certificate. Your ACME Client Software
-may perform this task for You. You agree that You will have accepted Your Certificate when You
-first use Your Certificate or the corresponding Private Key after obtaining Your Certificate, or if You
-fail to request revocation of Your Certificate immediately following Initial Inspection.
+You warrant to ISRG and the public-at-large, and You agree, that You will immediately inspect the
+contents of Your Certificate (“Initial Inspection”), and to immediately request revocation if you
+become aware of any inaccuracies, errors, defects, or other problems (collectively, “Certificate
+Problems”) with Your Certificate. Your ACME Client Software may perform this task for You. You
+agree that You will have accepted Your Certificate when You first use Your Certificate or the
+corresponding Private Key after obtaining Your Certificate, or if You fail to request revocation of
+Your Certificate immediately following Initial Inspection.
 3.6

-Use of Your Certificate
-
-The purpose of Your Certificate is to encrypt Internet communications. ISRG is not responsible for any
-legal or other consequences resulting from or associated with the use of Your Certificate. You agree that
-You will not use Your Certificate for any purpose requiring fail-safe performance, such as the operation of
-public utilities or power facilities, air traffic control or navigation systems, weapons systems, or any other
-systems, the failure of which would reasonably be expected to lead to bodily injury, death or property
-damage.
+Installation and Use of Your Certificate
+
+You may reproduce and distribute Your Certificate on a nonexclusive and royalty-free basis, provided that
+it is reproduced and distributed in full and in compliance with this Agreement. You warrant to ISRG and
+the public-at-large, and You agree, that You will install Your Certificate only on servers that are accessible
+
+Version 1.1.1
+August 1, 2016
+Page 4 of 7
+at the subjectAltName(s) listed in Your Certificate, and that you will use Your Certificate solely in
+compliance with all applicable laws and solely in accordance with this Agreement. Your Certificate will
+remain the property of ISRG, subject to Your right to use it as set forth in this Agreement.
+The purpose of Your Certificate is to authenticate and encrypt Internet communications. ISRG is not
+responsible for any legal or other consequences resulting from or associated with the use of Your
+Certificate. You agree that You will not use Your Certificate for any purpose requiring fail-safe
+performance, such as the operation of public utilities or power facilities, air traffic control or navigation
+systems, weapons systems, or any other systems, the failure of which would reasonably be expected to
+lead to bodily injury, death or property damage.
 3.7.

 When to Revoke Your Certificate

-You must immediately request that Your Certificate be revoked if: (i) You suspect or discover that
-Your Private Key has been, or is in danger of being, lost, stolen, otherwise compromised, or subjected
-to unauthorized use, or (ii) any information in Your Certificate is no longer accurate, current or
-complete, or any such information becomes misleading. You may make a revocation request to ISRG
-
-Version 1.0.1
-July 27, 2015
-Page 4 of 6
-using ACME Client Software. You should also notify anyone who may have relied upon Your use of
-Your Certificate that Your encrypted communications may have been subject to compromise
+You warrant to ISRG and the public-at-large, and You agree, that You will immediately request that
+Your Certificate be revoked if: (i) there is any actual or suspected misuse or Key Compromise of the
+Private Key associated with the Public Key included in Your Certificate, or (ii) any information in Your
+Certificate is, or becomes, misleading, incorrect or inaccurate. You may make a revocation request to
+ISRG using ACME Client Software. You should also notify anyone who may have relied upon Your
+use of Your Certificate that Your encrypted communications may have been subject to compromise.
 3.8

 When to Cease Using Your Certificate

-You must immediately cease using Your Certificate if: (i) You suspect or discover that the Private Key
-corresponding to Your Certificate has been or may be stolen, lost, or otherwise compromised or subjected
-to unauthorized use, (ii) any information in Your Certificate is no longer accurate, current or complete, or
-any such information becomes misleading, or (iii) upon the revocation or expiration of Your Certificate.
+You warrant to ISRG and the public-at-large, and You agree, that You will promptly cease using Your
+Certificate (i) if any information in Your Certificate is, or becomes, misleading, incorrect or inaccurate, or
+(ii) upon the revocation or expiration of Your Certificate.
 3.9

+When to Cease Using Your Private Key
+
+You warrant to ISRG and the public-at-large, and You agree, that You will promptly cease all use of the
+Private Key corresponding to the Public Key included in Your Certificate upon revocation of Your
+Certificate for reasons of known or suspected Key Compromise.
+3.10
+
 Indemnification

 You agree to indemnify and hold harmless ISRG and its directors, officers, employees, agents, and
@@ -207,20 +228,17 @@ ISRG’s Rights and Responsibilities

 Privacy

-Because others may rely on your use of Your Certificate to encrypt Internet communications, much of the
+Because others may rely on your use of Your Certificates to encrypt Internet communications, much of the
 information You send to ISRG will be published by ISRG and will become a matter of public record.
-However, information used for account-recovery purposes (such as Your email address and telephone
-number) (“Private Recovery Information” or “PRI”) will NOT be published by ISRG. ISRG will not sell
-or share your Private Recovery Information. ISRG may disclose Private Recovery Information, however,
-if compelled to do so by court order or other compulsory legal process. If legally permissible and to the
-extent possible and within ISRG’s control, and if you have provided ISRG with an email address, ISRG
-will send an email to such address notifying You of the potential disclosure. ISRG may also disclose your
-PRI if ISRG believes disclosure is necessary to prevent loss of life, personal injury, damage to property, or
-significant financial harm.
+ISRG’s collection, storage, use and disclosure of such information are governed by the Let’s Encrypt
+Privacy Policy at: https://letsencrypt.org/privacy/.
 4.2

 Certificate Repository

+Version 1.1.1
+August 1, 2016
+Page 5 of 7
 During the term of the Agreement, ISRG will operate and maintain a secure online Repository that is
 available to authorized relying parties that contains: (i) all past and current Let’s Encrypt Certificates
 (including, as applicable, Your Certificate) and (ii) a CRL or similar online database indicating whether
@@ -231,36 +249,36 @@ public to access this information.

 Suspension and Revocation

-ISRG may immediately suspend Your Certificate if any party notifies ISRG that Your Certificate is
-invalid or has been compromised. ISRG will determine, in its sole discretion, whether to revoke Your
-Certificate or restore it to valid status. If You or Your agent requests that Your Certificate be revoked,
-ISRG will revoke Your Certificate and update the Repository as soon as practical. If a request for
-revocation is signed by your Private Key, then ISRG will automatically deem the request to be valid.
-
-Version 1.0.1
-July 27, 2015
-Page 5 of 6
-ISRG may also, without advance notice, revoke Your Certificate if ISRG determines, in its sole discretion,
-that: (i) Your Certificate was not properly issued or was obtained through misrepresentation, concealment,
-or fraud; (ii) Your Certificate has become, or appears to have become, unreliable; (iii) the security of the
-Private Key corresponding to Your Certificate has been or may be stolen, lost, or otherwise compromised,
-or subject to unauthorized use; (iv) any information in Your registration with ISRG or Your request for a
-Let’s Encrypt Certificate has changed or has become false or misleading; (v) You have violated any
-applicable law, agreement or other obligation; (vi) You request revocation; (vii) ISRG is legally required to
-revoke Your Certificate pursuant to a valid court order issued by a court of competent jurisdiction; (viii)
-this Agreement has terminated; or (iv) there are other reasonable and lawful grounds for revocation. ISRG
-will provide notice of revocation via email to the email address of record.
+You acknowledge and accept that ISRG may immediately suspend Your Certificate if any party notifies
+ISRG that Your Certificate is invalid or has been compromised. ISRG will determine, in its sole discretion,
+whether to revoke Your Certificate. If You or Your agent requests that Your Certificate be revoked, ISRG
+will revoke Your Certificate and update the Repository as soon as practical. If a request for revocation is
+signed by your Private Key, then ISRG will automatically deem the request to be valid. You also
+acknowledge and accept that ISRG may, without advance notice, immediately revoke Your Certificate if
+ISRG determines, in its sole discretion, that: (i) Your Certificate was not properly issued or was obtained
+through misrepresentation, concealment, or fraud; (ii) Your Certificate has become, or appears to have
+become, unreliable; (iii) the security of the Private Key corresponding to Your Certificate has been or may
+be stolen, lost, or otherwise compromised, or subject to unauthorized use; (iv) any information in Your
+registration with ISRG or Your request for a Let’s Encrypt Certificate has changed or has become false or
+misleading; (v) You have violated any applicable law, agreement (including this Agreement), or other
+obligation; (vi) Your Certificate is being used, or has been used, to enable any criminal activity (such as
+phishing attacks, fraud or the distribution of malware); (vii) Your Certificate is being used, or has been
+used, to intercept the traffic of others; (viii) You request revocation; (ix) ISRG is legally required to revoke
+Your Certificate pursuant to a valid court order issued by a court of competent jurisdiction; (x) this
+Agreement has terminated; or (xi) there are other reasonable and lawful grounds for revocation. ISRG will
+provide notice of revocation via email to the email address of record.
 4.4

 IMPORTANT DISCLAIMER OF WARRANTIES AND LIMITATION OF
 LIABILITY

-LET’S ENCRYPT CERTIFICATES AND SERVICES ARE PROVIDED “AS-IS.”
-ISRG DISCLAIMS ANY AND ALL WARRANTIES OF ANY TYPE, WHETHER EXPRESS
-OR IMPLIED, INCLUDING AND WITHOUT LIMITATION ANY IMPLIED WARRANTY OF
-TITLE, NON-INFRINGEMENT, MERCHANTABILITY, OR FITNESS FOR A PARTICULAR
-PURPOSE, IN CONNECTION WITH ANY ISRG SERVICE OR LET’S ENCRYPT
-CERTIFICATE.
+EXCEPT AS EXPRESSLY SET FORTH IN ISRG’S CERTIFICATE POLICY AND
+CERTIFICATE PRACTICE STATEMENT, LET’S ENCRYPT CERTIFICATES AND
+SERVICES ARE PROVIDED “AS-IS” AND ISRG DISCLAIMS ANY AND ALL
+WARRANTIES OF ANY TYPE, WHETHER EXPRESS OR IMPLIED, INCLUDING AND
+WITHOUT LIMITATION ANY IMPLIED WARRANTY OF TITLE, NON-INFRINGEMENT,
+MERCHANTABILITY, OR FITNESS FOR A PARTICULAR PURPOSE, IN CONNECTION
+WITH ANY ISRG SERVICE OR LET’S ENCRYPT CERTIFICATE.
 BECAUSE LET’S ENCRYPT CERTIFICATES ARE ISSUED FREE-OF-CHARGE AS A PUBLIC
 SERVICE, ISRG CANNOT ACCEPT ANY LIABILITY FOR ANY LOSS, HARM, CLAIM, OR
 ATTORNEY’S FEES IN CONNECTION WITH SUCH CERTIFICATES. ACCORDINGLY, YOU
@@ -275,6 +293,10 @@ REGULATION, COMMON LAW, OR ANY OTHER SOURCE OF LAW, STANDARD OF CARE,
 CATEGORY OF CLAIM, NOTION OF FAULT OR RESPONSIBILITY, OR THEORY OF
 RECOVERY. THE PARTIES AGREE THAT THIS DISCLAIMER IS INTENDED TO BE
 CONSTRUED TO THE FULLEST EXTENT ALLOWED BY APPLICABLE LAW.
+
+Version 1.1.1
+August 1, 2016
+Page 6 of 7
 BY WAY OF FURTHER EXPLANATION REGARDING THE SCOPE OF THE DISCLAIMER,
 AND WITHOUT WAIVING OR LIMITING THE FOREGOING IN ANY WAY, ISRG DOES NOT
 MAKE, AND ISRG EXPRESSLY DISCLAIMS, ANY WARRANTY REGARDING ITS RIGHT TO
@@ -297,9 +319,6 @@ choice of law and conflicts of law principles.

 Choice of Forum

-Version 1.0.1
-July 27, 2015
-Page 6 of 6
 Any claim, suit or proceeding arising out of this Agreement must be brought in a state or federal court
 located in San Jose, California.
 5.3
@@ -339,6 +358,10 @@ If any provision of this Agreement is found to be invalid, unenforceable, or con
 Agreement will be deemed amended by modifying such provision to the extent necessary to make it valid
 and enforceable while preserving its intent or, if that is not possible, by striking the provision and enforcing
 the remainder of this Agreement.
+
+Version 1.1.1
+August 1, 2016
+Page 7 of 7
 5.8

 Authorization of ISRG to Send Emails
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[letsencrypt の Rate Limit について]]></title>
    <link href="http://blog.n-z.jp/blog/2016-06-17-letsencrypt.html"/>
    <updated>2016-06-17T15:44:18+09:00</updated>
    <id>http://blog.n-z.jp/blog/letsencrypt</id>
    <content type="html"><![CDATA[<p><a href="http://www.clear-code.com/blog/2016/6/16.html" title="Let’s Encryptをcloudapp.azure.comで使おうとするときのハマりどころ">Let’s Encryptをcloudapp.azure.comで使おうとするときのハマりどころ</a>
という記事で Rate Limit の制限解除方法について誤解があるようなので、解説してみたいと思います。</p>

<!--more-->


<h2>Rate Limit について</h2>

<p><code>細かな制限はいろいろありますが、どうやら特定ドメインに対しては、週に20個のSSL/TLSサーバー証明書しか発行しないようです。そのため*.cloudapp.azure.comなどのように、皆がこぞってSSL/TLSサーバー証明書を取得しに行くような場合、見事に制限にひっかかってしまいます。</code>
と書いてありますが、これはその通りだと思います。</p>

<p><code>これを回避するには別途独自にドメインをとるなどしなければなりません。</code>
とありますが、 Dynamic DNS や IaaS などを利用している場合はプロバイダーに対応してもらうという方法があります。
また、その方が Cookie Monster と呼ばれる問題にも対処出来て望ましいと思います。</p>

<h2>適用例外について</h2>

<p><a href="https://github.com/certbot/certbot/issues/1607" title="DDNS Rate Limited">DDNS Rate Limited</a>
や
<a href="https://github.com/certbot/certbot/issues/2186" title="Too many certificates already issued for dynamic dns provider sub domain">Too many certificates already issued for dynamic dns provider sub domain</a>
のやりとりをみてもらえば詳細はわかるのですが、簡単に言うと</p>

<ul>
<li>プロバイダーに <a href="https://publicsuffix.org/">Public Suffix List</a> に登録してもらう</li>
<li><a href="https://github.com/letsencrypt/boulder">Let&rsquo;s Encrypt のサーバー</a> に反映してもらう</li>
</ul>


<p>ということになります。</p>

<h2>「正式版じゃなくてもいいから試してみたい」について</h2>

<p><code>certbot --help all</code> で出てくるヘルプにあるように <code>--test-cert</code> オプションか <code>--staging</code> オプションを使えば <code>/usr/lib/python2.7/dist-packages/certbot/constants.py</code> を書き換えるなどという方法をとらなくてもステージング環境の ACME サーバーを使えるようになります。</p>

<pre><code>% certbot --help all
(中略)
testing:
  The following flags are meant for testing purposes only! Do NOT change
  them, unless you really know what you're doing!

  --debug               Show tracebacks in case of errors, and allow
                        letsencrypt-auto execution on experimental platforms
                        (default: False)
  --no-verify-ssl       Disable SSL certificate verification. (default: False)
  --tls-sni-01-port TLS_SNI_01_PORT
                        Port number to perform tls-sni-01 challenge. Boulder
                        in testing mode defaults to 5001. (default: 443)
  --http-01-port HTTP01_PORT
                        Port used in the SimpleHttp challenge. (default: 80)
  --break-my-certs      Be willing to replace or renew valid certs with
                        invalid (testing/staging) certs (default: False)
  --test-cert, --staging
                        Use the staging server to obtain test (invalid) certs;
                        equivalent to --server https://acme-
                        staging.api.letsencrypt.org/directory (default: False)
(後略)
</code></pre>

<h2>まとめ</h2>

<p>Dynamic DNS や IaaS などを使っていて Rate Limit に引っかかった時の対処方法について説明しました。
また Cookie Monster と呼ばれる問題の影響についても少し触れました。</p>

<p>また、ステージング環境の ACME サーバーを使うのにソースを書き換えなくてもオプション指定で済むということを説明しました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jessie の letsencrypt を certbot にあげてみた]]></title>
    <link href="http://blog.n-z.jp/blog/2016-05-30-letsencrypt-to-certbot-on-jessie.html"/>
    <updated>2016-05-30T21:20:43+09:00</updated>
    <id>http://blog.n-z.jp/blog/letsencrypt-to-certbot-on-jessie</id>
    <content type="html"><![CDATA[<p>Debian で <a href="https://packages.debian.org/letsencrypt">letsencrypt パッケージ</a>が <a href="https://packages.debian.org/certbot">certbot パッケージ</a>に変わって、
jessie-backports にも反映されたので、 certbot パッケージに入れ替えてみました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>Debian GNU/Linux 8.4 (jessie) (amd64)</li>
<li>letsencrypt 0.5.0-1~bpo8+1 から certbot 0.6.0-2~bpo8+1</li>
</ul>


<h2>アップグレード失敗</h2>

<p>普通に upgrade しようとすると以下のように失敗します。</p>

<pre><code class="text">%  sudo aptitude full-upgrade -DV
以下のパッケージが更新されます:
  python-acme{b} [0.5.0-1~bpo8+1 -&gt; 0.6.0-1~bpo8+1] (破: python-letsencrypt)
更新: 1 個、新規インストール: 0 個、削除: 0 個、保留: 0 個。
アーカイブ 54.6 k バイト中 0  バイトを取得する必要があります。展開後に 1,024  バイトのディスク領域が新たに消費されます。以下のパッケージには満たされていない依存関係があります:
 python-acme : 破壊: python-letsencrypt (&lt; 0.6.0) [0.5.0-1~bpo8+1 が既にインストール済みです]
以下のアクションでこれらの依存関係の問題は解決されます:

     以下のパッケージを削除する:
1)     letsencrypt
2)     python-letsencrypt



この解決方法を受け入れますか? [Y/n/q/?]q
これらの依存関係の問題を解決するための努力をすべて放棄します。
中断。
</code></pre>

<h2>certbot パッケージで入れ替え</h2>

<p>以下のように <code>certbot</code> パッケージをインストールすることで <code>letsencrypt</code> パッケージが削除されます。</p>

<pre><code class="text">% sudo aptitude install certbot
以下の新規パッケージがインストールされます:
  certbot{b} python-certbot{ab}
以下のパッケージが更新されます:
  python-acme{b}
更新: 1 個、新規インストール: 2 個、削除: 0 個、保留: 0 個。
アーカイブ 204 k バイト中 149 k バイトを取得する必要があります。展開後に 816 k バイトのディスク領域が新たに消費されます 。
以下のパッケージには満たされていない依存関係があります:
 python-acme : 破壊: python-letsencrypt (&lt; 0.6.0) [0.5.0-1~bpo8+1 が既にインストール済みです]
 python-certbot : 破壊: python-letsencrypt [0.5.0-1~bpo8+1 が既にインストール済みです]
 certbot : 破壊: letsencrypt [0.5.0-1~bpo8+1 が既にインストール済みです]
以下のアクションでこれらの依存関係の問題は解決されます:

     以下のパッケージを削除する:
1)     letsencrypt
2)     python-letsencrypt



この解決方法を受け入れますか? [Y/n/q/?]
以下の新規パッケージがインストールされます:
  certbot python-certbot{a}
以下のパッケージが削除されます:
  letsencrypt{a} python-letsencrypt{a}
以下のパッケージが更新されます:
  python-acme
更新: 1 個、新規インストール: 2 個、削除: 2 個、保留: 0 個。
アーカイブ 204 k バイト中 149 k バイトを取得する必要があります。展開後に 14.3 k バイトのディスク領域が新たに消費されます。
先に進みますか? [Y/n/?]
</code></pre>

<h2>自動更新設定確認</h2>

<p>インストール後に <code>etckeeper</code> の <code>commit</code> が発生して差分があるようだったので、
<code>sudo etckeeper vcs log -p --stat</code> で確認してみたところ、
<code>/etc/cron.d/certbot</code> ができていました。</p>

<pre><code class="diff">diff --git a/cron.d/certbot b/cron.d/certbot
new file mode 100644
index 0000000..9c3dc35
--- /dev/null
+++ b/cron.d/certbot
@@ -0,0 +1,6 @@
+# Upstream recommends attempting renewal twice a day
+#
+# Eventually, this will be an opportunity to validate certificates
+# haven't been revoked, etc.  Renewal will only occur if expiration
+# is within 30 days.
+* */12 * * * root perl -e 'sleep int(rand(3600))'; certbot -q renew
</code></pre>

<h2>自動更新設定変更</h2>

<p>自動更新はログを残しつつ、 apache の reload も行う自前のスクリプトを用意していたので、
そちらを引き続き使うことにして、 <code>/etc/cron.d/certbot</code> はコメントアウトして動かないようにしました。</p>

<pre><code class="diff">% sudo etckeeper vcs diff
diff --git a/cron.d/certbot b/cron.d/certbot
index 9c3dc35..e81f9aa 100644
--- a/cron.d/certbot
+++ b/cron.d/certbot
@@ -3,4 +3,4 @@
 # Eventually, this will be an opportunity to validate certificates
 # haven't been revoked, etc.  Renewal will only occur if expiration
 # is within 30 days.
-* */12 * * * root perl -e 'sleep int(rand(3600))'; certbot -q renew
+#* */12 * * * root perl -e 'sleep int(rand(3600))'; certbot -q renew
diff --git a/cron.daily/local-letsencrypt b/cron.daily/local-letsencrypt
index 8b83e29..40a23ea 100755
--- a/cron.daily/local-letsencrypt
+++ b/cron.daily/local-letsencrypt
@@ -3,7 +3,7 @@ LOGFILE=/var/log/letsencrypt/renew.log
 if [ -f "$LOGFILE" ]; then
     savelog -c 90 -q "$LOGFILE"
 fi
-if ! letsencrypt renew &gt; "$LOGFILE" 2&gt;&amp;1 ; then
+if ! certbot renew &gt; "$LOGFILE" 2&gt;&amp;1 ; then
     echo Automated renewal failed:
     cat "$LOGFILE"
     exit 1
</code></pre>

<h2>現状の自動更新スクリプト</h2>

<p>現状の自動更新スクリプト <code>/etc/cron.daily/local-letsencrypt</code> は以下のようにしています。</p>

<pre><code class="bash">#!/bin/sh
LOGFILE=/var/log/letsencrypt/renew.log
if [ -f "$LOGFILE" ]; then
    savelog -c 90 -q "$LOGFILE"
fi
if ! certbot renew &gt; "$LOGFILE" 2&gt;&amp;1 ; then
    echo Automated renewal failed:
    cat "$LOGFILE"
    exit 1
fi
if [ -f "$LOGFILE".0 ]; then
    diff -u "$LOGFILE".0 "$LOGFILE"
fi
apachectl graceful
</code></pre>

<p>以下のようなシンボリックリンクがあるので、 <code>letsencrypt renew</code> のままでも大丈夫そうでしたが、念のため変更しました。</p>

<pre><code class="text">% ls -alF /usr/bin/letsencrypt
lrwxrwxrwx 1 root root 7  5月 28 07:30 /usr/bin/letsencrypt -&gt; certbot*
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[letsencrypt-auto が certbot-auto になった]]></title>
    <link href="http://blog.n-z.jp/blog/2016-05-13-letsencrypt-certbot.html"/>
    <updated>2016-05-13T23:40:09+09:00</updated>
    <id>http://blog.n-z.jp/blog/letsencrypt-certbot</id>
    <content type="html"><![CDATA[<p><a href="https://www.eff.org/deeplinks/2016/05/announcing-certbot-new-tls-robot">EFF の Let&rsquo;s Encrypt クライアントが Certbot になった</a>という話です。</p>

<!--more-->


<h2>経緯</h2>

<p><a href="https://letsencrypt.jp/usage/">Let&rsquo;s Encrypt の使い方</a> から引用しつつまとめます。</p>

<ul>
<li>2016年4月12日 に、Let&rsquo;s Encrypt の公開ベータプログラム（Public Beta Program）が終了し、正式サービスが開始されました。</li>
<li>この時点でベータがとれたのは Let&rsquo;s Encrypt のサービス側で <code>letsencrypt-auto</code> コマンドを含む github.com/letsencrypt/letsencrypt にあったクライアントはまだベータのままでした。</li>
<li>クライアントの 0.6.0 のリリースにあたり github.com/letsencrypt/letsencrypt は github.com/certbot/certbot に移動して Certbot に改名されました。</li>
<li><a href="https://www.eff.org/deeplinks/2016/05/announcing-certbot-new-tls-robot">Announcing Certbot: EFF&rsquo;s Client for Let&rsquo;s Encrypt</a> に書いてあるように Certbot もまだベータで、今年中に Certbot 1.0 のリリースが予定されているようです。</li>
</ul>


<p>改名されたのは EFF の Let&rsquo;s Encrypt クライアントだけでサービス自体は Let&rsquo;s Encrypt という名前のままです。</p>

<h2>その他の変更点</h2>

<p>インストール方法も <code>git clone</code> して <code>letsencrypt-auto</code> を実行する方法から、 <code>https://dl.eff.org/certbot-auto</code> をダウンロードして実行する方法に変わっています。</p>

<h2>インストール済み環境への影響</h2>

<p>インストール済み環境ではどうなるのかと思って、 <code>letsencrypt-auto --help</code> を実行してアップグレードさせてみたところ、以下のようになりました。</p>

<p>出力をよく見ると <code>sudo</code> のところで <code>CERTBOT_AUTO</code> という環境変数の指定が増えていて、 <code>letsencrypt-auto</code> コマンド自体はそのまま使えるようです。</p>

<pre><code>% ~/letsencrypt/letsencrypt-auto --help
Checking for new version...
Upgrading letsencrypt-auto 0.5.0 to 0.6.0...
Replacing letsencrypt-auto...
   sudo cp -p /home/vpsuser/letsencrypt/letsencrypt-auto /tmp/user/1000/tmp.AiqGtrjioJ/letsencrypt-auto.permission-clone
   sudo cp /tmp/user/1000/tmp.AiqGtrjioJ/letsencrypt-auto /tmp/user/1000/tmp.AiqGtrjioJ/letsencrypt-auto.permission-clone
   sudo mv -f /tmp/user/1000/tmp.AiqGtrjioJ/letsencrypt-auto.permission-clone /home/vpsuser/letsencrypt/letsencrypt-auto
Creating virtual environment...
Installing Python packages...
Installation succeeded.
Requesting root privileges to run certbot...
   sudo CERTBOT_AUTO=/home/vpsuser/letsencrypt/letsencrypt-auto /home/vpsuser/.local/share/letsencrypt/bin/letsencrypt --help

  letsencrypt-auto [SUBCOMMAND] [options] [-d domain] [-d domain] ...

Certbot can obtain and install HTTPS/TLS/SSL certificates.  By default,
it will attempt to use a webserver both for obtaining and installing the
cert. Major SUBCOMMANDS are:

  (default) run        Obtain &amp; install a cert in your current webserver
  certonly             Obtain cert, but do not install it (aka "auth")
  install              Install a previously obtained cert in a server
  renew                Renew previously obtained certs that are near expiry
  revoke               Revoke a previously obtained certificate
  rollback             Rollback server configuration changes made during install
  config_changes       Show changes made to server config during installation
  plugins              Display information about installed plugins

Choice of server plugins for obtaining and installing cert:

  --apache          Use the Apache plugin for authentication &amp; installation
  --standalone      Run a standalone webserver for authentication
  (nginx support is experimental, buggy, and not installed by default)
  --webroot         Place files in a server's webroot folder for authentication

OR use different plugins to obtain (authenticate) the cert and then install it:

  --authenticator standalone --installer apache

More detailed help:

  -h, --help [topic]    print this message, or detailed help on a topic;
                        the available topics are:

   all, automation, paths, security, testing, or any of the subcommands or
   plugins (certonly, install, nginx, apache, standalone, webroot, etc)
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jessie に backports から letsencrypt を入れてみた]]></title>
    <link href="http://blog.n-z.jp/blog/2016-04-08-jessie-letsencrypt.html"/>
    <updated>2016-04-08T14:30:02+09:00</updated>
    <id>http://blog.n-z.jp/blog/jessie-letsencrypt</id>
    <content type="html"><![CDATA[<p>現在リリースされている Ubuntu と違って Debian jessie には backports に letsencrypt パッケージがあるので、ちょっと古いですがパッケージ版の letsencrypt を使ってみることにしました。</p>

<p>Ubuntu も今月リリースされる 16.04 (xenial) には universe ですが letsencrypt パッケージが含まれるので、それが使えると思います。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>Debian GNU/Linux 8.4 (jessie) (amd64)</li>
<li>letsencrypt 0.4.1-1~bpo8+1</li>
<li>apache2 2.4.10-10+deb8u4</li>
</ul>


<h2>インストール</h2>

<p><code>/etc/apt/sources.list</code> で <code>deb http://ftp.jp.debian.org/debian jessie-backports main contrib non-free</code> のように backports を有効にしておきます。</p>

<p>依存パッケージも backports のものが必要なので <code>-t jessie-backports</code> 付きでインストールする必要がありました。</p>

<p><code>webroot</code> を使う予定だったので、 <code>python-letsencrypt-apache</code> はインストールしませんでした。</p>

<p>stable にあるパッケージのうち、いくつかのパッケージも backports のものに上がってしまうので、そのリスクが許容できない場合は <code>letsencrypt-auto</code> など、他のインストール方法を検討した方が良さそうです。</p>

<pre><code>%  sudo apt install letsencrypt
パッケージリストを読み込んでいます... 完了
依存関係ツリーを作成しています
状態情報を読み取っています... 完了
インストールすることができないパッケージがありました。おそらく、あり得
ない状況を要求したか、(不安定版ディストリビューションを使用しているの
であれば) 必要なパッケージがまだ作成されていなかったり Incoming から移
動されていないことが考えられます。
以下の情報がこの問題を解決するために役立つかもしれません:

以下のパッケージには満たせない依存関係があります:
 letsencrypt : 依存: python-letsencrypt (= 0.4.1-1~bpo8+1) しかし、インストールされようとしていませ ん
E: 問題を解決することができません。壊れた変更禁止パッケージがあります。
zsh: exit 100   sudo apt install letsencrypt
%  sudo apt install -t jessie-backports letsencrypt
パッケージリストを読み込んでいます... 完了
依存関係ツリーを作成しています
状態情報を読み取っています... 完了
以下のパッケージが自動でインストールされましたが、もう必要とされていません:
  python-cffi python-ply python-pycparser
これを削除するには 'apt-get autoremove' を利用してください。
以下の追加パッケージがインストールされます:
  dialog python-acme python-cffi python-cffi-backend python-configargparse python-configobj
  python-cryptography python-dialog python-enum34 python-funcsigs python-idna python-ipaddress
  python-letsencrypt python-mock python-ndg-httpsclient python-openssl python-parsedatetime
  python-pbr python-psutil python-pyasn1 python-pyicu python-requests python-rfc3339 python-six
  python-urllib3 python-zope.component python-zope.event python-zope.interface
提案パッケージ:
  python-letsencrypt-apache python-letsencrypt-doc python-configobj-doc python-cryptography-doc
  python-cryptography-vectors python-enum34-doc python-funcsigs-doc python-mock-doc
  python-openssl-doc python-openssl-dbg doc-base python-ntlm
以下のパッケージが新たにインストールされます:
  dialog letsencrypt python-acme python-cffi-backend python-configargparse python-configobj
  python-dialog python-enum34 python-funcsigs python-idna python-ipaddress python-letsencrypt
  python-mock python-ndg-httpsclient python-parsedatetime python-pbr python-psutil python-pyasn1
  python-pyicu python-requests python-rfc3339 python-urllib3 python-zope.component
  python-zope.event python-zope.interface
以下のパッケージはアップグレードされます:
  python-cffi python-cryptography python-openssl python-six
アップグレード: 4 個、新規インストール: 25 個、削除: 0 個、保留: 24 個。
1,906 kB のアーカイブを取得する必要があります。
この操作後に追加で 8,772 kB のディスク容量が消費されます。
続行しますか? [Y/n]
</code></pre>

<h2>letsencrypt コマンド実行</h2>

<p>一般ユーザー権限で実行するとエラーになり、カレントディレクトリに <code>letsencrypt.log</code> が作成されていました。
<code>--help</code> 付きでの実行は特にエラーもなく、 <code>letsencrypt.log</code> も作成されることなくヘルプが表示されました。</p>

<pre><code>%  letsencrypt
An unexpected error occurred:
OSError: [Errno 13] Permission denied: '/etc/letsencrypt'
Please see the logfile 'letsencrypt.log' for more details.
%  rm letsencrypt.log
%  letsencrypt --help

  letsencrypt [SUBCOMMAND] [options] [-d domain] [-d domain] ...

The Let's Encrypt agent can obtain and install HTTPS/TLS/SSL certificates.  By
default, it will attempt to use a webserver both for obtaining and installing
the cert. Major SUBCOMMANDS are:

  (default) run        Obtain &amp; install a cert in your current webserver
  certonly             Obtain cert, but do not install it (aka "auth")
  install              Install a previously obtained cert in a server
  renew                Renew previously obtained certs that are near expiry
  revoke               Revoke a previously obtained certificate
  rollback             Rollback server configuration changes made during install
  config_changes       Show changes made to server config during installation
  plugins              Display information about installed plugins

Choice of server plugins for obtaining and installing cert:

  (the apache plugin is not installed)
  --standalone      Run a standalone webserver for authentication
  (nginx support is experimental, buggy, and not installed by default)
  --webroot         Place files in a server's webroot folder for authentication

OR use different plugins to obtain (authenticate) the cert and then install it:

  --authenticator standalone --installer apache

More detailed help:

  -h, --help [topic]    print this message, or detailed help on a topic;
                        the available topics are:

   all, automation, paths, security, testing, or any of the subcommands or
   plugins (certonly, install, nginx, apache, standalone, webroot, etc)
</code></pre>

<h2>本番実行</h2>

<p><code>letsencrypt certonly</code> で証明書発行します。</p>

<pre><code>%  sudo letsencrypt certonly --webroot -w /srv/www/www.example.org/htdocs -d www.example.org
</code></pre>

<p>まず、アカウントの作成があるので、アカウントの作成はメールアドレス入力しました。
アカウントのリカバリや緊急時の連絡などに使われるだけのようで、今の所ここで入力したメールアドレスに letsencrypt からメールが来たことはありません。</p>

<pre><code>         ┌──────────────────────────────────────────────────────────────────────┐
         │ Enter email address (used for urgent notices and lost key recovery)  │
         │ ┌──────────────────────────────────────────────────────────────────┐ │
         │ │                                                                  │ │
         │ └──────────────────────────────────────────────────────────────────┘ │
         ├──────────────────────────────────────────────────────────────────────┤
         │                     &lt; 了解 &gt;           &lt; 取消 &gt;                      │
         └──────────────────────────────────────────────────────────────────────┘
</code></pre>

<p>Terms of Service は前回みた時から変わっていないので、今度も Agree しました。</p>

<pre><code>         ┌──────────────────────────────────────────────────────────────────────┐
         │ Please read the Terms of Service at                                  │
         │ https://letsencrypt.org/documents/LE-SA-v1.0.1-July-27-2015.pdf. You │
         │ must agree in order to register with the ACME server at              │
         │ https://acme-v01.api.letsencrypt.org/directory                       │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         │                                                                      │
         ├──────────────────────────────────────────────────────────────────────┤
         │                     &lt;Agree &gt;           &lt;Cancel&gt;                      │
         └──────────────────────────────────────────────────────────────────────┘
</code></pre>

<p>以下のような作成完了のメッセージが出ました。</p>

<pre><code>IMPORTANT NOTES:
 - If you lose your account credentials, you can recover through
   e-mails sent to z@n-z.jp.
 - Congratulations! Your certificate and chain have been saved at
   /etc/letsencrypt/live/www.example.org/fullchain.pem. Your cert will
   expire on 2016-07-07. To obtain a new version of the certificate in
   the future, simply run Let's Encrypt again.
 - Your account credentials have been saved in your Let's Encrypt
   configuration directory at /etc/letsencrypt. You should make a
   secure backup of this folder now. This configuration directory will
   also contain certificates and private keys obtained by Let's
   Encrypt so making regular backups of this folder is ideal.
 - If you like Let's Encrypt, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le
</code></pre>

<p>問題があれば <code>/var/log/letsencrypt/letsencrypt.log</code> でログを確認します。</p>

<h2>apache2 の設定変更</h2>

<p>apache2 の設定を変更して、 <code>sudo service apache2 reload</code> で反映します。
ブラウザーで Let&rsquo;s Encrypt Authority X3 の証明書になっていることが確認できたら設定完了です。</p>

<pre><code>SSLCertificateKeyFile /etc/letsencrypt/live/www.example.org/privkey.pem
SSLCertificateFile /etc/letsencrypt/live/www.example.org/fullchain.pem
</code></pre>

<h2>自動更新設定</h2>

<p>パッケージの <code>letsencrypt</code> でインストールされたものではないということを明示するために <code>local</code> をつけて <code>/etc/cron.daily/local-letsencrypt</code> に自動更新の設定をしました。</p>

<p>試しに実行してみてちゃんと動いていれば設定完了です。</p>

<pre><code>% sudoedit /etc/cron.daily/local-letsencrypt
% sudo chmod +x /etc/cron.daily/local-letsencrypt
% sudo /etc/cron.daily/local-letsencrypt
% sudo cat /var/log/letsencrypt/renew.log
Processing /etc/letsencrypt/renewal/www.example.org.conf

The following certs are not due for renewal yet:
  /etc/letsencrypt/live/www.example.org/fullchain.pem (skipped)
No renewals were attempted.
</code></pre>

<p><a href="http://blog.n-z.jp/blog/2016-04-07-letsencrypt.html">前回の記事</a> のように <a href="http://packages.debian.org/debianutils">debianutils</a> の <code>savelog</code> でログをローテートして、証明書の有効期限の 90 日分残すようにしています。</p>

<pre><code class="bash /etc/cron.daily/local-letsencrypt">#!/bin/sh
LOGFILE=/var/log/letsencrypt/renew.log
if [ -f "$LOGFILE" ]; then
    savelog -c 90 -q "$LOGFILE"
fi
if ! letsencrypt renew &gt; "$LOGFILE" 2&gt;&amp;1 ; then
    echo Automated renewal failed:
    cat "$LOGFILE"
    exit 1
fi
apachectl graceful
</code></pre>
]]></content>
  </entry>
  
</feed>
