<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: linux | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/linux/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2017-05-28T23:31:32+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[OpenSSH の ~/.ssh/config の見直しをした]]></title>
    <link href="http://blog.n-z.jp/blog/2017-05-20-openssh-config.html"/>
    <updated>2017-05-20T14:30:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/openssh-config</id>
    <content type="html"><![CDATA[<p>最新の man を参考にしながら OpenSSH の <code>~/.ssh/config</code> の設定を見直してみたので、使っている設定項目についてまとめてみました。</p>

<!--more-->


<h2>確認バージョン</h2>

<p>全て確認したわけではないですが、古いのや新しいのを確認したいときはこの辺りを使いました。</p>

<ul>
<li>Debian GNU/Linux 8.7 (jessie) の OpenSSH_6.7p1 Debian-5+deb8u3, OpenSSL 1.0.1t  3 May 2016</li>
<li>archlinux の OpenSSH_7.5p1, OpenSSL 1.1.0e  16 Feb 2017</li>
</ul>


<h2>参考</h2>

<p><a href="https://euske.github.io/openssh-jman/ssh_config.html">https://euske.github.io/openssh-jman/ssh_config.html</a> の日本語訳や <code>man ssh_config</code> で英語のマニュアルを確認したりしました。</p>

<h2>優先順位</h2>

<ol>
<li>コマンドラインオプション</li>
<li>ユーザごとの設定ファイル <code>~/.ssh/config</code></li>
<li>システム全体にわたる (system-wide) 設定ファイル <code>/etc/ssh/ssh_config</code></li>
</ol>


<p>の順番で最初に見つかった設定が使われます。</p>

<p>設定ファイルは <code>Host</code> の行で区切られていて、設定ファイルの中でも前に見つかったものが優先されるので、ホストごとの設定をファイルの先頭の方に、全体的な設定を末尾の方に書くことを想定しているようです。</p>

<h2>Host</h2>

<p><code>Host</code> または <code>Match</code> は設定ファイルの区切りです。</p>

<p>コマンドラインで指定されたホスト名にマッチするので、<code>ssh localhost</code> の時には <code>Host localhost</code> の設定が使われて <code>Host 127.0.0.1</code> や <code>Host ::1</code> の設定は使われません。</p>

<h2>CheckHostIP</h2>

<p>同じホスト名なのに IP アドレスが変わる可能性がある場合に <code>CheckHostIP no</code> にしておくと <code>known_hosts</code> に IP アドレスが記録されないようになります。</p>

<p>DNS を工夫して LAN 内では直接、外からはルーターのポートフォワーディング経由で接続できるようにしている場合など、接続の仕方によって変わる場合や、 GitHub などのようにホスト鍵はそのままで IP アドレスが変わることがあるサービスを使っている時に使うと良いと思います。</p>

<h2>Ciphers</h2>

<p><a href="/blog/2014-08-11-openssh-arcfour256.html">vagrantなどのローカルへのssh接続のみarcfour256で高速化する</a>ということをしていたこともありましたが、<a href="https://srad.jp/comment/2875861">https://srad.jp/comment/2875861</a> のリンク先の <a href="http://www.openssh.com/txt/release-7.1">http://www.openssh.com/txt/release-7.1</a> に</p>

<pre><code>Future deprecation notice
=========================

We plan on retiring more legacy cryptography in the next release
including:

 * Refusing all RSA keys smaller than 1024 bits (the current minimum
   is 768 bits)

 * Several ciphers will be disabled by default: blowfish-cbc,
   cast128-cbc, all arcfour variants and the rijndael-cbc aliases
   for AES.

 * MD5-based HMAC algorithms will be disabled by default.

This list reflects our current intentions, but please check the final
release notes for OpenSSH 7.2 when it is released.
</code></pre>

<p>と書いてあって、 <a href="http://www.openssh.com/txt/release-7.2">http://www.openssh.com/txt/release-7.2</a> には</p>

<pre><code>Potentially-incompatible changes
================================

This release disables a number of legacy cryptographic algorithms
by default in ssh:

 * Several ciphers blowfish-cbc, cast128-cbc, all arcfour variants
   and the rijndael-cbc aliases for AES.

 * MD5-based and truncated HMAC algorithms.

These algorithms are already disabled by default in sshd.
</code></pre>

<p>となっていて arcfour 系はデフォルトでは使われないようになったようなので、 arcfour 系はもうあまり使わない方が良さそうです。</p>

<p>OpenSSH_7.5p1 で <code>ssh -Q cipher</code> を確認しても残っていますが、サーバー側で無効になっていると結局使えないので、将来的には使えないものと考えて良さそうです。</p>

<p>速度を気にするなら <a href="http://blog.uu59.org/2014-04-12-ssh-ciphers.html">OpenSSH 6.6p1の各cipherのスループットを計測した</a> を参考にして実際に計測するのが良さそうです。</p>

<p>試した感じだと <code>chacha20-poly1305@openssh.com</code> が遅くて <code>aes*-ctr</code> 系と <code>aes*-gcm@openssh.com</code> 系はそんなに違いがない感じだったので、速度を気にする場合は</p>

<pre><code>Ciphers aes128-ctr,aes192-ctr,aes256-ctr,aes128-gcm@openssh.com,aes256-gcm@openssh.com
</code></pre>

<p>ぐらいでいいのではないかと思いました。(セキュリティを優先するならビット数が多い方を前に持ってくると良いと思います。)</p>

<h2>ControlMaster, ControlPath, ControlPersist</h2>

<p>デフォルトの <code>ControlMaster no</code> のまま、使いたい Host だけ <code>ControlMaster auto</code> を設定する方法と、末尾の <code>Host *</code> でデフォルトを <code>ControlMaster auto</code> にしてしまって不要な Host や設定していると問題が起きる Host だけ <code>ControlMaster no</code> を設定する方法があると思います。</p>

<p><code>ControlPath</code> は XDG Base Directory Specification の <code>XDG_CACHE_HOME</code> を参考にして <code>$HOME/.cache</code> を使って <code>ControlPath ~/.cache/ssh,%r,%h,%p,sock</code> にしています。(区切りはどの OS でも問題が起きにくそうなのとホスト名の中の <code>.</code> と区別できるように、ということで <code>,</code> にしています。)</p>

<p><code>ControlPersist</code>は OpenSSH 5.6 で、存在を知った当時はまだ対応していない OS の方が多かったので、使っていませんでしたが、せっかくなので <code>ControlPersist 10</code> に設定してみました。</p>

<h2>DynamicForward</h2>

<p>SOCKS proxy 機能です。</p>

<p>ブラウザーの接続元 IP アドレスを変えてテストしたい時に使うことがあったので、</p>

<pre><code>Host hoge hoge-proxy
HostName FQDNかIPアドレス
# ...その他の設定...

Host hoge-proxy
DynamicForward 1088
</code></pre>

<p>のように、<code>ssh hoge-proxy</code> で有効になるように設定していることもありましたが、滅多に使わないので、コマンドラインで <code>-D 1080</code> のように明示的に指定して使うことの方が多くなりました。</p>

<h2>ExitOnForwardFailure</h2>

<p>ポートフォワーディングを設定しているのにポートフォワーディングされていないことの方が、ポートフォワーディングを設定している先に多重に接続できなくて困ることより多かったので、 <code>ExitOnForwardFailure yes</code> で有効にしています。</p>

<h2>FingerprintHash</h2>

<p>サーバー側の OpenSSH が古い時に <code>ssh-keygen -l -f /etc/ssh/ssh_host_ecdsa_key.pub</code> などの結果が md5 固定なので、クライアントの OpenSSH が新しい時に <code>ssh -o FingerprintHash=md5</code> で md5 に変更して照合しています。</p>

<p>サーバー側が新しくて、クライアントが古い時に md5 の fingerprint を出すのは <code>ssh-keygen -l -E md5 -f /etc/ssh/ssh_host_ecdsa_key.pub</code> などのようです。</p>

<p>おまけの情報として、簡単に fingerprint の照合をするのに、適当なエディターにコピペして検索して全体がハイライトされるのを確認するという方法があります。
ダウンロードしたファイルのハッシュの確認にも同じ方法を使っています。</p>

<h2>ForwardAgent, ForwardX11</h2>

<p>セキュリティリスクがあるので、必要な時はコマンドラインで明示的に <code>-A</code> や <code>-X</code> で使うようにしています。</p>

<h2>HashKnownHosts</h2>

<p>不便さの方が大きい (IP アドレスも追加されているかどうか確認しにくいなど) と感じているので、 <code>HashKnownHosts no</code> で無効にしています。</p>

<h2>HostKeyAlias</h2>

<p>多段 SSH の時などに使っています。</p>

<h2>HostName</h2>

<pre><code>Host hoge hoge.example.com
HostName hoge.example.com
</code></pre>

<p>のようにして、 FQDN の代わりに短いホスト名で接続できるようにしたり、 <code>HostName IPアドレス</code> で IP アドレスを直接指定したり、よく使っています。</p>

<h2>IdentitiesOnly, IdentityFile</h2>

<p><code>IdentitiesOnly yes</code> と <code>IdentityFile</code> をセットで使って特定の鍵を使うように指定できます。
<code>IdentityFile</code> のみだと <code>ssh-agent</code> に登録されている全ての鍵を試してしまうので、普通は <code>IdentitiesOnly yes</code> とセットにして使うと思います。</p>

<p>GitHub や Heroku などのように鍵でユーザーが区別されるサービスで複数ユーザーを使い分ける時には必須だと思います。</p>

<h2>LocalCommand, PermitLocalCommand</h2>

<p>あまり使うことはなさそうですが、不用意に出力を伴うコマンドを設定していると、内部的に ssh を使うコマンドが謎の失敗をする原因になることがあります。</p>

<h2>LocalForward</h2>

<p>IRC bouncer に接続するのに</p>

<pre><code>LocalForward 6665 127.0.0.1:6665
LocalForward 6666 127.0.0.1:6666
LocalForward 6667 127.0.0.1:6667
</code></pre>

<p>という感じで使っていましたが、 TCP over TCP はあまりよくないということで、今は OpenVPN を使うようになったので、使っていません。</p>

<h2>NoHostAuthenticationForLocalhost</h2>

<p>仮想環境への接続で問題が起きたことがあるので <code>NoHostAuthenticationForLocalhost yes</code> にしています。</p>

<h2>Port</h2>

<p>ポート番号を変更している Host の設定によく使います。
明示的に <code>Port 22</code> を書いていることもあります。</p>

<h2>ProxyCommand, ProxyJump</h2>

<p>gateway を経由して target に接続するのに</p>

<pre><code>Host target
HostKeyAlias target.example.com
Hostname target.example.com
ProxyCommand ssh gateway.example.com nc -w 330 target.example.com 22
</code></pre>

<p>のように使っていました。</p>

<p>このような場合に OpenSSH 7.3 以降だと <code>ProxyJump</code> という設定が使えそうです。</p>

<p>今はそういう接続が必要な Host がないので使っていません。</p>

<h2>RequestTTY</h2>

<p><a href="http://dokku.viewdocs.io/dokku/" title="Dokku">Dokku</a> のように常に有効にしていた方が便利な Host に <code>RequestTTY yes</code> を指定しています。</p>

<p>たとえば dokku の vagrant 環境用の設定全体は以下のようにしています。</p>

<pre><code> Host dokku dokku.me
 User dokku
 HostName 10.0.0.2
 Port 22
 UserKnownHostsFile /dev/null
 StrictHostKeyChecking no
 PasswordAuthentication no
 #IdentityFile ~/.vagrant.d/insecure_private_key
 IdentityFile ~/.ssh/id_rsa
 IdentitiesOnly yes
 LogLevel FATAL
 RequestTTY yes
</code></pre>

<h2>ServerAliveInterval</h2>

<p>接続が切れた時にタイムアウトしてくれる設定です。
昔 Debian には <code>ProtocolKeepAlives</code> という設定がありましたが、今は <code>ServerAliveInterval</code> がどの OS でも使えます。
<code>ServerAliveInterval 300</code> や <code>ServerAliveInterval 30</code> を設定しています。</p>

<h2>StrictHostKeyChecking</h2>

<p>vagrant 環境など、ローカルの接続でホスト鍵も変わる可能性のある Host で <code>StrictHostKeyChecking no</code> にしています。</p>

<h2>Tunnel, TunnelDevice</h2>

<p>ssh のプロセスに与える権限が大きくなりすぎてしまうので使いにくいと思って使っていません。
代わりにトンネルには OpenVPN を使っています。</p>

<h2>UpdateHostKeys</h2>

<p>OpenSSH 6.8 以降のサーバーとクライアントだと複数のホスト鍵を受け取れるようになるようなので <code>UpdateHostKeys ask</code> にしておくと良さそうです。</p>

<p>試してみると、たとえば <code>ecdsa-sha2-nistp256</code> のホスト鍵だけ <code>known_hosts</code> に登録されているホストに接続する時に</p>

<pre><code>% ssh localhost
vagrant@localhost's password:
Learned new hostkey: RSA SHA256:+sjb9SQChXBlm/pZDyl8ORJQb4wP16eeKDqUvDli5wU
Learned new hostkey: ED25519 SHA256:rvlZW3lRcN86oPu19ym032zhuzVLz37E88A3VX2fVHE
Accept updated hostkeys? (yes/no): yes
</code></pre>

<p>のように RSA のホスト鍵と ED25519 のホスト鍵も <code>known_hosts</code> に登録するかどうかきいてきました。
(試した範囲では DSA の鍵は追加されませんでした。)</p>

<p>サーバー側が古いバージョンでも特に何も悪影響はなさそうなので、クライアントが OpenSSH 6.8 以降ならデフォルトで有効にしても良さそうです。
(クライアントが古いとエラーになるので、バージョンが古いうちから書いておくことはできない。)</p>

<p><code>ssh_config</code> の説明に書いてあるように <code>ControlPersist</code> を有効にしていると <code>UpdateHostKeys</code> は無効になるようです。</p>

<h2>User</h2>

<p><code>ssh user@host</code> で指定する代わりに <code>~/.ssh/config</code> で <code>User</code> を設定することが多いです。</p>

<h2>UserKnownHostsFile</h2>

<p>ローカルの仮想環境は <code>UserKnownHostsFile /dev/null</code> で事実上無効にしたり、<code>UserKnownHostsFile ~/.ssh/known_hosts.d/hoge.known_hosts</code> のように個別ファイルにして調べる行数を減らして速くしたりしています。</p>

<h2>VerifyHostKeyDNS</h2>

<p><a href="https://devcenter.heroku.com/articles/git-repository-ssh-fingerprints#verifying-with-dns" title="Verifying with DNS">Verifying with DNS</a> に書いてあるように <code>heroku.com</code> は SSHFP リソースレコードが設定されているようなので、 <code>VerifyHostKeyDNS yes</code> にしています。</p>

<h2>まとめ</h2>

<p><code>ServerAliveInterval</code> のように以前設定を見直したときにどの環境でも使えるようになっていたものもありましたが、 <code>ControlPersist</code> のように以前は使えない環境もあったけど、今はどこでも使える設定があったり、 <code>UpdateHostKeys</code> のようにまだ使えない環境もある設定もあったりするので、たまに気が向いたときに設定の見直しをするのはお勧めだと思いました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ LILO&東海道らぐオフラインミーティング 2017/05/06]]></title>
    <link href="http://blog.n-z.jp/blog/2017-05-06-lilo-tokaidolug.html"/>
    <updated>2017-05-06T13:17:50+09:00</updated>
    <id>http://blog.n-z.jp/blog/lilo-tokaidolug</id>
    <content type="html"><![CDATA[<p><a href="https://lilo.connpass.com/event/55003/" title="LILO&amp;東海道らぐオフラインミーティング 2017/05/06">LILO&amp;東海道らぐオフラインミーティング 2017/05/06</a> に参加しました。</p>

<p>今回もアンカンファレンス形式でした。</p>

<!--more-->


<h2>メモ</h2>

<p>今回のメモです。</p>

<ul>
<li>会場はいつもの 4 階でした。</li>
<li>ハッシュタグ: <code>#lilo_jp</code> <code>#東海道らぐ</code></li>
<li>登録参加者数 16名</li>
<li>自己紹介から</li>
</ul>


<h2>自分の発表</h2>

<ul>
<li>資料にある話</li>
<li>資料にないけど DNS CAA の話</li>
<li>CAA レコードに書いて spam が増えなかったかという話</li>
<li>公開しているアドレスなので変化はわからず</li>
<li>.travis.yml に書いた時には明らかに増えた</li>
<li>質問があったので、ちょっと etckeeper の話 (etckeeper vcs とか)</li>
</ul>


<h2>こんどうさん</h2>

<ul>
<li>ESP パーティションの話</li>
<li>ESP 内の grub データを消せば Windows のみになる</li>
<li>BIOS/MBR から UEFI の過渡期の話</li>
<li>openSUSE の話</li>
<li>openSUSE Asia Summit 招聘中</li>
<li>LibO もほぼ併催確定</li>
<li>Cinnamon を入れた</li>
<li>Linux Mint 17.3 with NVIDIA Driver は GPU 切り替えがログアウトだけで可能</li>
<li>18.1 では切り替え NG (プロプラドライバとの相性も悪い)</li>
<li>M17N: ibus の設定</li>
<li>SUSE のデフォルトは <code>/</code> が btrfs で <code>/home</code> が XFS</li>
</ul>


<h2>5分休憩</h2>

<h2>としひささん</h2>

<ul>
<li>スマートウォッチ</li>
<li>WSD-F20 と Pebble</li>
<li>必要な理由とか要件とか</li>
<li>特徴とか比較とか</li>
<li>個人的には Pebble の方が良い</li>
<li>WSD-F20 は GPS ロガーにはならない</li>
<li><p>Android Wear 2.0 はアプリが少ない</p></li>
<li><p>LILO の歴史 <a href="https://lilo.linux.or.jp/history/">https://lilo.linux.or.jp/history/</a></p></li>
<li>今年で 20 年</li>
<li>インストールからサポートする場、九州でやっているから関西でも、というのが発足理由</li>
<li>Samba の話で 150 人ぐらいきたことがあるのがピーク</li>
<li>普通は多くて50人ぐらい</li>
<li>普通は10から20人ぐらい</li>
<li>タコを育てようという文化</li>
<li>JF がすばらしい</li>
<li>Linux は初心者を大切にするのが良い</li>
<li><a href="https://twitter.com/xoxyuxu/status/860737579657732098">https://twitter.com/xoxyuxu/status/860737579657732098</a> JFは素晴らしい(ドキュメントがあることは素晴らしい) タコを育てよ(判らないことがある環境が悪い,という考え方)</li>
<li>みんないろんなものを持ってきていた</li>
<li>NAIST でやっていた奈良時代</li>
<li>場所が先端</li>
<li>デスクトップマシンを持ってくるのが普通</li>
<li>Doom をやりたくて Linux を入れた人もいる</li>
<li>Enlightment は昔からかっこいい</li>
<li>昔は重かったが時代が変わって今は軽い</li>
<li>Tizen にのっているので今も開発は活発</li>
<li>第3回のアンケート結果</li>
<li>2002年より後の歴史は分散していてまとまっていない</li>
<li>Wiki にある <a href="https://lilo.linux.or.jp/wiki/history">https://lilo.linux.or.jp/wiki/history</a></li>
<li>トップから辿れる一覧ページもある <a href="https://lilo.linux.or.jp/event/">https://lilo.linux.or.jp/event/</a></li>
<li>LMS だけ別ページ <a href="https://lilo.linux.or.jp/event/lms/">https://lilo.linux.or.jp/event/lms/</a></li>
</ul>


<h2>さかのしたさん</h2>

<ul>
<li>「Google map 印刷 制約」で検索</li>
<li><a href="https://www.google.co.jp/intl/ja/permissions/geoguidelines.html">https://www.google.co.jp/intl/ja/permissions/geoguidelines.html</a></li>
<li>Google Map は使用に制限がある</li>
<li>Open Street Map</li>
<li>facebook のチェックインなどに使われている</li>
<li>overpass turbo</li>
<li>f4map - 延暦寺</li>
<li><a href="https://www.netfort.gr.jp/~saka/accessmap/">OSM Access Map</a> というのを作った</li>
<li>道路のみの画像を保存できる</li>
<li>道路の区別は実データを元にご意見募集中</li>
<li>ゼンリンが地図グッズを売っている <a href="http://www.zenrin.co.jp/goods/matimati/item/">http://www.zenrin.co.jp/goods/matimati/item/</a></li>
<li>SUZURI でグッズを売る?</li>
<li>5月20日(土) 【西国街道#04】摂津富田の街並みと寺社巡り <a href="https://countries-romantic.connpass.com/event/56126/">https://countries-romantic.connpass.com/event/56126/</a></li>
</ul>


<h2>やまうちさん</h2>

<ul>
<li>実践IOTハウス 古いPCで</li>
<li>Tocos 無線モジュール</li>
<li>Raspberry Pi が遅いので古い PC に置き換え</li>
<li>Linux Beans</li>
<li>TOCOS TWE-Lite と ToCoStick で簡易照度センサー(100均電卓)</li>
<li>太陽電池部分の電圧をとっている</li>
<li>デモはうまく動かず</li>
</ul>


<h2>休憩</h2>

<ul>
<li>懇親会参加予定は 10 名</li>
<li>会場費は 100 円</li>
</ul>


<h2>もりわかさん</h2>

<ul>
<li><a href="https://developers.redhat.com/">https://developers.redhat.com/</a></li>
<li>登録すると 1 年間無料で開発用途に使える</li>
<li>1 年後に更新すればずっと使える</li>
<li>シェルスクリプト10行ぐらい書くよねという話</li>
<li>JBoss などもある</li>
<li>ナレッジベースやドキュメントにもアクセスできる</li>
<li>質の高いドキュメント</li>
<li>実マシン1台という制限があるが、VM の制限はないのですごいマシンを用意して 100 VM とかでも OK</li>
<li>会社で開発者がそれぞれ登録して手元のマシンはそれで動かすと言うのもあり</li>
<li>バグかどうか困ったらサポートを買うのが良い</li>
</ul>


<h2>のがたさん</h2>

<ul>
<li><a href="http://gihyo.jp/admin/serial/01/ubuntu-recipe/0462">第462回　韓国開催，Korea Community Day参加レポート 〜Ubuntu KRのみなさんと交流してきました：Ubuntu Weekly Recipe｜gihyo.jp … 技術評論社</a></li>
<li>記事とは違う話を</li>
<li><a href="http://cogniti.github.io/nimf/ja/">http://cogniti.github.io/nimf/ja/</a> (ibus などの層のもの) の開発者の人と Google 翻訳を使って話をした</li>
<li>Google 翻訳は韓国語と日本語の翻訳はスラングなどを使わずきれいに話せば精度良く翻訳できるので、突っ込んだ話もできた</li>
<li>Samsung と Tizen</li>
<li>言語が違うだけでやっていることは同じだと思った話</li>
</ul>


<h2>ぉゅぅさん</h2>

<ul>
<li>Ext4 filesystem ではまった話</li>
<li>32 bit OS だと 16TiB まで</li>
<li>ブロックアロケータまで調べた</li>
<li><code>posix_fallocate</code></li>
<li><a href="http://www.ujiya.net/linux/">http://www.ujiya.net/linux/</a></li>
</ul>


<h2>今後の予定</h2>

<ul>
<li>次回はたぶん 8 月</li>
</ul>


<h2>発表した内容</h2>

<p>スライドはいつも通り <a href="http://slide.rabbit-shocker.org/authors/znz/lilo-20170506/">Rabbit Slide Show</a> (<a href="https://rubygems.org/gems/rabbit-slide-znz-lilo-20170506">RubyGems</a>), <a href="https://slideshare.net/znzjp/lilolinuxorjp-20175">SlideShare</a>, <a href="https://speakerdeck.com/u/znz/p/lilo-dot-linux-dot-or-dot-jp-falsehua-2017nian-5yue">Speaker Deck</a> にあげています。(ソースは <a href="https://github.com/znz/lilo-20170506">github</a> にあげています。)</p>

<iframe src="https://slide.rabbit-shocker.org/authors/znz/lilo-20170506/viewer.html"
        width="640" height="524"
        frameborder="0"
        marginwidth="0"
        marginheight="0"
        scrolling="no"
        style="border: 1px solid #ccc; border-width: 1px 1px 0; margin-bottom: 5px"
        allowfullscreen> </iframe>


<div style="margin-bottom: 5px">
  <a href="https://slide.rabbit-shocker.org/authors/znz/lilo-20170506/" title="lilo.linux.or.jp の話 (2017年5月)">lilo.linux.or.jp の話 (2017年5月)</a>
</div>


<h2>Togetter まとめ</h2>

<p><a href="https://togetter.com/li/1107707">LILO&amp;東海道らぐオフラインミーティング 2017/05/06の記録 - Togetterまとめ</a>にまとめられているようです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[関西 Debian 勉強会 + openSUSE Meetup + LILO & 東海道らぐLT大会に参加しました]]></title>
    <link href="http://blog.n-z.jp/blog/2017-01-29-kansai4cjointsession.html"/>
    <updated>2017-01-29T13:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/kansai4cjointsession</id>
    <content type="html"><![CDATA[<p><a href="https://opensuseja.connpass.com/event/47907/" title="関西 Debian 勉強会 + openSUSE Meetup + LILO &amp; 東海道らぐLT大会">関西 Debian 勉強会 + openSUSE Meetup + LILO &amp; 東海道らぐLT大会</a>
に参加しました。</p>

<!--more-->


<h2>自己紹介など</h2>

<ul>
<li>人数が多いので、一言ずつの自己紹介と出欠チェックのための connpass のアカウントの申告でした。</li>
<li>会場費は人数が多かったのと学生が少なかったので、学生無料で社会人 100 円になりました。</li>
<li>Debian の発表者の到着が遅れていたので、順番が入れ替えになりました。</li>
<li>ハッシュタグは connpass のページに書いてあるように <code>#Kansai4cJointSession</code></li>
</ul>


<h2>Leap 42.2, 42.3とAsia Summitについて語る</h2>

<ul>
<li>Tumbleweed : 常に最新 (ローリングリリース)</li>
<li>Leap : 安定</li>
<li>Leap 42 系は 42.1 が最初</li>
<li>デスクトップ環境のデフォルトは存在しないが KDE Plasma を使っている人が多いらしい</li>
<li>YaST は GUI, TUI でいろいろ設定できる</li>
<li>パーティショニングから fstab の設定までまとめてできる</li>
<li>Samba の共有の設定も簡単にできる</li>
<li>YaST2 と YaST の違い : 特にない? 会場にいる人は YaST1 の頃を誰も知らなかった。 Ruby に書き換わった時も YaST3 にはならなかった。</li>
<li>openSUSE.Asia Summit</li>
<li><a href="http://blog.geeko.jp/ftake/1405">http://blog.geeko.jp/ftake/1405</a></li>
<li>KDE の翻訳が危うい</li>
</ul>


<h2>openSUSE Build Serviceへの愛を語る</h2>

<ul>
<li>etckeeper や tamago などのパッケージのメンテナ</li>
<li>デフォルトのファイルシステムが btrfs</li>
<li>VirtualBox のゲスト OS としてインストールしたら Guest Additions が最初から入っている</li>
<li>DE (デスクトップ環境) が選べるからというのがカメレオン (Geeko) の由来らしい</li>
<li>1枚のインストーラDVDで複数DE、複数ロケール対応</li>
<li>dpkg 系は git build package が楽なのでは? → 会場から CI などに使える一式の環境が一発で用意できるのが良いという話</li>
<li>アカウントは Novell のシングルサインオン</li>
<li>OBS にログインして実演</li>
<li>github の fork 的なこともできる</li>
<li>ビルドされたパッケージを公開するかどうかを選べる</li>
<li>ビルドされたパッケージのユーザーとしては Ubuntu PPA のように使える</li>
<li>github の pull request のようなこともできる (Submit Request)</li>
<li>spec ファイルに clean 処理が不要</li>
<li>OBS の弱点はネットに繋がっていないとほとんど何もできない</li>
<li><a href="http://miniconf.debian.or.jp/">Mini Debian Conference Japan 2016</a> の Open Build Service in Debian の資料も参照</li>
<li>upstream が git だった場合の話</li>
</ul>


<h2>Debian Updates</h2>

<ul>
<li>到着が遅れた話</li>
<li>LaTeX Beamer のテーマを更新した話</li>
<li>Debian とは?</li>
<li>Debian Updates</li>
<li>autoreconf の話</li>
<li>autoconf-archive パッケージがあるので古い autoconf に依存しているものも動く</li>
<li>Next Debian Release</li>
<li>ビルドインフラが足りないからサポートアーキテクチャから落ちる話</li>
<li>新テーマ Soft waves</li>
<li>Tシャツが作りにくい</li>
<li><a href="https://wiki.debian.org/DebianDesktop/Artwork/Stretch">https://wiki.debian.org/DebianDesktop/Artwork/Stretch</a></li>
<li>PHP5 が消える話</li>
<li>Wayland の話</li>
<li>emacs 25 があるが emacs で入るのは 24</li>
<li>vim が 8</li>
<li>Linux kernel は 4.9 が LTS <a href="https://lkml.org/lkml/2017/1/19/339">https://lkml.org/lkml/2017/1/19/339</a></li>
<li>KDE Connect</li>
</ul>


<h2>集合写真</h2>

<p>休憩時間に集合写真を撮りました。</p>

<h2>LT 大会</h2>

<ul>
<li>Debian を Windows タブレットに入れる話</li>
<li><a href="https://github.com/znz/rabbit-slide-ssh-ed25519">sshでed25519鍵</a> の話をしました。(<a href="/blog/2016-12-04-ssh-ed25519.html">sshでed25519鍵を使うようにした話</a>と基本的に同じ内容なので、スライドサイトへの公開はしていません。)</li>
<li>16進数が好きになりました</li>
<li>年末恒例、IM飲み会に行ってみた</li>
<li>Debconf 16, cape town, South Africa</li>
</ul>


<h2>今後の予定の告知</h2>

<ul>
<li><a href="https://wiki.debian.org/KansaiDebianMeeting">https://wiki.debian.org/KansaiDebianMeeting</a></li>
<li><a href="https://lilo.linux.or.jp/">https://lilo.linux.or.jp/</a></li>
<li><a href="https://histudy.github.io/">姫路IT系勉強会</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LILO&東海道らぐオフラインミーティング 2017/01/07]]></title>
    <link href="http://blog.n-z.jp/blog/2017-01-07-lilo-tokaidolug.html"/>
    <updated>2017-01-07T13:20:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/lilo-tokaidolug</id>
    <content type="html"><![CDATA[<p><a href="https://lilo.connpass.com/event/47841/" title="LILO&amp;東海道らぐオフラインミーティング 2017/01/07">LILO&amp;東海道らぐオフラインミーティング 2017/01/07</a> に参加しました。</p>

<p>今回もアンカンファレンス形式でした。</p>

<!--more-->


<h2>メモ</h2>

<p>今回のメモです。</p>

<ul>
<li>本を読んでいたら電車を乗り過ごしてしまって一度梅田まで行ってしまってちょっと遅くなりました。(開始時刻の13時には間に合いました。)</li>
<li>会場の建物は同じでも、いつもの4階と違って6階でした。</li>
<li>ハッシュタグ: <code>#lilo_jp</code> <code>#東海道らぐ</code></li>
<li>登録参加者数 8名</li>
<li>自己紹介から</li>
<li><a href="https://opensuseja.connpass.com/event/47907/" title="関西 Debian 勉強会 + openSUSE Meetup + LILO &amp; 東海道らぐLT大会">関西 Debian 勉強会 + openSUSE Meetup + LILO &amp; 東海道らぐLT大会</a></li>
<li>ラズパイで音楽 (山内さん)</li>
<li>サンハヤトのハイレゾオーディオDACボード AS-E404RAS</li>
<li>Volumio</li>
<li>Spotify</li>
<li>AirPlay対応スピーカーにできた</li>
<li>lilo.linux.or.jp のサーバー管理の話 (自分)</li>
<li>unattended-upgrades の公式っぽさを確認するにはメンテナをみればいいのではという話があったので確認してみたところ、 unattended-upgrades のメンテナを確認すると apt のメンテナの一人でした。 cron-apt のメンテナは全然別の人でした。</li>
<li>休憩</li>
<li>LibreOffice Kaigi 2016.12 の時の資料を使っての話 (榎さん)</li>
<li>LibreOffice Conference の話</li>
<li>Debian を再インストールした話 (さとうさん)</li>
<li>OSM の話 (さかのしたさん)</li>
<li>Overpass API</li>
<li>umap</li>
<li>LOF の LILO 展示の復習 (まるいちさん)</li>
<li>gPhoto2</li>
<li>最後にまた <a href="https://opensuseja.connpass.com/event/47907/" title="関西 Debian 勉強会 + openSUSE Meetup + LILO &amp; 東海道らぐLT大会">関西 Debian 勉強会 + openSUSE Meetup + LILO &amp; 東海道らぐLT大会</a> についての案内</li>
</ul>


<h2>発表した内容</h2>

<p>スライドはいつも通り <a href="http://slide.rabbit-shocker.org/authors/znz/lilo-20170107/">Rabbit Slide Show</a> (<a href="https://rubygems.org/gems/rabbit-slide-znz-lilo-20170107">RubyGems</a>), <a href="https://slideshare.net/znzjp/lilolinuxorjp-20171">SlideShare</a>, <a href="https://speakerdeck.com/u/znz/p/lilo-dot-linux-dot-or-dot-jp-falsehua-2017nian-1yue">Speaker Deck</a> にあげています。(ソースは <a href="https://github.com/znz/lilo-20170107">github</a> にあげています。)</p>

<iframe src="https://slide.rabbit-shocker.org/authors/znz/lilo-20170107/viewer.html"
        width="640" height="524"
        frameborder="0"
        marginwidth="0"
        marginheight="0"
        scrolling="no"
        style="border: 1px solid #ccc; border-width: 1px 1px 0; margin-bottom: 5px"
        allowfullscreen> </iframe>


<div style="margin-bottom: 5px">
  <a href="https://slide.rabbit-shocker.org/authors/znz/lilo-20170107/" title="lilo.linux.or.jp の話 (2017年1月)">lilo.linux.or.jp の話 (2017年1月)</a>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[jessie の certbot が 0.9.3 に上がったので設定を変更した]]></title>
    <link href="http://blog.n-z.jp/blog/2016-11-08-certbot-0-dot-9-3.html"/>
    <updated>2016-11-08T23:14:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/certbot-0-dot-9-3</id>
    <content type="html"><![CDATA[<p>jessie の certbot が 0.9.3 に上がって、
<code>/etc/cron.d/certbot</code> よりも systemd の <code>certbot.timer</code> が優先して動くように変わったので、
reload に post-hook を使うように変えたり、
ログの差分メールの仕組みを変えたりしました。</p>

<!--more-->


<h2>今までの方法</h2>

<p>今までは <code>/etc/cron.daily/local-letsencrypt</code> で <code>certbot renew</code> を呼び出して、ログを保存して <code>diff</code> を出力して cron からメールを送信させて、
<code>reload</code> は更新の有無にかかわらず実行していました。</p>

<pre><code class="sh">#!/bin/sh
LOGFILE=/var/log/certbot-renew.log
if [ -f "$LOGFILE" ]; then
    savelog -c 90 -q "$LOGFILE"
fi
if ! certbot renew &gt; "$LOGFILE" 2&gt;&amp;1 ; then
    echo Automated renewal failed:
    cat "$LOGFILE"
    exit 1
fi
if [ -f "$LOGFILE".0 ]; then
    diff -u "$LOGFILE".0 "$LOGFILE"
fi
apachectl graceful
service postfix reload
</code></pre>

<h2>certbot パッケージでインストールされた自動更新の仕組み</h2>

<p><code>/etc/cron.d/certbot</code> は <code>/run/systemd/system</code> をチェックして普通は動かないようになっていました。</p>

<pre><code> % cat /etc/cron.d/certbot
 # /etc/cron.d/certbot: crontab entries for the certbot package
 #
 # Upstream recommends attempting renewal twice a day
 #
 # Eventually, this will be an opportunity to validate certificates
 # haven't been revoked, etc.  Renewal will only occur if expiration
 # is within 30 days.
 SHELL=/bin/sh
 PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

 0 */12 * * * root test -x /usr/bin/certbot -a \! -d /run/systemd/system &amp;&amp; perl -e 'sleep int(rand(3600))' &amp;&amp; certbot -q renew
</code></pre>

<p>systemd の方では、<code>timer</code> から動かすため、有効化されていない <code>certbot.service</code> と、 service を動かすための <code>certbot.timer</code> が入っていました。</p>

<pre><code>% cat /lib/systemd/system/certbot.service
[Unit]
Description=Certbot
Documentation=file:///usr/share/doc/python-certbot-doc/html/index.html
Documentation=https://letsencrypt.readthedocs.io/en/latest/
[Service]
Type=oneshot
ExecStart=/usr/bin/certbot -q renew
PrivateTmp=true
% cat /lib/systemd/system/certbot.timer
[Unit]
Description=Run certbot twice daily

[Timer]
OnCalendar=*-*-* 00,12:00:00
RandomizedDelaySec=3600
Persistent=true

[Install]
WantedBy=timers.target
</code></pre>

<p><code>OnCalendar</code> で毎日 00:00:00 と 12:00:00 に動くようになっていました。
<code>RandomizedDelaySec</code> でランダムな遅延の設定をしようとしているようですが、
jessie の systemd は対応していないようで、
<code>systemd[1]: [/lib/systemd/system/certbot.timer:6] Unknown lvalue 'RandomizedDelaySec' in section 'Timer'</code>
というログが出ていました。
(<a href="https://bugs.debian.org/843607" title="#843607 - certbot: Unknown lvalue 'RandomizedDelaySec' in section 'Timer'">#843607 - certbot: Unknown lvalue &lsquo;RandomizedDelaySec&rsquo; in section &lsquo;Timer&rsquo;</a> として報告済みです。)</p>

<h2>ログの diff のメール送信方法変更</h2>

<p>設定を追加するには <code>/etc/systemd/system/certbot.service.d</code> にファイルをおけば良いので、
以下の内容の <code>/etc/systemd/system/certbot.service.d/diffmail.conf</code> を作成しました。</p>

<p><code>certbot.service</code> の <code>ExecStart=/usr/bin/certbot -q renew</code> の後に実行したかったので、
<code>ExecStopPost</code> を使ってみました。</p>

<pre><code>[Service]
ExecStopPost=/bin/bash -c "diff -u &lt;(cut -d: -f4- /var/log/letsencrypt/letsencrypt.log.1 | egrep -v '^DEBUG') &lt;(cut -d: -f4- /var/log/letsencrypt/letsencrypt.log | egrep -v '^DEBUG') | ifne mail -s 'Change certbot log' root"
</code></pre>

<p>前回のログ (<code>letsencrypt.log.1</code>) と今回のログ (<code>letsencrypt.log</code>) から、必ず差分になってしまう時刻を <code>cut</code> で削って、さらに DEBUG ログの中にも現在日時で変化する部分があったので除外するようにしてから差分をとっています。</p>

<p>そして <a href="https://packages.debian.org/moreutils" title="moreutils">moreutils</a> の <code>ifne</code> を使って差分があるときだけメール送信をするようにしています。</p>

<h2>post-hook への変更</h2>

<p>systemd の <code>ExecStart</code> を書き換えるのは、メンテナンスしにくいとか、手動で <code>certbot renew</code> を実行したときに使われないなど、あまりよくないかと思い、
<code>/etc/letsencrypt/cli.ini</code> で設定することにしました。</p>

<p>letsencrypt の証明書を apache のみで使っているサーバーでは post-hook にリロードするコマンドを直接設定しました。</p>

<p>ついでに <code>rsa-key-size</code> も 2048 から 4096 に変更するようにしました。</p>

<pre><code>% cat /etc/letsencrypt/cli.ini
rsa-key-size = 4096
post-hook = apachectl graceful
</code></pre>

<h2>複数コマンドの post-hook</h2>

<p><code>post-hook = apachectl graceful; service postfix reload &gt;/dev/null</code> のような書き方は
<code>certbot: error: Unexpected line 1 in /etc/letsencrypt/cli.ini: post-hook = apachectl graceful; service postfix reload &gt;/dev/null</code>
というエラーになってうまくいかなかったので、
<code>/etc/letsencrypt/post-hook</code> に実行ファイルを作って、それを post-hook に指定することにしました。</p>

<pre><code> % sudoedit /etc/letsencrypt/cli.ini
 % sudoedit /etc/letsencrypt/post-hook
 % sudo chmod +x /etc/letsencrypt/post-hook
 % cat /etc/letsencrypt/cli.ini
 rsa-key-size = 4096
 post-hook = /etc/letsencrypt/post-hook
 % cat /etc/letsencrypt/post-hook
 #!/bin/sh
 apachectl graceful
 service postfix reload &gt;/dev/null
</code></pre>

<h2>テスト実行</h2>

<p><code>sudo certbot renew</code> で試しに実行してみたところ、以下のような感じで更新の必要がないときは <code>post-hook</code> は実行されないことが確認できました。</p>

<pre><code>% sudo certbot renew
Saving debug log to /var/log/letsencrypt/letsencrypt.log

-------------------------------------------------------------------------------
Processing /etc/letsencrypt/renewal/www.example.org.conf
-------------------------------------------------------------------------------
Cert not yet due for renewal

The following certs are not due for renewal yet:
  /etc/letsencrypt/live/www.example.org/fullchain.pem (skipped)
No renewals were attempted.
No renewals attempted, so not running post-hook
</code></pre>

<h2>まとめ</h2>

<p><code>certbot renew</code> で証明書が更新されたときに実行したいことは <code>post-hook</code> に、
証明書の更新とは関係なく毎回実行したいことは systemd の <code>ExecStopPost</code> を使えば良いことがわかりました。</p>

<p>certbot の hook には <code>post-hook</code> 以外に <code>pre-hook</code> と <code>renew-hook</code> もあるので、
用途によってはそちらも使えそうです。
(<code>webroot</code> プラグインを使っているので使っていませんが、
<code>standalone</code> プラグインを使っているのなら <code>pre-hook</code> で <code>stop</code> して <code>post-hook</code> で <code>start</code> するとか、
<code>renew-hook</code> で更新されたドメインに応じて必要な時だけ <code>postfix reload</code> するとか)</p>
]]></content>
  </entry>
  
</feed>
