<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: linux | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/linux/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2018-01-23T21:21:47+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[gitolite から gitolite3 への移行]]></title>
    <link href="http://blog.n-z.jp/blog/2018-01-23-migrate-gitolite3.html"/>
    <updated>2018-01-23T21:16:34+09:00</updated>
    <id>http://blog.n-z.jp/blog/migrate-gitolite3</id>
    <content type="html"><![CDATA[<p>Ubuntu 14.04.5 (trusty) から 16.04.3 (xenial) に更新したら、 gitolite パッケージが消えてしまって、 gitolite3 で設定し直す必要がありました。</p>

<!--more-->


<h2>環境</h2>

<ul>
<li>Ubuntu 14.04.5 (trusty) から 16.04.3 (xenial)</li>
<li>gitolite 2.3-1 から gitolite3 3.6.4-1</li>
</ul>


<h2>gitolite3 パッケージのインストール</h2>

<p>「gitolite のアクセス設定を管理するユーザの鍵を指定」では「gitolite version 2.x から移行する場合は空白にしてください。」と書いてあったので空欄のままにしました。</p>

<pre><code>% sudo apt install gitolite3
[sudo] password for adminuser@ns6:
パッケージリストを読み込んでいます... 完了
依存関係ツリーを作成しています
状態情報を読み取っています... 完了
以下の追加パッケージがインストールされます:
  libcommon-sense-perl libjson-perl libjson-xs-perl libtypes-serialiser-perl
提案パッケージ:
  git-daemon-sysvinit gitweb
以下のパッケージが新たにインストールされます:
  gitolite3 libcommon-sense-perl libjson-perl libjson-xs-perl libtypes-serialiser-perl
アップグレード: 0 個、新規インストール: 5 個、削除: 0 個、保留: 0 個。
292 kB のアーカイブを取得する必要があります。
この操作後に追加で 970 kB のディスク容量が消費されます。
続行しますか? [Y/n]
</code></pre>

<h2>migrate</h2>

<p><a href="http://gitolite.com/gitolite/migr/index.html">migrating from gitolite v2</a> をみると gitolite-admin/conf/gitolite.conf で <code>NAME/</code> ルールを使っている場合は書き換えが必要とありましたが、 <code>RW+</code> と <code>R</code> しか使っていなかったので、そのままで大丈夫そうでした。</p>

<p>移行手順には、はっきりとは書いていませんでしたが、後は <code>gitolite setup</code> を実行するだけでした。</p>

<pre><code>% sudo su - git
$ gitolite setup

FATAL: '/home/git/.gitolite.rc' seems to be for older gitolite; please see
http://gitolite.com/gitolite/migr.html
$
</code></pre>

<p><code>-pk</code> で公開鍵を指定しても同じエラーでした。</p>

<p><code>.gitolite.rc</code> は変更した覚えがなかったので、リネームして再実行したところ、正常終了しました。</p>

<pre><code>$ mv .gitolite.rc .gitolite.rc.v2
$ gitolite setup
$
</code></pre>

<p>その後、 ssh 経由で接続確認したところ、問題なく使えるようになっていました。</p>

<h2>まとめ</h2>

<p>gitolite3 への移行手順の情報があまりなかったようなので、書いてみました。
基本的には gitolite3 パッケージを入れて <code>gitolite setup</code> を実行するだけでした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ubuntu 14.04.5 (trusty) から 16.04.3 (xenial) に更新したら subversion が壊れた話]]></title>
    <link href="http://blog.n-z.jp/blog/2018-01-22-ubuntu-broken-svn.html"/>
    <updated>2018-01-22T21:17:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/ubuntu-broken-svn</id>
    <content type="html"><![CDATA[<p>subversion のレポジトリを置いているサーバーを Ubuntu 14.04.5 (trusty) から 16.04.3 (xenial) に更新したら <a href="https://bugs.launchpad.net/ubuntu/+source/subversion/+bug/1639406">Old repository can&rsquo;t be read: svn: E125012: Invalid character in hex checksum</a> の影響でコミットできなくなったので、他の環境にコピーして直した話です。</p>

<!--more-->


<h2>環境</h2>

<ul>
<li>壊れた環境: Ubuntu 14.04.5 (trusty) から 16.04.3 (xenial)</li>
<li>svnadmin dump に使った環境: Debian GNU/Linux 9</li>
</ul>


<h2>現象</h2>

<p>レポジトリを置いているサーバーの Ubuntu のバージョンをあげたら <code>svn: E125012: Invalid character in hex checksum</code> とでるようになって svn ci などができなくなりました。</p>

<p><a href="https://bugs.launchpad.net/ubuntu/+source/subversion/+bug/1639406">Old repository can&rsquo;t be read: svn: E125012: Invalid character in hex checksum</a> によると subversion の upstream ではなおっていて、 Ubuntu xenial では1年以上も放置されていて、修正される望みは薄いと思いました。</p>

<h2>復旧作業</h2>

<p>svnadmin dump/load で復旧できるとあったので、 svnadmin dump しようとしましたが、壊れた環境では svnadmin dump もできなかったので、一時的に他の環境に持っていって dump することにしました。</p>

<ul>
<li>壊れた環境で tarball 作成: <code>time tar acvf ~/repo.tar.xz repo</code></li>
<li>別環境にコピー: <code>scp svn@server:repo.tar.xz .</code></li>
<li>別環境でダンプ: <code>tar xf repo.tar.xz; time svnadmin dump repo &gt; repo.svndump</code></li>
<li>ダンプをコピー: <code>xz -k repo.svndump; ls -lh repo.svndump*; scp repo.svndump.xz svn@server:</code></li>
<li>load: <code>mv repo repo-2017; rm -rf repo-2017; svnadmin create repo; xzcat repo.svndump.xz | svnadmin load repo</code></li>
<li><p>(一度 mv しているのは履歴で最新のレポジトリを消してしまう事故を防ぐため)</p></li>
<li><p>以下のエラーが出たのでオプションを追加して再実行: <code>mv repo repo-2017; rm -rf repo-2017; svnadmin create repo; xzcat repo.svndump.xz | svnadmin load --bypass-prop-validation repo</code></p></li>
</ul>


<pre><code>    svnadmin: E125005: Invalid property value found in dumpstream; consider repairing the source or using --bypass-prop-validation while loading.
    svnadmin: E125005: Cannot accept 'svn:log' property because it is not encoded in UTF-8
</code></pre>

<h2>まとめ</h2>

<p>E125012 の復旧方法についての日本語の記事が見当たらなかったので、まとめると svnadmin dump/load するというだけですが、書いてみました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[webhook でサイトの git pull をする設定をした]]></title>
    <link href="http://blog.n-z.jp/blog/2018-01-03-webhook-git-pull.html"/>
    <updated>2018-01-03T18:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/webhook-git-pull</id>
    <content type="html"><![CDATA[<p>GitLab.com に git push した時に webhook で通知を受け取って git pull という設定をしました。</p>

<p>方針としては Web サーバーの実行ユーザー権限の cgi で通知用のファイルを更新して、 systemd の <code>*.path</code> で監視して、別途ディレクトリの所有者権限でアップデートのシェルスクリプトを実行して、アップデートのログは journald に任せるという感じにしました。</p>

<!--more-->


<h2>GitLab.com の設定</h2>

<p>Webhook が使えるシステムなら GitHub などでも同様に設定可能だと思います。</p>

<ul>
<li>Settings - Integrations で Webhooks 設定</li>
<li>URL: <code>https://lilo.linux.or.jp/trigger/update.cgi</code> のような感じ</li>
<li>Secret Token あり</li>
<li>Trigger : Push events のみ</li>
<li>Enable SSL verification はチェックありのまま</li>
</ul>


<h2>trigger cgi</h2>

<p>URL がわかっていても Secret Token がちゃんと設定されていないリクエストはエラーを返すようにしました。</p>

<p>内容はチェックせずに通知用のファイルにリクエスト内容をそのまま書き込んでデバッグ用に使えるようにしました。</p>

<p><code>/home/www</code> は CGI の権限で書き込めるディレクトリです。</p>

<pre><code class="sh">#!/bin/sh
set -e
if [ x"$HTTP_X_GITLAB_TOKEN" = x"XXXXXXXXXXXXXXXXXXXX" ]; then
  cat &gt; /home/www/trigger_update_web
  echo "Content-Type: text/plain; charset=utf-8"
  echo
  echo OK
else
  echo "Status: 403"
  echo "Content-Type: text/plain; charset=utf-8"
  echo
  echo NG
fi
</code></pre>

<h2>systemd の設定追加</h2>

<p>後述のファイルを以下のように追加して設定しました。</p>

<pre><code>  sudo cp lilo_web_update.path /etc/systemd/system
  sudo cp lilo_web_update.service /etc/systemd/system
  sudo systemctl daemon-reload
  sudo systemctl start lilo_web_update.path
</code></pre>

<h2><code>lilo_web_update.path</code></h2>

<p><code>trigger_update_web</code> ファイルを <code>PathModified</code> で監視して変化があれば <code>lilo_web_update.service</code> を実行するようにしました。</p>

<pre><code>[Unit]
Description=Trigger update web

[Path]
PathModified=/home/www/trigger_update_web

[Install]
WantedBy=muti-user.target
</code></pre>

<h2><code>lilo_web_update.service</code></h2>

<p>Web コンテンツに書き込めるユーザーでシェルスクリプトを実行します。</p>

<pre><code>[Unit]
Description=Update web

[Service]
Type=oneshot
ExecStart=/path/to/lilo_web_update.sh
User=someuser
Group=someuser
</code></pre>

<h2><code>lilo_web_update.sh</code></h2>

<p>flock コマンドで同時実行を抑制 (同時実行は後の方が失敗終了) した上で、何か変更されていたらそれを捨てて、 <code>git pull</code> でリモートのコンテンツで上書きするようにしています。</p>

<p>とりあえず自分が知っているコマンドの中でクリーンにできるものとして <code>git checkout .</code> と <code>git clean -dfx</code> を使っているだけなので、もっと良い方法があるかもしれません。</p>

<pre><code class="bash">#!/bin/bash
set -euxo pipefail
exec {lock_fd}&lt;"$0"
flock --nonblock "${lock_fd}"
cd "$(dirname "$0")/.."
git checkout .
git clean -dfx
git pull
</code></pre>

<h2>apache2 設定</h2>

<p>trigger ディレクトリに cgi-bin の設定を参考にして ExecCGI と AddHandler の設定をしました。</p>

<pre><code>&lt;Directory /path/to/trigger/&gt;
        AllowOverride None
        Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
        Require all granted
        AddHandler cgi-script .cgi
&lt;/Directory&gt;
</code></pre>

<p><code>/etc/apache2/conf-enabled/security.conf</code> の <code>.svn*</code> へのアクセスを禁止する設定を参考にして、 <code>.git*</code> へのアクセスを禁止しました。</p>

<pre><code>&lt;DirectoryMatch "/\.git"&gt;
   Require all denied
&lt;/DirectoryMatch&gt;
</code></pre>

<h2>動作確認</h2>

<ul>
<li><code>sudo -u someuser /path/to/lilo_web_update.sh</code> で git pull の動作確認</li>
<li><code>touch /home/www/trigger_update_web</code> と <code>sudo systemctl status lilo_web_update.service</code> で PathModified 経由での実行確認</li>
<li><code>curl -H 'X-Gitlab-Token: XXXXXXXXXXXXXXXXXXXX' https://lilo.linux.or.jp/trigger/update.cgi</code> で webhook 経由での動作確認</li>
</ul>


<h2>まとめ</h2>

<p>git push で webhook 経由でコンテンツを更新して、 journald でログを確認できるシステムを構築しました。
Unix 的にそれぞれは大した設定はしていないのですが、組み合わせるとそれなりの設定量になりました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LILO 20周年記念ミートアップに参加しました]]></title>
    <link href="http://blog.n-z.jp/blog/2017-12-17-lilo-event.html"/>
    <updated>2017-12-17T23:06:45+09:00</updated>
    <id>http://blog.n-z.jp/blog/lilo-event</id>
    <content type="html"><![CDATA[<p><a href="https://lilo.connpass.com/event/73932/">LILO 20周年記念ミートアップ</a>に参加しました。
いくつか事前に発表されていたものもありましたが、他はいつも通りアンカンファレンス形式でした。</p>

<!--more-->


<p>以下、メモです。</p>

<h2>会場</h2>

<p>いつもより遅い14時からでした。</p>

<h2>オープニング</h2>

<ul>
<li>自己紹介案: 名前, いつから Linux を使っているのか?, 初めて使った Linux ディストリビューション, 最近の Linux の使い方</li>
<li>会場費とか会計の話とか (結局プールされているお金があるので、今回は参加費は無料だった)</li>
<li>ハッシュタグは <code>#lilo_jp</code></li>
</ul>


<h2>自己紹介など</h2>

<ul>
<li>名前, いつから Linux を使っているのか?, 初めて使った Linux ディストリビューション, 最近の Linux の使い方</li>
<li>好きなディストリビューション: Debian: 7, Gentoo: 1, Vine: 1, Rasbian: 2, Plamo: 2, Ubuntu: 1, CentOS: 1</li>
<li>UNIX: Minix: 1, OS9: 1</li>
<li>好きな言語: AWK: 4, Python: 2, JavaScript: 1, bash: 3, 日本語: 1, C: 3, BASIC09: 1, Perl: 2, Ruby: 1, PHP: 1</li>
<li>libc5 のバージョンアップではまったという話が数人</li>
<li>初めて使ったのは Slackware という人が多かった感じがする</li>
</ul>


<h2>Linuxコミュニティ20年の振返りと学んだ事(もうちょと付け足し版)</h2>

<ul>
<li>GPD Pocket で HDMI がうまく出なかったので Windows で発表</li>
<li>id にこだわりがあるので、取れなかったサービスはあまり利用しない</li>
<li>1997-06-22 から (ML に投稿があって名前が決定した日)</li>
<li>運営者は特にいなくて、その時々でやっている人が違う</li>
<li>linux.or.jp ドメイン管理者の JLA との窓口やさくらインターネットとの窓口はやっている</li>
<li>LinuxMaMa というパッチを集めたサイトがあった</li>
<li>IP マスカレードは最初はここにあって、本体に取り込まれた</li>
<li>Linux JF, Linux JM</li>
<li>linux-users ML の方が LinuxMaMa より後から知った</li>
<li>UNIX が十万円以上する頃に Linux は CD-ROM 代だけで売っていた</li>
<li>営業さんはすごいと感じた話</li>
<li><p>コミュニティはいろんな人がいる</p></li>
<li><p>k-of.jp/2017 の時からの付け足しはお世話になったサイトとお店</p></li>
<li>最近は野良パッチというのはあまり見かけない</li>
<li><p>今は github があるが、昔は SCM が無料というのはなかった</p></li>
<li><p>Google 翻訳などで翻訳のモチベーションが減っているかも</p></li>
<li>英語ができる人しか生き残っていない?</li>
<li>仕様書がない?</li>
<li>ウォーターフォールではない, リーンに近い</li>
<li>開発プロセスも勉強になる</li>
<li><p>コアはきれいだが周辺のデバイスドライバのソースはまちまち</p></li>
<li><p>Windows が嫌いというより (シャットダウン時に時間がかかる) Windows Update が嫌い</p></li>
</ul>


<h2>LILO(7)</h2>

<ul>
<li>LILO の説明を man page にした</li>
<li>LILO(8) だとブートローダーとかぶってしまう</li>
<li>LILO のサイトの複数のページから日付が付いているものを集めた</li>
<li>LibreOffice Calc にまとめて、重複などは TSV を AWK で処理</li>
<li>イベント開催回数は 100 回以上 (141回ぐらい?)</li>
</ul>


<h2>lilo.linux.or.jp の話</h2>

<ul>
<li>いつもの更新情報</li>
<li>GitHub のプライベートリポジトリを使わせてもらっていたのを GitLab.com に変更した</li>
<li>Web コンテンツが非公開なのは内容のライセンスというよりもコミットログが適当なので公開したくないということの方が大きいようでした</li>
<li>発表資料などの置き場所として resources を作った</li>
<li>デフォルトのライセンスも決めた</li>
</ul>


<p>スライドはいつも通り、
- <a href="https://slide.rabbit-shocker.org/authors/znz/lilo-20171217/">Rabbit Slide Show</a>
- <a href="https://slideshare.net/znzjp/lilolinuxorjp-201712">SlideShare</a>
- <a href="https://speakerdeck.com/u/znz/p/lilo-dot-linux-dot-or-dot-jp-falsehua-2017nian-12yue">Speaker Deck</a>
- <a href="https://rubygems.org/gems/rabbit-slide-znz-lilo-20171217">RubyGems.org</a>
- <a href="https://github.com/znz/lilo-20171217">GitHub.com</a>
で公開しています。</p>

<iframe src="https://slide.rabbit-shocker.org/authors/znz/lilo-20171217/viewer.html"
        width="640" height="524"
        frameborder="0"
        marginwidth="0"
        marginheight="0"
        scrolling="no"
        style="border: 1px solid #ccc; border-width: 1px 1px 0; margin-bottom: 5px"
        allowfullscreen> </iframe>


<div style="margin-bottom: 5px">
  <a href="https://slide.rabbit-shocker.org/authors/znz/lilo-20171217/" title="lilo.linux.or.jp の話 (2017年12月)">lilo.linux.or.jp の話 (2017年12月)</a>
</div>


<h2>ライセンス変更の話</h2>

<ul>
<li>Ruby のリファレンスマニュアルは RWiki の頃に仮の適当なライセンス + 変更手順を決めていたので、今は CC にできた</li>
<li>Ruby は 1.9.3 で GPL とのデュアルライセンスから 2条項 BSDL に切り替えた</li>
<li>tdiary は GPL2 から GPL2+ に変わった

<ul>
<li>highlight の著作権者に入っているが、特に個別連絡はなかったので詳細はよくわからない</li>
<li>日本の著作権法では異議申し立てがなければ問題はないはずという意見があった</li>
</ul>
</li>
</ul>


<p>スライドはいつも通り、
- <a href="https://slide.rabbit-shocker.org/authors/znz/change-license/">Rabbit Slide Show</a>
- <a href="https://www.slideshare.net/znzjp/ss-84299220">SlideShare</a>
- <a href="https://speakerdeck.com/znz/raisensubian-geng-falsehua">Speaker Deck</a>
- <a href="https://rubygems.org/gems/rabbit-slide-znz-change-license">RubyGems.org</a>
- <a href="https://github.com/znz/change-license">GitHub.com</a>
で公開しています。</p>

<iframe src="https://slide.rabbit-shocker.org/authors/znz/change-license/viewer.html"
        width="640" height="524"
        frameborder="0"
        marginwidth="0"
        marginheight="0"
        scrolling="no"
        style="border: 1px solid #ccc; border-width: 1px 1px 0; margin-bottom: 5px"
        allowfullscreen> </iframe>


<div style="margin-bottom: 5px">
  <a href="https://slide.rabbit-shocker.org/authors/znz/change-license/" title="ライセンス変更の話">ライセンス変更の話</a>
</div>


<h2>LibreOffice や各地の IT コミュニティ運営について</h2>

<ul>
<li>LILO や KOF などのイベント関連とか</li>
<li>OpenOffice.org や LibreOffice などのソフトウェア関係とか</li>
<li>ノウハウの文書は少ない, <a href="https://www.oreilly.co.jp/books/9784873114958/">アート・オブ・コミュニティ</a> とか</li>
<li>コミュニティの目的によっていろいろ違う</li>
<li>LILO は ML で反論があると意思決定が難しい</li>
<li>connpass に移行して楽になった</li>
<li>やり方は様々</li>
<li>ミッション大事、最初のメンバーで文化が決まる</li>
<li>人のトラブルとか悩ましい</li>
<li>CoC の話</li>
<li>DroidKaigi は毎年スタッフが半分入れ替わるらしい</li>
<li>若い人がいない問題: 諦める or 取りに行く</li>
<li>既存のところに入るより新しく立ち上げた方が活躍しやすい問題</li>
<li>最初の慣なれるための場として活用してもらう?</li>
<li>OSC 広島だとトップを学生にしてみたことがある</li>
<li>LibreOffice コミュニティの話は省略</li>
</ul>


<h2>実数ってナンだ?</h2>

<ul>
<li>人工知能や機械学習をきっかけにして数学を勉強し直した</li>
<li>自然数はここでは1以上 (0 を含む場合もある)</li>
<li>ペアノの公理</li>
<li>自然数→整数→有理数</li>
<li>有理数, 無理数は有比数, 無比数の方がわかりやすかったのに</li>
<li>デデキントの有理数の切断</li>
<li>有理数→無理数</li>
<li>無限の和で近似する話</li>
<li>無限の話</li>
</ul>


<h2>Processing でなんとなく</h2>

<ul>
<li>Processing : アート向けのプログラミング環境</li>
<li>setup と draw</li>
<li>デモ</li>
<li>ランダムに贈りあうシミュレーション</li>
<li><a href="https://gigazine.net/news/20170711-random-people-give-money-to-random-other-people/">https://gigazine.net/news/20170711-random-people-give-money-to-random-other-people/</a></li>
</ul>


<h2>qemu-debootstrap で別アーキテクチャ環境が手軽に使えて便利</h2>

<ul>
<li>arm64 (aarch64) のノート PC Pinebook を買った</li>
<li>chroot と qemu-user-static で別アーキテクチャが使える</li>
<li>Korea Community Day 2018 の紹介 (OSC のようなものらしい)</li>
</ul>


<h2>おっさんの集中力について</h2>

<ul>
<li>適度に運動する</li>
<li>寝ることが重要</li>
<li>食事のデザインも大事</li>
<li>マインドフルネスも大事</li>
<li>スピリチュアル系はやめた方が良い</li>
<li>注意力は限りがある</li>
<li>Task warrior, Time warrior</li>
<li>anki</li>
</ul>


<h2>今後の予定</h2>

<ul>
<li><a href="https://www.ospn.jp/osc2018-osaka/">OSC 2018 Osaka</a> の翌日の 2018-01-28(日) にまた関西Debian勉強会と合同で勉強会をやるらしい</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[gitlab-ci-multi-runner パッケージから gitlab-runner パッケージへの更新]]></title>
    <link href="http://blog.n-z.jp/blog/2017-11-06-gitlab-runner.html"/>
    <updated>2017-11-06T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/gitlab-runner</id>
    <content type="html"><![CDATA[<p>GitLab Runner が 10.0.0 だとパッケージ名が gitlab-runner に変わってしまって、そのままだと 9.5.1 から更新されなくなってしまったので、対応しました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>Ubuntu 16.04.3 LTS</li>
<li>gitlab-ci-multi-runner (9.5.1) から gitlab-runner (10.1.0)</li>
</ul>


<h2>GitLab Runner とは?</h2>

<p><a href="https://docs.gitlab.com/runner/">GitLab Runner</a> とは GitLab CI のジョブを実行する部分のことです。</p>

<p>詳細は<a href="/blog/2017-07-09-gitlab-runner.html">インストール時の記事</a>を参照してください。</p>

<h2>インストール方法</h2>

<p><a href="https://docs.gitlab.com/runner/install/linux-repository.html">Install GitLab Runner using the official GitLab repositories - GitLab Documentation</a> が gitlab-runner に改名後のインストール方法になっているので、参考にして移行しました。</p>

<h2>移行方法</h2>

<p>簡単にまとめると apt の設定を変えて <code>gitlab-runner</code> パッケージを入れ直すだけでした。</p>

<p>GitLab (GitLab CI) への登録や <code>/etc/gitlab-runner/config.toml</code> はそのままで大丈夫でした。</p>

<h2>apt-line の更新</h2>

<p><code>/etc/apt/sources.list.d/</code> 以下に入っている</p>

<pre><code>deb https://packages.gitlab.com/runner/gitlab-ci-multi-runner/ubuntu xenial main
</code></pre>

<p>の apt-line を削除して、</p>

<pre><code>deb https://packages.gitlab.com/runner/gitlab-runner/ubuntu xenial main
</code></pre>

<p>を追加しました。</p>

<h2>pinning 設定変更</h2>

<p><code>/etc/apt/preferences.d/pin-gitlab-runner.pref</code> で <code>gitlab-ci-multi-runner</code> パッケージを <code>packages.gitlab.com</code> のものを優先するように設定していたのを、 <code>gitlab-runner</code> パッケージに変更しました。</p>

<h2>パッケージのインストール</h2>

<p><code>gitlab-runner</code> パッケージをインストールすると自動的に <code>gitlab-ci-multi-runner</code> パッケージと置き換わりました。</p>

<p><code>gitlab-ci-multi-runner</code> パッケージを purge しても <code>/etc/gitlab-runner/config.toml</code> が消えたりすることもないので、特に注意するような点はなさそうでした。</p>

<h2>ansible での例</h2>

<p><a href="https://github.com/znz/ansible-role-gitlab-runner/commit/616a9da561360fbae940940aec49483a5ee1ce9b">Use gitlab-runner instead of gitlab-ci-multi-runner</a> のように変更しました。</p>

<p>移行措置として、 gitlab-ci-multi-runner の apt-line を消す処理も入れています。</p>

<h2>まとめ</h2>

<p><code>gitlab-ci-multi-runner</code> パッケージから <code>gitlab-runner</code> パッケージへの移行は GitLab (GitLab CI) への登録し直しが必要だと面倒そうと思って、 10.0.x の間は躊躇してそのままにしてしまっていましたが、 vagrant 環境で確認したところ、パッケージの更新だけで大丈夫ということがわかったので、問題なく上げることができました。</p>
]]></content>
  </entry>
  
</feed>
