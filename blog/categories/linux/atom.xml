<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: linux | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/linux/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2013-11-04T14:49:26+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[/dev/snd/hwC0D0でPermission deniedになる問題を調べた]]></title>
    <link href="http://blog.n-z.jp/blog/2013-11-04-dev-snd-hwc0d0-permission-denied.html"/>
    <updated>2013-11-04T14:22:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/dev-snd-hwc0d0-permission-denied</id>
    <content type="html"><![CDATA[<p><code>/dev/snd/hwC0D0</code> を <code>O_RDWR</code> で <code>open(2)</code> するところで
<code>Permission denied</code> になるという話
(
<a href="https://twitter.com/takaswie/status/397014733494026240">ツイート</a>、
<a href="https://forums.ubuntulinux.jp/viewtopic.php?pid=100488#p100488">Ubuntu日本語フォーラム</a>
)
が気になったので、調べてみました。</p>

<!--more-->


<h2>結論</h2>

<p>最終的にどうすれば良いか知りたい人向けの情報としては、
<code>setcap cap_sys_rawio=ep filename</code>
でケーパビリティ (capability) を設定する、ということになります。</p>

<p>以下は、その結論にたどり着くまでに調べたことのメモです。</p>

<h2>パーミッションと ACL</h2>

<p><a href="http://blog.n-z.jp/blog/2013-10-27-kansai-debian-meeting.html">第 77 回 関西 Debian 勉強会に参加した</a>
で書いたように、
audio グループに属しているか、コンソールから直接ログインしていれば
パーミッションの問題はないはずです。</p>

<h2>余談: デバイスの sticky bit</h2>

<p><code>crw-rw---T</code> になっていて、
もしかして末尾の sticky bit が影響しているのかと思って調べてみたところ、
<a href="http://lists.debian.org/debian-user/2012/02/msg01273.html">Re: Sticky bit on device files?</a>
によると udev の管理用のフラグとして使われているようでした。
今回の件とは関係なさそうだったので、これ以上深追いはしていません。</p>

<h2>AppArmor</h2>

<p><code>/etc/apparmor.d/abstractions/audio</code> に
<code>/dev/snd/*      rw,</code> とあるので、
念のため
<code>sudo service apparmor stop</code>
で <code>AppArmor</code> を止めて試してみましたが、
変化が無かったので、
<code>sudo service apparmor start</code>
で戻しました。</p>

<h2>カーネルのソースコード探索</h2>

<p><code>strace</code> などで確認しても、
ユーザーランドでは <code>EACCES</code> が返ってくるとしかわからないので、
こうなったらカーネルのソースコードから <code>EACCES</code> を返しているところを
探すしかないということで、
<code>apt-get source linux-image-$(uname -r)</code>
でソースコードをダウンロードして探してみました。</p>

<p><code>grep -r EACCES sound</code> で探してみると
<code>sound/pci/hda/hda_hwdep.c</code> で以下のように
<code>CAP_SYS_RAWIO</code> をみていることがわかりました。</p>

<p>```c sound/pci/hda/hda_hwdep.c
 static int hda_hwdep_open(struct snd_hwdep <em>hw, struct file </em>file)
 {
 #ifndef CONFIG_SND_DEBUG_VERBOSE</p>

<pre><code>if (!capable(CAP_SYS_RAWIO))
    return -EACCES;
</code></pre>

<p> #endif</p>

<pre><code>return 0;
</code></pre>

<p> }
```</p>

<h2>Linux のケーパビリティ (capability)</h2>

<p><a href="http://linuxjm.sourceforge.jp/html/LDP_man-pages/man7/capabilities.7.html">Man page of CAPABILITIES</a>
が関係しているということがわかったところで、
設定方法も調べてみると、
<code>setcap</code> で設定できるとわかったので、
以下のような簡単なテストプログラムを用意して、
<code>sudo setcap cap_sys_rawio=ep ./a.out</code>
でケーパビリティを設定すると
<code>open(2)</code>
に成功するのを確認できました。
<code>cap_sys_rawio=ep</code> は危険そうなので、
テストプログラムとはいえ、
任意のパスを受け取れるようにするのは止めた方が良さそうに思いました。</p>

<p>```c open-hwC0D0.c
 #include &lt;sys/types.h>
 #include &lt;sys/stat.h>
 #include &lt;fcntl.h>
 #include &lt;stdio.h></p>

<p> int main() {</p>

<pre><code>open("/dev/snd/hwC0D0", O_RDWR);
perror("open");
return 0;
</code></pre>

<p> }
```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LC_COLLATEの問題でuniqで丸数字が同一視されてしまう]]></title>
    <link href="http://blog.n-z.jp/blog/2013-10-31-lc-collate-uniq.html"/>
    <updated>2013-10-31T23:50:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/lc-collate-uniq</id>
    <content type="html"><![CDATA[<p><code>uniq -c</code> で重複がないのを確認しようとしたら、
丸数字のところだけ違う行が同一視されてしまって、
2以上になることがあって困ったので、
原因を調べてみました。</p>

<!--more-->


<h2>現象</h2>

<p>以下のように丸数字などが同一視されています。</p>

<p><code>
$ cat n.txt
①
②
$ uniq n.txt
①
$ sort n.txt
①
②
$ tac n.txt | sort
②
①
$
</code></p>

<p>```
$ cat n.txt
①
②
$ LANG=ja_JP.utf8 uniq -c n.txt</p>

<pre><code>  2 ①
</code></pre>

<p>$ LANG=C uniq -c n.txt</p>

<pre><code>  1 ①
  1 ②
</code></pre>

<p>$ uniq &mdash;version
uniq (GNU coreutils) 8.20
Copyright &copy; 2012 Free Software Foundation, Inc.
ライセンス GPLv3+: GNU GPL version 3 or later <a href="http://gnu.org/licenses/gpl.html">http://gnu.org/licenses/gpl.html</a>.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.</p>

<p>作者 Richard M. Stallman および David MacKenzie。
$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 13.04
Release:        13.04
Codename:       raring
$
```</p>

<h2>調査</h2>

<p><code>apt-get source locales</code>
でソースをとってきて調べてみると
<code>locales/ja_JP</code> の <code>LC_COLLATE</code> から <code>END LC_COLLATE</code>
の間に書いていないコードポイントは同一視されているように見えました。</p>

<p>これは glibc の問題だと思って、既に報告されているかどうか調べてみると
<a href="https://sourceware.org/bugzilla/show_bug.cgi?id=13063">Bug 13063 – &lsquo;sort -u&rsquo; will erase some Chinese characters</a>
に同じような話がありました。</p>

<h2>ML で聞いてみた</h2>

<p><a href="http://listserv.linux.or.jp/pipermail/linux-users/2013-October/000527.html">linux-users: 108951</a>
で質問してみたところ、
<a href="http://listserv.linux.or.jp/pipermail/linux-users/2013-October/000528.html">linux-users: 108952</a>
で返信があり、
<code>LC_COLLATE</code>
をちゃんと定義して解決するか、
単純にバイト順でソートしたいだけなら
<code>LC_COLLATE=C</code> で良いという話でした。</p>

<h2>結論</h2>

<p>結局今回の目的はソートではなく重複検査だったので、
<code>LC_COLLATE=C</code> で解決ということになりました。</p>

<p>誰か興味のある人は真面目に
<code>LC_COLLATE</code>
の定義に挑戦してみると良いのではないでしょうか。</p>

<p>それとは別に定義されていない文字を同一視せずにバイト順でも何でもいいので、
適当に別の文字として扱ってくれるようになればいいのに、
とは思いました。
誰かそういう方向での対応も挑戦してみると
他の言語も含めて幸せになれるのではないかと思いました。</p>
]]></content>
  </entry>
  
</feed>
