<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: osx | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/osx/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2014-01-12T15:30:08+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[RubyMotionのOSXアプリの起動エラー]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-28-rubymotion-error.html"/>
    <updated>2013-12-28T18:55:18+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-error</id>
    <content type="html"><![CDATA[<p>最近 RubyMotion で作っている OSX アプリが
<code>LSOpenURLsWithRole() failed with error -10810</code>
などで起動しないことがあったので原因を調べてみました。</p>

<!--more-->


<h2>LSOpenURLsWithRole() failed with error -10810</h2>

<h3>よくある原因</h3>

<p><code>Hello.app/Contents/MacOS/Hello</code>
のような実行ファイルの実体に実行属性が外れているというのが
よくある原因のようで、
<a href="http://owncloud.org/">ownCloud</a>
経由で同期したアプリが実行できなかったときは
これが原因でした。</p>

<h3>別の原因</h3>

<p>実行属性も問題なくて悩んでいたときに
コンソール (Console.app) のログを見てみると</p>

<p><code>
2013/12/28 10:39:17.963 open[85406]: spawn_via_launchd() failed, errno=22 label=com.yourcompany.Hello.44032 path=.../Hello/build/MacOSX-10.9-Development/Hello.app/Contents/MacOS/Hello flags=0 : LaunchApplicationClient.cp #1168 LaunchApplicationViaLaunchDJobLabel() q=com.apple.main-thread
</code>
のようなログが出ていたので、
<code>LaunchApplicationViaLaunchDJobLabel</code>
で検索してみたところ、
<a href="http://portingteam.com/topic/9723-mavericks-problem-opening-fresh-wrapper/">Mavericks problem opening fresh wrapper</a>
という話が見つかって、
そこに書いてあった</p>

<p><code>
launchctl remove $(launchctl list | grep wineskin | awk '{ print $3 }')
</code></p>

<p>という手順を参考にして解決しました。</p>

<p><code>Hello</code> が2個残っていて、
<code>$()</code> だとダメだったので個別に <code>launchctl remove</code> しました。</p>

<p><code>
% launchctl list | grep Hello
-   2   com.yourcompany.Hello.44032
-   0   com.yourcompany.Hello.53008
%  launchctl remove $(launchctl list | awk '/Hello/{print $3}')
usage: launchctl remove &lt;job label&gt;
zsh: exit 1     launchctl remove $(launchctl list | awk '/Hello/{print $3}')
%  echo launchctl remove $(launchctl list | awk '/Hello/{print $3}')
launchctl remove com.yourcompany.Hello.44032 com.yourcompany.Hello.53008
%  launchctl remove com.yourcompany.Hello.44032
%  launchctl remove com.yourcompany.Hello.53008
%  open -a Hello
</code></p>

<h3>その他</h3>

<p>その他の対象方法も含めて
<a href="http://www.thexlab.com/faqs/error-10810.html">Error -10810 Openng Applictions or Relaunching Finder</a>
にいろいろ書いてあるようです。
(英語で長かったのでちゃんと読んでません。)</p>

<h2>MacBookPro6,2 で EXC_BAD_INSTRUCTION (SIGILL) になって起動しない</h2>

<p>未解決です。</p>

<p><a href="https://github.com/MohawkApps/Hacker-Bar/issues/36">EXC_BAD_INSTRUCTION crash in App Store version&hellip;</a>
に似た話があって、
RubyMotion のバグっぽいという話のようです。</p>

<p><code>motion create --template=osx HelloOSX</code>
で作成しただけのものでも
<a href="https://gist.github.com/znz/8158061#file-helloosx-report-txt">クラッシュ</a>
して起動しませんでした。</p>

<p>RubyMotion を入れている自分の MacBook Air の環境の問題かどうかを切り分けるために
<a href="http://shin1x1.github.io/vagrantx/">VagrantX</a>
も試してみましたが、
<a href="https://gist.github.com/znz/8158061#file-vagrantx-report-txt">同じくクラッシュ</a>
して起動しませんでした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[distnotedの暴走が止まるというCocoa Emacsのinline patch修正版を使ってみた]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-27-emacs-inline-patch.html"/>
    <updated>2013-12-27T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/emacs-inline-patch</id>
    <content type="html"><![CDATA[<p><a href="/blog/2013-11-13-killall-distnoted-periodically.html">launchdでdistnotedを定期的に終了させる</a>
話のコメントで
<a href="https://gist.github.com/anonymous/8142555">Emacs.appでインラインパッチを当てた時にdistnotedが暴走しなくなる</a>
修正を教えてもらったので、
試してみました。</p>

<!--more-->


<h2>homebrew で適用するパッチの変更</h2>

<p>適用法としては
<code>brew edit emacs</code>
で以下のように変更して、
<code>brew reinstall emacs</code>
で再インストールしました。</p>

<p>```diff
diff &mdash;git a/Library/Formula/emacs.rb b/Library/Formula/emacs.rb
index 712c3d1..5ce4ce2 100644
&mdash;&ndash; a/Library/Formula/emacs.rb
+++ b/Library/Formula/emacs.rb
@@ -47,7 +47,7 @@ class Emacs &lt; Formula</p>

<pre><code> # "--japanese" option:
 # to apply a patch from MacEmacsJP for Japanese input methods
 if build.include? "cocoa" and build.include? "japanese"
</code></pre>

<ul>
<li>   p[:p0].push(&ldquo;<a href="http://sourceforge.jp/projects/macemacsjp/svn/view/inline_patch/trunk/emacs-inline.patch?view=co&amp;revision=583&amp;root=macemacsjp&amp;pathrev=583">http://sourceforge.jp/projects/macemacsjp/svn/view/inline_patch/trunk/emacs-inline.patch?view=co&amp;revision=583&amp;root=macemacsjp&amp;pathrev=583</a>&rdquo;)</li>
<li>   p[:p0].push(&ldquo;<a href="https://gist.github.com/anonymous/8142555/raw/d67ad1dc814579d125afbd18de3a62ba69895601/emacs-inline.patch">https://gist.github.com/anonymous/8142555/raw/d67ad1dc814579d125afbd18de3a62ba69895601/emacs-inline.patch</a>&rdquo;)
 end
 p
end unless build.head?
```</li>
</ul>


<h2>元のパッチからの変更点</h2>

<p>元の sourceforge.jp のパッチとの差分をとってみると、
以下のメソッド呼び出しが変わっているだけでした。</p>

<p>```diff
diff &mdash;git a/emacs-inline.patch.sfjp b/emacs-inline.patch.gist
index 52f2052..d67ad1d 100644
&mdash;&ndash; a/emacs-inline.patch.sfjp
+++ b/emacs-inline.patch.gist
@@ -1015,7 +1015,7 @@ diff -r -N -p ../emacs-24.3.org/src/nsterm.m src/nsterm.m</p>

<pre><code>                                            name: nil object: nil]; */
</code></pre>

<ul>
<li> [[NSDistributedNotificationCenter defaultCenter] addObserver: NSApp</li>
<li><pre><code>            selector: @selector (changeInputMethod:)
</code></pre>

<p>&ndash;+                         name: @&ldquo;AppleSelectedInputSourcesChangedNotification&rdquo; object: nil];
++                         name: @&ldquo;AppleSelectedInputSourcesChangedNotification&rdquo; object: nil suspensionBehavior:NSNotificationSuspensionBehaviorDeliverImmediately];</p>

<p>   dpyinfo = xzalloc (sizeof *dpyinfo);</p></li>
</ul>


<p>```</p>

<h2>まとめ</h2>

<p>使ってみて問題がなければ sourceforge.jp の方に取り込んでもらうのが良さそうです。</p>

<p>しばらく使ってみた感じだと distnoted のメモリ使用量が増えていっても、
一度 Emacs.app を終了すると distnoted のメモリ使用量が一気に減るようになりました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第 6 回 RubyMotion もくもく会 in Osaka に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-26-rubymotion-mokumoku-osaka.html"/>
    <updated>2013-12-26T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-mokumoku-osaka</id>
    <content type="html"><![CDATA[<p>第 1 回から第 5 回にも参加した RubyMotion もくもく会 in Osaka の
<a href="http://connpass.com/event/4211/">第 6 回 RubyMotion もくもく会 in Osaka</a>
に参加してきました。</p>

<p>次回の
<a href="http://connpass.com/event/4560/">第 7 回 RubyMotion もくもく会 in Osaka</a>
は 1/22(水) になりました。</p>

<!--more-->


<h2>話に出たもの</h2>

<p>話に出てきたサイトなどのメモです。</p>

<ul>
<li><a href="http://shin1x1.github.io/vagrantx/">http://shin1x1.github.io/vagrantx/</a>

<ul>
<li>URL が小文字に変わっていました。</li>
</ul>
</li>
<li><a href="https://www.cocoacontrols.com/">Cocoa Controls</a></li>
<li><a href="http://getpocket.com/">Pocket</a></li>
<li><a href="http://71squared.com/ja/particledesigner">Particle Designer</a></li>
<li>UIMotionEffect で視差効果が簡単に実装できる</li>
<li>All Cast という Android アプリで Apple TV に AirPlay できる</li>
</ul>


<h2>やっていたこと</h2>

<p>今回は前回作り始めていたデフォルトブラウザを乗っ取って、
Firefox とか Chrome とか Safari とかに起動し分けられる
OSX アプリの作成の続きをやっていました。</p>

<p>今回の最後ではスクリーンショットのようになりました。</p>

<p><img src="/images/2013-12-26-hello.png" title="&ldquo;screenshot&rdquo; &ldquo;作成途中のアプリのスクリーンショット&rdquo;" ></p>

<p>適当に作った Hello.app に動作確認用のメソッドを付け足していただけなので、
まだタイトルは Hello のままになっています。</p>

<h3>URL 受け取り問題</h3>

<p>LimeChat で URL をクリックしたときなどに受け取るのは
前回調べていた <code>LSSetDefaultHandlerForURLScheme</code> での
デフォルトブラウザ設定とあわせて、</p>

<p>```ruby</p>

<pre><code>NSAppleEventManager.sharedAppleEventManager.setEventHandler(
  self,
  andSelector: :'handleGetURLEvent:withReplyEvent:',
  forEventClass: KInternetEventClass,
  andEventID: KAEGetURL)
</code></pre>

<p>```</p>

<p>でイベントを受け取ると Hello.app 起動中は受け取れたのですが、
起動していない時の URL クリックのイベントを受け取れない問題は
結局解決できませんでした。</p>

<p><code>open -a Hello --args URL</code>
というなら
<code>NSProcessInfo.processInfo.arguments</code>
で受け取れるのですが、
LimeChat などでの URL クリックで起動された時や
<code>open -a Hello URL</code>
という起動方法だと受け取り方がわかりませんでした。</p>

<p>他のブラウザの起動も
<code>open -a 'Google Chrome' http://localhost:4000/ --args -incognito</code>
のように URL は args ではない方法で渡さないと開けませんでした。</p>

<h3><code>keyDirectObject</code> がない問題と前面に出てこない問題</h3>

<p>URL の受け取り部分は今のところ、以下のようにしています。</p>

<p>```ruby
  def handleGetURLEvent(event, withReplyEvent: replyEvent)</p>

<pre><code>keyDirectObject = '----'.unpack('L')[0]
urlStr = event.paramDescriptorForKeyword(keyDirectObject).stringValue
@text.stringValue = urlStr

Process.spawn("osascript", "-e", &lt;&lt;-SCRIPT)
</code></pre>

<p>tell Application &ldquo;#{NSBundle.mainBundle.infoDictionary[&lsquo;CFBundleName&rsquo;]}&rdquo;
  activate
end tell</p>

<pre><code>SCRIPT
</code></pre>

<p>  end
```</p>

<p>最初の問題として、
<code>keyDirectObject</code> が RubyMotion にはなさそうだったので、
値を調べて <code>unpack</code> で同等の値を生成するようにしました。
この部分は前回から今回までの間に調査して作成済みだったので、
詳しい調査方法は忘れてしまいましたが、
引数のオブジェクトを調べて見つけたような気がします。</p>

<p>前面に出てこない問題は
今回のもくもく会の間に対処しました。</p>

<p>前面に持ってくる方法がどういう API を呼べばよいのかわからず、
AppleScript を使った方法は情報があったので、
とりあえず <code>osascript</code> を呼び出してしまうことにしました。</p>

<p>最初は <code>spawn</code> ではなく <code>system</code> を使ってしまったら、
デッドロックしてしまって強制終了するしかなくなってしまったので、
<code>Process.spawn</code> を使いました。</p>

<h2>まとめ</h2>

<p>今回は作りたいものが決まっていて、しっかりもくもく出来ました。</p>

<p>起動時に URL が受け取れない問題は
自分が使うだけなら
URL を 2 回クリックするという方法で
回避できるのですが、なんとかしたいところです。</p>

<p><code>keyDirectObject</code> と <code>osascript</code> を使っているところは
他に方法がなければ
今のままでも実用上は困らないと感じました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第 5 回 RubyMotion もくもく会 in Osaka に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2013-11-20-rubymotion-mokumoku-osaka.html"/>
    <updated>2013-11-20T21:54:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-mokumoku-osaka</id>
    <content type="html"><![CDATA[<p>第 1 回から第 4 回にも参加した RubyMotion もくもく会 in Osaka の
<a href="http://connpass.com/event/3871/">第 5 回 RubyMotion もくもく会 in Osaka</a>
に参加してきました。</p>

<p>今回も東京と同時開催でしたが、
接続などはせずに終わってしまいました。</p>

<p>次回の
<a href="http://connpass.com/event/4211/">第 6 回 RubyMotion もくもく会 in Osaka</a>
は 12/26(木) になりました。</p>

<!--more-->


<h2>話に出たもの</h2>

<p>話に出てきたサイトなどのメモです。</p>

<ul>
<li><a href="http://shin1x1.github.io/VagrantX/">http://shin1x1.github.io/VagrantX/</a>
のサイトのデザインを
<a href="https://wrapbootstrap.com/">https://wrapbootstrap.com/</a>
から選ぼうとしたが、結局 github のテンプレートのまま使うことにしたという話</li>
<li>昔は nib というバイナリだったけど今は xib という XML ファイルになっているという話</li>
<li><a href="http://www.rainymood.com/">Rainy Mood</a>
と
<a href="http://tadaya.net/blog/2012/12/01">多田屋のBGM</a>
の組み合わせが良いという話</li>
<li>アドベントカレンダーの話

<ul>
<li><a href="http://www.adventar.org/">Adventar</a></li>
<li><a href="http://qiita.com/advent-calendar/2013/rubymotion">RubyMotion Advent Calendar 2013</a></li>
</ul>
</li>
<li><a href="http://www.img2icnsapp.com/">Img2icns</a> の無料の方で OSX アプリのアイコンへの変換が出来そうという話</li>
<li>クラウドソーシングでアイコンを募集するのはどうかという話

<ul>
<li><a href="http://www.designclue.co/">designclue（デザインクルー） &ndash; デザインクラウドソーシング</a></li>
</ul>
</li>
</ul>


<h2>やっていたこと</h2>

<h3>www.ruby-lang.org</h3>

<p><a href="https://www.ruby-lang.org/ja/news/2013/09/28/design-contest/">www.ruby-lang.org のサイトデザイン募集</a>
の投票を webmaster でやっていて、締め切りが今日だったということで、
投票しようかと思っていたら、
締め切りが 9:00 20 Nov(JST) だったのに気付いて諦めました。
まだ集計前だったようなので、間に合いそうでしたが、
無理はしないということにしました。</p>

<p>ちなみに
<a href="https://github.com/ruby/www.ruby-lang.org/issues?labels=contest">応募は7件</a>
でした。</p>

<h3>notification</h3>

<p>最初は
<a href="https://github.com/Watson1978/notification">https://github.com/Watson1978/notification</a>
という OSX のサンプルをいじってみていました。</p>

<p><code>open ./build/MacOSX-10.8-Development/notification.app</code>
で開くと右上の通知はそもそも出てきているのかどうかわからない状態で終了してしまって、
通知センターを開くとちゃんと送れていることが確認できたり、
引数は <code>-psn_なんとか</code> という
Emacs.app のカレントディレクトリ問題を調べていた時に見かけたものが渡ってきていたりしたのがわかりました。</p>

<h3>Calc</h3>

<p><a href="https://github.com/HipByte/RubyMotionSamples">RubyMotionSamples</a>
の osx に Calc というのが追加されていたので、
それを試していました。</p>

<h2>デフォルトブラウザ設定</h2>

<p>デフォルトブラウザはどこで設定しているんだろうと思って、
<code>defaults read</code>
の出力を調べたりしていたら、
<code>LSSetDefaultHandlerForURLScheme</code>
と
<code>LSSetDefaultRoleHandlerForContentType</code>
で設定できるとわかったので、
RubyMotion の中から呼び出そうとしたのですが、
<code>NoMethodError</code>
になるだけで、
結局呼び出し方がわかりませんでした。</p>

<p>試したこととしては <code>Calc</code> のボタンと同じように
ボタンが押された時に呼ばれるメソッドの中で、</p>

<p>```ruby</p>

<pre><code>bundle_id = NSBundle.mainBundle.bundleIdentifier
LSSetDefaultHandlerForURLScheme("http", bundle_id) #~&gt; NoMethodError
</code></pre>

<p>```</p>

<p>のように呼び出そうとしたところ、
<code>LSSetDefaultHandlerForURLScheme</code>
で
<code>NoMethodError</code>
になりました。</p>

<p>それから <code>Rakefile</code> の
<code>Motion::Project::App.setup do |app|</code>
のブロックで
<code>app.frameworks &lt;&lt; 'ApplicationServices'</code>
のように
<code>ApplicationServices</code>
フレームワークを追加というのも試してみたのですが、
変化はありませんでした。</p>

<p>そんな感じで手詰まっていたら時間が来て終了ということになりました。</p>

<p>確認したバージョンは以下の通りです。</p>

<ul>
<li>Mac OS X 10.8.5</li>
<li>Xcode 5.0.2</li>
<li>RubyMotion 2.14</li>
</ul>


<h3>解決</h3>

<p><code>CoreServices</code> が必要と教えてもらったので、
<code>app.frameworks &lt;&lt; 'CoreServices'</code>
も足してみたのですが、
<code>NoMethodError</code>
のままで動かず、
結局
RubyMotion を 2.15 に上げると直っていました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mac OS XでのIME制御についての考察]]></title>
    <link href="http://blog.n-z.jp/blog/2013-11-14-macosx-ime.html"/>
    <updated>2013-11-14T02:24:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/macosx-ime</id>
    <content type="html"><![CDATA[<p><a href="/blog/2013-11-12-cocoa-emacs-ime.html">Cocoa Emacs のインラインパッチ関連の設定</a>
の時や
<a href="/blog/2013-11-13-tty-ime.html">iTerm2 で IME 制御シーケンスがきかないのを調べた</a>
時にも気になったのですが、
Mac の IME に open/close という概念はあるのかという話です。</p>

<!--more-->


<h2>IME の開閉状態?</h2>

<p>iBus 1.5 関連の記事の
<a href="http://www.kaoriya.net/blog/2013/10/18/">iBusがクソになった理由 — KaoriYa</a>
で知ったのですが、
Mac OS X は IME のオン・オフのような状態の切り替えではなく、
「ことえりのひらがな」とか
「ことえりのカタカナ」とか
「ことえりの英字」とか
のようなIMEの種類を切り替えて入力するようになっています。</p>

<p>この考え方と開閉状態しか考慮していない二値的な制御シーケンスは相性が悪いのではないかと思いました。</p>

<h2>Cocoa Emacs のインラインパッチでは?</h2>

<p>Cocoa Emacs のインラインパッチをよく見ると
<code>mac-toggle-input-source</code>
という関数があって、
<code>(mac-toggle-input-source nil)</code>
で IME オフ相当に、
<code>(mac-toggle-input-source t)</code>
で IME オン相当にできるようなので、
対応は不可能ではないのかもしれません。</p>

<h2>端末の制御シーケンスでは?</h2>

<p><a href="http://ttssh2.sourceforge.jp/manual/ja/about/ctrlseq.html">TeraTerm Pro の対応制御シーケンス</a>
には以下の3種類の IME 関連の制御シーケンスがあります。</p>

<p>```
  CSI &lt; r    TTIMERSIME の開閉状態を復元する。
  CSI &lt; s    TTIMESVIME の開閉状態を保存する。
  CSI &lt; Ps t TTIMESTIME の開閉状態を設定する。省略時の Ps の値は 0。</p>

<pre><code>           Ps = 0      IME を閉じる。
              = 1      IME を開く。
</code></pre>

<p>```</p>

<p>この中の <code>TTIMESTIME</code> の <code>Ps</code> を拡張して、
2 以上も受け付けるようにして、
(別の状態が不可能なら 1 と同じ挙動で)
可能ならカタカナ入力などの別の IME の状態を設定できるようにするという案を思いつきました。</p>
]]></content>
  </entry>
  
</feed>
