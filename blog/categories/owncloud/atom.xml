<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: owncloud | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/owncloud/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2014-07-16T07:55:11+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Mac OS X で owncloudcmd を使う]]></title>
    <link href="http://blog.n-z.jp/blog/2014-05-02-owncloudcmd.html"/>
    <updated>2014-05-02T22:18:39+09:00</updated>
    <id>http://blog.n-z.jp/blog/owncloudcmd</id>
    <content type="html"><![CDATA[<p>ownCloud のデスクトップクライアントには <code>owncloudcmd</code> というコマンドが含まれています。
昔は <code>ocsync</code> というコマンドが別途あったようですが、今は同梱されている <code>owncloudcmd</code> を使うのが主流のようです。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>クライアント : ownCloud client for Mac 1.5.4 に同梱の <code>owncloudcmd</code> で試しました。</li>
<li>サーバー : 自前サーバーなら ownCloud 6.0.3 で、今回の例では <a href="https://teracloud.jp/">Teraクラウド</a> を使ってみました。</li>
</ul>


<h2>概要</h2>

<p><code>path/to/owncloudcmd path/to/localdir ownclouds://example.jp/remote.php/webdav</code>
のようにローカルのディレクトリと <code>owncloud</code> の WebDAV 用の URL の先頭の <code>http</code> を <code>owncloud</code> に置き換えたもの (<code>https</code> なら <code>ownclouds</code>) を指定すると同期できます。</p>

<p>引数なしで実行するとオプションの説明が出ます。</p>

<h2>Mac OS X 版での修正</h2>

<h3><code>owncloudcmd</code> のリンクミス?</h3>

<p>普通に使おうとすると <code>dyld: Library not loaded: libowncloudsync.0.dylib</code> で起動できません。</p>

<p><code>console
% /Applications/owncloud.app/Contents/MacOS/owncloudcmd $HOME/teracloud ownclouds://teracloud.jp/remote.php/webdav
dyld: Library not loaded: libowncloudsync.0.dylib
  Referenced from: /Applications/owncloud.app/Contents/MacOS/owncloudcmd
  Reason: image not found
zsh: trace trap  /Applications/owncloud.app/Contents/MacOS/owncloudcmd
</code></p>

<h3>ライブラリのパス修正</h3>

<p><code>otool -L</code> で確認すると相対パスがまずいとわかります。</p>

<p>```console
% otool -L /Applications/owncloud.app/Contents/MacOS/owncloudcmd
/Applications/owncloud.app/Contents/MacOS/owncloudcmd:</p>

<pre><code>libowncloudsync.0.dylib (compatibility version 0.0.0, current version 1.5.4)
QtWebKit.framework/Versions/4/QtWebKit (compatibility version 4.9.0, current version 4.9.3)
QtXmlPatterns.framework/Versions/4/QtXmlPatterns (compatibility version 4.8.0, current version 4.8.4)
QtGui.framework/Versions/4/QtGui (compatibility version 4.8.0, current version 4.8.4)
QtDBus.framework/Versions/4/QtDBus (compatibility version 4.8.0, current version 4.8.4)
QtXml.framework/Versions/4/QtXml (compatibility version 4.8.0, current version 4.8.4)
QtSql.framework/Versions/4/QtSql (compatibility version 4.8.0, current version 4.8.4)
QtNetwork.framework/Versions/4/QtNetwork (compatibility version 4.8.0, current version 4.8.4)
QtCore.framework/Versions/4/QtCore (compatibility version 4.8.0, current version 4.8.4)
libocsync.0.dylib (compatibility version 0.0.0, current version 0.2.1)
/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 125.2.11)
/usr/local/opt/sqlite/lib/libsqlite3.0.dylib (compatibility version 9.0.0, current version 9.6.0)
/usr/lib/libiconv.2.dylib (compatibility version 7.0.0, current version 7.0.0)
/System/Library/Frameworks/CoreServices.framework/Versions/A/CoreServices (compatibility version 1.0.0, current version 44.0.0)
/System/Library/Frameworks/Foundation.framework/Versions/C/Foundation (compatibility version 300.0.0, current version 751.63.0)
/System/Library/Frameworks/AppKit.framework/Versions/C/AppKit (compatibility version 45.0.0, current version 1038.36.0)
@loader_path/../Frameworks/Sparkle.framework/Versions/A/Sparkle (compatibility version 1.5.0, current version 1.5.0)
/usr/local/lib/libqtkeychain.0.3.0.dylib (compatibility version 0.0.0, current version 0.3.0)
/usr/local/opt/neon/lib/libneon.27.dylib (compatibility version 31.0.0, current version 31.0.0)
/usr/lib/libstdc++.6.dylib (compatibility version 7.0.0, current version 7.9.0)
</code></pre>

<p>```</p>

<p><code>install_name_tool -add_rpath</code> や <code>install_name_tool -delete_rpath</code> で試行錯誤したのですが、
<code>otool -l /Applications/owncloud.app/Contents/MacOS/owncloudcmd</code> で確認しても
<code>rpath</code> が後ろに追加されてきいていないようだったので、
<code>install_name_tool -change</code> で対応することにしました。</p>

<p>まず相対パスを修正しました。</p>

<p><code>console
%  otool -L /Applications/owncloud.app/Contents/MacOS/owncloudcmd | awk '$1~"^lib"{print "install_name_tool -change " $1 " @executable_path/../MacOS/" $1 " /Applications/owncloud.app/Contents/MacOS/owncloudcmd" }' | sh -e
%  otool -L /Applications/owncloud.app/Contents/MacOS/owncloudcmd | awk '$1~"^Qt"{print "install_name_tool -change " $1 " @executable_path/../Frameworks/" $1 " /Applications/owncloud.app/Contents/MacOS/owncloudcmd" }' | sh -e
</code></p>

<p>さらに <code>/usr/local/lib</code> をさしているものがあったのを修正しました。</p>

<p><code>console
%  /Applications/owncloud.app/Contents/MacOS/owncloudcmd
dyld: Library not loaded: /usr/local/lib/libqtkeychain.0.3.0.dylib
  Referenced from: /Applications/owncloud.app/Contents/MacOS/owncloudcmd
  Reason: image not found
zsh: trace trap  /Applications/owncloud.app/Contents/MacOS/owncloudcmd
%  find /Applications/owncloud.app -name libqtkeychain.0.3.0.dylib
/Applications/owncloud.app/Contents/MacOS/libqtkeychain.0.3.0.dylib
%  install_name_tool -change /usr/local/lib/libqtkeychain.0.3.0.dylib /Applications/owncloud.app/Contents/MacOS/libqtkeychain.0.3.0.dylib /Applications/owncloud.app/Contents/MacOS/owncloudcmd
%  /Applications/owncloud.app/Contents/MacOS/owncloudcmd
dyld: Library not loaded: /usr/local/opt/neon/lib/libneon.27.dylib
  Referenced from: /Applications/owncloud.app/Contents/MacOS/owncloudcmd
  Reason: image not found
zsh: trace trap  /Applications/owncloud.app/Contents/MacOS/owncloudcmd
%  find /Applications/owncloud.app -name libneon.27.dylib
/Applications/owncloud.app/Contents/MacOS/libneon.27.dylib
%  install_name_tool -change /usr/local/opt/neon/lib/libneon.27.dylib /Applications/owncloud.app/Contents/MacOS/libneon.27.dylib /Applications/owncloud.app/Contents/MacOS/owncloudcmd
</code></p>

<p>これで余計なメッセージは出ますが、使えるようになりました。</p>

<p>```console
%  /Applications/owncloud.app/Contents/MacOS/owncloudcmd
objc[40210]: Class WebCoreMovieObserver is implemented in both /System/Library/Frameworks/WebKit.framework/Versions/A/Frameworks/WebCore.framework/Versions/A/WebCore and /Applications/owncloud.app/Contents/Frameworks/QtWebKit.framework/Versions/4/QtWebKit. One of the two will be used. Which one is undefined.
objc[40210]: Class WebCoreSharedBufferData is implemented in both /System/Library/Frameworks/WebKit.framework/Versions/A/Frameworks/WebCore.framework/Versions/A/WebCore and /Applications/owncloud.app/Contents/Frameworks/QtWebKit.framework/Versions/4/QtWebKit. One of the two will be used. Which one is undefined.
objc[40210]: Class WebVideoFullscreenWindow is implemented in both /System/Library/Frameworks/WebKit.framework/Versions/A/Frameworks/WebCore.framework/Versions/A/WebCore and /Applications/owncloud.app/Contents/Frameworks/QtWebKit.framework/Versions/4/QtWebKit. One of the two will be used. Which one is undefined.
objc[40210]: Class WebVideoFullscreenController is implemented in both /System/Library/Frameworks/WebKit.framework/Versions/A/Frameworks/WebCore.framework/Versions/A/WebCore and /Applications/owncloud.app/Contents/Frameworks/QtWebKit.framework/Versions/4/QtWebKit. One of the two will be used. Which one is undefined.
objc[40210]: Class WebVideoFullscreenHUDWindowController is implemented in both /System/Library/Frameworks/WebKit.framework/Versions/A/Frameworks/WebCore.framework/Versions/A/WebCore and /Applications/owncloud.app/Contents/Frameworks/QtWebKit.framework/Versions/4/QtWebKit. One of the two will be used. Which one is undefined.
objc[40210]: Class WebVideoFullscreenHUDWindow is implemented in both /System/Library/Frameworks/WebKit.framework/Versions/A/Frameworks/WebCore.framework/Versions/A/WebCore and /Applications/owncloud.app/Contents/Frameworks/QtWebKit.framework/Versions/4/QtWebKit. One of the two will be used. Which one is undefined.
objc[40210]: Class WebWindowFadeAnimation is implemented in both /System/Library/Frameworks/WebKit.framework/Versions/A/Frameworks/WebCore.framework/Versions/A/WebCore and /Applications/owncloud.app/Contents/Frameworks/QtWebKit.framework/Versions/4/QtWebKit. One of the two will be used. Which one is undefined.
objc[40210]: Class WebWindowScaleAnimation is implemented in both /System/Library/Frameworks/WebKit.framework/Versions/A/Frameworks/WebCore.framework/Versions/A/WebCore and /Applications/owncloud.app/Contents/Frameworks/QtWebKit.framework/Versions/4/QtWebKit. One of the two will be used. Which one is undefined.
owncloudcmd &ndash; command line ownCloud client tool.</p>

<p>Usage: owncloudcmd <sourcedir> <owncloudurl></p>

<p>A proxy can either be set manually using &mdash;httpproxy or it
uses the setting from a configured sync client.</p>

<p>Options:
  &mdash;confdir = configdir: Read config from there.
  &mdash;httpproxy = proxy:   Specify a http proxy to use.</p>

<pre><code>                     Proxy is http://server:port
</code></pre>

<p>zsh: exit 1     /Applications/owncloud.app/Contents/MacOS/owncloudcmd
```</p>

<h2>使い方</h2>

<p>概要のところに書いたように、
普通に <code>owncloudcmd sourcedir owncloudurl</code> で実行するとユーザー名とパスワードを聞かれます。
URL に <code>ownclouds://user:password@example.jp/remote.php/webdav</code> のようにユーザー名とパスワードを埋め込むことも出来ますが、あまりコマンドラインにパスワードは書きたくないことが多いと思います。</p>

<p>しかし、
<a href="https://github.com/owncloud/mirall/blob/f72e1cc8375b72c97d6566c6875f7214415cea9c/src/owncloudcmd/owncloudcmd.cpp">owncloudcmd のオプション処理部分のソース</a>
をみても <code>"--confdir"</code> は読み込むだけで使われていないようなので、
他の方法で指定することは出来なさそうでした。</p>

<h2>まとめ</h2>

<p><code>owncloudcmd</code> を使えば GUI クライアントで設定しているサーバー以外のサーバーと同期したり、
サーバーなどのコマンドラインのみの環境でも <code>owncloud</code> との同期が出来ることがわかりました。</p>

<p>しかし、クライアントの出来がまだあまりよくないので、使い勝手は良くないということもわかりました。</p>
]]></content>
  </entry>
  
</feed>
