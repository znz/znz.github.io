<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: rails | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/rails/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2014-07-12T09:48:07+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rails 4.1 で Doorkeeper を使った OAuth2 Provider のサンプルを実装した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-07-11-doorkeeper-provider-example-app.html"/>
    <updated>2014-07-11T23:30:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/doorkeeper-provider-example-app</id>
    <content type="html"><![CDATA[<p>ソースは github の
<a href="https://github.com/znz/doorkeeper-provider-app" title="znz/doorkeeper-provider-app">znz/doorkeeper-provider-app</a>
で公開しています。</p>

<p>基本的にはソースをみて参考にしてもらうと良いと思いますが、
説明が必要な部分を続きに書いてみました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>ruby 2.1.2</li>
<li>rails 4.1.4</li>
<li>bootstrap 3.2.0</li>
<li>devise 3.2.4</li>
<li>devise-i18n-views 0.2.8</li>
<li>doorkeeper 1.3.1</li>
<li>cancancan 1.8.4</li>
<li>rolify 3.4.0</li>
<li>rspec-rails 3.0.1</li>
</ul>


<h2>試し方</h2>

<p>README に書いたようにローカルで動かすか heroku に deploy して
<a href="https://github.com/doorkeeper-gem/doorkeeper/wiki/Example-Applications" title="Example Applications">Example Applications</a>
にある Client examples の Sinatra and OAuth2 gem の
<a href="https://github.com/doorkeeper-gem/doorkeeper-sinatra-client" title="Doorkeeper Sinatra Client">Doorkeeper Sinatra Client</a>
を使って試しました。</p>

<h2>初期設定</h2>

<p>devise, doorkeeper, cancancan, rolify, rspec の個別の初期設定は普通に <code>rails generate</code> を使いました。</p>

<h2>ユーザー情報追加</h2>

<p>とれる情報を増やすために <code>User</code> に <code>name</code> を追加しました。
<code>devise-i18n-views</code> を使っている関係で view のカスタマイズはしていないので、
<code>rake db:seed</code> で設定したユーザーだけ <code>name</code> が設定されています。</p>

<p>必要に応じて view もカスタマイズしてください。</p>

<p>また <code>devise-i18n</code> の ja.yml を devise.ja.yml として入れています。
これは flash のメッセージやメールのメッセージなど、
<code>app/views</code> 以外の翻訳になるようです。</p>

<p><code>devise-i18n-views</code> は <code>app/views</code> を翻訳可能な view にするプロジェクトです。
なぜ <code>devise</code> とは別プロジェクトでやっているのかはよくわかりません。</p>

<h2><code>I18n.available_locales</code></h2>

<p><code>devise-i18n-views</code> を入れてしまうと <code>I18n.available_locales</code> が増えてしまうので、
困るのなら、カスタマイズ用の view を generate して、必要な言語だけ取り込んで
<code>Gemfile</code> から外してしまうのが良いと思います。</p>

<p>今回はそのまま残して右上の <code>Locale</code> で選択できるようにしています。
選択肢の翻訳は Wikipedia の左や www.debian.org の下などを参考にしたのですが <code>es-AR</code> はわからなかったので、
<code>es</code> と同じになってしまっています。</p>

<h2><code>/oauth/applications</code> のアクセス制限</h2>

<p><code>cancancan</code> と <code>rolify</code> を使って admin role があるユーザーだけに制限しています。
secret も見えてしまうので、 read 権限までしっかり制限する必要があるようです。</p>

<p><code>load_and_authorize_resource</code> でのロードと親クラス (<code>Doorkeeper::ApplicationsController</code>) の中でのロードでモデルの読み込みが二重になってしまうのですが、変更を少なくするためにそこは許容しました。</p>

<h2><code>GET /api/v1/me.json</code></h2>

<p>Doorkeeper gem の Wiki の例にあるようにユーザー情報をとれるようにしています。
制限していないと以下のような情報がとれました。</p>

<p><code>json
{ "id": 1,
  "email": "admin@example.com",
  "created_at": "2014-07-11T06:32:22.077Z",
  "updated_at": "2014-07-11T09:33:42.143Z",
  "name": "admin" }
</code></p>

<p>制限したり関連するモデルの情報を増やしたりするなら
<a href="http://sugamasao.hatenablog.com/entry/20100914/1284415669" title="Rails のモデル関係と to_json(to_xml) - すがブロ">Rails のモデル関係と to_json(to_xml) &ndash; すがブロ</a>
に書いてあるように <code>respond_with</code> に <code>:only</code> をつけたり <code>:include</code> をつけたりすると出来るようです。</p>

<p>入ったり入らなかったりする条件がよくわからなかったのですが、
<code>devise</code> 関連では <code>authentication_token</code> が入っていることがあったので、
User モデルにいろんな情報を入れているなら、
きちんと制限した方が良さそうに思いました。</p>

<h2>microposts</h2>

<p><a href="http://railstutorial.jp/" title="Ruby on Rails チュートリアル：実例を使って Rails を学ぼう">Ruby on Rails チュートリアル：実例を使って Rails を学ぼう</a>
のように <code>Micropost</code> モデルを作成して、 API からも投稿できるようにしました。</p>

<p>投稿は scope で制限していて、デフォルトの <code>public</code> のみでは書き込めずに <code>write</code> も必要にしています。</p>

<p>API としては</p>

<ul>
<li><code>GET /api/v1/microposts</code> で投稿一覧</li>
<li><code>POST /api/v1/microposts</code> で新規投稿</li>
</ul>


<p>を用意しています。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[devise で通常ログイン出来るユーザーが他の複数サービス連携でログインできるようにした]]></title>
    <link href="http://blog.n-z.jp/blog/2014-07-08-devise-omniauth.html"/>
    <updated>2014-07-08T08:30:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/devise-omniauth</id>
    <content type="html"><![CDATA[<p><code>devise</code> でデータベース認証を実装している Rails アプリに Twitter などでもログインできるように
実装を追加してみました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>ruby 2.1.2</li>
<li>rails 4.1.4</li>
<li>devise 3.2.4</li>
<li>omniauth 1.2.1</li>
<li>omniauth-facebook 1.6.0</li>
<li>omniauth-github 1.1.2</li>
<li>omniauth-google-oauth2 0.2.4</li>
<li>omniauth-twitter 1.0.1</li>
<li>(dotenv 0.11.1) (key と secret の管理)</li>
<li>(font-awesome-sass 4.1.0) (view での <code>icon</code> メソッド)</li>
</ul>


<h2>前提条件</h2>

<ul>
<li>devise で通常の User モデルにメールアドレスとパスワードによる認証は実装されている。</li>
<li>複数サービスとの連携をするために User モデルには連携サービスの情報は直接持たずに UserAuth モデルに分ける。</li>
<li>連携対象サービスは Facebook, GitHub, Google+, Twitter</li>
<li>連携サービスからの追加情報はメールアドレスなども含めて一切とらずに認証だけに利用する。</li>
<li>どの連携サービス (provider) かと識別するための ID だけ保存する。</li>
<li>key や secret は環境変数で渡す。 (今回は dotenv を使ったが、 config/secrets.yml 経由でも良さそう)</li>
<li>今回はテストは未実装 (連携部分のテストの書き方をまだ調べていないため)</li>
<li>今回の実装範囲では I18n は使わずにメッセージは日本語固定</li>
</ul>


<h2>実装</h2>

<p>今回は以下のように実装を追加すると連携サービスでログインできるようになりました。</p>

<h3>Gemfile</h3>

<p>OmniAuth と使用するサービスを追加します。</p>

<p>```ruby Gemfile</p>

<pre><code>gem 'omniauth'
gem 'omniauth-facebook'
gem 'omniauth-github'
gem 'omniauth-google-oauth2'
gem 'omniauth-twitter'
</code></pre>

<p>```</p>

<h3>initializer 追加</h3>

<p>key と secret があれば provider 登録するようにしました。</p>

<p>view で使うために、
登録されている provider の情報の取り方がわからなかったのと
追加で名前や Font Awesome のアイコン名も入れたかったので、
<code>AUTH_PROVIDERS</code> という配列にハッシュを入れるようにしています。</p>

<p>```ruby config/initializers/omniauth.rb</p>

<pre><code>AUTH_PROVIDERS = []

Rails.application.config.middleware.use OmniAuth::Builder do
  key, secret = ENV['FACEBOOK_KEY'], ENV['FACEBOOK_SECRET']
  if key &amp;&amp; secret
    provider :facebook, key, secret
    AUTH_PROVIDERS &lt;&lt; {
      provider: :facebook,
      name: 'Facebook',
    }
  end

  key, secret = ENV['GITHUB_CONSUMER_KEY'], ENV['GITHUB_CONSUMER_SECRET']
  if key &amp;&amp; secret
    provider :github, key, secret
    AUTH_PROVIDERS &lt;&lt; {
      provider: :github,
      name: 'GitHub',
    }
  end

  key, secret = ENV['GOOGLE_CLIENT_ID'], ENV['GOOGLE_CLIENT_SECRET']
  if key &amp;&amp; secret
    provider :google_oauth2, key, secret
    AUTH_PROVIDERS &lt;&lt; {
      provider: :google_oauth2,
      name: 'Google',
      icon: :google
    }
  end

  key, secret = ENV['TWITTER_CONSUMER_KEY'], ENV['TWITTER_CONSUMER_SECRET']
  if key &amp;&amp; secret
    provider :twitter, key, secret
    AUTH_PROVIDERS &lt;&lt; {
      provider: :twitter,
      name: 'Twitter',
    }
  end

  AUTH_PROVIDERS.each do |provider|
    provider[:icon] ||= provider[:provider]
  end
end
</code></pre>

<p>```</p>

<h3>UserAuth モデル作成</h3>

<p><code>rails g model UserAuth user:references uid:string provider:string</code> で作成します。</p>

<p>モデルクラスは生成されたまま使いましたが、
validation を追加した方が良さそうです。</p>

<p>```ruby app/models/user_auth.rb</p>

<pre><code>class UserAuth &lt; ActiveRecord::Base
  belongs_to :user
end
</code></pre>

<p>```</p>

<p>データベースの方は <code>null: false</code> や index を追加しました。</p>

<p>```ruby db/migrate/*_create_user_auths.rb</p>

<pre><code>class CreateUserAuths &lt; ActiveRecord::Migration
  def change
    create_table :user_auths do |t|
      t.references :user, index: true, null: false
      t.string :uid, null: false
      t.string :provider, null: false

      t.timestamps
    end

    add_index :user_auths, [:uid, :provider], unique: true
  end
end
</code></pre>

<p>```</p>

<h3><code>rake db:migrate</code></h3>

<p><code>rake db:migrate</code> で反映しておきます。</p>

<h3>User クラス側</h3>

<p><code>has_many</code> を追加しておきます。</p>

<p>```ruby app/models/user.rb</p>

<pre><code>  has_many :user_auths, dependent: :destroy
</code></pre>

<p>```</p>

<h3>ルーティング追加</h3>

<p>まず、どう使われるのか把握するためにルーティングを追加します。</p>

<p><code>auth_help</code> は後でプライバシーポリシーなどを書いています。</p>

<p>```ruby config/routes.rb</p>

<pre><code>  get '/auth/help' =&gt; 'auth#help', as: :auth_help
  get '/auth/:provider/callback' =&gt; 'auth#create'
  delete '/auth/destroy/:provider' =&gt; 'auth#destroy', as: :destroy_connection
</code></pre>

<p>```</p>

<p>ここには出てきていませんが、
OmniAuth で <code>/auth/:provider</code> がルーティングされるようです。</p>

<h3>AuthController 実装</h3>

<p>参考サイトの実装例を参考にして AuthController を実装しました。</p>

<p>help は静的な情報を表示するだけなので、実装は空です。</p>

<p>```ruby</p>

<pre><code># -*- coding: utf-8 -*-
class AuthController &lt; ApplicationController
  skip_before_filter :authenticate_user!

  def create
    auth = request.env['omniauth.auth']
    uid = auth['uid']
    provider = auth['provider']
    auth = UserAuth.where(uid: uid, provider: provider).first
    if auth
      flash[:notice] = "#{provider}でログインしました。"
      sign_in_and_redirect auth.user, event: :authentication
    else
      authenticate_user!
      UserAuth.create!(uid: uid, provider: provider, user_id: current_user.id)
      redirect_to root_url, notice: "#{provider}と連携しました。"
    end
  end

  def destroy
    provider = params.require(:provider)
    authenticate_user!
    auth = UserAuth.where(provider: provider, user_id: current_user.id).first
    auth.destroy if auth
    redirect_to root_url, notice: "#{provider}と連携解除しました。"
  end

  def help
  end
end
</code></pre>

<p>```</p>

<p>まだ連携を登録していない状態で</p>

<ul>
<li>ログアウト状態</li>
<li>連携サービスで認証・連携許可</li>
<li>戻ってきて通常ログイン</li>
<li><code>auth/failure</code> に飛ばされる</li>
</ul>


<p>ということがおきているのですが、
<code>auth/failure</code>
を実装していないので、デフォルトの 404 エラー画面になってしまいます。</p>

<h3>view helpers 実装</h3>

<p>以前から使っていた <code>link_to_sign_in_or_out</code> の実装も同じファイルに持ってきて、
<code>link_to_provider</code> という汎用的なメソッドを実装しました。
使い方は後述します。</p>

<p><code>AUTH_PROVIDERS</code> のハッシュはここで使っています。</p>

<p>```ruby app/helpers/link_to_auth_helper.rb</p>

<pre><code># -*- coding: utf-8 -*-
module LinkToAuthHelper
  def link_to_sign_in_or_out(html_options={})
    if user_signed_in?
      body = icon(:'sign-out') + t(:"devise.shared.links.sign_out", default: "Sign out")
      html_options = { method: :delete }.merge(html_options)
      link_to body, :destroy_user_session, html_options
    else
      body = icon(:'sign-in') + t(:"devise.shared.links.sign_in", default: "Sign in")
      link_to body, :new_user_session, html_options
    end
  end

  def link_to_provider(provider, html_options={})
    if current_user
      if UserAuth.where(user_id: current_user.id, provider: provider[:provider]).exists?
        html_options = { method: :delete }.merge(html_options)
        link_to icon(provider[:icon])+"#{provider[:name]}との連携を解除", destroy_connection_path(provider: provider[:provider]), html_options
      else
        link_to icon(provider[:icon])+"#{provider[:name]}と連携", "/auth/#{provider[:provider]}", html_options
      end
    else
      link_to icon(provider[:icon])+"#{provider[:name]}でログイン", "/auth/#{provider[:provider]}", html_options
    end
  end
end
</code></pre>

<p>```</p>

<h3>view に追加</h3>

<p>ナビゲーションに以下のように追加しました。
認証連携がないときは従来のログイン・ログアウトだけ表示しています。</p>

<p><code>AUTH_PROVIDERS</code> に登録されているときだけ連携のリンクを表示するようにしています。</p>

<p>```text app/views/layouts/_navigation.html.slim</p>

<pre><code>    li.dropdown
      a.dropdown-toggle data-toggle="dropdown"
        = icon(:user) + 'ログイン管理'
        b.caret
      ul.dropdown-menu
        li= link_to_sign_in_or_out
        - unless AUTH_PROVIDERS.empty?
          li= link_to icon(:info)+"認証連携のヘルプ", auth_help_path
        - AUTH_PROVIDERS.each do |provider|
          li= link_to_provider(provider)
</code></pre>

<p>```</p>

<h3>twitter 連携</h3>

<p>Twitter は複数アカウントを使うことも通常の使用範囲として想定されていて、
アプリ専用のアカウントもとりやすいので、
Twitter 連携から試してみました。</p>

<p><a href="https://apps.twitter.com/">https://apps.twitter.com/</a> から <code>Create New App</code> で作成します。</p>

<ul>
<li>Name: Twitter 全体で一意になるアプリケーションの ID 的にも使われるもの。ツイートの時にツイートしたアプリ名としても埋め込まれるが、今回は認証のみなので、他とぶつからないような名前という以上はこだわらなかった。</li>
<li>Description: 認証のときに出てくる説明。</li>
<li>Website: たとえば <code>http://app.127.0.0.1.xip.io:3000/</code> など</li>
<li>Callback URL: たとえば <code>http://app.127.0.0.1.xip.io:3000/auth/twitter/callback</code> のように <code>/auth/twitter/callback</code> にする。実サイトなら <code>https</code> にすべき。</li>
</ul>


<p>作成後には <code>Allow this application to be used to Sign in with Twitter</code> のチェックを入れておきます。
チェックがないと Twitter 連携でのログインがうまくいかないようです。</p>

<p>アイコンや Organization なども必要に応じて変更します。</p>

<p>API keys タブで key と secret を取得します。</p>

<ul>
<li>API key : 環境変数 <code>TWITTER_CONSUMER_KEY</code> に設定</li>
<li>API secret : 環境変数 <code>TWITTER_CONSUMER_SECRET</code> に設定</li>
</ul>


<p>dotenv を使っているので <code>.env</code> に以下のような感じで設定しました。
ランダムな文字列のように見えます。</p>

<p>```text</p>

<pre><code>TWITTER_CONSUMER_KEY="xxxxXXxxXxXxXXXxXxXXXXxxx"
TWITTER_CONSUMER_SECRET="xxXXxXXxxxxxxXXXXXxXxXXxxXXXxXXxxxxXXxxXxxXXxxXxxx"
</code></pre>

<p>```</p>

<h3>動作確認</h3>

<ul>
<li>通常のログインをした状態で「Twitter と連携」で Twitter の許可画面に飛びます。</li>
<li>許可すると「Twitter 側に許可情報」と「UserAuth に連携情報」が保存されます。</li>
<li>「Twitter との連携を解除」で「UserAuth が削除」されます。</li>
<li>「ログアウト」して「Twitter でログイン」すると「ログイン画面」に戻ります。</li>
<li>ログインすると <code>auth/failure</code> が 404 エラーになります。ここは後で実装する予定です。</li>
<li>再度ログイン後の画面を直接開きます。</li>
<li>再度「Twitter と連携」で「UserAuth に連携情報」が保存されます。「Twitter 側の許可情報」は古いままです。</li>
<li>「ログアウト」して「Twitter でログイン」でログインできます。</li>
<li><a href="https://twitter.com/settings/applications">https://twitter.com/settings/applications</a> で許可を取り消します。</li>
<li>「ログアウト」して「Twitter でログイン」で Twitter の許可画面に飛びます。</li>
<li>許可すると「Twitter 側に許可情報」が保存されて、「UserAuth」は残っているので、そのままログインできます。</li>
</ul>


<h3>GitHub 連携</h3>

<p>GitHub 連携は作成後にすぐに使えるので、アプリケーション作成に使っても良いアカウントがあれば一番簡単です。</p>

<p><a href="https://github.com/settings/applications">https://github.com/settings/applications</a> から <code>Register new application</code> で作成します。</p>

<ul>
<li>Application name: 適切な名前を設定</li>
<li>Homepage URL: たとえば <code>http://app.127.0.0.1.xip.io:3000/</code> など</li>
<li>Application description: ユーザーが許可するときにわかりやすい説明</li>
<li>Authorization callback URL: たとえば <code>http://app.127.0.0.1.xip.io:3000/auth/github/callback</code> のように <code>/auth/github/callback</code> にする。実サイトなら <code>https</code> にすべき。</li>
</ul>


<p>右上に見えている Client ID と Client Secret を使います。</p>

<ul>
<li>Client ID : 環境変数 <code>GITHUB_CONSUMER_KEY</code> に設定</li>
<li>Client Secret : 環境変数 <code>GITHUB_CONSUMER_SECRET</code> に設定</li>
</ul>


<p>dotenv を使っているので <code>.env</code> に以下のような感じで設定しました。
十六進数の数字のように見えます。</p>

<p>```text</p>

<pre><code>GITHUB_CONSUMER_KEY="xxxxxxxxxxxxxxxxxxxx"
GITHUB_CONSUMER_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
</code></pre>

<p>```</p>

<h2>Facebook 連携</h2>

<p><a href="https://developers.facebook.com/">https://developers.facebook.com/</a> から上の <code>Apps</code> の中にある <code>Craete a New App</code> で作成します。
最初は作成前に開発者関連の規約などに同意する必要があるようです。</p>

<ul>
<li>Display Name: 適切な名前を設定します。</li>
<li>Namespace: optional なので空欄のままで良いようです。</li>
<li>カテゴリ: 適当に選択します。</li>
</ul>


<p>セキュリティチェックがあるので、入力すると作成できます。</p>

<p>右上に見えている App ID と App Secret (Show を押すとパスワード認証の後に内容表示) を使います。</p>

<ul>
<li>App ID : 環境変数 <code>FACEBOOK_KEY</code> に設定</li>
<li>App Secret : 環境変数 <code>FACEBOOK_SECRET</code> に設定</li>
</ul>


<p>dotenv を使っているので <code>.env</code> に以下のような感じで設定しました。
十進数と十六進数の数字のように見えます。</p>

<p>```text</p>

<pre><code>FACEBOOK_KEY="xxxxxxxxxxxxxxx"
FACEBOOK_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
</code></pre>

<p>```</p>

<p><code>Settings</code> の <code>Add Platform</code> で <code>Website</code> を選んで追加します。</p>

<ul>
<li>Site URL: たとえば <code>http://app.127.0.0.1.xip.io:3000/</code> など</li>
<li>Mobile Site URL: 空欄のまま</li>
</ul>


<p>callback URL は設定が不要だったので、
Site URL の下ならどこでも良さそうです。</p>

<h3><code>google_oauth2</code> 連携</h3>

<p><a href="https://github.com/zquestz/omniauth-google-oauth2">https://github.com/zquestz/omniauth-google-oauth2</a> に書いてあるように
<a href="https://code.google.com/apis/console/">https://code.google.com/apis/console/</a> を開きます。</p>

<p>飛ばされる先で <code>API &amp; AUTH</code> の中の <code>Credentials</code> で <code>Create new Client ID</code> で作成します。</p>

<ul>
<li>Application type : Web application</li>
<li>Authorized JavaScript origins : たとえば <code>http://app.127.0.0.1.xip.io:3000</code> など</li>
<li>Authorized redirect URI : たとえば <code>http://app.127.0.0.1.xip.io:3000/auth/google_oauth2/callback</code> のように <code>/auth/google_oauth2/callback</code> にする。実サイトなら <code>https</code> にすべき。</li>
</ul>


<p>右に見えている Client ID と Client secret を使います。</p>

<ul>
<li>Client ID : 環境変数 <code>GOOGLE_CLIENT_ID</code> に設定</li>
<li>Client secret : 環境変数 <code>GOOGLE_CLIENT_SECRET</code> に設定</li>
</ul>


<p>dotenv を使っているので <code>.env</code> に以下のような感じで設定しました。
ドメインっぽい文字列とランダムな文字列のように見えます。</p>

<p>```text</p>

<pre><code>GOOGLE_CLIENT_ID="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="XXxxxXxXxxxXXxXXxXxXXxxX"
</code></pre>

<p>```</p>

<p>さらに <code>Consent screen</code> での設定が必要です。
しかも全アプリ共通のようなので、名前を分けたい場合はグーグルアカウントごと違うものにしないといけないように見えました。</p>

<ul>
<li>Email address : グーグルアカウントのアドレス選択</li>
<li>Product name : 適切な名前を設定</li>
<li>Homepage URL 以下 : 必要に応じて設定</li>
</ul>


<p>さらにエラーメッセージ (<code>"Access Not Configured. Please use Google Developers Console to activate the API for your project."</code>) で検索してわかったのですが、
<a href="http://qiita.com/aikyo02/items/459d03af304e1188f110" title="Google OAuth 2.0 loginが2014年9月に使えなくなる(Googleアカウントからのユーザ登録機能がある場合は注意)">Google OAuth 2.0 loginが2014年9月に使えなくなる(Googleアカウントからのユーザ登録機能がある場合は注意)</a>
に書いてあるように、
APIs で <code>Google+ API</code> も有効にする必要がありました。</p>

<h2>参考サイト</h2>

<ul>
<li><a href="http://xoyip.hatenablog.com/entry/2013/12/20/212109" title="Railsでログインとは別に複数のサービスとの連携を行う方法 - PILOG">Railsでログインとは別に複数のサービスとの連携を行う方法 &ndash; PILOG</a>
と<a href="https://github.com/xoyip/multi-oauth">その実装</a>は非常に参考になりました。</li>
<li><a href="http://qiita.com/aikyo02/items/459d03af304e1188f110" title="Google OAuth 2.0 loginが2014年9月に使えなくなる(Googleアカウントからのユーザ登録機能がある場合は注意)">Google OAuth 2.0 loginが2014年9月に使えなくなる(Googleアカウントからのユーザ登録機能がある場合は注意)</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[環境変数にハッシュの配列を入れてみた]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-25-env-array-hash.html"/>
    <updated>2014-06-25T21:37:22+09:00</updated>
    <id>http://blog.n-z.jp/blog/env-array-hash</id>
    <content type="html"><![CDATA[<p><a href="https://twitter.com/znz/status/481691675136245760">環境変数にハッシュを入れたいと思って、ちょっと考えてみたら LTSV を使えば良いということに気づいた</a>ので、
実装してみました。
実際には単独のハッシュではなくハッシュの配列がほしかったので、
連続する数値を末尾に付けて複数受け取れるようにしています。</p>

<!--more-->


<h2>実装</h2>

<p>キーワード引数を使っているので、
以下の実装のままだと ruby 2.0.0 以降必須です。
必要なら適当に変更して使ってください。</p>

<p><div><script src='https://gist.github.com/849166c048a2117c341d.js?file=env_ltsv_each.rb'></script>
<noscript><pre><code># -*- coding: utf-8 -*-
# env_ltsv_each.rb
# copyright (c) 2014 Kazuhiro NISHIYAMA
# This software is released under the MIT License.
# http://opensource.org/licenses/MIT
require &#39;ostruct&#39;

def env_ltsv_each(prefix, start: 0, encoding: Encoding::UTF_8, scrub: false)
  block_given? or return enum_for(__method__)
  i = start
  loop do
    ltsv = ENV[&quot;#{prefix}_#{i}&quot;]
    i = i.succ
    break unless ltsv
    h = OpenStruct.new
    ltsv.split(/\t/).each do |pair|
      key, value = pair.split(&#39;:&#39;, 2)
      value.force_encoding(encoding)
      value.scrub! if scrub
      h[key] = value
    end
    yield h
  end
  nil
end

if __FILE__ == $0
  ENV[&#39;NAVI_0&#39;] = &#39;icon:top	label:Top	uri:/&#39;
  ENV[&#39;NAVI_1&#39;] = &#39;icon:posts	label:Listing Posts	uri:/posts&#39;
  ENV[&#39;NAVI_2&#39;] = &#39;icon:users	label:Listing Users	uri:/users&#39;
  env_ltsv_each(&#39;NAVI&#39;) do |h|
    puts %Q(&lt;a href=&quot;#{h.uri}&quot;&gt;&lt;img src=&quot;#{h.icon}.png&quot; alt=&quot;#{h.label}&quot;&gt;&lt;/a&gt;)
    #=&gt;
    # &lt;a href=&quot;/&quot;&gt;&lt;img src=&quot;top.png&quot; alt=&quot;Top&quot;&gt;&lt;/a&gt;
    # &lt;a href=&quot;/posts&quot;&gt;&lt;img src=&quot;posts.png&quot; alt=&quot;Listing Posts&quot;&gt;&lt;/a&gt;
    # &lt;a href=&quot;/users&quot;&gt;&lt;img src=&quot;users.png&quot; alt=&quot;Listing Users&quot;&gt;&lt;/a&gt;
  end
end
</code></pre></noscript></div>
</p>

<h2>詳細</h2>

<p><code>String#scrub!</code> は 2.1.0 以降か
<a href="https://rubygems.org/gems/string-scrub">string-scrub gem</a>
が必要なのでデフォルトでは呼ばないようにしています。</p>

<p><code>Hash</code> だと取り出すのが面倒だったので、
<code>OpenStruct</code> を使ってみました。
メソッド名として問題がある場合は
<code>h['send']</code> のように普通の <code>Hash</code> のように取り出せます。</p>

<p>添字をまわすのに <code>succ</code> を使っているので <code>FOO_A</code>, <code>FOO_B</code>, &hellip; のような使い方も出来ると思います。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ci_reporter から rspec_junit_formatter に移行した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-06-13-ci-reporter-to-rspec-junit-formatter.html"/>
    <updated>2014-06-13T22:33:12+09:00</updated>
    <id>http://blog.n-z.jp/blog/ci-reporter-to-rspec-junit-formatter</id>
    <content type="html"><![CDATA[<p>rspec 2 から rpsec 3 への移行で <code>ci_reporter</code> がうまく動かなくなって困っていたら、
<code>rspec_junit_formatter</code> というのを<a href="https://twitter.com/joker1007/status/477372843601055744">教えてもらった</a>ので、
移行してみました。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li><code>ruby</code> 2.1.2</li>
<li><code>rails</code> 3.2.18</li>
<li><code>rspec-rails</code> 3.0.1</li>
<li><code>rspec_junit_formatter</code> 0.2.0</li>
</ul>


<h2>Gemfile の変更</h2>

<p><code>group :test</code> の <code>gem 'ci_reporter', require: false</code> を <code>gem 'rspec_junit_formatter'</code> に変更しました。</p>

<h2>jenkins で実行しているシェルスクリプトの変更</h2>

<p><code>bundle exec rake -f $(bundle show ci_reporter)/stub.rake ci:setup:rspec default SPEC_OPTS=--no-drb COVERAGE=on</code>
のように実行していたのを</p>

<p><code>
rm -rf spec/reports
cat &gt;.rspec &lt;&lt;EOF
--format RspecJunitFormatter
--out spec/reports/rspec.xml
EOF
bundle exec rake COVERAGE=on
</code></p>

<p>に変更しました。
<code>spec/reports</code> は自動で作成してくれるようで、事前に作成しておく必要はないようです。
<code>ci_reporter</code> はタスクの最初の方で <code>spec/reports</code> を削除していたので、同様に削除するようにしました。</p>

<p><code>COVERAGE=on</code> は <code>simplecov</code>, <code>simplecov-rcov</code> を有効にするかどうかのフラグとして使っているので今回の移行とは無関係です。</p>

<p><a href="https://github.com/sj26/rspec_junit_formatter">RSpec JUnit Formatter の README</a> に書いてある
<code>rspec --format RspecJunitFormatter --out rspec.xml</code>
という実行方法だとテスト用データベースの初期化関連で問題がおきたので、
<code>rspec</code> コマンド直接ではなく <code>rake</code> コマンドのデフォルトタスクで実行するために、
<code>.rspec</code> ファイルを書き換えるようにしました。
<code>SPEC_OPTS</code> で指定する方法でも良かったかもしれません。</p>

<h2>Jenkins の設定</h2>

<p><code>ci_reporter</code> の設定のときに
<code>ビルド後の処理</code> で <code>JUnitテスト結果の集計</code> を追加していて、
<code>テスト結果XML</code> は <code>spec/reports/**/*.xml</code> という設定にしていて、
<code>RspecJunitFormatter</code> の出力先の方をそちらにあわせたので、
Jenkins 側の設定は変更していません。</p>

<h2>テスト結果</h2>

<p>Jenkins のテスト結果の表示では <code>spec.controllers</code> や <code>spec.models</code> などがパッケージになっていました。</p>

<p><code>spec/support/*.rb</code> で <code>shared_examples</code> を定義していたら、
<code>spec.support</code> がパッケージになってしまっているのが気になりましたが、
<code>ci_reporter</code> のときはほぼすべてが <code>(root)</code> というパッケージになっていたのに比べると
便利になったように思います。</p>

<h2><code>RSpec::Core::DeprecationError</code></h2>

<p><code>RSpec.configure do |config|</code> で <code>config.raise_errors_for_deprecations!</code> を実行していると</p>

<pre><code>.../gems/rspec-core-3.0.1/lib/rspec/core/formatters/deprecation_formatter.rb:186:in `puts': Treating `metadata[:execution_result]` as a hash is deprecated. Use the attributes methods to access the data instead. Called from .../rspec_junit_formatter-0.2.0/lib/rspec_junit_formatter/rspec3.rb:43:in `result_of'. (RSpec::Core::DeprecationError)`
</code></pre>

<p>というエラーになったので、
<code>config.raise_errors_for_deprecations!</code>
を外しました。</p>

<p><a href="https://github.com/sj26/rspec_junit_formatter/commit/96f0115f7dabbea623f04b60dc23519683f39cfa">github の master では直っている</a>ので、次のバージョンがリリースされたら解決しそうです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[bootstrap 2.3.2 から bootstrap 3.1.1 への移行]]></title>
    <link href="http://blog.n-z.jp/blog/2014-03-14-bootstrap-2-to-3.html"/>
    <updated>2014-03-14T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/bootstrap-2-to-3</id>
    <content type="html"><![CDATA[<p>Rails 3.2.17 を使っている rails アプリで
bootstrap 2.3.2 から bootstrap 3.1.1 に移行している途中なのですが、
どういうところに対処が必要だったのか、
メモをまとめてみました。</p>

<!--more-->


<h2>Gemfile 変更</h2>

<p>bootstrap 2 系のときは twitter-bootstrap-rails gem を使っていたのですが、
bootstrap 3 系対応がリリースされていないこともあって、
bootstrap 側から公式にリリースされている bootstrap-sass gem に移行しました。</p>

<p>bootstrap-sass は rails_admin gem で使われていて、
バージョンが rails_admin によって制限されてしまうので、
公式の less の gem があれば良かったのですが、
見つけられなかったので、
自分しか使っていない rails_admin を rails 4 に上げるまでの間、
一時的に rails_admin を外して、
新しい bootstrap-sass を rails 3.2.17 と一緒に使いました。</p>

<p><code>ruby Gemfile
gem 'less-rails'
gem 'twitter-bootstrap-rails'
</code></p>

<p>を <a href="https://github.com/twbs/bootstrap-sass">https://github.com/twbs/bootstrap-sass</a> に書いてあるバージョン指定付きで</p>

<p><code>ruby Gemfile
gem 'sass-rails', '&gt;= 3.2'
gem 'bootstrap-sass', '~&gt; 3.1.1'
</code></p>

<p>に書き換えて、 <code>bundle update</code> で反映しました。</p>

<h2>twitter-bootstrap-rails のヘルパーメソッド削除</h2>

<p>twitter-bootstrap-rails で定義されているヘルパーメソッドを使っていたら、
削除するなり代替メソッドを定義して置き換えるなり、
一時的にコメントアウトするなりしてエラーにならないようにしておきます。</p>

<p>今回は <code>glyph</code> と <code>add_breadcrumb</code> がひっかかりました。</p>

<h2>bootstrap_and_overrides.css.less 削除</h2>

<p>app/assets/stylesheets/bootstrap_and_overrides.css.less を削除して、
app/assets/stylesheets/app.css.scss のようなファイルに移行しました。</p>

<p>```css app.css.scss
@import &ldquo;bootstrap&rdquo;;</p>

<p>// その他の bootstrap_and_overrides.css.less から移行した内容
```</p>

<h2>キャッシュ削除</h2>

<p>less を消したはずなのにエラーにならなくておかしいと思っていたら、
キャッシュの影響だったので、
development 環境でもキャッシュを有効にしている場合は削除します。</p>

<p><code>bundle exec rake tmp:clear</code> で消したり、
<code>rake</code> 経由だと遅いと思ったら
<code>rm -rf tmp/cache</code> のようにばっさり削除したりすると良いと思います。</p>

<h2>.navbar</h2>

<p>bootstrap 2 を使っていた頃は
<code>.navbar</code> と <code>.nav</code> の違いがよくわかっていなかったのですが、
<code>.navbar</code> は上 (または下) のバーのことで、
<code>.nav</code> はその中にある <code>ul</code> のリンクのことでした。</p>

<p><code>.nav</code> は他にも <code>.nav-tabs</code> のような使い方もするというのを先に知っていれば
迷わなかったと思います。</p>

<p><a href="http://getbootstrap.com/components/#nav">http://getbootstrap.com/components/#nav</a>
(古い方: <a href="http://getbootstrap.com/2.3.2/components.html#navs">http://getbootstrap.com/2.3.2/components.html#navs</a> )
の説明では navbar の上なのですが、
サイトの作成順として画面の上から作っていっていたので、
迷ってしまっていたようです。</p>

<p><code>.navbar</code> の中の <code>.nav</code> は <code>.navbar-nav</code> に変わっている、
<code>.navbar-inner</code> は <code>.container</code> か <code>.container-fluid</code> に置き換えなど、
変更点が多いので、
<code>.navbar</code> の中身は全面的に見直すのが良さそうです。</p>

<h2>.brand から .navbar-brand</h2>

<p><code>.brand</code> から <code>.navbar-brand</code> に変わっていました。</p>

<p>中に画像を入れているとずれてしまうので、
scss に以下のように書いて調整しました。</p>

<p>```css
.navbar-brand {
  padding-top: 8px;
  img {</p>

<pre><code>height: 34px;
width: 34px;
</code></pre>

<p>  }
}
```</p>

<p>8 + 34 + 8 ということで高さ 50px の <code>.navbar</code> の真ん中になることを期待しています。</p>

<h2>.container (固定幅) か .container-fluid (横幅いっぱい)</h2>

<p>grid system の配置を使うなら <code>.row</code> は <code>.container</code> か <code>.container-fluid</code> の中に置く必要があります。</p>

<p>違いは実際に window の横幅を変えてみればわかるのですが、
<code>.container</code> だと
<a href="http://getbootstrap.com/css/#grid">http://getbootstrap.com/css/#grid</a>
のように 768px 992px 1200px のところで急に配置が変わって、
その間は左右の余白が増減するだけのようです。</p>

<p><code>.container-fluid</code> だと普通のサイトと同じように出来るだけ横幅いっぱいになるように中身の横幅が変わります。</p>

<p>bootstrap 2 ではレスポンシブにしたいときは <code>.container-fluid</code> で固定幅の時は <code>.container</code> だったので、
<code>.container-fluid</code> しか使っていなかったのですが、
今はレスポンシブな中で使い分けが出来るようになっているようです。</p>

<p><a href="http://getbootstrap.com/examples/navbar-fixed-top/">http://getbootstrap.com/examples/navbar-fixed-top/</a>
の例で <code>Project name</code> が左端によっていないのも <code>.container</code> を使っているからです。
ブラウザーのデベロッパーツールで <code>.container-fluid</code> に変えて横幅を変えてみれば
違いがわかると思います。</p>

<h2><code>.row-fluid .span*</code> から <code>.row .col-xs-*</code></h2>

<p><code>.row</code> と <code>.row-fluid</code> の区別はなくなって、
<code>.row</code> に統一されています。</p>

<p><code>.span*</code> の置き換えは <code>.col-md-*</code> と説明されていることが多いようですが、
<code>.col-md-</code> が <code>@media (min-width: 992px)</code> になっているなど、
小さい画面サイズ用のスタイルを大きい画面用のスタイルで上書きするようになっているので、
画面サイズに関わらず同じ分割をしたいのなら <code>.col-xs-</code> だけ指定すれば良さそうです。</p>

<h2>btn</h2>

<p><code>btn</code> だけでは色や枠 (border) が変わらなくなったので、
<code>btn-default</code> を足す必要がありました。</p>

<p>サイズ変更の <code>btn-mini</code> などがなくなって <code>btn-xs</code> などに変更する必要がありました。</p>

<h2>list-unstyled</h2>

<p><code>ul.unstyled</code> は <code>ul.list-unstyled</code> に変更する必要がありました。</p>

<h2>font-awesome-sass</h2>

<p>アイコンは glyphicons ではなく font-awesome を使っていたので、
<a href="https://github.com/FortAwesome/font-awesome-sass">font-awesome-sass</a>
に乗り換えました。</p>

<p>mixin や variables などがなければ関係なさそうですが、
<a href="https://github.com/twbs/bootstrap-sass#usage">bootstrap-sass の Usage</a>
では <code>//= require</code> より <code>@import</code> が推奨されていたので、</p>

<p><code>css
@import "bootstrap";
@import "font-awesome";
</code></p>

<p>のように <code>@import</code> にしてみました。</p>

<p><code>&lt;i class="icon-sort"&gt;&lt;/i&gt;</code> が
<code>&lt;i class="fa fa-sort"&gt;&lt;/i&gt;</code> に変わるような感じで、
<code>icon-</code> を <code>fa-</code> に置き換えるだけではなく、
<code>fa</code> の追加が必要でした。</p>

<p><code>glyph</code> ヘルパーメソッドを使っていた場合は、
<code>icon</code> ヘルパーメソッドに書き換えると良いのですが、
複数引数の扱いが違うのと、
<code>_</code> を <code>-</code> に置き換える処理がなくなっているのに注意が必要です。</p>

<p>たとえば <code>glyph(:sort_up)</code> は <code>icon('sort-up')</code> のように書き換えました。</p>

<p><code>glyph(:lock, :white)</code> のような複数指定には対応していないようなので、</p>

<p>```haml</p>

<pre><code>= icon('spinner fa-spin'.freeze)
-# or
= icon(:spinner, nil, class: 'fa-spin')
</code></pre>

<p>```</p>

<p>のように 2 個目以降は無理矢理埋め込むしかなさそうです。</p>

<p>それぞれのヘルパーメソッドのソースは以下のようになっています。</p>

<ul>
<li><a href="https://github.com/seyhunak/twitter-bootstrap-rails/blob/40afc477f6a3813ef82cf5821602c9cf2422efc2/app/helpers/glyph_helper.rb">glyph</a></li>
<li><a href="https://github.com/FortAwesome/font-awesome-sass/blob/23ca05e75e85ec84afecca9f62e7f01d1fb9628b/lib/font_awesome/sass/rails/helpers.rb">icon</a></li>
</ul>


<p><code>icon</code> は第2引数に文字列を指定すると間にスペースを入れてくれるので、
今までは</p>

<p><code>css
i[class^="icon-"]:after {
  content: " "
}
</code></p>

<p>のようにスタイルシートで空白を足していたのですが、</p>

<p><code>ruby
icon(:pencil, t('.edit', default: :'helpers.links.edit'))
</code></p>

<p>のように使うのも良さそうです。</p>

<p>今回は書き換えの手間を減らすため、以下のように今までと同じようにスタイルシートで空白を入れるようにしました。
何のスタイルが影響しているのか調べていないのですが、半角スペースだとうまくいかなかったので、 NBSP を直接埋め込みました。</p>

<p><code>css
i.fa:after {
  content: " "; // nbsp
}
</code></p>

<p>いくつかのアイコンの名前は変更が必要でした。
使っていて影響があったのは以下のアイコンでした。</p>

<ul>
<li>変更前 変更後</li>
<li>comment-alt comment-o</li>
<li>folder_close folder</li>
<li>picture picture-o</li>
<li>remove times</li>
<li>signin sign-in</li>
<li>signout sign-out</li>
<li>star-empty star-o</li>
<li>trash trash-o</li>
</ul>


<h2>pagination</h2>

<p>kaminari を使っているので、
<code>app/views/kaminari/_paginator.html.*</code>
の
<code>nav.pagination ul</code>
という構造になっている部分を
<code>ul.pagination</code>
に書き換えるだけでした。</p>

<h2>label</h2>

<p><code>btn</code> と同様に <code>label</code> 単独ではなく <code>label-default</code> と組み合わせるようになりました。</p>

<p>選択されているものに <code>label-inverse</code> を使っていたのになくなってしまったので、
<code>label-primary</code> に変えました。</p>

<p>意味的には <code>.nav</code> に変えた方が良さそうなので、
一通り一時的な対処をした後にちゃんと変更しようと思っています。</p>

<h2>muted</h2>

<p><code>.muted</code> は <code>.text-muted</code> に変更しました。</p>

<h2>参考サイト: Bootstrap3移行ガイド</h2>

<p>基本的に本家のドキュメントを参照していたのですが、
ここまで変更してから 2 から 3 への移行のドキュメントを探して、
<a href="http://bootstrap.s1.adexd.net/">Bootstrap3移行ガイド</a>
をみつけて見てみたのですが、全体としては非常に参考になるのですが、
所々気になる点がありました。
連絡先が見つけられなかったので、ここにメモしておきます。</p>

<p><a href="http://bootstrap.s1.adexd.net/css.php#grid">グリッドシステム（Grid system）</a>
の【Bootstrap2.xとの変更箇所】の説明で <code>.row</code> と使い分けると書いているのは
間違いだと思います。</p>

<p>スクリーンリーダー用のクラスを
<a href="http://bootstrap.s1.adexd.net/css.php#screen-reader">すべての要素の表示を隠す</a>
と説明しているなど、たまに間違いがあるようです。</p>

<h2>現状まとめ</h2>

<p>layouts といくつかのコントローラーに対応する views を変更すれば
ある程度自分のアプリで使っているものは網羅できるので、
そこからは移行に必要な変更点はわかってきて速くなっていく感じでした。</p>

<p>先日書いた haml から slim への移行も同時にやっていて、
views 全体を見直す良い機会になっています。</p>

<p>一部で jquery-ui を使っていて、
機能的には問題ないのですが、
見た目が bootstrap 3 となじまないので、
後で対処が必要そうでした。</p>
]]></content>
  </entry>
  
</feed>
