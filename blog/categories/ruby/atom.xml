<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ruby | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/ruby/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2014-03-11T14:40:37+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Ruby 2.1.1のhash#rejectの不具合対策]]></title>
    <link href="http://blog.n-z.jp/blog/2014-03-11-hash-reject.html"/>
    <updated>2014-03-11T14:22:28+09:00</updated>
    <id>http://blog.n-z.jp/blog/hash-reject</id>
    <content type="html"><![CDATA[<p><a href="https://www.ruby-lang.org/ja/news/2014/03/10/regression-of-hash-reject-in-ruby-2-1-1/">Ruby 2.1.1 に含まれる Hash#reject の不具合について</a>
という話があって、
自分で書くコードでは普通は Hash を継承することはない (is-a にせずに has-a にすることが多い) ので影響はないのですが、
Rails の中の ActiveSupport が影響を受けるということで対処を入れました。</p>

<p>他にもバックポート漏れのコミットをあてた独自ビルドを使うとか、
Ruby 2.1.0 を使う、という対処もあるようです。</p>

<!--more-->


<p><a href="https://github.com/rails/rails/issues/14188">Rails の Issue #14188</a>
で話があるようにセキュリティ修正ではないため、
Rails 3.2 系にこの修正は入らないので、
モンキーパッチを入れることにしました。</p>

<p>bugs.ruby-lang.org では
<a href="https://github.com/ruby/bugs.ruby-lang.org/blob/ro-2-5/lib/redmine/core_ext.rb">https://github.com/ruby/bugs.ruby-lang.org/blob/ro-2-5/lib/redmine/core_ext.rb</a>
のように対処していたのを参考にして、
以下のようなコードを
<code>config/initializers/hash_reject.rb</code>
に置いて対処することにしました。</p>

<p>```ruby config/initializers/hash_reject.rb</p>

<h1>monkey patch for regression of Hash#reject in Ruby 2.1.1</h1>

<h1>see <a href="https://www.ruby-lang.org/ja/news/2014/03/10/regression-of-hash-reject-in-ruby-2-1-1/">https://www.ruby-lang.org/ja/news/2014/03/10/regression-of-hash-reject-in-ruby-2-1-1/</a></h1>

<h1>or <a href="https://www.ruby-lang.org/en/news/2014/03/10/regression-of-hash-reject-in-ruby-2-1-1/">https://www.ruby-lang.org/en/news/2014/03/10/regression-of-hash-reject-in-ruby-2-1-1/</a></h1>

<p>require &lsquo;active_support/hash_with_indifferent_access&rsquo;
require &lsquo;active_support/ordered_hash&rsquo;</p>

<p>module ActiveSupport
  class HashWithIndifferentAccess</p>

<pre><code>def select(*args, &amp;block)
  dup.tap { |hash| hash.select!(*args, &amp;block) }
end

def reject(*args, &amp;block)
  dup.tap { |hash| hash.reject!(*args, &amp;block) }
end
</code></pre>

<p>  end</p>

<p>  class OrderedHash</p>

<pre><code>def select(*args, &amp;block)
  dup.tap { |hash| hash.select!(*args, &amp;block) }
end

def reject(*args, &amp;block)
  dup.tap { |hash| hash.reject!(*args, &amp;block) }
end
</code></pre>

<p>  end
end
```</p>

<p>ここのコードが実行される前に読み込まれていれば問題ないのですが、
ここでクラス定義してしまうと元々の定義が autoload されなくなるので、
念のため require しています。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第 8 回 RubyMotion もくもく会 in Osaka に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-02-19-rubymotion-mokumoku-osaka.html"/>
    <updated>2014-02-19T19:27:12+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-mokumoku-osaka</id>
    <content type="html"><![CDATA[<p>第 1 回から第 7 回にも参加した RubyMotion もくもく会 in Osaka の
<a href="http://connpass.com/event/4910/">第 8 回 RubyMotion もくもく会 in Osaka</a>
に参加してきました。</p>

<p>次回の
<a href="http://connpass.com/event/5276/">第 9 回 RubyMotion もくもく会 in Osaka</a>
は 3/19(水) になりました。</p>

<!--more-->


<h2>話に出たもの</h2>

<p>話に出てきたサイトなどのメモです。</p>

<ul>
<li><a href="http://connpass.com/event/5274/">iBeacon 勉強会（入門編）</a></li>
<li><a href="http://japan.gamesalad.com/">GameSalad</a></li>
<li><a href="http://www.hirotangame.net/">広探ゲーム</a></li>
</ul>


<h2>もくもく</h2>

<p>ブラウザを開くのに <code>open</code> コマンドを経由から <code>NSWorkspace</code> の <code>openURLs:withAppBundleIdentifier:options:additionalEventParamDescriptor:launchIdentifiers:</code> 経由に変更しました。</p>

<p>```ruby
  def openBrowser(app, *args)</p>

<pre><code>r, w = IO.pipe
pid = Process.spawn('open', '-a', app, @text.stringValue, *args, [:out, :err] =&gt; w)
w.close
pid, status = Process.waitpid2(pid)
output = r.read
r.close
unless status.success?
  alert = NSAlert.new
  alert.messageText = "Failed to open #{app}\n\n#{output}"
  alert.runModal
end
</code></pre>

<p>  end
```</p>

<p><code>open -b</code> を使っていれば引数は変わらなかったのですが、 <code>open -a</code> を使っていたので、引数がアプリケーション名からバンドル ID に変わりました。</p>

<p><code>open -a 'Google Chrome' http://localhost:4000/ --args -incognito</code> の <code>-incognito</code> のような追加引数の渡し方がわからなかったので、 Chrome のシークレットウインドウを直接開く機能はなくしました。</p>

<p>```ruby
  NSWorkspaceLaunchAsync = 0x00010000
  NSWorkspaceLaunchAllowingClassicStartup = 0x00020000
  NSWorkspaceLaunchDefault = NSWorkspaceLaunchAsync | NSWorkspaceLaunchAllowingClassicStartup</p>

<p>  def openBrowser(app_bundle_id)</p>

<pre><code>url = NSURL.URLWithString @text.stringValue
ret = NSWorkspace.sharedWorkspace.openURLs([url], withAppBundleIdentifier: app_bundle_id, options: NSWorkspaceLaunchDefault, additionalEventParamDescriptor: nil, launchIdentifiers: nil)
unless ret
  alert = NSAlert.new
  alert.messageText = "Failed to open #{app}"
  alert.runModal
end
</code></pre>

<p>  end
```</p>

<p><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/Workspace/Articles/WorkspaceServices.html">Workspace Services Programming Topics: Manipulating Files</a>
には <code>openURL:</code> しか書いてなかったり、
<code>additionalEventParamDescriptor</code> には何を渡せばいいのかわかりにくかったりして困りましたが、
<a href="http://www.lancard.com/blog/2011/05/01/open-url-with-browser-about-mac-app/">http://www.lancard.com/blog/2011/05/01/open-url-with-browser-about-mac-app/</a>
のように呼び出せばうまくいきました。</p>

<p>最初に <code>rake</code> の REPL で試していたら、以下のエラーになるので、しばらく悩んでいましたが、 <code>app/app_delegate.rb</code> の中に書けば動いたので、 <code>rake</code> でコンパイルされるタイミングでリンクできていないメソッドは呼び出せないということなのかと思いました。</p>

<p>```console
(main)> url = NSURL.URLWithString(&ldquo;<a href="http://www.apple.com">http://www.apple.com</a>&rdquo;)
=> #&lt;NSURL:0x7fcbe8e45060>
(main)> NSWorkspaceLaunchAsync = 0x00010000
=> 65536
(main)> NSWorkspaceLaunchAllowingClassicStartup = 0x00020000
=> 131072
(main)> NSWorkspaceLaunchDefault = NSWorkspaceLaunchAsync | NSWorkspaceLaunchAllowingClassicStartup
=> 196608
(main)> NSWorkspace.sharedWorkspace.openURLs([url], withAppBundleIdentifier: &ldquo;com.google.Chrome&rdquo;, options: NSWorkspaceLaunchDefault, additionalEventParamDescriptor: nil, launchIdentifiers: nil)
dyld: lazy symbol binding failed: Symbol not found: __ZN9RoxorCore14find_bs_cftypeESs
  Referenced from: /Library/RubyMotion/data/osx/librubymotion-repl.dylib
  Expected in: flat namespace</p>

<p>dyld: Symbol not found: __ZN9RoxorCore14find_bs_cftypeESs
  Referenced from: /Library/RubyMotion/data/osx/librubymotion-repl.dylib
  Expected in: flat namespace</p>

<p>================================================================================
The application terminated. A crash report file may have been generated by the
system, use <code>rake crashlog' to open it. Use</code>rake debug=1' to restart the app</p>

<h1>in the debugger.</h1>

<p>```</p>

<h2>NSDate</h2>

<p>途中 <code>NSDate.distantFuture</code> の返り値がおかしいという話がありました。</p>

<p><code>
(main)&gt; NSDate.distantFuture
=&gt; 1677-09-21 09:12:43 +0900
(main)&gt; NSDate.distantPast
=&gt; 1677-09-21 09:12:43 +0900
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[bootstrap-sass-railsからbootstrap-sassに移行した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-02-06-bootstrap-sass.html"/>
    <updated>2014-02-06T14:29:27+09:00</updated>
    <id>http://blog.n-z.jp/blog/bootstrap-sass</id>
    <content type="html"><![CDATA[<p>今日の <code>bundle update</code> は bootstrap の sass の gem を bootstrap 公式のものに移行したのが大きな変更点でした。</p>

<!--more-->


<h2>bootstrap-sass-rails から bootstrap-sass 3.1.0.2</h2>

<p><a href="http://blog.getbootstrap.com/2014/01/30/bootstrap-3-1-0-released/">bootstrap 3.1.0 がリリース</a>されて少し時間が経ったので、
bootstrap-sass-rails を確認してみたところ、
<a href="https://github.com/yabawock/bootstrap-sass-rails#deprecation-notice">DEPRECATION NOTICE</a>
に公式サポートされた sass の gem があるので、
そちらに移行を推奨と書かれていたので、移行しました。</p>

<p>bootstrap-sass gem への移行は UPGRADING に書かれているように <code>@import "twitter/bootstrap";</code> を <code>@import "bootstrap";</code> に書き換えるだけでした。</p>

<h2>bootstrap-sass のカスタマイズ</h2>

<p><a href="https://github.com/twbs/bootstrap-sass#usage">Usage</a>
によると、一番単純な使い方としては <code>@import "bootstrap";</code> だけですが、
<a href="http://getbootstrap.com/customize/#less-variables">Less variables</a>
を参考にして以下のようにカスタマイズして使うのが良いようです。</p>

<p>Less では変数の接頭辞は <code>@</code> ですが、 sass では <code>$</code> になることさえわかっていれば、最低限のカスタマイズは出来ると思います。</p>

<p>```
$navbar-default-bg: #312312;
$light-orange: #ff8c00;
$navbar-default-color: $light-orange;</p>

<p>@import &ldquo;bootstrap&rdquo;;
```</p>

<p>bootstrap-sass-rails からの移行だったので、
bootstrap-custom.css.scss の内容は以下のようにしました。</p>

<p>```
$body-bg:               #fff;
$text-color:            lighten(#000, 20%);</p>

<p>@import &ldquo;bootstrap&rdquo;;
```</p>

<p>もっと高度なカスタマイズをするなら、
<code>cp $(bundle show bootstrap-sass)/vendor/assets/stylesheets/bootstrap.scss app/assets/stylesheets/bootstrap-custom.scss</code>
でコピーしたファイルを
<code>@import 'bootstrap';</code>
の代わりに
<code>@import 'bootstrap-custom';</code>
で使うことを想定しているようです。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rails_best_practices 1.15.0でtryが壊れた]]></title>
    <link href="http://blog.n-z.jp/blog/2014-02-05-rails-best-practices-1-15-0-broken.html"/>
    <updated>2014-02-05T10:35:06+09:00</updated>
    <id>http://blog.n-z.jp/blog/rails-best-practices-1-15-0-broken</id>
    <content type="html"><![CDATA[<p>今日の <code>bundle update</code> をしてみたところ、開発環境での devise でのログイン時に <code>devise (3.2.2) lib/devise/hooks/csrf_cleaner.rb, line 3</code> で <code>wrong number of arguments (2 for 1)</code> という <code>ArgumentError</code> が発生するようになりました。</p>

<p>その原因調査方法の記録です。</p>

<!--more-->


<p>例外が発生した行は以下の内容で、今まで問題なく動いていたし、特に問題はなさそうだったので、他の gem の影響だということがわかりました。</p>

<p>```ruby lib/devise/hooks/csrf_cleaner.rb
Warden::Manager.after_authentication do |record, warden, options|
  if Devise.clean_up_csrf_token_on_authentication</p>

<pre><code>warden.request.session.try(:delete, :_csrf_token)
</code></pre>

<p>  end
end
```</p>

<p>ソースコードを追いかけるのは難しそうだったので、 better_errors の live shell を使って調査しました。</p>

<p>```console</p>

<blockquote><blockquote><p>env.keys
=> 略
env[&ldquo;warden&rdquo;]
=> Warden::Proxy:70192217236640 @config={:default_scope=>:user, :scope_defaults=>{}, :default_strategies=>{:user=>[:rememberable, :database_authenticatable]}, :intercept_401=>false, :failure_app=>#&lt;Devise::Delegator:0x007fadcc44d438>}
env[&ldquo;warden&rdquo;].request
=> #&lt;ActionDispatch::Request:0x007fadd10c4dc0 略>
env[&ldquo;warden&rdquo;].request.session
=> {&ldquo;session_id&rdquo;=>&ldquo;略&rdquo;, &ldquo;user_return_to&rdquo;=>&ldquo;/&rdquo;, &ldquo;<em>csrf_token&rdquo;=>&ldquo;略&rdquo;, &ldquo;warden.user.user.key&rdquo;=>[[8], &ldquo;$2a$10$略&rdquo;]}
env[&ldquo;warden&rdquo;].request.session.try(:delete, :</em>csrf_token)
!! #&lt;ArgumentError: wrong number of arguments (2 for 1)>
```</p></blockquote></blockquote>

<p><code>env["warden"]</code> 経由で再現しました。</p>

<p>次に原因を探るために <code>arity</code> を調べました。</p>

<p>```console</p>

<blockquote><blockquote><p>env[&ldquo;warden&rdquo;].request.session.methods.grep /delete/
=> [:delete, :delete_if]
env[&ldquo;warden&rdquo;].request.session.method(&ldquo;delete&rdquo;)
=> #&lt;Method: Rack::Session::Abstract::SessionHash#delete>
env[&ldquo;warden&rdquo;].request.session.method(&ldquo;delete&rdquo;).arity
=> 1
env[&ldquo;warden&rdquo;].request.session.method(&ldquo;try&rdquo;)
=> #&lt;Method: Rack::Session::Abstract::SessionHash(Object)#try>
env[&ldquo;warden&rdquo;].request.session.method(&ldquo;try&rdquo;).arity
=> 1
env[&ldquo;warden&rdquo;].request.session.method(&ldquo;try&rdquo;).source_location
=> [&ldquo;略/rails_best_practices-1.15.0/lib/rails_best_practices/core_ext/object.rb&rdquo;, 7]</p>

<p>```</p></blockquote></blockquote>

<p>rails_best_practices 1.15.0 が原因とわかったので issues を確認すると既に同様の現象の報告があったので、<a href="https://github.com/railsbp/rails_best_practices/issues/202#issuecomment-34129010">コメントしておきました</a>。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[bundle updateした記録]]></title>
    <link href="http://blog.n-z.jp/blog/2014-02-03-bundle-update.html"/>
    <updated>2014-02-03T17:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/bundle-update</id>
    <content type="html"><![CDATA[<p><code>bundle update</code> で更新された gem などのメモを残すことにしました。</p>

<!--more-->


<h2>jquery-rails 3.1.0 (was 3.0.4)</h2>

<p>jQuery 1.11.0 にあがったのと jquery-ujs が更新されていました。</p>

<p>```text CHANGELOG.md</p>

<h2>3.1.0 (29 January 2014)</h2>

<ul>
<li>Updated to jQuery 1.11.0</li>
<li>Updated to latest jquery-ujs</li>
<li>Added development rake task for updating jQuery
```</li>
</ul>


<h2>omniauth-oauth2 1.1.2 (was 1.1.1)</h2>

<p>oauth2 が 0.8.1 から 0.9.3 に一気にあがって驚きましたが、
omniauth-oauth2 の依存関係が更新されたのが原因でした。</p>

<p>他にもたくさん変更されていました。</p>

<h2>turbolinks 2.2.1 (was 2.2.0)</h2>

<p><a href="https://github.com/rails/turbolinks/blob/master/CHANGELOG.md#turbolinks-221-january-30-2014">https://github.com/rails/turbolinks/blob/master/CHANGELOG.md#turbolinks-221-january-30-2014</a>
によるとバグ修正のみのようです。</p>

<h2>rails_admin 0.6.1 (was 0.6.0)</h2>

<p>paper_trail gem が 3.0.0 で <code>Version</code> から <code>PaperTrail::Version</code> に変わった
<a href="https://github.com/airblade/paper_trail/pull/165">#165</a>
影響を受けて、
<code>config/initializers/rails_admin.rb</code>
を以下のように変更する必要がありました。</p>

<p>```diff config/initializers/rails_admin.rb.diff
&mdash;&ndash; a/config/initializers/rails_admin.rb
+++ b/config/initializers/rails_admin.rb
@@ -18,7 +18,7 @@ RailsAdmin.config do |config|
   # config.audit_with :history, &lsquo;User&rsquo;</p>

<p>   # Or with a PaperTrail: (you need to install it first)
&ndash;  config.audit_with :paper_trail, &lsquo;User&rsquo;
+  config.audit_with :paper_trail, &lsquo;User&rsquo;, &lsquo;PaperTrail::Version&rsquo;</p>

<p>   # Display empty fields in show views:
   # config.compact_show_view = false
```</p>

<p>あまりカスタマイズしていないのなら、
<code>rails g rails_admin:install</code>
で生成し直して、設定し直した方が良いかもしれません。</p>

<p>最初に rails_admin を更新した rails アプリでは以下のように
devise と pundit と paper_trail の設定をしただけで、
actions などはそのままにしています。</p>

<p>```ruby config/initializers/rails_admin.rb
RailsAdmin.config do |config|</p>

<p>  ### Popular gems integration</p>

<p>  ## == Devise ==
  config.authenticate_with do</p>

<pre><code>warden.authenticate! scope: :user
</code></pre>

<p>  end
  config.current_user_method(&amp;:current_user)</p>

<p>  ## == Cancan ==
  # config.authorize_with :cancan</p>

<p>  require &lsquo;rails_admin/extensions/pundit&rsquo;
  config.authorize_with :pundit</p>

<p>  ## == PaperTrail ==
  config.audit_with :paper_trail, &lsquo;User&rsquo;, &lsquo;PaperTrail::Version&rsquo; # PaperTrail >= 3.0.0</p>

<p>  ### More at <a href="https://github.com/sferik/rails_admin/wiki/Base-configuration">https://github.com/sferik/rails_admin/wiki/Base-configuration</a></p>

<p>  config.actions do</p>

<pre><code>dashboard                     # mandatory
index                         # mandatory
new
export
bulk_delete
show
edit
delete
show_in_app

## With an audit adapter, you can add:
# history_index
# history_show
</code></pre>

<p>  end
end
```</p>
]]></content>
  </entry>
  
</feed>
