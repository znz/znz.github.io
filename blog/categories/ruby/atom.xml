<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ruby | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/ruby/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2015-01-10T17:06:16+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rubyによるクローラー開発技法を読んだ]]></title>
    <link href="http://blog.n-z.jp/blog/2014-12-30-ruby-crawler.html"/>
    <updated>2014-12-30T18:21:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/ruby-crawler</id>
    <content type="html"><![CDATA[<p>次回の
<a href="http://kokucheese.com/event/index/247692/" title="1月10日 Rubyによるクローラー開発技法　読書会　第3回(兵庫県)">1月10日 Rubyによるクローラー開発技法　読書会　第3回(兵庫県)</a>
は
<a href="http://lilo.doorkeeper.jp/events/18987" title="LILO ＆ 東海道らぐ・オフラインミーティング（2015/01/10） - LILO | Doorkeeper">LILO ＆ 東海道らぐ・オフラインミーティング（2015/01/10） - LILO | Doorkeeper</a>
と重なっていて参加できないということで、Rubyによるクローラー開発技法を読んでしまったので、そのメモです。</p>

<!--more-->


<h2>メモ</h2>

<div style="float:right">
<iframe src="http://rcm-fe.amazon-adsystem.com/e/cm?lt1=_blank&amp;bc1=000000&amp;IS2=1&amp;bg1=FFFFFF&amp;fc1=000000&amp;lc1=0000FF&amp;t=znz-22&amp;o=9&amp;p=8&amp;l=as4&amp;m=amazon&amp;f=ifr&amp;ref=ss_til&amp;asins=4797380357" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>
</div>


<ul>
<li>p.62 <code>robotex.rb</code> の 4 行目は 3 行目の引数にならずに意味がないのでは。</li>
<li>p.67 <code>anemone-skip_links_like.rb</code> で「adminを含むURLは除外」と書いてあるのに <code>/\/r\//</code> になっている。</li>
<li>p.69 <code>http://example.com</code> と <code>http://example.com/</code> は同じ意味で 301 リダイレクトは発生しないのでは。</li>
<li>p.143 「スクリーンショットはページごとに上書きされていって、」とあるが、ここは上書きされないのでは。</li>
<li>p.173 <code>Nokogiri#parse</code> などは <code>Nokogiri.parse</code> (インスタンスメソッドではなくクラスメソッド) なのでは。</li>
<li>p.215 <code>initialize</code> の <code>#{}</code> は不要なのでは。</li>
<li>p.239 <code>page.code = 500</code> は <code>page.code == 500</code> の間違い?</li>
<li>p.258 <code>base_url</code> への代入が連続しているのが不要</li>
<li>p.359 プスクリプト → スクリプト</li>
<li>p.420 varidation → validation</li>
<li>p.420 gsub の結果は Integer にならないのでは?</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[doorkeeper gem を 1.4 系から 2.0 系にアップデートした]]></title>
    <link href="http://blog.n-z.jp/blog/2014-12-18-doorkeeper-gem-1-to-2.html"/>
    <updated>2014-12-18T16:18:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/doorkeeper-gem-1-to-2</id>
    <content type="html"><![CDATA[<p>doorkeeper gem がメジャーバージョンアップして非互換があったので、
対応したときのメモです。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>rails 4.1.8</li>
<li>doorkeeper 1.4.0 から 2.0.1</li>
</ul>


<h2>変更点確認</h2>

<p><a href="https://github.com/doorkeeper-gem/doorkeeper/blob/master/CHANGELOG.md">CHANGELOG.md</a>
にまとまっていたので、参考にしました。</p>

<p>セキュリティアップデートも含まれるようなので、
2.0 系にあげられないときは 1.4.1 にあげておくのが良さそうです。</p>

<h2><code>doorkeeper_for</code> の書き換え</h2>

<p><code>doorkeeper_for :all</code> は <code>before_action :doorkeeper_authorize!</code> に書き換えました。</p>

<pre><code class="diff">-    doorkeeper_for :all
-    respond_to     :json
+    before_action :doorkeeper_authorize!
+    respond_to    :json
</code></pre>

<pre><code class="diff">-    doorkeeper_for :index,  :show,   scopes: %w"public"
-    doorkeeper_for :create, :update, scopes: %w"admin write"
+    before_action -&gt; { doorkeeper_authorize! :public }, only: [:index, :show]
+    before_action only: [:create, :update] do
+      doorkeeper_authorize! :admin, :write
+    end
</code></pre>

<h2><code>config/initializers/doorkeeper.rb</code> の更新</h2>

<p><code>rails g doorkeeper:install</code> で生成し直して変更していた部分を再適用しました。</p>

<ul>
<li><code>resource_owner_authenticator</code> で <code>devise</code> との連携</li>
<li>scope 関連</li>
<li>認可の画面のスキップ</li>
<li>動的な query parameter の許可</li>
</ul>


<pre><code class="ruby">  resource_owner_authenticator do
    current_user || warden.authenticate!(scope: :user)
  end

  default_scopes  :public
  optional_scopes :admin, :write

  skip_authorization do |resource_owner, client|
    true
  end

  wildcard_redirect_uri true
</code></pre>

<h2><code>config/locales/doorkeeper.en.yml</code> の更新</h2>

<p><code>rails g doorkeeper:install</code> で <code>config/initializers/doorkeeper.rb</code> と一緒に更新されていました。</p>

<p>認可の画面をスキップしている関係で、翻訳はせずに en を ja に置き換えただけで
そのまま使っていたので、同様に置き換えてそのまま使いました。</p>

<h2><code>redirect urimust be an HTTPS/SSL URI.</code> 対策</h2>

<p>テストの中で
<code>let!(:application) { Doorkeeper::Application.create!(name: 'MyApp', redirect_uri: 'http://api.test') }</code>
のようにしていると
<code>redirect urimust be an HTTPS/SSL URI.</code>
で失敗していたので、
<code>https</code> の URL に変更するか、
<code>config/initializers/doorkeeper.rb</code> で
<code>force_ssl_in_redirect_uri false</code>
にする必要がありました。</p>

<h2>Missing column: <code>applications.scopes</code></h2>

<p>テストを実行したときに</p>

<pre><code>[doorkeeper] Missing column: `applications.scopes`. If you are using ActiveRecord run `rails generate doorkeeper:application_scopes &amp;&amp; rake db:migrate` to add it.
</code></pre>

<p>というメッセージが出るので、メッセージ通り
<code>rails generate doorkeeper:application_scopes &amp;&amp; rake db:migrate</code>
で追加しました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第64回 Ruby関西 勉強会に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-12-13-rubykansai64.html"/>
    <updated>2014-12-13T13:13:04+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubykansai64</id>
    <content type="html"><![CDATA[<p><a href="http://rubykansai.doorkeeper.jp/events/17347" title="第64回 Ruby関西 勉強会">第64回 Ruby関西 勉強会</a>
に参加したので、そのメモです。</p>

<!--more-->


<h2>オープニング</h2>

<ul>
<li>勉強会の名前がちょっと変わった。</li>
</ul>


<h2>名付け親システム</h2>

<ul>
<li>子供の名前付けの補助をするプログラムを作った話</li>
<li>要件定義が一番時間がかかった</li>
</ul>


<h2>史上最安易／できるだけ速く数を数えたい</h2>

<ul>
<li>那由他まで挑戦したい</li>
<li>enzi</li>
<li>RuJit</li>
<li>IO が遅いのではという話</li>
</ul>


<h2>Ruby/SDL2 のはなし</h2>

<ul>
<li><a href="https://github.com/ohai/ruby-sdl2">https://github.com/ohai/ruby-sdl2</a></li>
<li><a href="http://www.kmc.gr.jp/~ohai/rubysdl2/doc-en/">http://www.kmc.gr.jp/~ohai/rubysdl2/doc-en/</a></li>
<li>SDL 2.x 自体は Android などにも対応しているらしい (Ruby/SDL2 は無理)</li>
<li>2000年頃(?)から 2D 描画にも 3D 機能を利用するようになってきていた</li>
<li>初期化に失敗したときのエラーメッセージ表示とかできるようになった</li>
<li>yard の i18n 機能は英語を書いておかないと日本語が書けないので日本語は後になっている</li>
<li>加算ブレンディングは光っぽいものに使う</li>
<li>アルファブレンディングは透明っぽいものに使う</li>
<li>デモ: <a href="https://gist.github.com/ohai/fb18f6c313ce669911a3">https://gist.github.com/ohai/fb18f6c313ce669911a3</a></li>
<li>Smalruby で Ruby/SDL (1の方) が使われているらしい</li>
<li>SDL と SDL2 が非互換なので</li>
</ul>


<h2>DDD with Rails</h2>

<ul>
<li><a href="https://speakerdeck.com/ogom/ddd-with-rails">https://speakerdeck.com/ogom/ddd-with-rails</a></li>
<li><a href="https://github.com/hommachirb/rails-ddd">https://github.com/hommachirb/rails-ddd</a></li>
<li>ActiveState が middleware なのはデータベースに接続できないと ActiveRecord の middleware でエラーになって、そもそも任意の view が使えないため</li>
<li>state machine gem は開発が止まっている</li>
<li>aasm gem は活発</li>
<li><a href="http://qiita.com/ogomr/items/0b5c4de7f38fd1482a48" title="PlantUML Cheat Sheet">PlantUML Cheat Sheet</a></li>
</ul>


<h2>Ruby初級者向けレッスン 51回 例外</h2>

<p>内容の他に、デモのときのシェルや Emacs の操作などが気になりました (参考になりました)。</p>

<h2>クロージング</h2>

<ul>
<li>次回は 2015 年 2 月 21 日</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[capistrano 3.3.3 が依存している capistrano-stats について]]></title>
    <link href="http://blog.n-z.jp/blog/2014-12-01-capistrano-stats.html"/>
    <updated>2014-12-01T21:33:21+09:00</updated>
    <id>http://blog.n-z.jp/blog/capistrano-stats</id>
    <content type="html"><![CDATA[<p>capistrano が 3.3.3 にあがって
<a href="https://github.com/capistrano/stats">capistrano-stats</a>
という gem に依存するようになりました。
これは <code>metrics.capistranorb.com:1200</code> にバージョン情報などを送信して
capistrano のサポートの改善に役立てようとするもののようです。</p>

<!--more-->


<h2>対象バージョン</h2>

<ul>
<li>capistrano 3.3.3</li>
<li>capistrano-stats 1.0.3</li>
</ul>


<h2>Capfile locked</h2>

<p>capistrano-stats とは関係ないですが、
<code>Capfile locked at 3.2.1, but 3.3.3 is loaded</code>
と出るときは <code>config/deploy.rb</code> の最初の方にある
<code>lock '3.2.1'</code>
という行を
<code>lock '3.3.3'</code>
に書き換えれば OK です。</p>

<h2>capistrano-stats 1.0.3 の挙動</h2>

<p>初回実行時に
<code>Do you want to enable statistics? (y/N):</code>
ときかれて、
そのまま Enter か <code>n</code> を入力すると ruby や capistrano のバージョンは送信されなくなるのですが、
(少なくとも私の) 期待に反して
<code>metrics.capistranorb.com:1200</code>
への送信自体は発生するようになっています。</p>

<h2>何が問題か</h2>

<p>全く送信してほしくない場合にも通信が発生したり、
firewall で塞がれている場合にエラーになったり
という問題があります。</p>

<h2>一時的に無効にするには?</h2>

<p><code>CAPISTRANO_METRICS=localhost:1200 bundle exec cap default</code>
のように環境変数 <code>CAPISTRANO_METRICS</code> で送っても無視されるところに送信すれば良さそうです。</p>

<h2>完全に無効にするには?</h2>

<p>pull request 1 の
<a href="https://github.com/capistrano/stats/pull/1" title="Honor the users privacy decision and do not send UDP packets if he does not want to send metrics">Honor the users privacy decision and do not send UDP packets if he does not want to send metrics</a>
にあるように</p>

<pre><code class="ruby">Rake::Task['metrics:collect'].clear_actions
</code></pre>

<p>を <code>config/deploy.rb</code> に追加すると送信されなくなりました。</p>

<h2>今後</h2>

<p><a href="https://github.com/capistrano/stats/pull/2" title="Allow users to opt-out of sending the UDP ping and improve error handling when the sendto syscall fails">Allow users to opt-out of sending the UDP ping and improve error handling when the sendto syscall fails</a>
という pull request が続きで出ているので、
将来のバージョンでは全く送信しない選択肢が用意されるかもしれません。</p>

<h2>2014-12-13 追記</h2>

<p>その後、
capistrano 3.3.4 と capistrano-stats 1.1.0 にあがって、
デフォルトの N を 2 回は全く送信しないようになりました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第 17 回 RubyMotion もくもく会 in Osaka に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-11-19-rubymotion-mokumoku-osaka.html"/>
    <updated>2014-11-19T19:36:19+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-mokumoku-osaka</id>
    <content type="html"><![CDATA[<p>第 1 回から第 15 回に参加していて
前回の 16 回は中止になっていた
RubyMotion もくもく会 in Osaka の
<a href="http://rubymotionjp.connpass.com/event/9597/" title="第 17 回 RubyMotion もくもく会 in Osaka - connpass">第 17 回 RubyMotion もくもく会 in Osaka - connpass</a>
に参加してきました。
今回も基本的にみんなもくもくしていました。</p>

<p>次回の
<a href="http://rubymotionjp.connpass.com/event/10195/" title="第 18 回 RubyMotion もくもく会 in Osaka - connpass">第 18 回 RubyMotion もくもく会 in Osaka - connpass</a>
は 2014/12/17(水) になりました。</p>

<!--more-->


<p>今回はメールを書いたり github の issues を見たりコメントしたりしていました。</p>

<p>最後の方は <a href="http://support.apple.com/ja-jp/HT5868">iPod touch の「このコンピュータを信頼しますか」警告</a>が出続けて
iTunes が認識してくれない問題を思い出したので、調べていたのですが、結局解決しませんでした。
Dropbox は認識して写真を取り込んでくれるので、ケーブルなどのハードウェアは問題がないはずなので、
ソフトウェア側の問題らしいというところまでは絞り込めています。</p>

<h2>メモ</h2>

<p>以下メモです。</p>

<ul>
<li>Firebase</li>
<li>WKWebView</li>
<li><a href="https://www.mapbox.com/">Mapbox</a></li>
<li><a href="http://qiita.com/aki/items/c0073bf1e83858fe2e92">Xcode6のiPhone Simulatorの場所</a></li>
<li><a href="https://github.com/magicalpanda/MagicalRecord">https://github.com/magicalpanda/MagicalRecord</a></li>
<li><a href="http://qiita.com/susieyy/items/749c4ac5d82d765c12c6">SwiftのRSS Readerを100行で作ったよ</a></li>
<li><a href="https://github.com/lingoer/SwiftyJSON">https://github.com/lingoer/SwiftyJSON</a></li>
<li>WatchKit</li>
</ul>

]]></content>
  </entry>
  
</feed>
