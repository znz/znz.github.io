<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: ruby | @znz blog]]></title>
  <link href="http://blog.n-z.jp/blog/categories/ruby/atom.xml" rel="self"/>
  <link href="http://blog.n-z.jp/"/>
  <updated>2014-01-28T21:29:03+09:00</updated>
  <id>http://blog.n-z.jp/</id>
  <author>
    <name><![CDATA[Kazuhiro NISHIYAMA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[yaml_dbでMySQLからPostgreSQLに移行した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-28-yaml-db.html"/>
    <updated>2014-01-28T21:25:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/yaml-db</id>
    <content type="html"><![CDATA[<p>先週 redmine を MySQL から PostgreSQL に移行するときに、最近の ruby では動かなくなっている taps ではなく yaml_db を使ってみました。</p>

<p>その後、自作 Rails アプリでも yaml_db を使って移行しました。</p>

<!--more-->


<h2>yaml_db 選び</h2>

<p>yaml_db は <code>gem install yaml_db</code> でインストールできるものが新しい rails などに
対応していないため fork が乱立していて、どれを使えばいいのか悩ましいのですが、
どこかで見かけた情報を元に
<code>gem 'yaml_db', github: 'jetthoughts/yaml_db', ref: 'fb4b6bd7e12de3cffa93e0a298a1e5253d7e92ba'</code>
を使いました。(今だと別の指定の方が良さそうです。後述)</p>

<p>redmine の場合は <code>Gemfile.local</code> に書いて (なければ作成)、
<code>bundle</code> でインストールすれば使えます。</p>

<h2>データベース移行</h2>

<p>アプリを止めるなどして、データベースの変更が発生しない状態にして移行作業をします。
YAML の互換性の問題などがあるので、データベースの移行と Ruby や Redmine のバージョンアップは別々にした方が良いです。</p>

<ol>
<li>まず <code>RAILS_ENV=production bundle exec rake db:data:dump</code> で <code>db/data.yml</code> を作成します。</li>
<li>つぎに Ruby や Rails や Redmine のバージョンはそのままで <code>config/database.yml</code> を変更します。</li>
<li>必要に応じて <code>bundle</code> でデータベースアダプターの gem をインストールします。</li>
<li>データベースの作成をしたり <code>db:migrate</code> をしておきます。</li>
<li><code>RAILS_ENV=production bundle exec rake db:data:load</code> で読み込みます。</li>
</ol>


<h2>yaml_db の fork の再調査</h2>

<p><a href="https://rubygems.org/gems/yaml_db">yaml_db gem</a> ( <a href="https://github.com/ludicast/yaml_db">ludicast/yaml_db</a> )
からの fork としては
<a href="https://rubygems.org/gems/gitlab_yaml_db">gitlab_yaml_db</a> ( <a href="https://github.com/gitlabhq/yaml_db">gitlabhq/yaml_db</a> ? )
のインストール数が
多いようですが、これは以前の gitlabhq が依存していたからのようです。 (今は依存していない)</p>

<p>新しい fork として
<a href="https://rubygems.org/gems/yaml_db_with_schema_tables">yaml_db_with_schema_tables</a>
( <a href="https://github.com/zweitag/yaml_db">zweitag/yaml_db</a> )
がありましたが、古い yaml_db からの fork なので、新しい rails への対応が入っていないような気がします。
他の fork との違いとして <code>schema_info</code> と <code>schema_migrations</code> も dump するようにしているようです。</p>

<p><a href="https://github.com/jetthoughts/yaml_db">jetthoughts/yaml_db</a> という fork は
rubygems.org にはリリースしていないようですが、
Rails 4 に対応して、 README の <code>This gem is now Rails 3 only.</code> という記述を削除しているなど、メンテナンスが続いていそうなので、
次はこの fork を使うのが良さそうだと思いました。
(古いブログの記事だと <code>gem 'yaml_db', github: 'jetthoughts/yaml_db', branch: 'rails4'</code> で rails4 ブランチを指定している例もあるようですが、 master にマージ済みなので branch 指定は不要です。)</p>

<h2>別 Rails アプリの移行</h2>

<p>続きとして、本日、自作の Rails アプリを <code>jetthoughts/yaml_db</code> を使って移行してみました。</p>

<h3>postgresql のデータベース作成</h3>

<p>データベースの作成は事前に出来るので、
<code>sudo -u postgres psql</code>
で作成しておきます。</p>

<p><code>
CREATE ROLE dbuser LOGIN ENCRYPTED PASSWORD 'dbpass' NOINHERIT VALID UNTIL 'infinity';
CREATE DATABASE dbname WITH ENCODING='UTF8' OWNER=dbuser;
</code></p>

<p>データベースの作成方法はいつも
<a href="http://www.redmine.org/projects/redmine/wiki/RedmineInstall">RedmineInstall</a>
を参考にしています。</p>

<h3>pg gem</h3>

<p>pg gem も忘れずにあらかじめ入れておきます。</p>

<h3>メンテナンス中画面設定</h3>

<p>まず apache2 + passenger の方でメンテナンス中画面を出すようにしました。</p>

<p>```</p>

<pre><code>&lt;Directory /path/to/app&gt;
    Options FollowSymLinks
    AllowOverride None
    #Order allow,deny
    #allow from all
    Order deny,allow
    deny from all
&lt;/Directory&gt;
ErrorDocument 403 "&amp;#x30e1;&amp;#x30f3;&amp;#x30c6;&amp;#x30ca;&amp;#x30f3;&amp;#x30b9;&amp;#x4e2d;&amp;#x3067;&amp;#x3059;&amp;#x3002;&amp;#x20;&amp;#x3057;&amp;#x3070;&amp;#x3089;&amp;#x304f;&amp;#x304a;&amp;#x5f85;&amp;#x3061;&amp;#x304f;&amp;#x3060;&amp;#x3055;&amp;#x3044;&amp;#x3002;"
</code></pre>

<p>```</p>

<p><code>ErrorDocument</code> の埋め込み文字列は <code>Content-Type: text/html;charset=iso-8859-1</code> になってNいたので、
<code>'メンテナンス中です。 しばらくお待ちください。'.unpack('U*').map{|c| '&amp;#x%x;' % c }.join('')</code>
のようにして、すべてエスケープして日本語を埋め込みました。</p>

<p>本来は 5xx のステータスにすべきですが、一時的なものなので 403 で妥協しました。
後日メンテナンスをするときはちゃんと 5xx にしたいと思っています。</p>

<h3>データベースのバックアップとダンプ</h3>

<p>cron で動かしているデータベースのバックアップと yaml_db でのダンプをしました。</p>

<p><code>
/path/to/app$ sudo /etc/cron.daily/local-dump
/path/to/app$ $ sudo env PATH=$(dirname $(awk '/PassengerDefaultRuby/{print $2}' /etc/apache2/conf.d/passenger.conf)):$PATH RAILS_ENV=production bundle exec rake db:data:dump
</code></p>

<h3>config/database.yml 書き換え</h3>

<p>database.yml で postgresql の方を使うように書き換えます。</p>

<p><code>
  adapter: postgresql
  encoding: unicode
  database: dbname
  pool: 5
  username: dbuser
  password: dbpass
  host: localhost
  #port: 5432
  min_messages: warning
</code></p>

<h3>データの読み込み</h3>

<p><code>rake db:migrate</code> でマイグレーションを実行した後、
<code>rake db:data:load</code> でデータを読み込みます。</p>

<p><code>
/path/to/app$ $ sudo env PATH=$(dirname $(awk '/PassengerDefaultRuby/{print $2}' /etc/apache2/conf.d/passenger.conf)):$PATH RAILS_ENV=production bundle exec rake db:migrate
/path/to/app$ $ sudo env PATH=$(dirname $(awk '/PassengerDefaultRuby/{print $2}' /etc/apache2/conf.d/passenger.conf)):$PATH RAILS_ENV=production bundle exec rake db:data:load
</code></p>

<h3>メンテナンス解除と確認</h3>

<p>apache2 の設定を戻して、動作確認します。</p>

<h2>まとめ</h2>

<p>Rails のデータベースの移行に yaml_db を使ってみました。</p>

<p>yaml_db の方が taps より昔からあって、
しばらくメンテナンスが止まっていて、
taps の方が主流になるかと思っていたら、
逆に taps の方がメンテナンスがあまりされなくなって、
yaml_db の方が fork が乱立して、新しい rails に対応したものもでてきて、
結局今のところデータベースの移行には yaml_db が無難という状況になっているようです。</p>

<p>taps は新しい Ruby に対応できていなかったり、
以前の記事に書いたようにスキーマの移行が不十分なところがあったりして、
使われなくなっていくように感じました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第59回 Ruby/Rails勉強会＠関西に参加しました]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-25-kansaiworkshop059.html"/>
    <updated>2014-01-25T13:36:50+09:00</updated>
    <id>http://blog.n-z.jp/blog/kansaiworkshop059</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/rubykansai/workshops/wiki/Kansaiworkshop059">第59回 Ruby/Rails勉強会＠関西</a> に参加しました。</p>

<p>一部メモを書いていたので公開しておきます。</p>

<!--more-->


<h2>IT関係の同人誌などの話</h2>

<h3>質疑応答</h3>

<ul>
<li>Q ReVIEW の本は?</li>
<li><p>A 存在を知ったのが後だったので、電子書籍で買っただけ。</p></li>
<li><p>Q いくらぐらい?</p></li>
<li>A コピー本などで無料のものもありますが、たとえば500円とか1200円とか。印刷代などの関係で決まります。</li>
</ul>


<h2>gitlab</h2>

<h3>メモ</h3>

<ul>
<li><a href="http://atnd.org/events/47159">C++テンプレート完全ガイド勉強会 vol.1大阪 : ATND</a></li>
<li><a href="http://qwik.jp/minamirb/">Minami.rb</a></li>
<li><a href="https://wiki.debian.org/KansaiDebianMeeting">関西Debian勉強会</a></li>
<li><a href="http://www.slideshare.net/takafumionaka/is-there-anynecessityofusinggithubenterprise">Gitlab は貧者の github enterprise</a></li>
<li><a href="https://gitorious.org/">Gitorious</a></li>
<li><a href="http://gitblit.com/">Gitblit</a></li>
<li>chef とか puppet とか ansible とかが何か知っている人は会場には少なかった。</li>
<li><a href="https://twitter.com/koichiroo/status/425454305944952832/photo/1">レガシー依存の悪循環こわい</a></li>
<li><a href="http://mrk1869.com/blog/gitlab_installation/">GitLab 6.0をインストールする &ndash; Markovnikov Laboratory</a></li>
<li>「6.2で転けて、6.1で転けて、ここまで設定するのに3日かかった…」と書いてあって大変そうなので、 ansible playbook を使ったという話</li>
<li><a href="http://d.hatena.ne.jp/akishin999/20130819/1376868748">20分(くらい)で GitLab をインストールする方法 &ndash; akishin999の日記</a></li>
<li>svn からの移行には GUI がある方が良い</li>
</ul>


<h2>LT1 ダジャレ</h2>

<ul>
<li>わたしを創ったもの R・C・フェラン 年刊ＳＦ傑作選１</li>
<li>mecab で分解して置き換えてダジャレ生成</li>
<li>変なのもたくさん出てくる</li>
<li>評価関数</li>
</ul>


<h2>Ruby 関西 10 周年</h2>

<ul>
<li><a href="https://k-of.jp/2004/">関西オープンソース 2004</a></li>
<li>2004年11月27日 第0回 Ruby勉強会</li>
<li>大前研一: 人間が変わる方法は3つしかない。 １番目は「時間配分を変える。」 ２番目は「住む場所 を変える。」 ３番目は「つきあう人を変える。」 この３つの要素でしか人間は変わらない。 最も無意味なのは「決意を新たにする」ことだ。</li>
<li>助け合いの力</li>
<li>グラミン銀行</li>
<li>Jim Rohn の名言 : あなたは、あなたのまわりの5人の平均です。</li>
<li><a href="http://thewriteway.com/2011/01/learning-by-doing-revisited/">http://thewriteway.com/2011/01/learning-by-doing-revisited/</a></li>
<li>多様性は善</li>
<li>ハブとしてのRuby関西</li>
</ul>


<h2>Ruby初級者向けレッスン</h2>

<ul>
<li><code>codepoints</code> とは Unicode のだったり、それぞれの encoding のだったり。</li>
<li><code>"Ruby関西".chars.each{|c| puts c}</code> の <code>.each</code> はなくても動くが <code>$VERBOSE=true</code> のときに <code>warning: passing a block to String#chars is deprecated</code> という警告がでる。</li>
<li><a href="https://gist.github.com/higaki/8147246">https://gist.github.com/higaki/8147246</a></li>
<li><a href="https://github.com/higaki/learn_ruby_kansai_59">https://github.com/higaki/learn_ruby_kansai_59</a></li>
</ul>


<h2>帰り際の話</h2>

<ul>
<li>Windows 版の Ruby で 2.0.0 からエスケープシーケンスに対応しているのが、
NEWS に書いていないなどソース以外に情報がない。</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[heroku で passenger を使うようにした]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-24-passenger-ruby-heroku.html"/>
    <updated>2014-01-24T23:23:25+09:00</updated>
    <id>http://blog.n-z.jp/blog/passenger-ruby-heroku</id>
    <content type="html"><![CDATA[<p>今は heroku で動いている <a href="https://bugs.ruby-lang.org/">https://bugs.ruby-lang.org/</a> が thin から passenger に切り替えて安定したという話を IRC で知ったので、自分が heroku で動かしている Rails アプリも passenger に切り替えてみました。
(ruby-lang.org の方はいろいろ試すために今後他のものに切り替える可能性もあります。)</p>

<!--more-->


<h2>概要</h2>

<p><a href="https://github.com/phusion/passenger-ruby-heroku-demo">https://github.com/phusion/passenger-ruby-heroku-demo</a>
を参考にして Gemfile と Procfile を設定するだけです。</p>

<h2>Gemfile の書き換え</h2>

<p><code>gem "unicorn"</code> や  <code>gem "thin"</code> があればコメントアウトするなり削除するなりして、
代わりに <code>gem "passenger"</code> を追加します。</p>

<h2>Procfile の設定</h2>

<p>Procfile がなければ新規作成します。
既存の Procfile があって以下のような行があれば削除します。</p>

<pre><code>web: bundle exec ruby web.rb -p $PORT
web: bundle exec unicorn -p $PORT
web: bundle exec thin start -p $PORT
</code></pre>

<p>Procfile に以下の設定を追加します。</p>

<pre><code>web: bundle exec passenger start -p $PORT --max-pool-size 3
</code></pre>

<h2>切り替え反映</h2>

<p>以下のように切り替えを反映します。</p>

<pre><code>bundle install
git commit -a -m "Switch to Phusion Passenger"
git push heroku master
</code></pre>

<p>ここまでは
<a href="https://github.com/phusion/passenger-ruby-heroku-demo">https://github.com/phusion/passenger-ruby-heroku-demo</a>
の手順そのままです。</p>

<h2>ローカルで使う</h2>

<p><code>gem install foreman</code> で <code>foreman</code> を入れておいて <code>env PORT=3000 foreman start</code> とか、
<code>bundle exec passenger start -p 3000 --max-pool-size 3</code> とかで
3000 番ポートで passenger を使えます。</p>

<p>初回起動時は standalone 版 passenger の初期設定が走るので、
少し時間がかかります。</p>

<h2>まとめ</h2>

<p>あまりアクセスが多くない無料の範囲内で使っている Rails アプリなので、
違いはあまりわかっていませんが、簡単に切り替えられるので、
選択肢のひとつとして使われやすくなるのではないかと思います。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第 7 回 RubyMotion もくもく会 in Osaka に参加した]]></title>
    <link href="http://blog.n-z.jp/blog/2014-01-22-rubymotion-mokumoku-osaka.html"/>
    <updated>2014-01-22T23:00:00+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-mokumoku-osaka</id>
    <content type="html"><![CDATA[<p>第 1 回から第 6 回にも参加した RubyMotion もくもく会 in Osaka の
<a href="http://connpass.com/event/4560/">第 7 回 RubyMotion もくもく会 in Osaka</a>
に参加してきました。</p>

<p>次回の
<a href="http://connpass.com/event/4910/">第 8 回 RubyMotion もくもく会 in Osaka</a>
は 2/19(水) になりました。</p>

<!--more-->


<h2>もくもく</h2>

<p>今回は初参加の人がいました。</p>

<p>途中は少し質問の話があったり、リリースしたものの話があったりした以外は
基本的にみんなもくもくしていました。</p>

<h2>話に出たもの</h2>

<p>話に出てきたサイトなどのメモです。</p>

<ul>
<li><a href="https://parse.com/">https://parse.com/</a></li>
<li><a href="http://shin1x1.github.io/vagrantx/">http://shin1x1.github.io/vagrantx/</a></li>
<li><a href="https://twitter.com/ametalk">https://twitter.com/ametalk</a></li>
<li><a href="http://orekike.com/history/orekike7">http://orekike.com/history/orekike7</a></li>
<li><a href="http://www.paintcodeapp.com/">http://www.paintcodeapp.com/</a></li>
</ul>


<h2>やっていたこと</h2>

<ul>
<li>ちゃんと名前をつけて <code>motion create</code> からやり直しました。</li>
<li>いらないメニュー項目がほとんどなので、 <code>buildMenu</code> をコメントアウトしてみたら、
Command+q での終了も出来なくなって不便になったので、戻しました。</li>
<li><code>open</code> コマンドでエラーになったときに <code>NSAlert</code> でエラーメッセージを出すようにしました。</li>
</ul>


<h2>引き続き不明な点</h2>

<p>細かいものはいろいろありますが、大きなものは以下の2点です。</p>

<h3>URL の受け取り方</h3>

<p>起動中に <code>open http://localhost:3000</code> のように URL を開いた場合は</p>

<p>```ruby</p>

<pre><code>NSAppleEventManager.sharedAppleEventManager.setEventHandler(
  self,
  andSelector: :'handleGetURLEvent:withReplyEvent:',
  forEventClass: KInternetEventClass,
  andEventID: KAEGetURL)
</code></pre>

<p>```</p>

<p>で登録しておけば受け取れていますが、
起動していない時に開かれた URL を受け取る方法がわからないままです。</p>

<p><code>open -a Hello --args http://localhost:3000</code> のように起動すれば
<code>NSProcessInfo.processInfo.arguments</code> で取り出せますが、
他のアプリケーションから URL を開いた時に受け取れないので
意味がないです。</p>

<h3>window が閉じられた時の処理</h3>

<p>今のままだと Command+w などで閉じられてしまうと
URL を受け取っても見せる window がなくなっているので
何も出来ないです。</p>

<p>window を閉じられたら終了するか、
閉じられても URL を開いたらまた出てくるようにしたいです。</p>

<h2>まとめ</h2>

<p>今回はみんなもくもくとそれぞれの作業が進んだという感じで、
成果発表もすぐに終わった感じでした。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RubyMotionのOSXアプリの起動エラー]]></title>
    <link href="http://blog.n-z.jp/blog/2013-12-28-rubymotion-error.html"/>
    <updated>2013-12-28T18:55:18+09:00</updated>
    <id>http://blog.n-z.jp/blog/rubymotion-error</id>
    <content type="html"><![CDATA[<p>最近 RubyMotion で作っている OSX アプリが
<code>LSOpenURLsWithRole() failed with error -10810</code>
などで起動しないことがあったので原因を調べてみました。</p>

<!--more-->


<h2>LSOpenURLsWithRole() failed with error -10810</h2>

<h3>よくある原因</h3>

<p><code>Hello.app/Contents/MacOS/Hello</code>
のような実行ファイルの実体に実行属性が外れているというのが
よくある原因のようで、
<a href="http://owncloud.org/">ownCloud</a>
経由で同期したアプリが実行できなかったときは
これが原因でした。</p>

<h3>別の原因</h3>

<p>実行属性も問題なくて悩んでいたときに
コンソール (Console.app) のログを見てみると</p>

<p><code>
2013/12/28 10:39:17.963 open[85406]: spawn_via_launchd() failed, errno=22 label=com.yourcompany.Hello.44032 path=.../Hello/build/MacOSX-10.9-Development/Hello.app/Contents/MacOS/Hello flags=0 : LaunchApplicationClient.cp #1168 LaunchApplicationViaLaunchDJobLabel() q=com.apple.main-thread
</code>
のようなログが出ていたので、
<code>LaunchApplicationViaLaunchDJobLabel</code>
で検索してみたところ、
<a href="http://portingteam.com/topic/9723-mavericks-problem-opening-fresh-wrapper/">Mavericks problem opening fresh wrapper</a>
という話が見つかって、
そこに書いてあった</p>

<p><code>
launchctl remove $(launchctl list | grep wineskin | awk '{ print $3 }')
</code></p>

<p>という手順を参考にして解決しました。</p>

<p><code>Hello</code> が2個残っていて、
<code>$()</code> だとダメだったので個別に <code>launchctl remove</code> しました。</p>

<p><code>
% launchctl list | grep Hello
-   2   com.yourcompany.Hello.44032
-   0   com.yourcompany.Hello.53008
%  launchctl remove $(launchctl list | awk '/Hello/{print $3}')
usage: launchctl remove &lt;job label&gt;
zsh: exit 1     launchctl remove $(launchctl list | awk '/Hello/{print $3}')
%  echo launchctl remove $(launchctl list | awk '/Hello/{print $3}')
launchctl remove com.yourcompany.Hello.44032 com.yourcompany.Hello.53008
%  launchctl remove com.yourcompany.Hello.44032
%  launchctl remove com.yourcompany.Hello.53008
%  open -a Hello
</code></p>

<h3>その他</h3>

<p>その他の対象方法も含めて
<a href="http://www.thexlab.com/faqs/error-10810.html">Error -10810 Openng Applictions or Relaunching Finder</a>
にいろいろ書いてあるようです。
(英語で長かったのでちゃんと読んでません。)</p>

<h2>MacBookPro6,2 で EXC_BAD_INSTRUCTION (SIGILL) になって起動しない</h2>

<p>未解決です。</p>

<p><a href="https://github.com/MohawkApps/Hacker-Bar/issues/36">EXC_BAD_INSTRUCTION crash in App Store version&hellip;</a>
に似た話があって、
RubyMotion のバグっぽいという話のようです。</p>

<p><code>motion create --template=osx HelloOSX</code>
で作成しただけのものでも
<a href="https://gist.github.com/znz/8158061#file-helloosx-report-txt">クラッシュ</a>
して起動しませんでした。</p>

<p>RubyMotion を入れている自分の MacBook Air の環境の問題かどうかを切り分けるために
<a href="http://shin1x1.github.io/vagrantx/">VagrantX</a>
も試してみましたが、
<a href="https://gist.github.com/znz/8158061#file-vagrantx-report-txt">同じくクラッシュ</a>
して起動しませんでした。</p>
]]></content>
  </entry>
  
</feed>
